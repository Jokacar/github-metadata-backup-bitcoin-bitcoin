{
  "type": "issue",
  "issue": {
    "id": 2398671777,
    "node_id": "I_kwDOABII586O-NOh",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30416",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30416/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30416/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30416/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/30416",
    "number": 30416,
    "state": "open",
    "state_reason": null,
    "title": "Send RPC calls performance",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nI want to report performance changes of `sendmany` and `sendtoaddress` RPC calls.\r\n\r\nWe use fresh-new wallet for more than an year. There are 24 descriptors in the wallet from which 12 were imported from about a month older wallet. We generated circa 300 k addresses from these imported descriptors and hundreds of addresses from the new ones. We had send about 1500 transactions from this wallet which probably generated hundreds of change addresses.\r\n\r\nDuring the operation of that wallet, the time of RPC `send*` calls degraded a lot. From several seconds at start to almost 3 minutes.\r\n\r\n![Screenshot from 2024-07-09 17-19-55](https://github.com/bitcoin/bitcoin/assets/11145995/d7bc7ff1-cc2e-45c4-a43a-cdaf9b1d81dc)\r\n\r\nGraph of RPC call duration during last monts. yellow `sendmany` and blue `sendtoaddress`.\r\n\r\nThe significant drop to cca 25 seconds appears just after update to version 27.0.\r\n\r\nBTW, during that time of performance degradation, I monitored number of UTXOs as well and the performance didn't correlate. We have 1-10 k of UTXOs in the wallet and even if I consolidate these to only tens of UTXOs, the performance didn't improve, as you may notice on the graph.\r\n\r\n![Screenshot from 2024-07-09 17-29-10](https://github.com/bitcoin/bitcoin/assets/11145995/75148214-7bd6-4dc7-a9df-32dd07e78ee9)\r\n \r\nThe same graph for last few weeks after update to version 27.0\r\n\r\n**So, big kudos and many thanks to this perfomance improvement!** :clap:  I notice the new coin-selection algorithm in the changelog, but – according to documentation – this new algorithm should apply only with high fees, which does not apply during last weeks. So I am not sure what could have caused this improvement change and so I am posting this report.\r\n\r\nWe notice only minor degradation during last days – from 24 seconds to 26 seconds. I will monitor the performance further and report if it get worse or not.\r\n\n\n### Expected behaviour\n\nBitcoin core performance of `send*` RPC calls will not degrade over time.\n\n### Steps to reproduce\n\nI am not sure how to reproduce. For short: generate hundreds of thousands of addresses, receive ten thousands of UTXOs, send thousand of UTXOs. \n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\n27.1\n\n### Operating system and version\n\nDebian 11\n\n### Machine specifications\n\nAmazon AWS EC2 instances. Mainly `t3a` and `c6a` instance types (AMD EPYC 7571). Instance type change didn't have significant impact on performance.",
    "user": {
      "login": "VojtechMyslivec",
      "id": 11145995,
      "node_id": "MDQ6VXNlcjExMTQ1OTk1",
      "avatar_url": "https://avatars.githubusercontent.com/u/11145995?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/VojtechMyslivec",
      "html_url": "https://github.com/VojtechMyslivec",
      "followers_url": "https://api.github.com/users/VojtechMyslivec/followers",
      "following_url": "https://api.github.com/users/VojtechMyslivec/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/VojtechMyslivec/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/VojtechMyslivec/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/VojtechMyslivec/subscriptions",
      "organizations_url": "https://api.github.com/users/VojtechMyslivec/orgs",
      "repos_url": "https://api.github.com/users/VojtechMyslivec/repos",
      "events_url": "https://api.github.com/users/VojtechMyslivec/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/VojtechMyslivec/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 1,
    "created_at": "2024-07-09T16:36:03Z",
    "updated_at": "2024-07-09T16:39:28Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2218170930,
      "node_id": "IC_kwDOABII586ENpoy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2218170930",
      "actor": {
        "login": "VojtechMyslivec",
        "id": 11145995,
        "node_id": "MDQ6VXNlcjExMTQ1OTk1",
        "avatar_url": "https://avatars.githubusercontent.com/u/11145995?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/VojtechMyslivec",
        "html_url": "https://github.com/VojtechMyslivec",
        "followers_url": "https://api.github.com/users/VojtechMyslivec/followers",
        "following_url": "https://api.github.com/users/VojtechMyslivec/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/VojtechMyslivec/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/VojtechMyslivec/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/VojtechMyslivec/subscriptions",
        "organizations_url": "https://api.github.com/users/VojtechMyslivec/orgs",
        "repos_url": "https://api.github.com/users/VojtechMyslivec/repos",
        "events_url": "https://api.github.com/users/VojtechMyslivec/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/VojtechMyslivec/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-09T16:39:27Z",
      "updated_at": "2024-07-09T16:39:27Z",
      "author_association": "NONE",
      "body": "#26008 may relate? I am not sure if it was included in 27.0 release",
      "user": {
        "login": "VojtechMyslivec",
        "id": 11145995,
        "node_id": "MDQ6VXNlcjExMTQ1OTk1",
        "avatar_url": "https://avatars.githubusercontent.com/u/11145995?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/VojtechMyslivec",
        "html_url": "https://github.com/VojtechMyslivec",
        "followers_url": "https://api.github.com/users/VojtechMyslivec/followers",
        "following_url": "https://api.github.com/users/VojtechMyslivec/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/VojtechMyslivec/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/VojtechMyslivec/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/VojtechMyslivec/subscriptions",
        "organizations_url": "https://api.github.com/users/VojtechMyslivec/orgs",
        "repos_url": "https://api.github.com/users/VojtechMyslivec/repos",
        "events_url": "https://api.github.com/users/VojtechMyslivec/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/VojtechMyslivec/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30416#issuecomment-2218170930",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30416"
    }
  ]
}