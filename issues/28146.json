{
  "type": "issue",
  "issue": {
    "id": 1820003645,
    "node_id": "I_kwDOABII585sew09",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/28146",
    "number": 28146,
    "state": "closed",
    "state_reason": "completed",
    "title": "error: in \"validationinterface_tests/unregister_all_during_call\": check destroyed has failed",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\ncheck failed\n\n### Expected behaviour\n\nnot fail\n\n### Steps to reproduce\n\n?\n\n### Relevant log output\n\nhttps://cirrus-ci.com/task/4769037708689408?logs=ci#L3768\r\n\r\n```\r\ntest/validationinterface_tests.cpp(93): error: in \"validationinterface_tests/unregister_all_during_call\": check destroyed has failed\r\n```\r\n\r\n\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\ncurrent master\n\n### Operating system and version\n\narm CI\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 4,
    "closed_at": "2023-07-25T15:36:17Z",
    "created_at": "2023-07-25T10:15:25Z",
    "updated_at": "2023-07-25T15:36:18Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1649540097,
      "node_id": "IC_kwDOABII585iUfwB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649540097",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T10:16:16Z",
      "updated_at": "2023-07-25T10:16:16Z",
      "author_association": "MEMBER",
      "body": "`TestInterface::Call();` should be blocking on the destructor, which sets `destroyed`, so I have no idea how this could happen.",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1649540097",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146"
    },
    {
      "event": "labeled",
      "id": 9909778616,
      "node_id": "LE_lADOABII585sew09zwAAAAJOqzi4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9909778616",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T10:16:25Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "commented",
      "id": 1649931679,
      "node_id": "IC_kwDOABII585iV_Wf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649931679",
      "actor": {
        "login": "Crypt-iQ",
        "id": 15145615,
        "node_id": "MDQ6VXNlcjE1MTQ1NjE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/15145615?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypt-iQ",
        "html_url": "https://github.com/Crypt-iQ",
        "followers_url": "https://api.github.com/users/Crypt-iQ/followers",
        "following_url": "https://api.github.com/users/Crypt-iQ/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypt-iQ/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypt-iQ/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypt-iQ/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypt-iQ/orgs",
        "repos_url": "https://api.github.com/users/Crypt-iQ/repos",
        "events_url": "https://api.github.com/users/Crypt-iQ/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypt-iQ/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T14:16:31Z",
      "updated_at": "2023-07-25T14:22:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "I was able to reproduce this by adding some sleeps:\r\n\r\n<details>\r\n<summary>diff on bc4f6b13feb29146b7e10e86f93dc7f6fb6937f2 </summary>\r\n<br>\r\n\r\n```diff\r\ndiff --git a/src/validationinterface.cpp b/src/validationinterface.cpp\r\nindex d344c8bfb..bb645ae94 100644\r\n--- a/src/validationinterface.cpp\r\n+++ b/src/validationinterface.cpp\r\n@@ -17,6 +17,9 @@\r\n #include <unordered_map>\r\n #include <utility>\r\n \r\n+#include <chrono>\r\n+#include <thread>\r\n+\r\n std::string RemovalReasonToString(const MemPoolRemovalReason& r) noexcept;\r\n \r\n /**\r\n@@ -86,7 +89,9 @@ public:\r\n             {\r\n                 REVERSE_LOCK(lock);\r\n                 f(*it->callbacks);\r\n+                std::this_thread::sleep_for(1ms);\r\n             }\r\n+            LogPrintf(\"it->count %v\\n\", it->count);\r\n             it = --it->count ? std::next(it) : m_list.erase(it);\r\n         }\r\n     }\r\n@@ -182,6 +187,7 @@ void SyncWithValidationInterfaceQueue()\r\n         auto local_name = (name);                              \\\r\n         LOG_EVENT(\"Enqueuing \" fmt, local_name, __VA_ARGS__);  \\\r\n         m_internals->m_schedulerClient.AddToProcessQueue([=] { \\\r\n+            std::this_thread::sleep_for(800us);                  \\\r\n             LOG_EVENT(fmt, local_name, __VA_ARGS__);           \\\r\n             event();                                           \\\r\n         });                                                    \\\r\n@@ -194,7 +200,6 @@ void CMainSignals::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInd\r\n     // Dependencies exist that require UpdatedBlockTip events to be delivered in the order in which\r\n     // the chain actually updates. One way to ensure this is for the caller to invoke this signal\r\n     // in the same critical section where the chain is updated\r\n-\r\n     auto event = [pindexNew, pindexFork, fInitialDownload, this] {\r\n         m_internals->Iterate([&](CValidationInterface& callbacks) { callbacks.UpdatedBlockTip(pindexNew, pindexFork, fInitialDownload); });\r\n     };\r\n```\r\n</details>\r\n\r\nIn the CI logs, `UpdatedBlockTip` and `BlockChecked` run at ~ the same time. I think what happens is:\r\n- `BlockChecked` calls `Iterate` which increments `it->count` (count = 2) with `m_mutex`\r\n- `m_on_call` gets called without `m_mutex`\r\n- In the scheduler thread, `Iterate` is called and increments `it->count` (count = 3) with `m_mutex`. (`UpdatedBlockTip` runs in the scheduler thread). Then `m_mutex` is released to call `UpdatedBlockTip`\r\n- `m_on_call` calls `UnregisterAllValidationInterfaces` which will decrement `it->count` (count = 2) with `m_mutex`.\r\n- `m_on_call` calls `UnregisterAllValidationInterfaces` which is a no-op.\r\n- The `BlockChecked` callback finishes and since the count = 2, the element isn't erased so the destructor isn't called. This fails the test",
      "user": {
        "login": "Crypt-iQ",
        "id": 15145615,
        "node_id": "MDQ6VXNlcjE1MTQ1NjE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/15145615?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypt-iQ",
        "html_url": "https://github.com/Crypt-iQ",
        "followers_url": "https://api.github.com/users/Crypt-iQ/followers",
        "following_url": "https://api.github.com/users/Crypt-iQ/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypt-iQ/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypt-iQ/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypt-iQ/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypt-iQ/orgs",
        "repos_url": "https://api.github.com/users/Crypt-iQ/repos",
        "events_url": "https://api.github.com/users/Crypt-iQ/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypt-iQ/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1649931679",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146"
    },
    {
      "event": "commented",
      "id": 1650064645,
      "node_id": "IC_kwDOABII585iWf0F",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650064645",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T15:30:58Z",
      "updated_at": "2023-07-25T15:30:58Z",
      "author_association": "MEMBER",
      "body": "> UpdatedBlockTip runs in the scheduler thread\r\n\r\nThanks. That sounds like a bug. The unit test should be single threaded, or alternatively drop all async notifications before starting.",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1650064645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146"
    },
    {
      "event": "commented",
      "id": 1650073657,
      "node_id": "IC_kwDOABII585iWiA5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650073657",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T15:36:17Z",
      "updated_at": "2023-07-25T15:36:17Z",
      "author_association": "MEMBER",
      "body": "Let's continue discussion in https://github.com/bitcoin/bitcoin/pull/28150",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1650073657",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28146"
    },
    {
      "event": "closed",
      "id": 9913495051,
      "node_id": "CE_lADOABII585sew09zwAAAAJO4-4L",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9913495051",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T15:36:18Z"
    }
  ]
}