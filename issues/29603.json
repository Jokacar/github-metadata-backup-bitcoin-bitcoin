{
  "type": "issue",
  "issue": {
    "id": 2176381162,
    "node_id": "I_kwDOABII586BuPDq",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/29603",
    "number": 29603,
    "state": "open",
    "state_reason": null,
    "title": "Current default settings are broken, some fix is needed",
    "body": "### Please describe the feature you'd like to see added.\r\n\r\nBetter default settings, or fix to database cache handling\r\n\r\n### Is your feature related to a problem, if so please describe it.\r\n\r\nWhen doing IBD using default settings, on a relatively fast machine on relatively fast HDD everything works well until ~when segwit was activated. After that ETA estimate shot up from 4 days to 3 weeks. Investigating, my 1MB/s internet was downloading only about 15% of the time. The operating system became extremely laggy, and i found that the HDD was stuck on 100% IO load, doing 4-6MB/s read, plus the normal occasional writes for downloaded parts.\r\n\r\nI tried increasing db cache by 2x to 900MB, but absolutely nothing changed. RAM usage etc. same.\r\n\r\nSearching for issues i found that many \"fixed\" it by putting chainstate on SSD. This was not an option, so i started looking into putting it into a ramdrive. But then in a random comment about using a ramdrive someone said using more than 8000 dbcache makes the full chainstate fit into ram, essentially achieving the same. I was skeptical, since doubling it had not made any difference. But i decided to test it with 8500.\r\n\r\nAnd Bitcoin started working perfectly. Continuous download, low IO load, much faster write throughput. Something bordering unusable became smooth. So why is this a feature request instead of \"that's expected with such high db cache\"\r\n\r\nBecause even a device with only 3 gigs of ram can use a value of 8500 and start working well, instead of being useless. It takes something like 8 hours before bitcoin's RAM usage reaches 3 gigs when syncing at 1MB/s. And at this point one can restart bitcoin which frees the ram, and sync for another 8 hours.\r\n\r\nThis is very weird that there exists an undocumented \"threshold\" where dbcache's operation changes completely, starting to work as an actual cache, freeing the HDD from doing constant small random read operations.\r\n\r\n### Describe the solution you'd like\r\n\r\njust drop dbcache setting completely, let it grow as needed and when RAM starts to get full, just flush it as if restarting bitcoin. I wonder how many HDD:s have broken down due to weeks long constant 100% random read IO stress due to this issue, and how many users gave up on the idea of running a node because they thought their machine is not up to the task.\r\n\r\n### Describe any alternatives you've considered\r\n\r\nchange default setting to the minimum value that can support proper cache behavior after segwit blocks. Warn user that reducing the cache will cause extreme slowdown and disk stress when doing IBD after segwit blocks start, practically only doable with SSD.",
    "user": {
      "login": "reivanen",
      "id": 6353462,
      "node_id": "MDQ6VXNlcjYzNTM0NjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/reivanen",
      "html_url": "https://github.com/reivanen",
      "followers_url": "https://api.github.com/users/reivanen/followers",
      "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
      "organizations_url": "https://api.github.com/users/reivanen/orgs",
      "repos_url": "https://api.github.com/users/reivanen/repos",
      "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/reivanen/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64583,
        "node_id": "MDU6TGFiZWw2NDU4Mw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Feature",
        "name": "Feature",
        "color": "7cf575",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "created_at": "2024-03-08T16:34:45Z",
    "updated_at": "2024-03-09T11:31:59Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 12057997744,
      "node_id": "LE_lADOABII586BuPDqzwAAAALOtnGw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12057997744",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T16:34:45Z",
      "label": {
        "name": "Feature",
        "color": "7cf575"
      }
    },
    {
      "event": "commented",
      "id": 1986067957,
      "node_id": "IC_kwDOABII5852YP31",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:39Z",
      "updated_at": "2024-03-08T17:01:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "Hi @reivanen, thanks for your report.\r\n\r\nIt is documented in https://github.com/bitcoin/bitcoin/blob/master/doc/reduce-memory.md#in-memory-caches that higher dbcache settings give better IBD performance, and I think it stands to reason that this effect would be more pronounced on slower hardware.\r\n\r\nI do agree though that it could be stated more clearly (other than in a doc titled \"reduce memory\") that this known effect occurs.\r\n\r\nThere is also a somewhat-related [PR open ](https://github.com/bitcoin/bitcoin/pull/28358)to increase the maximum dbcache value, to further speed up IBD.\r\n\r\nIn my opinion the current program model of having a constrained memory footprint is preferable to making it unconstrained. If you want to speed up IDB then you can temporarily increase your cache size (to another known maximum size), and after IDB is complete and you are in sync, the (known) memory constraints make Bitcoin Core a more stable program to run and use overall.\r\n\r\nAdditionally, having the program notified that \"memory is running out\" is often more simply said-than-done, usually requiring workarounds which also in turn can make other internals harder to reason about than fixed sizes.\r\n\r\nI have a spinning HDD so may get around to try your cache size cutoff and see if I can also notice the performance differences you mention.",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986067957",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "mentioned",
      "id": 12058354779,
      "node_id": "MEE_lADOABII586BuPDqzwAAAALOu-Rb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12058354779",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:41Z"
    },
    {
      "event": "subscribed",
      "id": 12058354810,
      "node_id": "SE_lADOABII586BuPDqzwAAAALOu-R6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12058354810",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:41Z"
    },
    {
      "event": "commented",
      "id": 1986824229,
      "node_id": "IC_kwDOABII5852bIgl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-09T10:56:02Z",
      "updated_at": "2024-03-09T11:12:31Z",
      "author_association": "NONE",
      "body": "This is not just an issue of \"better performance with larger dbcache\" but a completely different way of working (depending on how much dbcache is used of total allocated?).\r\n\r\nI tested by increasing the network speed to 2MB/s. It worked as good as with 1, HDD was more than able to keep up. Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time. Restart bitcoin, and it continues to download at 2MB/s continuously, presumably until 8 gigs of ram has filled.\r\n\r\nSo after these data points i don't see any other easy \"fix\" than making the default dbcache size large enough to start properly processing segwit blocks, and then purge the cache every time it is starting to fill up, before the \"phase change\" happens in cache behavior.\r\n\r\nI should not need to periodically restart bitcoin to make it work properly. (also it seems like the source i read is outdated, because currently the whole chainstate does not seem to fit into 8 gigs and it starts throttling DL speed due to the random reads. I will test with dbcache 10000 if it will finally sync to the end properly.",
      "user": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986824229",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "commented",
      "id": 1986828626,
      "node_id": "IC_kwDOABII5852bJlS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-09T11:16:15Z",
      "updated_at": "2024-03-09T11:31:59Z",
      "author_association": "NONE",
      "body": "One more data point came to mind: this seems to be related to segwit?\r\n\r\nBecause i was able to properly process the blockchain until around segwit activation using 450MB dbcache. But after that even 8500 dbcache was not enough, but started throttling as the RAM filled up.",
      "user": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986828626",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    }
  ]
}