{
  "type": "issue",
  "issue": {
    "id": 194749714,
    "node_id": "MDU6SXNzdWUxOTQ3NDk3MTQ=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9314",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9314/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9314/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9314/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/9314",
    "number": 9314,
    "state": "closed",
    "state_reason": "completed",
    "title": "60s timeouts during IBD",
    "body": "During IBD when many blocks are being UpdateTip()ed it can be very common for many new connections to be made but most of them timeout due to no messages being sent or received during the first 60 seconds. This was made worse recently by 902768099cb92b39f5ff509cd91fdd8970759b8a as now the version message is now sent from the messaging processing thread (and no longer the network connection thread) so the timeouts can occur from the remove peer also.\r\n\r\nPossible fixes are 1) to ensure the version message is sent upon connection from the network handling thread instead of the message processing thread which freezes during UpdateTip(), and 2) to change the disconnection logic for the 60s timeout so that it uses a timestamp set within the message processing thread (rather than a timestamp set possibly more than 60 seconds before it even gets a chance to process any messages).",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/rebroad/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/rebroad/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 1,
    "closed_at": "2017-10-07T14:36:43Z",
    "created_at": "2016-12-10T06:56:12Z",
    "updated_at": "2021-09-08T12:43:48Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 889234475,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDg4OTIzNDQ3NQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/889234475",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-12-10T08:11:36Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "commented",
      "id": 266351907,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI2NjM1MTkwNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266351907",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-12-12T06:21:17Z",
      "updated_at": "2016-12-12T06:21:17Z",
      "author_association": "MEMBER",
      "body": "This is known and will be fixed with the upcoming async changes.\r\n\r\nhttps://github.com/bitcoin/bitcoin/commit/902768099cb92b39f5ff509cd91fdd8970759b8a didn't change the sending thread for version, it should still (unfortunately) sent on the sockethander thread, since the optimistic send should always succeed.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9314#issuecomment-266351907",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9314"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "rebroad",
        "id": 1530283,
        "node_id": "MDQ6VXNlcjE1MzAyODM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rebroad",
        "html_url": "https://github.com/rebroad",
        "followers_url": "https://api.github.com/users/rebroad/followers",
        "following_url": "https://api.github.com/users/rebroad/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rebroad/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rebroad/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
        "organizations_url": "https://api.github.com/users/rebroad/orgs",
        "repos_url": "https://api.github.com/users/rebroad/repos",
        "events_url": "https://api.github.com/users/rebroad/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rebroad/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-12-27T04:00:21Z",
      "updated_at": "2016-12-27T04:00:21Z",
      "source": {
        "issue": {
          "id": 195154167,
          "node_id": "MDU6SXNzdWUxOTUxNTQxNjc=",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9337",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9337/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9337/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9337/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/9337",
          "number": 9337,
          "state": "closed",
          "state_reason": "completed",
          "title": "block downloads timeout on slow connection even though downloading",
          "body": "With additional debugging (a7629d3490d18a64a5eb2e0e3e0f593190940f0e) we can see that timeouts occur even when the block is still being downloaded (i.e. many examples of download progressing within the last few seconds prior to being disconnected).\r\n\r\ndebug.log extract:-\r\n\r\n```\r\n2016-12-11 15:36:23.372866 block download timeout. nDownloadingSince=600s nLastRecv=2s nLastSend=40s sipa disconnect peer=38\r\n2016-12-12 13:06:12.458955 block download timeout. nDownloadingSince=900s nLastRecv=2s nLastSend=7s sipa disconnect peer=30\r\n2016-12-12 13:16:03.047371 block download timeout. nDownloadingSince=900s nLastRecv=160s nLastSend=552s sipa disconnect peer=38\r\n2016-12-12 13:16:12.656307 block download timeout. nDownloadingSince=600s nLastRecv=102s nLastSend=2s sipa disconnect peer=31\r\n```\r\n\r\nThe debug above is prior to me adding the LastRecvBlk variable, but tests so far show that the data being received is block data at time of disconnection. E.g. the 1200s timeout often disconnects peers currently providing blocks also. This does not imply that it takes >1200s to download a block, as obviously that would be too slow given the average 1MB of block data every 10 minutes, but what can often happen is that internet connections become temporarily slow (e.g. in shared places, such as hotels) and this can cause several blocks to be downloading concurrently, therefore many blocks taking > 1200s to download but still achieving an average download speed of more than 1MB per 10 minutes.\r\n\r\n#9213 and #9314 are related also",
          "user": {
            "login": "rebroad",
            "id": 1530283,
            "node_id": "MDQ6VXNlcjE1MzAyODM=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/rebroad",
            "html_url": "https://github.com/rebroad",
            "followers_url": "https://api.github.com/users/rebroad/followers",
            "following_url": "https://api.github.com/users/rebroad/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/rebroad/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/rebroad/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
            "organizations_url": "https://api.github.com/users/rebroad/orgs",
            "repos_url": "https://api.github.com/users/rebroad/repos",
            "events_url": "https://api.github.com/users/rebroad/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/rebroad/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 1,
          "closed_at": "2022-08-04T09:24:01Z",
          "created_at": "2016-12-13T03:48:16Z",
          "updated_at": "2022-08-04T09:24:01Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "closed",
      "id": 1282875857,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTI4Mjg3NTg1Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1282875857",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-10-07T14:36:43Z"
    },
    {
      "event": "locked",
      "id": 5272064040,
      "node_id": "LOE_lADOABII584Lm6USzwAAAAE6PVAo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5272064040",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:43:48Z",
      "lock_reason": "resolved"
    }
  ]
}