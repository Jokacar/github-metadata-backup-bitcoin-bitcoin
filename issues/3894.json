{
  "type": "issue",
  "issue": {
    "id": 29667528,
    "node_id": "MDU6SXNzdWUyOTY2NzUyOA==",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3894",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3894/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3894/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3894/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/3894",
    "number": 3894,
    "state": "closed",
    "state_reason": "completed",
    "title": "zapwallettxes problem and wallet DB ordering",
    "body": "Most of the issue seems to be because of CWalletDB::ReorderTransactions. After applying zapwallettxes, I noticed that listtransactions was no longer listing new transactions. After further investigation, new tx records were being given a low nOrderPos number while old acentry records were high enough that they were being ordered at the end of listtransactions all the time. My theory is that after the malleability attacks, the wallet DB got filled with dead transactions that were removed by zapwallettxes, then somehow ReorderTransactions got invoked and reset nOrderPosNext. This left the acentry records with high nOrderPos and the new transactions being added near the beginning.\n\nI believe this is due to two issues:\n1. ReorderTransactions only collects the acentry records from \"\":\n   \n   ListAccountCreditDebit(\"\", acentries);\n   \n   which should probably be:\n   \n   ListAccountCreditDebit(\"*\", acentries);\n2. ReorderTransactions seems to try too hard to maintain previous ordering and likely fails. Or at least it did after I applied the fix above. Would it not be better to just reorder the records with:\n   \n   for (TxItems::iterator it = txByTime.begin(); it != txByTime.end(); ++it)\n   {\n       CWalletTx _const pwtx = (_it).second.first;\n       CAccountingEntry _const pacentry = (_it).second.second;\n       int64_t& nOrderPos = (pwtx != 0) ? pwtx->nOrderPos : pacentry->nOrderPos;\n   \n   ```\n   nOrderPos = ++nOrderPosNext;\n   if (pwtx)\n   {\n       if (!WriteTx(pwtx->GetHash(), *pwtx))\n         return DB_LOAD_FAIL;\n   }\n   else\n       if (!WriteAccountingEntry(pacentry->nEntryNo, *pacentry))\n         return DB_LOAD_FAIL;\n   ```\n   \n   }\n   \n   if (!WriteOrderPosNext(nOrderPosNext))\n       return DB_LOAD_FAIL;\n   \n   Perhaps I'm missing something here but this seems to be a better solution given the simplicity of the ordering system.\n\nUnsurprisingly, applying the two fixes (and hacking one entry to an nOrderPos of -1 to trigger ReorderTransactions) corrects the ordering in my wallet DB. Or at least I think it does. Does anyone know why this might be a bad idea? I'm new to the code and would like to know if I'm potentially breaking something else.\n",
    "user": {
      "login": "trav-j",
      "id": 6989944,
      "node_id": "MDQ6VXNlcjY5ODk5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6989944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/trav-j",
      "html_url": "https://github.com/trav-j",
      "followers_url": "https://api.github.com/users/trav-j/followers",
      "following_url": "https://api.github.com/users/trav-j/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/trav-j/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/trav-j/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/trav-j/subscriptions",
      "organizations_url": "https://api.github.com/users/trav-j/orgs",
      "repos_url": "https://api.github.com/users/trav-j/repos",
      "events_url": "https://api.github.com/users/trav-j/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/trav-j/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 1,
    "closed_at": "2014-09-25T10:26:00Z",
    "created_at": "2014-03-18T17:43:36Z",
    "updated_at": "2021-09-08T12:42:26Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 120436781,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDEyMDQzNjc4MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/120436781",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-05-13T06:54:17Z",
      "label": {
        "name": "Wallet",
        "color": "02d7e1"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "cozz",
        "id": 2814559,
        "node_id": "MDQ6VXNlcjI4MTQ1NTk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2814559?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cozz",
        "html_url": "https://github.com/cozz",
        "followers_url": "https://api.github.com/users/cozz/followers",
        "following_url": "https://api.github.com/users/cozz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/cozz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/cozz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/cozz/subscriptions",
        "organizations_url": "https://api.github.com/users/cozz/orgs",
        "repos_url": "https://api.github.com/users/cozz/repos",
        "events_url": "https://api.github.com/users/cozz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/cozz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-08-13T17:16:28Z",
      "updated_at": "2014-08-13T17:16:28Z",
      "source": {
        "issue": {
          "id": 40177101,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MTk3Mzg1MTI=",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4697",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4697/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4697/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/4697/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/4697",
          "number": 4697,
          "state": "closed",
          "state_reason": null,
          "title": "[Wallet] Improve ReorderTransactions(..)",
          "body": "ReorderTransactions is never called, unless someone would load a very old wallet. I couldnt even trigger ReorderTransactions by experimenting with zapwallettxs. And if it gets triggered somehow, it causes problems, see #3894. The function doesnt even write back txs to disk, if they have nOrderPos == -1, looks like a bug to me.\n\nThe worst thing that could happen, is that some txs/entries have nOrderPos = -1. But I dont see any problems with this, even if happen. At least those old transactions would always appear behind new ones.\n",
          "user": {
            "login": "cozz",
            "id": 2814559,
            "node_id": "MDQ6VXNlcjI4MTQ1NTk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2814559?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/cozz",
            "html_url": "https://github.com/cozz",
            "followers_url": "https://api.github.com/users/cozz/followers",
            "following_url": "https://api.github.com/users/cozz/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/cozz/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/cozz/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/cozz/subscriptions",
            "organizations_url": "https://api.github.com/users/cozz/orgs",
            "repos_url": "https://api.github.com/users/cozz/repos",
            "events_url": "https://api.github.com/users/cozz/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/cozz/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 13,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/4697",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/4697",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/4697.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/4697.patch"
          },
          "closed_at": "2014-09-08T09:07:09Z",
          "created_at": "2014-08-13T17:16:28Z",
          "updated_at": "2021-09-08T10:40:50Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 56800388,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU2ODAwMzg4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56800388",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-09-25T10:26:00Z",
      "updated_at": "2014-09-25T10:26:00Z",
      "author_association": "MEMBER",
      "body": "Fixed by #4697\n",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/3894#issuecomment-56800388",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/3894"
    },
    {
      "event": "closed",
      "id": 170088944,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTcwMDg4OTQ0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/170088944",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2014-09-25T10:26:00Z"
    },
    {
      "event": "locked",
      "id": 5272056234,
      "node_id": "LOE_lADOABII584BxLDIzwAAAAE6PTGq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5272056234",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T12:42:26Z",
      "lock_reason": "resolved"
    }
  ]
}