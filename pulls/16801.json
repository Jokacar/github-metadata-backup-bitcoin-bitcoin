{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801",
    "id": 313886169,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MzEzODg2MTY5",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/16801",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/16801.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/16801.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/54ada87348dbaa963490547b342ce57b4249987e",
    "number": 16801,
    "state": "closed",
    "locked": true,
    "maintainer_can_modify": false,
    "title": "faster & less memory for sync: bulk pool allocator for node based containers",
    "user": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is a custom allocator for node based containers, as described in https://github.com/bitcoin/bitcoin/pull/16718#issuecomment-525878177. Hopefully, this is a less controversial change and easier to review than https://github.com/bitcoin/bitcoin/pull/16718.\r\n\r\nThe allocator retains memory of nodes, and allocates them in bulk. In my benchmarks, using this pool allocator for `CCoinsMap` gives about 16% faster `-reindex-chainstate`, and decreases memory usage by ~8%. The allocator is potentially useful for all node-based containers like `std::list`, `std::map`, `std::unordered_map`, etc. I believe this is especially useful on systems where malloc() and free() are relatively expensive operations, since this allocator will dramatically reduce these calls.\r\n\r\nSome noteworthy properties about this allocator:\r\n\r\n* It relies on the fact that node based containers allocate nodes one at a time. If a container doesn't behave like this, the allocator will still work but won't be any faster.\r\n\r\n* The allocator determines the size of the nodes, which will then be used throughout the pool, by the first call to allocate(1). So if the container would not allocate something with the size of a node in its first call to allocate(1), the pool won't be usable for nodes since it was set up with a different size. With C++17 it would be possible to use a containers type `node_type` to correctly initialize the pool's size, but for now we have to rely on this heuristic.\r\n\r\n* Copying / moving / swapping a map propagates the allocator. So if two different pools are used for two containers a and b, calling `a = b` will from now on use b's pool in a.\r\n\r\n* The pool is not threadsafe. Two containers which use the same pool in different threads won't work.\r\n\r\n* A pool's memory is only actually destroyed in the pool's destructor.\r\n\r\nI've added a benchmark to compare std::map, std::unordered_map with and without the pool allocator for the `CCoinsMap`. ",
    "labels": [
      {
        "id": 64584,
        "node_id": "MDU6TGFiZWw2NDU4NA==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
        "name": "Brainstorming",
        "color": "ebd775",
        "default": false
      },
      {
        "id": 241832923,
        "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
        "name": "Utils/log/libs",
        "description": "",
        "color": "5319e7",
        "default": false
      },
      {
        "id": 1392286103,
        "node_id": "MDU6TGFiZWwxMzkyMjg2MTAz",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review",
        "name": "Needs Conceptual Review",
        "description": "",
        "color": "fef2c0",
        "default": false
      }
    ],
    "active_lock_reason": "resolved",
    "created_at": "2019-09-04T06:51:53Z",
    "updated_at": "2022-08-16T17:26:54Z",
    "closed_at": "2019-11-19T07:24:34Z",
    "mergeable_state": "unknown",
    "merge_commit_sha": "8908c97e4f437fc3617d6e0488d1b70f2a875bec",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "martinus:2019-08-bulkpoolallocator",
      "ref": "2019-08-bulkpoolallocator",
      "sha": "54ada87348dbaa963490547b342ce57b4249987e",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 107273866,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMDcyNzM4NjY=",
        "name": "bitcoin",
        "full_name": "martinus/bitcoin",
        "owner": {
          "login": "martinus",
          "id": 14386,
          "node_id": "MDQ6VXNlcjE0Mzg2",
          "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/martinus",
          "html_url": "https://github.com/martinus",
          "followers_url": "https://api.github.com/users/martinus/followers",
          "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
          "organizations_url": "https://api.github.com/users/martinus/orgs",
          "repos_url": "https://api.github.com/users/martinus/repos",
          "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/martinus/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/martinus/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/martinus/bitcoin",
        "archive_url": "https://api.github.com/repos/martinus/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/martinus/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/martinus/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/martinus/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/martinus/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/martinus/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/martinus/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/martinus/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/martinus/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/martinus/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/martinus/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/martinus/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/martinus/bitcoin/events",
        "forks_url": "https://api.github.com/repos/martinus/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/martinus/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/martinus/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/martinus/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/martinus/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/martinus/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/martinus/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/martinus/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/martinus/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/martinus/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/martinus/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/martinus/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/martinus/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/martinus/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/martinus/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/martinus/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:martinus/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/martinus/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/martinus/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/martinus/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/martinus/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/martinus/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/martinus/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/martinus/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/martinus/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/martinus/bitcoin/hooks",
        "svn_url": "https://github.com/martinus/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 3,
        "watchers_count": 3,
        "size": 233954,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-02T18:04:31Z",
        "created_at": "2017-10-17T13:40:13Z",
        "updated_at": "2023-07-11T15:23:38Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "222b7d0ca795c7306cd2103473c1c54c60e701f9",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35475,
        "stargazers_count": 70608,
        "watchers_count": 70608,
        "size": 236222,
        "default_branch": "master",
        "open_issues_count": 672,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-02T19:06:37Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-08-02T18:21:18Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 558,
    "deletions": 7,
    "changed_files": 10,
    "commits": 1,
    "review_comments": 12,
    "comments": 21
  },
  "events": [
    {
      "event": "labeled",
      "id": 2605892001,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDI2MDU4OTIwMDE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2605892001",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T06:53:17Z",
      "label": {
        "name": "Utils/log/libs",
        "color": "5319e7"
      }
    },
    {
      "event": "commented",
      "id": 527784726,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUyNzc4NDcyNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527784726",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T07:45:49Z",
      "updated_at": "2019-11-15T05:44:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-527784726",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "labeled",
      "id": 2606393466,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDI2MDYzOTM0NjY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2606393466",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T09:51:08Z",
      "label": {
        "name": "Brainstorming",
        "color": "ebd775"
      }
    },
    {
      "event": "labeled",
      "id": 2606393470,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDI2MDYzOTM0NzA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2606393470",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T09:51:08Z",
      "label": {
        "name": "Needs Conceptual Review",
        "color": "fef2c0"
      }
    },
    {
      "event": "commented",
      "id": 527859568,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUyNzg1OTU2OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527859568",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T11:26:27Z",
      "updated_at": "2019-09-04T11:26:27Z",
      "author_association": "MEMBER",
      "body": "re-run ci",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-527859568",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "closed",
      "id": 2606648083,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjYwNjY0ODA4Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2606648083",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T11:26:27Z"
    },
    {
      "event": "reopened",
      "id": 2606648256,
      "node_id": "MDEzOlJlb3BlbmVkRXZlbnQyNjA2NjQ4MjU2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2606648256",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T11:26:31Z"
    },
    {
      "event": "commented",
      "id": 527910427,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUyNzkxMDQyNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527910427",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-04T13:52:18Z",
      "updated_at": "2019-09-04T13:52:18Z",
      "author_association": "MEMBER",
      "body": "Concept ACK. Thanks for working on this. I did a cursory skim over the code and it looks very readable. The tests are nice too.\r\n\r\nI'll do a more thorough review and some benchmark runs in the next few days. ",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-527910427",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "renamed",
      "id": 2611355543,
      "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50MjYxMTM1NTU0Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2611355543",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-05T16:25:08Z",
      "rename": {
        "from": "bulk pool allocator for node based containers",
        "to": "faster & less memory for sync: bulk pool allocator for node based containers"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 2611430073,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MjYxMTQzMDA3Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2611430073",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-05T16:49:21Z"
    },
    {
      "event": "closed",
      "id": 2612145235,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjYxMjE0NTIzNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2612145235",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-05T20:13:29Z"
    },
    {
      "event": "reopened",
      "id": 2612145752,
      "node_id": "MDEzOlJlb3BlbmVkRXZlbnQyNjEyMTQ1NzUy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2612145752",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-05T20:13:40Z"
    },
    {
      "event": "reviewed",
      "id": 285166006,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mjg1MTY2MDA2",
      "url": null,
      "actor": null,
      "commit_id": "ad55a26725b015f00f99d99048e992e637aaebf4",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "",
      "user": {
        "login": "practicalswift",
        "id": 7826565,
        "node_id": "MDQ6VXNlcjc4MjY1NjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7826565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/practicalswift",
        "html_url": "https://github.com/practicalswift",
        "followers_url": "https://api.github.com/users/practicalswift/followers",
        "following_url": "https://api.github.com/users/practicalswift/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/practicalswift/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/practicalswift/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
        "organizations_url": "https://api.github.com/users/practicalswift/orgs",
        "repos_url": "https://api.github.com/users/practicalswift/repos",
        "events_url": "https://api.github.com/users/practicalswift/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/practicalswift/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#pullrequestreview-285166006",
      "submitted_at": "2019-09-07T11:18:26Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
    },
    {
      "event": "commented",
      "id": 530510425,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDUxMDQyNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530510425",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-11T18:37:21Z",
      "updated_at": "2019-09-11T18:39:06Z",
      "author_association": "CONTRIBUTOR",
      "body": "Here is a graph of another comparison run of the indexing progress over time that I get on my machine (Intel i7-8700 @ 3.20GHz, 32GB of RAM)\r\n\r\n![out](https://user-images.githubusercontent.com/14386/64724584-09da4c00-d4d3-11e9-8888-6586ad5829ba.png)\r\n\r\n* 3432sec for 2019-08-bulkpoolallocator, 4135 sec for master.\r\n* 6.973.488 kbyte max RSS for 2019-08-bulkpoolallocator, 7.643.956 kbyte for master.\r\n\r\nThe straight lines where no progress is made are when the cache is full and then dumped into the leveldb database.\r\n",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-530510425",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 530874101,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDg3NDEwMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530874101",
      "actor": {
        "login": "ktprime",
        "id": 1461362,
        "node_id": "MDQ6VXNlcjE0NjEzNjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1461362?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ktprime",
        "html_url": "https://github.com/ktprime",
        "followers_url": "https://api.github.com/users/ktprime/followers",
        "following_url": "https://api.github.com/users/ktprime/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ktprime/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ktprime/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ktprime/subscriptions",
        "organizations_url": "https://api.github.com/users/ktprime/orgs",
        "repos_url": "https://api.github.com/users/ktprime/repos",
        "events_url": "https://api.github.com/users/ktprime/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ktprime/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-12T15:16:45Z",
      "updated_at": "2019-09-12T15:16:45Z",
      "author_association": "NONE",
      "body": "I want to how to migrate your good bulk pool to my project.",
      "user": {
        "login": "ktprime",
        "id": 1461362,
        "node_id": "MDQ6VXNlcjE0NjEzNjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1461362?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ktprime",
        "html_url": "https://github.com/ktprime",
        "followers_url": "https://api.github.com/users/ktprime/followers",
        "following_url": "https://api.github.com/users/ktprime/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ktprime/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ktprime/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ktprime/subscriptions",
        "organizations_url": "https://api.github.com/users/ktprime/orgs",
        "repos_url": "https://api.github.com/users/ktprime/repos",
        "events_url": "https://api.github.com/users/ktprime/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ktprime/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-530874101",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 530913306,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDkxMzMwNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/530913306",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-12T16:55:26Z",
      "updated_at": "2019-09-12T17:07:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I want to how to migrate your good bulk pool to my project.\r\n\r\nFeel free to copy the bulk_pool.h to your project. It's under the MIT license. I might extract the file into a standalone project with more benchmarks, but thats not high on my priority list.\r\n\r\nI am interested though in any improvements you see with this allocator!",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-530913306",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 531607115,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTYwNzExNQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531607115",
      "actor": {
        "login": "promag",
        "id": 3534524,
        "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/promag",
        "html_url": "https://github.com/promag",
        "followers_url": "https://api.github.com/users/promag/followers",
        "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
        "organizations_url": "https://api.github.com/users/promag/orgs",
        "repos_url": "https://api.github.com/users/promag/repos",
        "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/promag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-15T23:05:13Z",
      "updated_at": "2019-09-15T23:05:13Z",
      "author_association": "MEMBER",
      "body": "Looks like the improvement grows over time/progress? Have you checked with a greater `-stopatheight`?",
      "user": {
        "login": "promag",
        "id": 3534524,
        "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/promag",
        "html_url": "https://github.com/promag",
        "followers_url": "https://api.github.com/users/promag/followers",
        "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
        "organizations_url": "https://api.github.com/users/promag/orgs",
        "repos_url": "https://api.github.com/users/promag/repos",
        "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/promag/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-531607115",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 531645046,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzMTY0NTA0Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/531645046",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-16T05:25:30Z",
      "updated_at": "2019-09-16T05:25:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "I've also made a graph with `-stopatheight 594000`: ![out](https://user-images.githubusercontent.com/14386/64935718-fd4b5000-d852-11e9-8c3c-44d0b1171560.png)\r\n",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-531645046",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-26T17:48:57Z",
      "updated_at": "2019-09-26T17:48:57Z",
      "source": {
        "issue": {
          "id": 499028021,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MzIxODM1NzMw",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16970",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16970/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16970/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16970/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/16970",
          "number": 16970,
          "state": "closed",
          "state_reason": null,
          "title": "6% faster, 6% less memory: more tightly pack CCoinMap::value_type",
          "body": "This change reduces `CCoinMap::value_type` from 96 bytes to 80 bytes by more tightly packing it's data. This allows to cache a lot more transactions in the cache. I've achieved this with these changes:\r\n\r\n* Refactored `prevector` so it uses a single byte to determine its size when in direct mode\r\n* Reduce `CScriptBase` from 28 to 27 indirect bytes\r\n* align `CTxOut` to 4 bytes to prevent padding when used as a member in `Coin`\r\n\r\nThis tighter packing means more data can be stored in the `coinsCache` before it is full and has to be flushed to disk. In my benchmark, `-reindex-chainstate` was 6% faster and used 6% less memory. The cache could fit 14% more txo's before it had to resize.\r\n\r\nSome numbers: \r\n\r\n|                                       | runtime h:mm:ss | max RSS kbyte |\r\n|---------------------------------------|-----------------|--------------|\r\n| master  -dbcache=5000                                |         4:13:59 |      7696728 |\r\n| 2019-09-more-compact-Coin  -dbcache=5000 |         3:57:59 |      7192772 |\r\n| change                                |          -6.30% |       -6.55% |\r\n\r\nThe graph shows nicely that the cache is able to be used a lot longer before it is full and flushed to the disk:\r\n![out](https://user-images.githubusercontent.com/14386/65710655-bbf94280-e093-11e9-820a-067e8c5c143b.png)\r\n\r\nI've tried this change in combination with #16957 to not cache hash), and then additionally in combination with #16801 :\r\n\r\n|                                       | runtime h:mm:ss | max RSS kbyte |\r\n|---------------------------------------|-----------------|--------------|\r\n| master  -dbcache=5000                                |         4:13:59 |      7696728 |\r\n| 2019-09-more-compact-Coin  -dbcache=5000 |         3:57:59 |      7192772 |\r\n| 2019-09-more-compact-Coin & #16957 -dbcache=5500 |         3:51:04 |      6600548 |\r\n| 2019-09-more-compact-Coin & #16957 & #16801 -dbcache=5500 | 3:38:44 | 6164380 |\r\n\r\n![out](https://user-images.githubusercontent.com/14386/65711422-278fdf80-e095-11e9-8095-faca6dc1edc2.png)\r\n\r\nWith all 3 PR's applied, reindex was 14% faster and used 20% less memory",
          "user": {
            "login": "martinus",
            "id": 14386,
            "node_id": "MDQ6VXNlcjE0Mzg2",
            "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/martinus",
            "html_url": "https://github.com/martinus",
            "followers_url": "https://api.github.com/users/martinus/followers",
            "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
            "organizations_url": "https://api.github.com/users/martinus/orgs",
            "repos_url": "https://api.github.com/users/martinus/repos",
            "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/martinus/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            },
            {
              "id": 326918230,
              "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
              "name": "Resource usage",
              "color": "981023",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 1,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16970",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/16970",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/16970.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/16970.patch"
          },
          "closed_at": "2019-09-27T06:25:18Z",
          "created_at": "2019-09-26T17:48:57Z",
          "updated_at": "2021-12-16T14:10:21Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 535969850,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzNTk2OTg1MA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/535969850",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-27T14:44:01Z",
      "updated_at": "2019-09-27T14:44:01Z",
      "author_association": "MEMBER",
      "body": "After running benchmarks across a few different machines, I'm pretty confused.\r\n\r\nThe raw results are below, but the headline is that I'm consistently seeing branches using this allocator outperform master but also *vice versa* depending upon the host. It's about half and half, and when master wins it's by a pretty dramatic margin.\r\n\r\nE.g. master is reliably faster than this branch and #16718 on bench-ssd-2, bench-ssd-5, and bench-hdd-5 (except for one weird run where master took 41 hours??). On all other hosts (ssd-3, ssd-4, hdd-4), these branches beat master consistently.\r\n\r\nThis is very confusing to me because AFAICT -reindex-chainstate should be a deterministic process - i.e. I'd expect the same logical execution for a given height on mainnet regardless of host. I guess maybe blockfile layouts can differ, but would that really be responsible for so dramatic a difference?\r\n\r\nBefore anyone asks: these are dedicated benchmarking machines (specs listed below). Before each run I'm dropping all caches (`sudo /sbin/swapoff -a; sudo /sbin/sysctl vm.drop_caches=3;`), tuning with pyperf (`sudo /usr/local/bin/pyperf system tune;`), and I've ensured that the CPU governors are set to `performance`.\r\n\r\n```\r\nHostname:              bench-ssd-2\r\nKernel:                Linux 4.9.0-8-amd64\r\nOS:                    Debian GNU/Linux 9\r\nRAM (GB):              7.71\r\nArchitecture:          x86_64\r\nCPU(s):                4\r\nThread(s) per core:    1\r\nCore(s) per socket:    4\r\nModel name:            Intel(R) Xeon(R) CPU E3-1220 v5 @ 3.00GHz\r\n```\r\n\r\n```\r\n-reindex-chainstate to 550,000 (dbcache 4000,4000,5000)\r\n\r\n\r\nhostname     branch                               runtime   peak mem  cpu%\r\n--------     ------                               -------   --------  ----\r\n\r\nbench-ssd-2  jamesob/2019-08-robinhood            8:44:15   5268.90MB 356%\r\n                                                  8:44:08   5279.89MB 356%\r\n                                                  8:54:16   6209.94MB 350%\r\n\r\n             master                               3:56:18   6257.37MB 211%\r\n                                                  3:52:25   6322.87MB 215%\r\n                                                  6:09:23   7184.23MB 138%\r\n\r\n             martinus/2019-08-bulkpoolallocator   8:57:44   5680.03MB 349%\r\n                                                  8:57:50   5710.53MB 349%\r\n                                                  9:19:26   6634.91MB 336%\r\n\r\nbench-ssd-3  jamesob/2019-08-robinhood            1:53:11   5288.62MB 88%\r\n                                                  1:56:02   5300.98MB 87%\r\n                                                  2:28:13   6289.06MB 71%\r\n\r\n             martinus/2019-08-bulkpoolallocator   2:14:50   5703.27MB 83%\r\n                                                  2:11:09   5709.48MB 85%\r\n                                                  3:28:15   6747.18MB 56%\r\n\r\n             master                               2:35:11   6272.42MB 88%\r\n                                                  2:32:48   6341.90MB 89%\r\n                                                  5:31:51   7212.80MB 45%\r\n\r\nbench-ssd-4  master                               2:54:59   6268.15MB 79%\r\n                                                  2:35:52   6277.92MB 88%\r\n                                                  5:14:52   7155.87MB 47%\r\n\r\n             jamesob/2019-08-robinhood            1:57:07   5269.11MB 85%\r\n                                                  1:53:59   5351.89MB 88%\r\n                                                  2:28:55   6312.53MB 71%\r\n\r\n             martinus/2019-08-bulkpoolallocator   2:12:36   5715.95MB 84%\r\n                                                  2:09:30   5668.43MB 86%\r\n                                                  3:18:38   6707.09MB 59%\r\n\r\nbench-ssd-5  master                               3:58:37   6263.33MB 210%\r\n                                                  3:40:44   6214.23MB 226%\r\n                                                  5:37:39   7109.82MB 151%\r\n\r\n             martinus/2019-08-bulkpoolallocator   8:53:29   5710.38MB 352%\r\n                                                  8:47:41   5692.83MB 356%\r\n                                                  9:25:06   6553.30MB 333%\r\n\r\n             jamesob/2019-08-robinhood            8:41:53   5294.47MB 357%\r\n                                                  8:36:57   5331.02MB 360%\r\n                                                  8:53:55   6176.95MB 350%\r\n\r\nbench-hdd-4  martinus/2019-08-bulkpoolallocator   3:50:01   5729.15MB 49%\r\n                                                  3:53:44   5793.15MB 47%\r\n                                                  17:20:06  6741.35MB 11%\r\n\r\n             jamesob/2019-08-robinhood            2:55:47   5310.89MB 57%\r\n                                                  2:54:19   5306.11MB 57%\r\n                                                  9:04:22   6220.20MB 19%\r\n\r\n             master                               10:11:25  6257.50MB 23%\r\n                                                  5:25:15   6256.57MB 42%\r\n                                                  40:32:45  7123.75MB 6%\r\n\r\nbench-hdd-5  martinus/2019-08-bulkpoolallocator   10:04:43  5703.16MB 310%\r\n                                                  10:03:57  5775.29MB 311%\r\n                                                  24:04:41  6728.74MB 130%\r\n\r\n             master                               8:05:00   6248.24MB 103%\r\n                                                  6:08:48   6250.89MB 135%\r\n                                                  41:39:38  7152.32MB 20%\r\n\r\n             jamesob/2019-08-robinhood            9:25:51   5295.75MB 329%\r\n                                                  9:24:18   5297.03MB 330%\r\n                                                  13:15:56  6134.24MB 235%\r\n\r\n```\r\n\r\nI'm wondering if this allocator is behaving pathologically based upon some different initial condition across the hosts, but for now I'm pretty stumped. In the coming weeks I'll work on tooling that will allow me to get a more precise idea of where time is being spent and will roll all that into [bitcoinperf](https://github.com/chaincodelabs/bitcoinperf).",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-535969850",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 536172801,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzNjE3MjgwMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/536172801",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-09-28T10:14:03Z",
      "updated_at": "2019-09-28T10:14:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "It's really strange that the difference is so dramatic. Do you have the debug.log files, or some graphs with the progresss? It would be interesting to see where it's slowing down: e.g. if it's in the DB sync, or continuously, or right *before* a sync.\r\n\r\nI think since your host only has 7.7GB memory the slowdown might come from the host swapping. Maybe the problem is the way bitcoin is handling the cache: As transactions are added to the cache, it slowly gets full.\r\nWith some bad luck / bad configuration, the hashmap's load factor can get full close to the actual dbcache limit. If it has to double it's size right at that time, it will temporarily need a lot more memory than the dbcache, has to rehash, and once this costly operation is done, it will be over the dbcache limit, and the cache is dumped and thrown away. \r\n\r\nSo in that case it would be a much better logic to flush the cache once the load factor reaches maximum, and when another insert would bump it over the limit.",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-536172801",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 2689407942,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50MjY4OTQwNzk0Mg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2689407942",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-05T16:55:14Z"
    },
    {
      "event": "commented",
      "id": 538669067,
      "node_id": "MDEyOklzc3VlQ29tbWVudDUzODY2OTA2Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538669067",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-05T17:08:33Z",
      "updated_at": "2019-10-05T17:08:33Z",
      "author_association": "CONTRIBUTOR",
      "body": "rebased & squashed in 329754d4c33656b0d526aa456077f4667c6ecb11",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-538669067",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "GChuf",
        "id": 42591821,
        "node_id": "MDQ6VXNlcjQyNTkxODIx",
        "avatar_url": "https://avatars.githubusercontent.com/u/42591821?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GChuf",
        "html_url": "https://github.com/GChuf",
        "followers_url": "https://api.github.com/users/GChuf/followers",
        "following_url": "https://api.github.com/users/GChuf/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GChuf/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GChuf/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GChuf/subscriptions",
        "organizations_url": "https://api.github.com/users/GChuf/orgs",
        "repos_url": "https://api.github.com/users/GChuf/repos",
        "events_url": "https://api.github.com/users/GChuf/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GChuf/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-19T15:55:09Z",
      "updated_at": "2019-10-19T15:55:09Z",
      "source": {
        "issue": {
          "id": 502949810,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MzI0OTMwNDYz",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17060",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17060/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17060/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17060/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/17060",
          "number": 17060,
          "state": "closed",
          "state_reason": null,
          "title": "Cache 26% more coins: Reduce CCoinsMap::value_type from 96 to 76 bytes",
          "body": "This is an attempt to more tightly pack the data inside `CCoinsMap`. (replaces #16970, done after my investigations on #16957) Currently, there is quite a bit of overhead involved in the `CCoinsMap::value_type` data structure (total bytes to the left):\r\n\r\n```\r\n96 CCoinsMap::value_type\r\n    36 COutPoint\r\n        32 uint256\r\n         4 uint32_t\r\n     4 >>> PADDING <<<\r\n    56 CCoinsCacheEntry\r\n        48 Coin\r\n            40 CTxOut\r\n                8 nValue\r\n                32 CScript\r\n             4 fCoinBase & nHeight\r\n             4 >>> PADDING <<<\r\n         1 flags (dirty & fresh)\r\n         7 >>> PADDING <<< \r\n```\r\n\r\nSo there is quite a bit of padding data. In my experiements I've noticed that the compiler is forced to use a padding size >=8 only because `nValue`'s `CAmount` type is `int64_t` which has to be 8-byte aligned. When replacing nValue with a 4-byte aligned data structure, the whole `CCoinsMap::value_type` will be aligned to 4 bytes, reducing padding.\r\n\r\nAnother 4 bytes can be saved by refactoring `prevector` to only use a single byte for direct size information, and reducing CScript's size from 28  to 27 bytes. It is still able to directly cache most scripts as most are <= 25 bytes long.\r\n\r\nThe remaining 4 bytes due to the 1 byte flag + 3 bytes padding in `CCoinsCacheEntry` can be removed by moving the flags into `Coin`, stealing another 2 bits from `nHeight`. \r\n\r\nFinally, the resulting data structure is 20 bytes smaller:\r\n\r\n```\r\n76 CCoinsMap::value_type\r\n    36 COutPoint\r\n        32 uint256\r\n         4 uint32_t\r\n    40 CCoinsCacheEntry\r\n        40 Coin\r\n            36 CTxOut\r\n                 8 nValue\r\n                28 CScript\r\n            4 fCoinBase & nHeight & flags (dirty & fresh)\r\n```\r\n\r\nSo we can store about 26% more data into dbcache's memory. I have evalued this on my Intel i7-8700, 32GB RAM, external SSD, for `-reindex-chainstate` with both `-dbcache=500` and `-dbcache=5000`:\r\n\r\n![out2](https://user-images.githubusercontent.com/14386/66253968-18352400-e770-11e9-9cf3-7ca5b5099054.png)\r\n\r\n  |   | time | max resident set size\r\n-- | -- | -- | --\r\nmaster | -dbcache=500 | 05:57:20 | 2957532\r\n2019-09-more-compact-Coin | -dbcache=500 | 05:33:37 | 2919312\r\nImprovement |   | 6,64% | 1,29%\r\n\r\n\r\n  |   | time | max resident set size\r\n-- | -- | -- | --\r\nmaster | -dbcache=5000 | 04:22:42 | 7072612\r\n2019-09-more-compact-Coin | -dbcache=5000 | 04:09:16 | 6533132\r\nImprovement |   | 5,11% | 7,63%\r\n\r\nSo on my machine there is definitive an improvement, but honestly I am not sure if this ~6% improvement is worth the change. Maybe the improvement is bigger with slower disk, as ~26% more transaction can be cached.",
          "user": {
            "login": "martinus",
            "id": 14386,
            "node_id": "MDQ6VXNlcjE0Mzg2",
            "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/martinus",
            "html_url": "https://github.com/martinus",
            "followers_url": "https://api.github.com/users/martinus/followers",
            "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
            "organizations_url": "https://api.github.com/users/martinus/orgs",
            "repos_url": "https://api.github.com/users/martinus/repos",
            "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/martinus/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 97470796,
              "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
              "name": "UTXO Db and Indexes",
              "color": "fbca04",
              "default": false
            },
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            },
            {
              "id": 326918230,
              "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
              "name": "Resource usage",
              "color": "981023",
              "default": false
            },
            {
              "id": 955867938,
              "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
              "name": "Needs rebase",
              "description": "",
              "color": "cccccc",
              "default": false
            },
            {
              "id": 1392286103,
              "node_id": "MDU6TGFiZWwxMzkyMjg2MTAz",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review",
              "name": "Needs Conceptual Review",
              "description": "",
              "color": "fef2c0",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 47,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17060",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/17060",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/17060.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/17060.patch"
          },
          "closed_at": "2020-02-18T22:45:52Z",
          "created_at": "2019-10-05T11:07:11Z",
          "updated_at": "2022-02-15T10:58:01Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "GChuf",
        "id": 42591821,
        "node_id": "MDQ6VXNlcjQyNTkxODIx",
        "avatar_url": "https://avatars.githubusercontent.com/u/42591821?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/GChuf",
        "html_url": "https://github.com/GChuf",
        "followers_url": "https://api.github.com/users/GChuf/followers",
        "following_url": "https://api.github.com/users/GChuf/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/GChuf/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/GChuf/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/GChuf/subscriptions",
        "organizations_url": "https://api.github.com/users/GChuf/orgs",
        "repos_url": "https://api.github.com/users/GChuf/repos",
        "events_url": "https://api.github.com/users/GChuf/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/GChuf/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-20T11:47:30Z",
      "updated_at": "2019-10-20T11:47:30Z",
      "source": {
        "issue": {
          "id": 509583952,
          "node_id": "MDU6SXNzdWU1MDk1ODM5NTI=",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17200",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17200/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17200/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17200/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/17200",
          "number": 17200,
          "state": "closed",
          "state_reason": "completed",
          "title": "Increase default -dbcache",
          "body": "I've noticed the default `-dbcache` used to be 600MiB, but got lowered to 450 in March 2017: https://github.com/bitcoin/bitcoin/commit/f33afd3b2be1bcabeb10168a53835359c9ff4a3e\r\n\r\nWe know this negatively affects performance on initial sync (and reindexing) and the average user most likely doesn't know they should increase the dbcache to make the sync faster.\r\n\r\nI think it is safe to assume that the (advanced) users who have low amounts of RAM on their machines know about dbcache flag and how to use it appropriately. It would, therefore, be best to increase the default dbcache.\r\n\r\nI'm not sure about the other parameters in `txdb.h`, but the blockchain is getting bigger every day and our computers are getting more and more capable. I'd like to propose to increase the dbcache size to 600MiB or higher, and if applicable, change the other parameters appropriately.\r\n\r\nYou should also take a look at this [comment ](https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-536713463) and the PR which decreased the memory usage by 9% - so bumping the dbcache to at least 500 would be more than appropriate. Another PR by @martinus which also decreases mem usage: https://github.com/bitcoin/bitcoin/pull/16801",
          "user": {
            "login": "GChuf",
            "id": 42591821,
            "node_id": "MDQ6VXNlcjQyNTkxODIx",
            "avatar_url": "https://avatars.githubusercontent.com/u/42591821?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/GChuf",
            "html_url": "https://github.com/GChuf",
            "followers_url": "https://api.github.com/users/GChuf/followers",
            "following_url": "https://api.github.com/users/GChuf/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/GChuf/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/GChuf/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/GChuf/subscriptions",
            "organizations_url": "https://api.github.com/users/GChuf/orgs",
            "repos_url": "https://api.github.com/users/GChuf/repos",
            "events_url": "https://api.github.com/users/GChuf/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/GChuf/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 326918230,
              "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
              "name": "Resource usage",
              "color": "981023",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 2,
          "closed_at": "2020-04-26T17:18:41Z",
          "created_at": "2019-10-20T11:47:30Z",
          "updated_at": "2022-02-15T10:43:33Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-10-23T06:32:42Z",
      "updated_at": "2019-10-23T06:32:42Z",
      "source": {
        "issue": {
          "id": 484882513,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MzEwNjUzMDkx",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16718",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16718/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16718/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16718/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/16718",
          "number": 16718,
          "state": "closed",
          "state_reason": null,
          "title": "Improve speed, memory efficiency with alternate hashmap",
          "body": "**tl;dr**\r\n\r\nI try swapping out `std::unordered_map` for a faster third-party implementation where it matters, see something like 15% speedup for initial block download coincident with a 19.3% reduction in memory usage.\r\n\r\n---\r\n\r\nWhen profiling initial block download, it's evident that a decent chunk of time on the critical path is spent in `CCoinsViewCache`, the data structure responsible for the in-memory representation of the UTXO set.\r\n\r\n![Selection_147](https://user-images.githubusercontent.com/73197/63644597-9b1b8700-c6ba-11e9-964c-91c6fb78b3a2.png)\r\n*Profile of the `msghand` thread at height ~300,000.*\r\n\r\nThe essential data member of the cache, `cacheCoins`, is a `std::unordered_map` that holds as many UTXO as can fit into memory given the `dbcache` setting. While this map implementation is definitely preferable to `std::map` (which retains order and has O(log(n)) lookups insted of O(1)), both stdlib maps are subpar [relative to non-`std` alternatives](https://martin.ankerl.com/2019/04/01/hashmap-benchmarks-01-overview/).\r\n\r\nAfter seeing cacheCoins as a bottleneck, I decided to try swapping one of these alternative implementations in to see if there is any benefit. It looks like there is.\r\n\r\n![ibd local range 500000 520000](https://user-images.githubusercontent.com/73197/63644703-0a927600-c6bd-11e9-9e1d-2748b8fbdf8d.png)\r\n\r\nFor 20,000 blocks at a representative part of the chain, we see something like a 15% speedup with a 19.3% reduction in memory usage (dbcache was set to 3000).\r\n\r\nThe `CCoinsCaching` benchmark shows improvement but not as dramatically as IBD does:\r\n\r\n![microbenches](https://user-images.githubusercontent.com/73197/63644768-572a8100-c6be-11e9-922c-8360a9f9e3b4.png)\r\n\r\nObviously adding 2000 lines of new consensus-critical code isn't appealing, but if those numbers hold for the full IBD process I think there might be a compelling case to be made for the added code.\r\n\r\n### Implementations considered\r\n\r\nOf the few best-looking options, I picked the one with the most succinct implementation and fewest dependencies, [`robin_hood::unordered_node_map`](https://github.com/martinus/robin-hood-hashing) (it's just a header file). I also looked at Facebook's [`F14NodeMap`](https://github.com/facebook/folly/blob/master/folly/container/F14.md) and Abseil's [`node_hash_map`](https://abseil.io/docs/cpp/guides/container) but both required too much elbow-grease (for now) to integrate here without pulling in a whole lot of code.\r\n\r\n### Next steps\r\n\r\nI'm going to be running more comprehensive benchmarks, including a near-full IBD from the network, to see if these improvements hold.\r\n\r\nI'm also interested in benching this along with a similar change to `mapBlockIndex` (currently a `std::unordered_map`).\r\n\r\n### Questions\r\n\r\nIf we decide to include this or another hashmap implementation, should we do a full fork inclusion a la leveldb or should we try to slim down the implementation to a single header file as is done here (but more)?",
          "user": {
            "login": "jamesob",
            "id": 73197,
            "node_id": "MDQ6VXNlcjczMTk3",
            "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jamesob",
            "html_url": "https://github.com/jamesob",
            "followers_url": "https://api.github.com/users/jamesob/followers",
            "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
            "organizations_url": "https://api.github.com/users/jamesob/orgs",
            "repos_url": "https://api.github.com/users/jamesob/repos",
            "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/jamesob/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 326918230,
              "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
              "name": "Resource usage",
              "color": "981023",
              "default": false
            },
            {
              "id": 1392286103,
              "node_id": "MDU6TGFiZWwxMzkyMjg2MTAz",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review",
              "name": "Needs Conceptual Review",
              "description": "",
              "color": "fef2c0",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 43,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16718",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/16718",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/16718.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/16718.patch"
          },
          "closed_at": "2019-11-14T22:30:08Z",
          "created_at": "2019-08-25T02:30:51Z",
          "updated_at": "2021-12-16T14:54:59Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 310050091,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzEwMDUwMDkx",
      "url": null,
      "actor": null,
      "commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Skimmed code and looks pretty good. Just had two questions below.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#pullrequestreview-310050091",
      "submitted_at": "2019-10-31T17:50:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NGFkYTg3MzQ4ZGJhYTk2MzQ5MDU0N2IzNDJjZTU3YjQyNDk5ODdl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/54ada87348dbaa963490547b342ce57b4249987e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/54ada87348dbaa963490547b342ce57b4249987e",
      "tree": {
        "sha": "146974ed8a482ab543e3d300cc107d76de36c5b5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/146974ed8a482ab543e3d300cc107d76de36c5b5"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/222b7d0ca795c7306cd2103473c1c54c60e701f9",
          "sha": "222b7d0ca795c7306cd2103473c1c54c60e701f9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/222b7d0ca795c7306cd2103473c1c54c60e701f9"
        }
      ],
      "message": "Add bulk pool allocator for node based containers.\n\nIn my benchmarks, using this pool allocator for CCoinsMap gives about\n16% faster `-reindex-chainstate`, and decreases memory usage by 8%.\nThe allocator is potentially useful for all node-based containers like\n`std::list`, `std::map`, `std::unordered_map`.",
      "committer": {
        "name": "Martin Ankerl",
        "email": "martin.ankerl@gmail.com",
        "date": "2019-11-01T07:20:08Z"
      },
      "author": {
        "name": "Martin Ankerl",
        "email": "martin.ankerl@gmail.com",
        "date": "2019-08-30T17:59:57Z"
      },
      "sha": "54ada87348dbaa963490547b342ce57b4249987e"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 2762371812,
      "node_id": "MDIzOkhlYWRSZWZGb3JjZVB1c2hlZEV2ZW50Mjc2MjM3MTgxMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2762371812",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T07:20:45Z"
    },
    {
      "event": "reviewed",
      "id": 310502054,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzEwNTAyMDU0",
      "url": null,
      "actor": null,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#pullrequestreview-310502054",
      "submitted_at": "2019-11-01T14:54:44Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
    },
    {
      "event": "commented",
      "id": 548879236,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODg3OTIzNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548879236",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T17:32:02Z",
      "updated_at": "2019-11-01T17:33:44Z",
      "author_association": "CONTRIBUTOR",
      "body": "James walked me through the benchmarks, and I guess a summary is that the benchmarks do generally look good and show expected decreases in runtime and memory usage at varying dbcache sizes.\r\n\r\nThe problem is that in some benchmark setups, reindexing reliably but for no explicable reason takes a lot longer (9 hours vs 2 hours) on the bulk allocator and robinhood branches than it does on the master branch. That is, the robinhood and bulk allocator branches generally perform better in the ways we would expect, but on some particular benchmarking machines with particular datadirs, reindexing takes a *lot* longer when using bulk allocator and robinhood branches instead of the master branch.\r\n\r\nAlso, very strangely, copying the datadir from a benchmarking machine where reindexing with the bulk allocator branch was fast, to a benchmarking machine where reindexing with the bulk allocator branch was slow, somehow makes reindexing on that same machine fast as well. This is suspicious and probably indicates either a mistake made in benchmark setup, or the presence of a pre-existing pathological performance bug in bitcoin somehow triggered by changing the allocator. (But even that doesn't make much sense, because while it's possible to imagine the layout of block data in the datadir impacting reindex time, the actual block reads done during reindexing should be identical between the master and bulk allocator branches.)\r\n\r\nIt does seem like we need to debug the case where switching to the bulk allocator appears to cause reindexing slowdowns with particular datadirs, even though using the bulk allocator could only be causing these slowdowns very indirectly.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-548879236",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 548896153,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODg5NjE1Mw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548896153",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T18:17:30Z",
      "updated_at": "2019-11-01T18:17:30Z",
      "author_association": "MEMBER",
      "body": "Just as an update, I've got a plan for diagnosing the benching weirdness I've seen thus far. With any luck I'll be posting an analysis (or at least additional information) in the next few days.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-548896153",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "commented",
      "id": 548899136,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODg5OTEzNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548899136",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T18:25:58Z",
      "updated_at": "2019-11-01T18:25:58Z",
      "author_association": "CONTRIBUTOR",
      "body": "Is it possible that this weirdness can be explained by different assumedvalid points? Either in the branches, or on the disk. It was a surprise to me: https://github.com/bitcoin/bitcoin/pull/17060#issuecomment-547674256\r\n\r\nAs @MarcoFalke wrote in https://github.com/bitcoin/bitcoin/pull/17060#issuecomment-547687821, it is probably best to either use `-noassumevalid` or use the same block hash, and make sure that block is actually available on all disks\r\n\r\n",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-548899136",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "mentioned",
      "id": 2764089502,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50Mjc2NDA4OTUwMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2764089502",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T18:25:58Z"
    },
    {
      "event": "subscribed",
      "id": 2764089503,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3NjQwODk1MDM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2764089503",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-01T18:25:58Z"
    },
    {
      "event": "mentioned",
      "id": 2765192944,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50Mjc2NTE5Mjk0NA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2765192944",
      "actor": {
        "login": "JeremyRubin",
        "id": 886523,
        "node_id": "MDQ6VXNlcjg4NjUyMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JeremyRubin",
        "html_url": "https://github.com/JeremyRubin",
        "followers_url": "https://api.github.com/users/JeremyRubin/followers",
        "following_url": "https://api.github.com/users/JeremyRubin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/JeremyRubin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/JeremyRubin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
        "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
        "repos_url": "https://api.github.com/users/JeremyRubin/repos",
        "events_url": "https://api.github.com/users/JeremyRubin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-02T12:06:35Z"
    },
    {
      "event": "subscribed",
      "id": 2765192945,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3NjUxOTI5NDU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2765192945",
      "actor": {
        "login": "JeremyRubin",
        "id": 886523,
        "node_id": "MDQ6VXNlcjg4NjUyMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JeremyRubin",
        "html_url": "https://github.com/JeremyRubin",
        "followers_url": "https://api.github.com/users/JeremyRubin/followers",
        "following_url": "https://api.github.com/users/JeremyRubin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/JeremyRubin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/JeremyRubin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
        "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
        "repos_url": "https://api.github.com/users/JeremyRubin/repos",
        "events_url": "https://api.github.com/users/JeremyRubin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-02T12:06:35Z"
    },
    {
      "event": "commented",
      "id": 551883348,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU1MTg4MzM0OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/551883348",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T15:58:01Z",
      "updated_at": "2019-11-08T15:58:01Z",
      "author_association": "MEMBER",
      "body": "Okay, I'm back with good news and bad(ish) news. The good news is that the bench weirdness has been resolved by comparing master (6a7c40bee4, [`bench/master.1`](https://github.com/jamesob/bitcoin/tree/bench/master.1)) to a version of this branch rebased on top of that same commit ([`bench/alloc.1`](https://github.com/jamesob/bitcoin/tree/bench/alloc.1)). So I'm guessing the weirdness before may have been related to an assumevalid bump, but I'm not definitively sure.\r\n\r\nThe bad news is that the now-very-consistent results don't show as much of an improvement as I expected. \r\n\r\nI did two separate runs over the course of a few days - for each machine, the branches were tested twice back-to-back in random order (results are ordered the same). The command tested was `bitcoind -reindex-chainstate -stopatheight=550000 -dbcache=$DBCACHE -connect=0`.\r\n\r\n```\r\nhost         branch                 time              %     maxmem  cpu% dbcache\r\nbench-ssd-2  bench/master.1             9:13:57    1.00  5777.93MB 344% dbcache=4000MB\r\nbench-ssd-2  bench/master.1             9:16:30    1.00  5760.55MB 343% dbcache=4000MB\r\nbench-ssd-2  bench/alloc.1              9:01:19    0.97  5466.12MB 348% dbcache=4000MB\r\nbench-ssd-2  bench/alloc.1              9:01:06    0.97  5453.22MB 349% dbcache=4000MB\r\n\r\nbench-ssd-3  bench/alloc.1              9:03:00    0.97  5451.97MB 348% dbcache=4000MB\r\nbench-ssd-3  bench/alloc.1              9:01:58    0.97  5474.70MB 348% dbcache=4000MB\r\nbench-ssd-3  bench/master.1             9:16:33    1.00  5772.59MB 343% dbcache=4000MB\r\nbench-ssd-3  bench/master.1             9:18:04    1.00  5781.47MB 342% dbcache=4000MB\r\n\r\nbench-ssd-4  bench/master.1             9:15:28    1.00  5781.36MB 343% dbcache=4000MB\r\nbench-ssd-4  bench/master.1             9:15:41    1.00  5765.45MB 343% dbcache=4000MB\r\nbench-ssd-4  bench/alloc.1              9:02:24    0.98  5451.96MB 348% dbcache=4000MB\r\nbench-ssd-4  bench/alloc.1              9:01:49    0.98  5443.95MB 348% dbcache=4000MB\r\n\r\nbench-ssd-5  bench/alloc.1              8:57:42    0.97  5456.22MB 351% dbcache=4000MB\r\nbench-ssd-5  bench/alloc.1              8:57:48    0.97  5464.43MB 351% dbcache=4000MB\r\nbench-ssd-5  bench/master.1             9:12:06    1.00  5787.68MB 345% dbcache=4000MB\r\nbench-ssd-5  bench/master.1             9:11:49    1.00  5777.87MB 346% dbcache=4000MB\r\n\r\nbench-strong bench/alloc.1              14:58:34   0.99  5425.66MB 548% dbcache=4000MB\r\nbench-strong bench/alloc.1              14:57:55   0.99  5463.18MB 548% dbcache=4000MB\r\nbench-strong bench/master.1             15:04:45   1.00  5751.64MB 545% dbcache=4000MB\r\nbench-strong bench/master.1             15:04:06   1.00  5734.97MB 545% dbcache=4000MB\r\n```\r\n\r\nSo we see very consistent times across branches and machines, but the gain associated with this branch is pretty mild (~2-3%).\r\n\r\nAll of the bench-ssd-* machines resemble each other pretty closely. `bench-strong` has much more CPU and RAM (which led me to be initially surprised by the results) but then I realized it has a spinning disk. The specs for the machines are below:\r\n\r\n#### (representative of the bench-ssd-* machines)\r\n| key                                  | value                                       |\r\n| ----------------------------------   | -----------------------------------------   |\r\n| hostname                             | bench-ssd-2                                 |\r\n| cpu_model_name                       | Intel(R) Xeon(R) CPU E3-1220 v5 @ 3.00GHz   |\r\n| ram_gb                               | 7.712375640869141                           |\r\n| os                                   | ['Debian GNU/Linux', '9', 'stretch']        |\r\n| arch                                 | x86_64                                      |\r\n| kernel                               | 4.9.0-8-amd64                               |\r\n| read_iops (/home/ccl/bitcoinperf)    | 2032                                        |\r\n| write_iops (/home/ccl/bitcoinperf)   | 672                                         |\r\n\r\n#### bench-strong\r\n| key                                 | value                                     |\r\n| ---------------------------------   | ---------------------------------------   |\r\n| hostname                            | bench-strong                              |\r\n| cpu_model_name                      | Intel(R) Core(TM) i7-4770 CPU @ 3.40GHz   |\r\n| ram_gb                              | 31.353431701660156                        |\r\n| os                                  | ['Debian GNU/Linux', '10', 'buster']      |\r\n| arch                                | x86_64                                    |\r\n| kernel                              | 4.19.0-5-amd64                            |\r\n| read_iops (/home/james/.bitcoin)    | 332                                       |\r\n| write_iops (/home/james/.bitcoin)   | 113                                       |\r\n\r\nIn order to make certain that these runtime characteristics aren't unstable based on dbcache, I reran this with `dbcache=5000` (from `dbcache=4000`) - in previous benchmarking sessions I hadn't seen the weird \"bi-modal\" behavior until dbcache hit 5000.\r\n\r\n```\r\nhost         branch                 time              %     maxmem  cpu% dbcache\r\nbench-ssd-2  bench/alloc.1              9:12:44    0.98  6397.99MB 341% dbcache=5000MB\r\nbench-ssd-2  bench/alloc.1              9:11:06    0.98  6397.02MB 342% dbcache=5000MB\r\nbench-ssd-2  bench/master.1             9:22:27    1.00  6697.26MB 340% dbcache=5000MB\r\nbench-ssd-2  bench/master.1             9:22:28    1.00  6609.71MB 339% dbcache=5000MB\r\n\r\nbench-ssd-3  bench/master.1             9:27:27    1.00  6738.98MB 336% dbcache=5000MB\r\nbench-ssd-3  bench/master.1             9:24:56    1.00  6770.75MB 338% dbcache=5000MB\r\nbench-ssd-3  bench/alloc.1              9:25:38    1.00  6454.57MB 334% dbcache=5000MB\r\nbench-ssd-3  bench/alloc.1              9:12:47    0.97  6418.94MB 341% dbcache=5000MB\r\n\r\nbench-ssd-4  bench/alloc.1              9:12:12    0.98  6543.72MB 341% dbcache=5000MB\r\nbench-ssd-4  bench/alloc.1              9:26:04    1.00  6394.11MB 333% dbcache=5000MB\r\nbench-ssd-4  bench/master.1             9:23:44    1.00  6749.35MB 338% dbcache=5000MB\r\nbench-ssd-4  bench/master.1             9:22:57    0.99  6673.99MB 339% dbcache=5000MB\r\n\r\nbench-ssd-5  bench/alloc.1              9:04:42    0.97  6380.43MB 346% dbcache=5000MB\r\nbench-ssd-5  bench/alloc.1              9:06:23    0.97  6380.80MB 345% dbcache=5000MB\r\nbench-ssd-5  bench/master.1             9:23:53    1.00  6666.49MB 338% dbcache=5000MB\r\nbench-ssd-5  bench/master.1             9:20:08    0.99  6604.82MB 341% dbcache=5000MB\r\n\r\nbench-strong bench/master.1             15:00:44   1.00  6869.63MB 545% dbcache=5000MB\r\nbench-strong bench/master.1             14:58:43   1.00  6706.32MB 546% dbcache=5000MB\r\nbench-strong bench/alloc.1              15:02:07   1.00  6511.17MB 545% dbcache=5000MB\r\nbench-strong bench/alloc.1              15:02:24   1.00  6415.48MB 545% dbcache=5000MB\r\n```\r\n\r\nAs you can see, the results are very similar. In fact I was a little surprised that an extra gig of dbcache doesn't seem to make any real difference in terms of runtime - if nothing else it marginally hurt the runtimes.\r\n\r\n---\r\n\r\nSo anyway, take this all for what it is. I wouldn't be surprised if after the wide variance seen in my benchmarking that this is all taken with a grain of salt, but I've done what I can to rule out spurious measures. That said, anyone should be able to reproduce these results by making superficial modifications to [this script](https://github.com/chaincodelabs/bitcoinperf/blob/master/bin/run_remote_reindex.py).\r\n\r\nI would say if these benchmarks are indeed characteristic of the performance gain associated with this PR, I am not in favor of merging it as such because I think the risk associated with swapping out an allocator isn't compensated for by a 3% reduction in IBD runtime. But that said I am (hopefully obviously) a big fan of this sort of work, and will continue to cheer @martinus on in his attempts to optimize what is certainly one of the biggest bottlenecks in bitcoind.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-551883348",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "mentioned",
      "id": 2783659265,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50Mjc4MzY1OTI2NQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2783659265",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T15:58:02Z"
    },
    {
      "event": "subscribed",
      "id": 2783659267,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3ODM2NTkyNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2783659267",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T15:58:02Z"
    },
    {
      "event": "commented",
      "id": 551896168,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU1MTg5NjE2OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/551896168",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T16:29:51Z",
      "updated_at": "2019-11-08T16:29:51Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for getting to the bottom of this @jamesob! It's good to see that the allocator actually seems to do it's job as it's supposed to be, even when the benefit is small. It's probably bigger when validation doesn't have be be redone, but the additional code complexity is probably not worth it. ",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-551896168",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "mentioned",
      "id": 2783801312,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50Mjc4MzgwMTMxMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2783801312",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T16:29:51Z"
    },
    {
      "event": "subscribed",
      "id": 2783801314,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3ODM4MDEzMTQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2783801314",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-08T16:29:51Z"
    },
    {
      "event": "commented",
      "id": 555200787,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU1NTIwMDc4Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555200787",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-18T20:44:29Z",
      "updated_at": "2019-11-18T20:44:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "> It's probably bigger when validation doesn't have be be redone, but the additional code complexity is probably not worth it.\r\n\r\nIt seems like a pool allocator could be a basic building block for a lot of future optimizations. It might also be useful for testing overhead of allocations even in places where we wouldn't want to enable it in released code. So I could see the effort here being useful even if we aren't looking to merge the PR now. But would suggest closing the PR or marking it work in progress to update the status.\r\n\r\nOne thing I'm not clear on is the difference between 3% performance improvement last measured and 16% initially measured. If there are theories about this, I'd be curious.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-555200787",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-18T21:17:29Z",
      "updated_at": "2019-11-18T21:17:29Z",
      "source": {
        "issue": {
          "id": 421531882,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MjYxNTYxNTQ3",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15606/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15606/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15606/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/15606",
          "number": 15606,
          "state": "closed",
          "state_reason": null,
          "title": "assumeutxo",
          "body": "**See the proposal for assumeutxo [here](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal).**\r\n\r\nTesting instructions can be found below the \"Progress\" section.\r\n\r\n---\r\n\r\n### Progress\r\n\r\nAll items here have corresponding commits here, but are unchecked if they haven't been merged yet.\r\n\r\n- [x] **Chainstate interface**\r\n  - https://github.com/bitcoin/bitcoin/pull/15976\r\n- [x] **Localize chainstate data**\r\n  - https://github.com/bitcoin/bitcoin/pull/16443\r\n- [x] **Share block data**\r\n  - https://github.com/bitcoin/bitcoin/pull/16194\r\n- [x] **Deglobalize chainstate**\r\n  - https://github.com/bitcoin/bitcoin/pull/15948\r\n- [x] **UpdateTip/CheckBlockIndex** modifications\r\n  - https://github.com/bitcoin/bitcoin/pull/21526\r\n- [x] **ChainstateManager**\r\n  - https://github.com/bitcoin/bitcoin/pull/17737\r\n- [x] **Mempool**\r\n  - https://github.com/bitcoin/bitcoin/pull/22415\r\n- [x] **LoadBlockIndex**\r\n  - https://github.com/bitcoin/bitcoin/pull/23174\r\n- [x] **Init/teardown**\r\n  - https://github.com/bitcoin/bitcoin/pull/24232\r\n  - https://github.com/bitcoin/bitcoin/pull/25667\r\n  - https://github.com/bitcoin/bitcoin/pull/25740\r\n- [x] **Wallet**: includes avoiding rescans when assumed-valid block data is in use\r\n  - https://github.com/bitcoin/bitcoin/pull/23997\r\n  - https://github.com/bitcoin/bitcoin/pull/26282\r\n- [ ] **P2P**: minor changes are made to `init.cpp` and `net_processing.cpp` to make simultaneous IBD across multiple chainstates work.\r\n  - #24008 \r\n- [ ] **Pruning**: implement correct pruning behavior when using a background chainstate\r\n- [ ] **Blockfile separation**: to prevent \"fragmentation\" in blockfile storage, have background chainstates use separate blockfiles from active snapshot chainstates to avoid interleaving heights and impairing pruning.\r\n- [ ] **Indexing**: all existing `CValidationInterface` events are given with an additional parameter, ChainstateRole, and all indexers ignore events from ChainstateRole::ASSUMEDVALID so that indexation only happens sequentially.\r\n- [ ] Raise error when both `-reindex` and assumeutxo are in use.\r\n- [ ] **RPC**: introduce RPC commands `dumptxoutset`, `loadtxoutset`, and (the probably temporary) `monitorsnapshot`.\r\n  - https://github.com/bitcoin/bitcoin/pull/16899\r\n- [ ] **Release docs & first assumeutxo commitment**: add notes and a particular assumeutxo hash value for first AU-enabled release.\r\n  - This will complete the project and allow use of UTXO snapshots for faster node bootstrap.\r\n- [ ] *(optional)* **Coinscache optimization**: allow flushing chainstate data without emptying the coins cache; results in better performance after UTXO snapshot load.\r\n  - https://github.com/bitcoin/bitcoin/pull/17487\r\n  - https://github.com/bitcoin/bitcoin/pull/27008\r\n\r\n---\r\n\r\n### Testing\r\n\r\n#### For fun (~5min)\r\n\r\nIf you want to do a quick test, you can run `./contrib/devtools/test_utxo_snapshots.sh` and follow the instructions. This is mostly obviated by the functional tests, though.\r\n\r\n#### For real (longer)\r\n\r\nIf you'd like to experience a real usage of assumeutxo, you can do that too.\r\nI've cut a new snapshot at height 788'000 (http://img.jameso.be/utxo-788000.dat - but you can do it yourself with `./contrib/devtools/utxo_snapshot.sh` if you want). Download that, and then create a datadir for testing:\r\n```sh\r\n$ cd ~/src/bitcoin  # or whatever\r\n\r\n# get the snapshot\r\n$ curl http://img.jameso.be/utxo-788000.dat > utxo-788000.dat\r\n\r\n# you'll want to do this if you like copy/pasting \r\n$ export AU_DATADIR=/home/${USER}/au-test # or wherever\r\n\r\n$ mkdir ${AU_DATADIR}\r\n$ vim ${AU_DATADIR}/bitcoin.conf\r\n\r\ndbcache=8000  # or, you know, something high\r\nblockfilterindex=1\r\ncoinstatsindex=1\r\nprune=3000\r\nlogthreadnames=1\r\n```\r\nObtain this branch, build it, and then start bitcoind:\r\n```sh\r\n$ git remote add jamesob https://github.com/jamesob/bitcoin\r\n$ git fetch jamesob utxo-dumpload-compressed\r\n$ git checkout jamesob/utxo-dumpload-compressed\r\n\r\n$ ./configure $conf_args && make  # (whatever you like to do here)\r\n\r\n# start 'er up and watch the logs\r\n$ ./src/bitcoind -datadir=${AU_DATADIR}\r\n```\r\nThen, in some other window, load the snapshot\r\n```sh\r\n$ ./src/bitcoin-cli -datadir=${AU_DATADIR} loadtxoutset $(pwd)/utxo-788000.dat\r\n```\r\n\r\nYou'll see some log messages about headers retrieval and waiting to see the snapshot in the headers chain. Once you get the full headers chain, you'll spend a decent amount of time (~10min) loading the snapshot, checking it, and flushing it to disk. After all that happens, you should be syncing to tip in pretty short order, and you'll see the occasional `[background validation]` log message go by.\r\n\r\nIn yet another window, you can check out chainstate status with\r\n```sh\r\n$ ./src/bitcoin-cli -datadir=${AU_DATADIR} getchainstates\r\n```\r\nas well as usual favorites like `getblockchaininfo`.\r\n\r\n---\r\n\r\n### Original change description\r\n\r\nFor those unfamiliar with assumeutxo, here's a brief summary from [the issue](https://github.com/bitcoin/bitcoin/issues/15605) (where any conceptual discussion not specific to this implementation should happen):\r\n\r\n> assumeutxo would be a way to initialize a node using a headers chain and a serialized version of the UTXO state which was generated from another node at some block height. A client making use of this UTXO \"snapshot\" would specify a hash and expect the content of the resulting UTXO set to yield this hash after deserialization. \r\n> \r\n> This would allow users to bootstrap a usable pruned node & wallet far more quickly (and with less disk usage) than waiting for a full initial block download to complete, since we only have to sync blocks between the base of the snapshot and the current network tip. Needless to say this is at expense of accepting a different trust model, though how different this really ends up being from `assumevalid` in effect is worth debate.\r\n\r\nIn short, this is an interesting change because it would allow nodes to get up and running within minutes given a ~3GB file (at time of writing) under an almost identical trust model to assumevalid.\r\n\r\nIn this implementation, I add a few RPC commands: `dumptxoutset` creates a UTXO snapshot and writes it to disk, and `loadtxoutset` intakes a snapshot from disk, constructs and activates chainstate based on it, and continues a from-scratch initial block download in the background for the sole purpose of validating the snapshot. Once the snapshot is validated, we throw away the chainstate used for background validation.\r\n\r\nThe assumeutxo procedure as implemented is as follows:\r\n\r\n1. A UTXO snapshot is loaded with the `loadtxoutset <path>` RPC command.\r\n1. A new chainstate (`CChainState`) is initialized using `ChainstateManager::ActivateSnapshot()`:\r\n   1. The serialized UTXO data is read in and various sanity checks are performed, e.g. compare expected coin count, recompute the hash and compare it with assumeutxo hash in source code.\r\n   1. We \"fast forward\" `new_chainstate->m_chain` to have a tip at the base of the snapshot (with or without block data). Lacking block data, we fake the `nTx` counts of the constituent `CBlockIndex` entries.\r\n   1. `LoadChainTip()` is called on the new snapshot and it is installed as our active chainstate.\r\n1. The new assumed-valid chainstate is now our active, and so that enters IBD until it is synced to the network's tip. Presumably the snapshot would be taken relatively close to the current tip but far enough away to avoid meaningful reorgs, say 10,000 blocks deep.\r\n1. Once the active chainstate is out of IBD, our old validation chain continues IBD \"in the background\" while the active chainstate services requests from most of the system.\r\n1. Once the background validation chainstate reaches a height equal the base of the snapshot, we take the hash of its UTXO set and ensure it equals the expected hash based on the snapshot. If the hashes are equivalent, we delete the validation chainstate and move on without event; if they aren't, we log loudly and fall back to the validation chainstate (we should probably just shut down).\r\n\r\nThe implicit assumption is that the background validation chain will always be a subset of the assumed-valid snapshot chain while the latter is active. We don't properly handle reorgs that go deeper than the base of the snapshot.\r\n\r\n### Changes (already merged/outdated)\r\n\r\n![chainstate-beforeafter (1)](https://user-images.githubusercontent.com/73197/54435797-a16b0780-4707-11e9-89c3-c90b5686804d.png)\r\n \r\nThe crux of this change is in removing any assumptions in the codebase that there is a single chainstate, i.e. any references to global variables `chainActive`, `pcoinsTip`, et al. need to be replaced with functions that return the relevant chainstate data at that moment in time. This change also takes `CChainState` to its logical conclusion by making it more self-contained - any references to globals like `chainActive` are removed with class-local references (`m_chain`).\r\n\r\nA few minor notes on the implementation:\r\n\r\n- When we attempt to load a wallet with a BestBlock locator lower than the base of a snapshot and the snapshot has not yet been validated, we refuse to load the wallet.\r\n\r\n- For additional notes, see [the new assumeutxo docs](https://github.com/jamesob/bitcoin/blob/utxo-dumpload-compressed/doc/assumeutxo.md).",
          "user": {
            "login": "jamesob",
            "id": 73197,
            "node_id": "MDQ6VXNlcjczMTk3",
            "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jamesob",
            "html_url": "https://github.com/jamesob",
            "followers_url": "https://api.github.com/users/jamesob/followers",
            "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
            "organizations_url": "https://api.github.com/users/jamesob/orgs",
            "repos_url": "https://api.github.com/users/jamesob/repos",
            "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/jamesob/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 64583,
              "node_id": "MDU6TGFiZWw2NDU4Mw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Feature",
              "name": "Feature",
              "color": "7cf575",
              "default": false
            },
            {
              "id": 97470796,
              "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
              "name": "UTXO Db and Indexes",
              "color": "fbca04",
              "default": false
            },
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 66,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/15606",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/15606.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/15606.patch"
          },
          "closed_at": "2023-05-08T15:09:24Z",
          "created_at": "2019-03-15T13:58:22Z",
          "updated_at": "2023-05-08T15:09:24Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 555370503,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU1NTM3MDUwMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555370503",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-19T07:24:34Z",
      "updated_at": "2019-11-19T07:24:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "> One thing I'm not clear on is the difference between 3% performance improvement last measured and 16% initially measured. If there are theories about this, I'd be curious.\r\n\r\nI'm pretty sure the difference is due to to additional validation due to `-noassumevalid`. With validation, validation is the bottleneck so the improvement is not as pronounced. When no validation needs to happen, you see much bigger gains from this PR.",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-555370503",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "closed",
      "id": 2810280948,
      "node_id": "MDExOkNsb3NlZEV2ZW50MjgxMDI4MDk0OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2810280948",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-19T07:24:34Z"
    },
    {
      "event": "commented",
      "id": 555523561,
      "node_id": "MDEyOklzc3VlQ29tbWVudDU1NTUyMzU2MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/555523561",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-11-19T14:09:22Z",
      "updated_at": "2019-11-19T14:09:22Z",
      "author_association": "MEMBER",
      "body": "Oh, I didn't want to imply in https://github.com/bitcoin/bitcoin/pull/17060#issuecomment-547687821 that `-noassumevalid` is the only setting that makes sense for benchmarking. Every release has a different assumed valid block set by default. So when looking at total IBD time, it makes sense to consider the setting where no validation happens because it is skipped by default. If there is a more than 10% speed-up, it should not be neglected.",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-555523561",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "jb55",
        "id": 45598,
        "node_id": "MDQ6VXNlcjQ1NTk4",
        "avatar_url": "https://avatars.githubusercontent.com/u/45598?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jb55",
        "html_url": "https://github.com/jb55",
        "followers_url": "https://api.github.com/users/jb55/followers",
        "following_url": "https://api.github.com/users/jb55/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jb55/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jb55/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jb55/subscriptions",
        "organizations_url": "https://api.github.com/users/jb55/orgs",
        "repos_url": "https://api.github.com/users/jb55/repos",
        "events_url": "https://api.github.com/users/jb55/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jb55/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-05T18:23:55Z",
      "updated_at": "2020-05-05T18:23:55Z",
      "source": {
        "issue": {
          "id": 611128011,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NDEyNDEzNzI2",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18849",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18849/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18849/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18849/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/18849",
          "number": 18849,
          "state": "closed",
          "state_reason": null,
          "title": "The Zero Allocations project",
          "body": "This is an octomerge staging PR for tracking various heap-allocation reductions during IBD and regular use. Reducing heap allocations improves cache coherency and should improve performance. Maybe. You can use this PR to bench IBD.\r\n\r\n- [ ] ZAP1 - #18847 - `compressor: use prevector in CompressScript serialization `\r\n- [x] ~ZAP2 - #18848 - `threadnames: don't allocate memory in ThreadRename`~\r\n- [ ] ZAP3 - #18985 - `bloom: use Span instead of std::vector for insert and contains`\r\n- [ ] ZAP4 - no pr yet - `netaddress: return a prevector from CService::GetKey()`",
          "user": {
            "login": "jb55",
            "id": 45598,
            "node_id": "MDQ6VXNlcjQ1NTk4",
            "avatar_url": "https://avatars.githubusercontent.com/u/45598?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jb55",
            "html_url": "https://github.com/jb55",
            "followers_url": "https://api.github.com/users/jb55/followers",
            "following_url": "https://api.github.com/users/jb55/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/jb55/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/jb55/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/jb55/subscriptions",
            "organizations_url": "https://api.github.com/users/jb55/orgs",
            "repos_url": "https://api.github.com/users/jb55/repos",
            "events_url": "https://api.github.com/users/jb55/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/jb55/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            },
            {
              "id": 749416508,
              "node_id": "MDU6TGFiZWw3NDk0MTY1MDg=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Up%20for%20grabs",
              "name": "Up for grabs",
              "color": "99a810",
              "default": false
            },
            {
              "id": 955867938,
              "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
              "name": "Needs rebase",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "comments": 19,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18849",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/18849",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/18849.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/18849.patch"
          },
          "closed_at": "2021-09-20T17:51:03Z",
          "created_at": "2020-05-02T07:40:30Z",
          "updated_at": "2022-10-30T19:10:28Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-06T07:15:48Z",
      "updated_at": "2021-08-06T07:15:48Z",
      "source": {
        "issue": {
          "id": 962165678,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NzA0OTk2NjE2",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22640",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22640/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22640/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22640/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/22640",
          "number": 22640,
          "state": "closed",
          "state_reason": null,
          "title": "Improve speed, memory efficiency with alternate hashmap (#2)",
          "body": "Resurrection of https://github.com/bitcoin/bitcoin/pull/16718\r\n\r\n---\r\n\r\n**tl;dr**\r\n\r\nI try swapping out `std::unordered_map` for a faster third-party implementation where it matters, see something like 15% speedup for initial block download coincident with a 19.3% reduction in memory usage.\r\n\r\n---\r\n\r\nWhen profiling initial block download, it's evident that a decent chunk of time on the critical path is spent in `CCoinsViewCache`, the data structure responsible for the in-memory representation of the UTXO set.\r\n\r\n![Selection_147](https://user-images.githubusercontent.com/73197/63644597-9b1b8700-c6ba-11e9-964c-91c6fb78b3a2.png)\r\n*Profile of the `msghand` thread at height ~300,000.*\r\n\r\nThe essential data member of the cache, `cacheCoins`, is a `std::unordered_map` that holds as many UTXO as can fit into memory given the `dbcache` setting. While this map implementation is definitely preferable to `std::map` (which retains order and has O(log(n)) lookups insted of O(1)), both stdlib maps are subpar [relative to non-`std` alternatives](https://martin.ankerl.com/2019/04/01/hashmap-benchmarks-01-overview/).\r\n\r\nAfter seeing cacheCoins as a bottleneck, I decided to try swapping one of these alternative implementations in to see if there is any benefit. It looks like there is.\r\n\r\n![ibd local range 500000 520000](https://user-images.githubusercontent.com/73197/63644703-0a927600-c6bd-11e9-9e1d-2748b8fbdf8d.png)\r\n\r\nFor 20,000 blocks at a representative part of the chain, we see something like a 15% speedup with a 19.3% reduction in memory usage (dbcache was set to 3000).\r\n\r\nThe `CCoinsCaching` benchmark shows improvement but not as dramatically as IBD does:\r\n\r\n![microbenches](https://user-images.githubusercontent.com/73197/63644768-572a8100-c6be-11e9-922c-8360a9f9e3b4.png)\r\n\r\nObviously adding 2000 lines of new consensus-critical code isn't appealing, but if those numbers hold for the full IBD process I think there might be a compelling case to be made for the added code.\r\n\r\n### Implementations considered\r\n\r\nOf the few best-looking options, I picked the one with the most succinct implementation and fewest dependencies, [`robin_hood::unordered_node_map`](https://github.com/martinus/robin-hood-hashing) (it's just a header file). I also looked at Facebook's [`F14NodeMap`](https://github.com/facebook/folly/blob/master/folly/container/F14.md) and Abseil's [`node_hash_map`](https://abseil.io/docs/cpp/guides/container) but both required too much elbow-grease (for now) to integrate here without pulling in a whole lot of code.\r\n\r\n### Next steps\r\n\r\nI'm going to be running more comprehensive benchmarks, including a near-full IBD from the network, to see if these improvements hold.\r\n\r\nI'm also interested in benching this along with a similar change to `mapBlockIndex` (currently a `std::unordered_map`).\r\n\r\n### Questions\r\n\r\nIf we decide to include this or another hashmap implementation, should we do a full fork inclusion a la leveldb or should we try to slim down the implementation to a single header file as is done here (but more)?\r\n\r\n",
          "user": {
            "login": "jamesob",
            "id": 73197,
            "node_id": "MDQ6VXNlcjczMTk3",
            "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jamesob",
            "html_url": "https://github.com/jamesob",
            "followers_url": "https://api.github.com/users/jamesob/followers",
            "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
            "organizations_url": "https://api.github.com/users/jamesob/orgs",
            "repos_url": "https://api.github.com/users/jamesob/repos",
            "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/jamesob/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 97470796,
              "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
              "name": "UTXO Db and Indexes",
              "color": "fbca04",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 5,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22640",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/22640",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/22640.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/22640.patch"
          },
          "closed_at": "2021-08-09T16:10:40Z",
          "created_at": "2021-08-05T20:19:01Z",
          "updated_at": "2022-08-16T17:26:53Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 895348607,
      "node_id": "IC_kwDOABII5841Xe9_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895348607",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-09T16:06:50Z",
      "updated_at": "2021-08-09T16:06:50Z",
      "author_association": "MEMBER",
      "body": "I've benchmarked @martinus' rebased version of this branch (per https://github.com/bitcoin/bitcoin/pull/22640#issuecomment-894506145) and I'm happy to report that I'm seeing a roughly 9% speedup along with an 8% reduction in memory usage (with a very high dbcache setting). A pull request for this branch should probably be reopened, though due to the rebase I think @martinus may have to open a separate pull request.\r\n\r\n---\r\n\r\n![ibd local range 500000 540000](https://user-images.githubusercontent.com/73197/128737336-1ddc0efa-4ca3-4efa-b1b9-fc6c39de4581.png)\r\n\r\n#### commands index\r\n|          bench name           |                                                                                                     command                                                                                                      |\r\n|-------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\r\n| ibd.local.range.500000.540000 | `bitcoind -dbcache=10000 -debug=coindb -debug=bench -listen=0 -connect=0 -addnode=127.0.0.1:8888 -prune=9999999 -printtoconsole=0 -assumevalid=000000000000000000176c192f42ad13ab159fdb20198b87e7ba3c001e47b876` |\r\n\r\n\r\n#### martinus/2019-08-bulkpoolallocator vs. $mergebase (absolute)\r\n|                  bench name                   |  x  | martinus/2019-08-bulkpoolallocator |         $mergebase         |\r\n|-----------------------------------------------|----:|------------------------------------|----------------------------|\r\n| ibd.local.range.500000.540000.total_secs      |   3 | 2850.0195 (± 9.6506)               | 3134.5484 (± 11.6699)      |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   3 | 5831204.0000 (± 3492.0817)         | 6358314.6667 (± 3223.6564) |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   3 | 261.0567 (± 1.3968)                | 267.7467 (± 0.7879)        |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   3 | 12815.7433 (± 3.5496)              | 13162.3167 (± 13.4203)     |\r\n\r\n\r\n#### martinus/2019-08-bulkpoolallocator vs. $mergebase (relative)\r\n|                  bench name                   |  x  | martinus/2019-08-bulkpoolallocator | $mergebase |\r\n|-----------------------------------------------|----:|-----------------------------------:|-----------:|\r\n| ibd.local.range.500000.540000.total_secs      |   3 |                                  1 |      1.100 |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   3 |                                  1 |      1.090 |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   3 |                                  1 |      1.026 |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   3 |                                  1 |      1.027 |\r\n\r\n",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-895348607",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "mentioned",
      "id": 5130672546,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NTEzMDY3MjU0Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5130672546",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-09T16:06:50Z"
    },
    {
      "event": "subscribed",
      "id": 5130672550,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDUxMzA2NzI1NTA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5130672550",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-09T16:06:50Z"
    },
    {
      "event": "commented",
      "id": 895372039,
      "node_id": "IC_kwDOABII5841XksH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895372039",
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-09T16:39:25Z",
      "updated_at": "2021-08-09T16:39:25Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for the thorough benchmark! I'll try to clean up the code a bit and then open another PR with the pool allocator. ",
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-895372039",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16801"
    },
    {
      "event": "subscribed",
      "id": 5131313943,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDUxMzEzMTM5NDM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5131313943",
      "actor": {
        "login": "0xB10C",
        "id": 19157360,
        "node_id": "MDQ6VXNlcjE5MTU3MzYw",
        "avatar_url": "https://avatars.githubusercontent.com/u/19157360?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/0xB10C",
        "html_url": "https://github.com/0xB10C",
        "followers_url": "https://api.github.com/users/0xB10C/followers",
        "following_url": "https://api.github.com/users/0xB10C/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/0xB10C/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/0xB10C/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/0xB10C/subscriptions",
        "organizations_url": "https://api.github.com/users/0xB10C/orgs",
        "repos_url": "https://api.github.com/users/0xB10C/repos",
        "events_url": "https://api.github.com/users/0xB10C/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/0xB10C/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-09T18:21:20Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-13T20:37:53Z",
      "updated_at": "2021-08-13T20:37:53Z",
      "source": {
        "issue": {
          "id": 970696298,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NzEyNjEzNDg2",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22702",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22702/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22702/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22702/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/22702",
          "number": 22702,
          "state": "closed",
          "state_reason": null,
          "title": "Add allocator for node based containers",
          "body": "jamesob has benchmarked my rebased branch (see https://github.com/bitcoin/bitcoin/pull/16801#issuecomment-895348607) concerning the allocator for node based containers, and has seen a 9% speedup along with 8% reduction in memory. That's why I had another good look at my previously closed PR https://github.com/bitcoin/bitcoin/pull/16801 and updated the code. I've updated the code quite a bit, mostly trying to simplify it and improve correctness:\r\n\r\n* Renamed classes to be more in line with naming used for the`std::pmr` allocators (see https://en.cppreference.com/w/cpp/memory/polymorphic_allocator)\r\n* Simplified `Allocator` thanks to being able to use C++17 behavior (`std::allocator_traits`)\r\n* Simpler allocation: only allocate blocks of the same size and just keep them in a `std::vector`.\r\n* Only access memory when actually needed. E.g. Linux uses optimistic memory allocation, so memory pages from malloc are only actually made available to the program when accessed\r\n* Correctly handle alignment for the inplace linked list.\r\n\r\njamesob it would be great if you could run your benchmarks again with the updated code. \r\n\r\nedit laanwj: removed @ signs and html comments from message",
          "user": {
            "login": "martinus",
            "id": 14386,
            "node_id": "MDQ6VXNlcjE0Mzg2",
            "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/martinus",
            "html_url": "https://github.com/martinus",
            "followers_url": "https://api.github.com/users/martinus/followers",
            "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
            "organizations_url": "https://api.github.com/users/martinus/orgs",
            "repos_url": "https://api.github.com/users/martinus/repos",
            "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/martinus/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 97470796,
              "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
              "name": "UTXO Db and Indexes",
              "color": "fbca04",
              "default": false
            },
            {
              "id": 241832923,
              "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
              "name": "Utils/log/libs",
              "description": "",
              "color": "5319e7",
              "default": false
            },
            {
              "id": 326918230,
              "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
              "name": "Resource usage",
              "color": "981023",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 63,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22702",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/22702",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/22702.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/22702.patch"
          },
          "closed_at": "2022-06-03T09:07:14Z",
          "created_at": "2021-08-13T20:37:53Z",
          "updated_at": "2022-09-13T14:42:24Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "subscribed",
      "id": 5171544175,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDUxNzE1NDQxNzU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5171544175",
      "actor": {
        "login": "brandonbryant12",
        "id": 15367258,
        "node_id": "MDQ6VXNlcjE1MzY3MjU4",
        "avatar_url": "https://avatars.githubusercontent.com/u/15367258?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brandonbryant12",
        "html_url": "https://github.com/brandonbryant12",
        "followers_url": "https://api.github.com/users/brandonbryant12/followers",
        "following_url": "https://api.github.com/users/brandonbryant12/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brandonbryant12/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brandonbryant12/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brandonbryant12/subscriptions",
        "organizations_url": "https://api.github.com/users/brandonbryant12/orgs",
        "repos_url": "https://api.github.com/users/brandonbryant12/repos",
        "events_url": "https://api.github.com/users/brandonbryant12/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brandonbryant12/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-08-17T22:18:02Z"
    },
    {
      "event": "locked",
      "id": 7199164568,
      "node_id": "LOE_lADOABII584dJS29zwAAAAGtGoiY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/7199164568",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-16T17:26:54Z",
      "lock_reason": "resolved"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321963843",
      "pull_request_review_id": 285166006,
      "id": 321963843,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTk2Mzg0Mw==",
      "diff_hunk": "@@ -0,0 +1,331 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory chunk) at a time. The first call to allocate determine\n+/// the size of elements in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// When the pool is empty, increasingly large blocks of are allocate, doubling its size until\n+/// m_max_num_allocs is reached. This way we don't have too large an overhead for small pool usage,\n+/// and still get efficiency for lots of elements since number of mallocs() are very reduced. Also,\n+/// less bookkeeping is necessary, so it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the T's.\n+///\n+/// Memory layout:\n+///\n+///  m_blocks\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Don't allow allocation for types that are smaller than a void*. This does not make sense\n+    /// because we need to fit a pointer into the memory.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    T* Allocate() noexcept\n+    {\n+        return nullptr;\n+    }\n+\n+    /// As with Allocate(), don't allow for types that are smaller than a void*.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    bool Deallocate() noexcept\n+    {\n+        return false;\n+    }\n+\n+    /// Tries to allocate one T. If allocation is not possible, returns nullptr and the callee\n+    /// has to do something else to get memory. First caller decides the size of the pool's data.\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    T* Allocate()\n+    {\n+        if (m_chunk_size == 0) {\n+            // allocator not yet used, so this type determines the size.\n+            m_chunk_size = sizeof(T);\n+        } else if (m_chunk_size != sizeof(T)) {\n+            // allocator's size does not match sizeof(T), don't allocate.\n+            return nullptr;\n+        }\n+\n+        // Make sure we have memory available\n+        if (m_free_chunks == nullptr) {\n+            AllocateAndCreateFreelist();\n+        }\n+\n+        // pop one element from the linked list, returning previous head\n+        auto old_head = m_free_chunks;\n+        m_free_chunks = *reinterpret_cast<void**>(old_head);\n+        return reinterpret_cast<T*>(old_head);\n+    }\n+\n+    /// Puts p back into the freelist, if it was the correct size. Only allowed with objects\n+    /// that were allocated with this pool!\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    bool Deallocate(T* p) noexcept\n+    {\n+        if (m_chunk_size != sizeof(T)) {\n+            // allocation didn't happen with this allocator\n+            return false;\n+        }\n+\n+        // put it into the linked list\n+        *reinterpret_cast<void**>(p) = m_free_chunks;",
      "path": "src/support/allocators/bulk_pool.h",
      "position": null,
      "original_position": 111,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "ad55a26725b015f00f99d99048e992e637aaebf4",
      "in_reply_to_id": null,
      "user": {
        "login": "practicalswift",
        "id": 7826565,
        "node_id": "MDQ6VXNlcjc4MjY1NjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7826565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/practicalswift",
        "html_url": "https://github.com/practicalswift",
        "followers_url": "https://api.github.com/users/practicalswift/followers",
        "following_url": "https://api.github.com/users/practicalswift/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/practicalswift/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/practicalswift/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
        "organizations_url": "https://api.github.com/users/practicalswift/orgs",
        "repos_url": "https://api.github.com/users/practicalswift/repos",
        "events_url": "https://api.github.com/users/practicalswift/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/practicalswift/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "&lt;language lawyer hat on&gt;\r\n\r\nIs this really defined behaviour? :-)\r\n\r\n&lt;/language lawyer hat on&gt;",
      "created_at": "2019-09-07T10:17:08Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r321963843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321963843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 111,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321966253",
      "pull_request_review_id": 285168816,
      "id": 321966253,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTk2NjI1Mw==",
      "diff_hunk": "@@ -0,0 +1,331 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory chunk) at a time. The first call to allocate determine\n+/// the size of elements in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// When the pool is empty, increasingly large blocks of are allocate, doubling its size until\n+/// m_max_num_allocs is reached. This way we don't have too large an overhead for small pool usage,\n+/// and still get efficiency for lots of elements since number of mallocs() are very reduced. Also,\n+/// less bookkeeping is necessary, so it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the T's.\n+///\n+/// Memory layout:\n+///\n+///  m_blocks\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Don't allow allocation for types that are smaller than a void*. This does not make sense\n+    /// because we need to fit a pointer into the memory.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    T* Allocate() noexcept\n+    {\n+        return nullptr;\n+    }\n+\n+    /// As with Allocate(), don't allow for types that are smaller than a void*.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    bool Deallocate() noexcept\n+    {\n+        return false;\n+    }\n+\n+    /// Tries to allocate one T. If allocation is not possible, returns nullptr and the callee\n+    /// has to do something else to get memory. First caller decides the size of the pool's data.\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    T* Allocate()\n+    {\n+        if (m_chunk_size == 0) {\n+            // allocator not yet used, so this type determines the size.\n+            m_chunk_size = sizeof(T);\n+        } else if (m_chunk_size != sizeof(T)) {\n+            // allocator's size does not match sizeof(T), don't allocate.\n+            return nullptr;\n+        }\n+\n+        // Make sure we have memory available\n+        if (m_free_chunks == nullptr) {\n+            AllocateAndCreateFreelist();\n+        }\n+\n+        // pop one element from the linked list, returning previous head\n+        auto old_head = m_free_chunks;\n+        m_free_chunks = *reinterpret_cast<void**>(old_head);\n+        return reinterpret_cast<T*>(old_head);\n+    }\n+\n+    /// Puts p back into the freelist, if it was the correct size. Only allowed with objects\n+    /// that were allocated with this pool!\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    bool Deallocate(T* p) noexcept\n+    {\n+        if (m_chunk_size != sizeof(T)) {\n+            // allocation didn't happen with this allocator\n+            return false;\n+        }\n+\n+        // put it into the linked list\n+        *reinterpret_cast<void**>(p) = m_free_chunks;",
      "path": "src/support/allocators/bulk_pool.h",
      "position": null,
      "original_position": 111,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "ad55a26725b015f00f99d99048e992e637aaebf4",
      "in_reply_to_id": 321963843,
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "hm, I could add a \r\n```cpp\r\nstruct Node {\r\n    Node* next;\r\n};\r\n```\r\nAnd then use `Node*` instead of `void*`. Then instead of \r\n```cpp\r\n// put it into the linked list\r\n*reinterpret_cast<void**>(p) = m_free_chunks;\r\nm_free_chunks = p;\r\n```\r\nI could write \r\n```cpp\r\nauto n = reinterpret_cast<Node*>(p);\r\nn->next = m_free_chunks;\r\nm_free_chunks = n;\r\n```\r\nI guess the code is a bit better readable with that, but I honestly don't know if it's more defined behavior :thinking:",
      "created_at": "2019-09-07T11:54:27Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r321966253",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321966253"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 111,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321999022",
      "pull_request_review_id": 285204867,
      "id": 321999022,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTk5OTAyMg==",
      "diff_hunk": "@@ -0,0 +1,331 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory chunk) at a time. The first call to allocate determine\n+/// the size of elements in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// When the pool is empty, increasingly large blocks of are allocate, doubling its size until\n+/// m_max_num_allocs is reached. This way we don't have too large an overhead for small pool usage,\n+/// and still get efficiency for lots of elements since number of mallocs() are very reduced. Also,\n+/// less bookkeeping is necessary, so it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the T's.\n+///\n+/// Memory layout:\n+///\n+///  m_blocks\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///    [ nextList, T, T, ... T]\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Don't allow allocation for types that are smaller than a void*. This does not make sense\n+    /// because we need to fit a pointer into the memory.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    T* Allocate() noexcept\n+    {\n+        return nullptr;\n+    }\n+\n+    /// As with Allocate(), don't allow for types that are smaller than a void*.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(void*), int>::type = 0>\n+    bool Deallocate() noexcept\n+    {\n+        return false;\n+    }\n+\n+    /// Tries to allocate one T. If allocation is not possible, returns nullptr and the callee\n+    /// has to do something else to get memory. First caller decides the size of the pool's data.\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    T* Allocate()\n+    {\n+        if (m_chunk_size == 0) {\n+            // allocator not yet used, so this type determines the size.\n+            m_chunk_size = sizeof(T);\n+        } else if (m_chunk_size != sizeof(T)) {\n+            // allocator's size does not match sizeof(T), don't allocate.\n+            return nullptr;\n+        }\n+\n+        // Make sure we have memory available\n+        if (m_free_chunks == nullptr) {\n+            AllocateAndCreateFreelist();\n+        }\n+\n+        // pop one element from the linked list, returning previous head\n+        auto old_head = m_free_chunks;\n+        m_free_chunks = *reinterpret_cast<void**>(old_head);\n+        return reinterpret_cast<T*>(old_head);\n+    }\n+\n+    /// Puts p back into the freelist, if it was the correct size. Only allowed with objects\n+    /// that were allocated with this pool!\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(void*), int>::type = 0>\n+    bool Deallocate(T* p) noexcept\n+    {\n+        if (m_chunk_size != sizeof(T)) {\n+            // allocation didn't happen with this allocator\n+            return false;\n+        }\n+\n+        // put it into the linked list\n+        *reinterpret_cast<void**>(p) = m_free_chunks;",
      "path": "src/support/allocators/bulk_pool.h",
      "position": null,
      "original_position": 111,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "ad55a26725b015f00f99d99048e992e637aaebf4",
      "in_reply_to_id": 321963843,
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I got rid of the `void**` casts in in https://github.com/bitcoin/bitcoin/pull/16801/commits/52ee5735304cb8be342e264a19274afc0f422fa8",
      "created_at": "2019-09-08T09:04:09Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r321999022",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321999022"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 111,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341266452",
      "pull_request_review_id": 310050091,
      "id": 341266452,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI2NjQ1Mg==",
      "diff_hunk": "@@ -0,0 +1,344 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory block) at a time. The first call to allocate determine\n+/// the size of chunks in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// The size of the allocated blocks are doubled until NUM_CHUNKS_ALLOC_MAX is reached. This way we\n+/// don't have too large an overhead for small pool usage, and still get efficiency for lots of\n+/// elements since number of mallocs() are very reduced. Also, less bookkeeping is necessary, so\n+/// it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the chunks.\n+///\n+/// Memory layout\n+///\n+///  m_blocks\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk3] // block 0\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk7] // block 1\n+///        :\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 12\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 13\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    // Inplace linked list of all allocated blocks. Make sure it is aligned in such a way that whatever comes\n+    // after a BlockNode is correctly aligned.\n+    struct alignas(alignof(::max_align_t)) BlockNode {\n+        // make sure to align\n+        BlockNode* next;\n+    };\n+\n+    // Inplace linked list of the allocation chunks\n+    struct ChunkNode {\n+        ChunkNode* next;\n+    };\n+\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called.\n+    ~Pool() noexcept\n+    {\n+        Destroy();\n+    }\n+\n+    /// Don't allow allocation for types that are smaller than a Node. This does not make sense\n+    /// because we need to fit a pointer into the memory.",
      "path": "src/support/allocators/bulk_pool.h",
      "position": 84,
      "original_position": 84,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Would it be better to drop these methods or to use a static assert, so it could be a compile time error when `sizeof(T) < sizeof(ChunkNode)` instead of a runtime error?",
      "created_at": "2019-10-31T17:18:22Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341266452",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341266452"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": 83,
      "original_start_line": 83,
      "start_side": "RIGHT",
      "line": 84,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341272476",
      "pull_request_review_id": 310050091,
      "id": 341272476,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI3MjQ3Ng==",
      "diff_hunk": "@@ -0,0 +1,344 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory block) at a time. The first call to allocate determine\n+/// the size of chunks in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// The size of the allocated blocks are doubled until NUM_CHUNKS_ALLOC_MAX is reached. This way we\n+/// don't have too large an overhead for small pool usage, and still get efficiency for lots of\n+/// elements since number of mallocs() are very reduced. Also, less bookkeeping is necessary, so\n+/// it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the chunks.\n+///\n+/// Memory layout\n+///\n+///  m_blocks\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk3] // block 0\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk7] // block 1\n+///        :\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 12\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 13\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    // Inplace linked list of all allocated blocks. Make sure it is aligned in such a way that whatever comes\n+    // after a BlockNode is correctly aligned.\n+    struct alignas(alignof(::max_align_t)) BlockNode {\n+        // make sure to align\n+        BlockNode* next;\n+    };\n+\n+    // Inplace linked list of the allocation chunks\n+    struct ChunkNode {\n+        ChunkNode* next;\n+    };\n+\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called.\n+    ~Pool() noexcept\n+    {\n+        Destroy();\n+    }\n+\n+    /// Don't allow allocation for types that are smaller than a Node. This does not make sense\n+    /// because we need to fit a pointer into the memory.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(ChunkNode), int>::type = 0>\n+    T* Allocate() noexcept\n+    {\n+        return nullptr;\n+    }\n+\n+    /// As with Allocate(), don't allow for types that are smaller than a Node.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(ChunkNode), int>::type = 0>\n+    bool Deallocate() noexcept\n+    {\n+        return false;\n+    }\n+\n+    /// Tries to allocate one T. If allocation is not possible, returns nullptr and the callee\n+    /// has to do something else to get memory. First caller decides the size of the pool's data.\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(ChunkNode), int>::type = 0>\n+    T* Allocate()\n+    {\n+        if (m_chunk_size == 0) {\n+            // allocator not yet used, so this type determines the size.\n+            m_chunk_size = sizeof(T);\n+        } else if (m_chunk_size != sizeof(T)) {\n+            // allocator's size does not match sizeof(T), don't allocate.\n+            return nullptr;\n+        }\n+\n+        // Make sure we have memory available\n+        if (m_free_chunks == nullptr) {\n+            AllocateAndCreateFreelist();\n+        }\n+\n+        // pop one element from the linked list, returning previous head\n+        auto old_head = m_free_chunks;\n+        m_free_chunks = old_head->next;\n+        return reinterpret_cast<T*>(old_head);\n+    }\n+\n+    /// Puts p back into the freelist, if it was the correct size. Only allowed with objects\n+    /// that were allocated with this pool!\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(ChunkNode), int>::type = 0>\n+    bool Deallocate(T* p) noexcept\n+    {\n+        if (m_chunk_size != sizeof(T)) {\n+            // allocation didn't happen with this allocator\n+            return false;\n+        }\n+\n+        // put it into the linked list\n+        auto n = reinterpret_cast<ChunkNode*>(p);\n+        n->next = m_free_chunks;\n+        m_free_chunks = n;\n+        return true;\n+    }\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called. Use with care!\n+    void Destroy() noexcept\n+    {\n+        while (m_blocks != nullptr) {\n+            auto old_head = m_blocks;\n+            m_blocks = m_blocks->next;\n+            ::operator delete(old_head);\n+        }\n+        m_free_chunks = nullptr;\n+    }\n+\n+    /// Counts number of free entries in the freelist. This is an O(n) operation. Mostly for debugging / logging / testing.\n+    size_t NumFreeChunks() const\n+    {\n+        return CountNodes(m_free_chunks);\n+    }\n+\n+    /// Counts number of allocated blocks. This is an O(n) operation. Mostly for debugging / logging / testing.\n+    size_t NumBlocks() const\n+    {\n+        return CountNodes(m_blocks);\n+    }\n+\n+    /// Size per chunk\n+    size_t ChunkSize() const\n+    {\n+        return m_chunk_size;\n+    }\n+\n+private:\n+    //! Minimum number of chunks to allocate for the first block\n+    static constexpr size_t NUM_CHUNKS_ALLOC_MIN = 4;\n+\n+    //! Maximum number of chunks to allocate in one block\n+    static constexpr size_t NUM_CHUNKS_ALLOC_MAX = 16384;\n+\n+    // Counts list length by iterating until nullptr is reached.\n+    template <typename N>\n+    size_t CountNodes(N* node) const\n+    {\n+        size_t length = 0;\n+        while (node != nullptr) {\n+            node = node->next;\n+            ++length;\n+        }\n+        return length;\n+    }\n+\n+    /// Called when no memory is available (m_free_chunks == nullptr).\n+    void AllocateAndCreateFreelist()\n+    {\n+        auto num_chunks = CalcNumChunksToAlloc();\n+        auto data = ::operator new(sizeof(BlockNode) + m_chunk_size * num_chunks);\n+\n+        // link block into blocklist\n+        auto block = reinterpret_cast<BlockNode*>(data);\n+        block->next = m_blocks;\n+        m_blocks = block;\n+\n+        m_free_chunks = MakeFreelist(block, num_chunks);\n+    }\n+\n+    /// Doubles number of elements to alloc until max is reached.\n+    size_t CalcNumChunksToAlloc() noexcept\n+    {\n+        if (m_num_chunks_alloc >= NUM_CHUNKS_ALLOC_MAX) {\n+            return NUM_CHUNKS_ALLOC_MAX;\n+        }\n+        auto prev = m_num_chunks_alloc;\n+        m_num_chunks_alloc *= 2;\n+        return prev;\n+    }\n+\n+    /// Integrates a previously allocated block of memory (where n > 1) into the linked list\n+    ChunkNode* MakeFreelist(BlockNode* block, const size_t num_elements) noexcept\n+    {\n+        // skip BlockNode to get to the chunks\n+        auto const data = reinterpret_cast<char*>(block + 1);\n+\n+        // interlink all chunks\n+        for (size_t i = 0; i < num_elements; ++i) {\n+            reinterpret_cast<ChunkNode*>(data + i * m_chunk_size)->next = reinterpret_cast<ChunkNode*>(data + (i + 1) * m_chunk_size);\n+        }\n+\n+        // last one points nullptr\n+        reinterpret_cast<ChunkNode*>(data + (num_elements - 1) * m_chunk_size)->next = nullptr;\n+        return reinterpret_cast<ChunkNode*>(data);\n+    }\n+\n+    //! A single linked list of all data available in the pool. This list is used for allocations of single elements.\n+    ChunkNode* m_free_chunks{nullptr};\n+\n+    //! A single linked list of all allocated blocks of memory, used to free the data in the destructor.\n+    BlockNode* m_blocks{nullptr};\n+\n+    //! The pool's size for the memory blocks. First call to Allocate() determines the used size.\n+    size_t m_chunk_size{0};\n+\n+    //! Number of elements to allocate in bulk. Doubles each time, until m_max_num_allocs is reached.\n+    size_t m_num_chunks_alloc{NUM_CHUNKS_ALLOC_MIN};\n+};\n+\n+/// Allocator that's usable for node-based containers like std::unorderd_map or std::list. It requires a Pool\n+/// which will be used for allocations of n==1. The pool's memory is only actually freed when the pool's\n+/// destructor is called, otherwise previously allocated memory will be put back into the pool for further use.\n+///\n+/// Be aware that this allocator assumes that the containers will call allocate(1) to allocate nodes, otherwise\n+/// the pool won't be used. Also, it assumes that the *first* call to allocate(1) is done with the actual node\n+/// size. Only subsequent allocate(1) calls with the same sizeof(T) will make use of the allocator.\n+template <typename T>\n+class Allocator\n+{\n+    template <typename U>\n+    friend class Allocator;\n+\n+    template <typename X, typename Y>\n+    friend bool operator==(const Allocator<X>& a, const Allocator<Y>& b) noexcept;\n+\n+public:\n+    using value_type = T;\n+\n+    //! Note: when two containers a and b have different pools and a=b is called, we replace a's allocator with b's.\n+    using propagate_on_container_copy_assignment = std::true_type;\n+    using propagate_on_container_move_assignment = std::true_type;\n+    using propagate_on_container_swap = std::true_type;\n+    using pointer = T*;\n+    using const_pointer = const T*;\n+    using reference = T&;\n+    using const_reference = const T&;\n+    using size_type = size_t;\n+    using difference_type = std::ptrdiff_t;\n+\n+    template <typename U>\n+    struct rebind {\n+        using other = Allocator<U>;\n+    };\n+\n+    explicit Allocator(Pool* pool) noexcept\n+        : m_pool(pool)\n+    {\n+    }\n+\n+    /// Conversion constructor, all Allocators use the same pool.\n+    template <typename U>\n+    Allocator(const Allocator<U>& other) noexcept\n+        : m_pool(other.m_pool)\n+    {\n+    }\n+\n+    /// Allocates n entries. When n==1, the pool is used. The pool might return nullptr if sizeof(T)\n+    /// does not match the pool's chunk size. In that case, we fall back to new().\n+    /// This method should be kept short so it's easily inlineable.\n+    T* allocate(size_t n)\n+    {\n+        if (n == 1) {\n+            auto r = m_pool->Allocate<T>();\n+            if (r != nullptr) {\n+                return r;\n+            }\n+        }\n+        return reinterpret_cast<T*>(::operator new(n * sizeof(T)));\n+    }\n+\n+    /// If n==1, we might have gotten the object from the pool. This is not the case when sizeof(T) does\n+    /// not match the pool's chunk size. In that case, we fall back to delete().\n+    void deallocate(T* p, std::size_t n)\n+    {\n+        if (n == 1 && m_pool->Deallocate(p)) {\n+            return;\n+        }\n+        ::operator delete(p);\n+    }\n+\n+    /// Calls p->~U(). Only required for g++4.8",
      "path": "src/support/allocators/bulk_pool.h",
      "position": null,
      "original_position": 312,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "More information on this? A quick web search didn't turn up anything for me. Could say more in comment.",
      "created_at": "2019-10-31T17:30:06Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341272476",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341272476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 312,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341292248",
      "pull_request_review_id": 310083782,
      "id": 341292248,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI5MjI0OA==",
      "diff_hunk": "@@ -0,0 +1,344 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory block) at a time. The first call to allocate determine\n+/// the size of chunks in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// The size of the allocated blocks are doubled until NUM_CHUNKS_ALLOC_MAX is reached. This way we\n+/// don't have too large an overhead for small pool usage, and still get efficiency for lots of\n+/// elements since number of mallocs() are very reduced. Also, less bookkeeping is necessary, so\n+/// it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the chunks.\n+///\n+/// Memory layout\n+///\n+///  m_blocks\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk3] // block 0\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk7] // block 1\n+///        :\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 12\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 13\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    // Inplace linked list of all allocated blocks. Make sure it is aligned in such a way that whatever comes\n+    // after a BlockNode is correctly aligned.\n+    struct alignas(alignof(::max_align_t)) BlockNode {\n+        // make sure to align\n+        BlockNode* next;\n+    };\n+\n+    // Inplace linked list of the allocation chunks\n+    struct ChunkNode {\n+        ChunkNode* next;\n+    };\n+\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called.\n+    ~Pool() noexcept\n+    {\n+        Destroy();\n+    }\n+\n+    /// Don't allow allocation for types that are smaller than a Node. This does not make sense\n+    /// because we need to fit a pointer into the memory.",
      "path": "src/support/allocators/bulk_pool.h",
      "position": 84,
      "original_position": 84,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "in_reply_to_id": 341266452,
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks for having a look at the code! In that case I think it it better to return `nullptr`, because of how it's used in `bulk_pool::Allocator<T>::allocate(size_t n)`. There `bulk_pool::Pool::Allocate()` is called, and if `nullptr` is returned I fall back to `::operator new`\r\n\r\nI could probably rewrite it to be a compile error, but then I need to rewrite `bulk_pool::Allocator<T>::allocate(size_t n)` to handle that case - which I don't know how to do nicely",
      "created_at": "2019-10-31T18:08:54Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341292248",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341292248"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": 83,
      "original_start_line": 83,
      "start_side": "RIGHT",
      "line": 84,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341292940",
      "pull_request_review_id": 310084725,
      "id": 341292940,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI5Mjk0MA==",
      "diff_hunk": "@@ -0,0 +1,344 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory block) at a time. The first call to allocate determine\n+/// the size of chunks in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// The size of the allocated blocks are doubled until NUM_CHUNKS_ALLOC_MAX is reached. This way we\n+/// don't have too large an overhead for small pool usage, and still get efficiency for lots of\n+/// elements since number of mallocs() are very reduced. Also, less bookkeeping is necessary, so\n+/// it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the chunks.\n+///\n+/// Memory layout\n+///\n+///  m_blocks\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk3] // block 0\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk7] // block 1\n+///        :\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 12\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 13\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    // Inplace linked list of all allocated blocks. Make sure it is aligned in such a way that whatever comes\n+    // after a BlockNode is correctly aligned.\n+    struct alignas(alignof(::max_align_t)) BlockNode {\n+        // make sure to align\n+        BlockNode* next;\n+    };\n+\n+    // Inplace linked list of the allocation chunks\n+    struct ChunkNode {\n+        ChunkNode* next;\n+    };\n+\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called.\n+    ~Pool() noexcept\n+    {\n+        Destroy();\n+    }\n+\n+    /// Don't allow allocation for types that are smaller than a Node. This does not make sense\n+    /// because we need to fit a pointer into the memory.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(ChunkNode), int>::type = 0>\n+    T* Allocate() noexcept\n+    {\n+        return nullptr;\n+    }\n+\n+    /// As with Allocate(), don't allow for types that are smaller than a Node.\n+    template <typename T, typename std::enable_if<sizeof(T) < sizeof(ChunkNode), int>::type = 0>\n+    bool Deallocate() noexcept\n+    {\n+        return false;\n+    }\n+\n+    /// Tries to allocate one T. If allocation is not possible, returns nullptr and the callee\n+    /// has to do something else to get memory. First caller decides the size of the pool's data.\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(ChunkNode), int>::type = 0>\n+    T* Allocate()\n+    {\n+        if (m_chunk_size == 0) {\n+            // allocator not yet used, so this type determines the size.\n+            m_chunk_size = sizeof(T);\n+        } else if (m_chunk_size != sizeof(T)) {\n+            // allocator's size does not match sizeof(T), don't allocate.\n+            return nullptr;\n+        }\n+\n+        // Make sure we have memory available\n+        if (m_free_chunks == nullptr) {\n+            AllocateAndCreateFreelist();\n+        }\n+\n+        // pop one element from the linked list, returning previous head\n+        auto old_head = m_free_chunks;\n+        m_free_chunks = old_head->next;\n+        return reinterpret_cast<T*>(old_head);\n+    }\n+\n+    /// Puts p back into the freelist, if it was the correct size. Only allowed with objects\n+    /// that were allocated with this pool!\n+    template <typename T, typename std::enable_if<sizeof(T) >= sizeof(ChunkNode), int>::type = 0>\n+    bool Deallocate(T* p) noexcept\n+    {\n+        if (m_chunk_size != sizeof(T)) {\n+            // allocation didn't happen with this allocator\n+            return false;\n+        }\n+\n+        // put it into the linked list\n+        auto n = reinterpret_cast<ChunkNode*>(p);\n+        n->next = m_free_chunks;\n+        m_free_chunks = n;\n+        return true;\n+    }\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called. Use with care!\n+    void Destroy() noexcept\n+    {\n+        while (m_blocks != nullptr) {\n+            auto old_head = m_blocks;\n+            m_blocks = m_blocks->next;\n+            ::operator delete(old_head);\n+        }\n+        m_free_chunks = nullptr;\n+    }\n+\n+    /// Counts number of free entries in the freelist. This is an O(n) operation. Mostly for debugging / logging / testing.\n+    size_t NumFreeChunks() const\n+    {\n+        return CountNodes(m_free_chunks);\n+    }\n+\n+    /// Counts number of allocated blocks. This is an O(n) operation. Mostly for debugging / logging / testing.\n+    size_t NumBlocks() const\n+    {\n+        return CountNodes(m_blocks);\n+    }\n+\n+    /// Size per chunk\n+    size_t ChunkSize() const\n+    {\n+        return m_chunk_size;\n+    }\n+\n+private:\n+    //! Minimum number of chunks to allocate for the first block\n+    static constexpr size_t NUM_CHUNKS_ALLOC_MIN = 4;\n+\n+    //! Maximum number of chunks to allocate in one block\n+    static constexpr size_t NUM_CHUNKS_ALLOC_MAX = 16384;\n+\n+    // Counts list length by iterating until nullptr is reached.\n+    template <typename N>\n+    size_t CountNodes(N* node) const\n+    {\n+        size_t length = 0;\n+        while (node != nullptr) {\n+            node = node->next;\n+            ++length;\n+        }\n+        return length;\n+    }\n+\n+    /// Called when no memory is available (m_free_chunks == nullptr).\n+    void AllocateAndCreateFreelist()\n+    {\n+        auto num_chunks = CalcNumChunksToAlloc();\n+        auto data = ::operator new(sizeof(BlockNode) + m_chunk_size * num_chunks);\n+\n+        // link block into blocklist\n+        auto block = reinterpret_cast<BlockNode*>(data);\n+        block->next = m_blocks;\n+        m_blocks = block;\n+\n+        m_free_chunks = MakeFreelist(block, num_chunks);\n+    }\n+\n+    /// Doubles number of elements to alloc until max is reached.\n+    size_t CalcNumChunksToAlloc() noexcept\n+    {\n+        if (m_num_chunks_alloc >= NUM_CHUNKS_ALLOC_MAX) {\n+            return NUM_CHUNKS_ALLOC_MAX;\n+        }\n+        auto prev = m_num_chunks_alloc;\n+        m_num_chunks_alloc *= 2;\n+        return prev;\n+    }\n+\n+    /// Integrates a previously allocated block of memory (where n > 1) into the linked list\n+    ChunkNode* MakeFreelist(BlockNode* block, const size_t num_elements) noexcept\n+    {\n+        // skip BlockNode to get to the chunks\n+        auto const data = reinterpret_cast<char*>(block + 1);\n+\n+        // interlink all chunks\n+        for (size_t i = 0; i < num_elements; ++i) {\n+            reinterpret_cast<ChunkNode*>(data + i * m_chunk_size)->next = reinterpret_cast<ChunkNode*>(data + (i + 1) * m_chunk_size);\n+        }\n+\n+        // last one points nullptr\n+        reinterpret_cast<ChunkNode*>(data + (num_elements - 1) * m_chunk_size)->next = nullptr;\n+        return reinterpret_cast<ChunkNode*>(data);\n+    }\n+\n+    //! A single linked list of all data available in the pool. This list is used for allocations of single elements.\n+    ChunkNode* m_free_chunks{nullptr};\n+\n+    //! A single linked list of all allocated blocks of memory, used to free the data in the destructor.\n+    BlockNode* m_blocks{nullptr};\n+\n+    //! The pool's size for the memory blocks. First call to Allocate() determines the used size.\n+    size_t m_chunk_size{0};\n+\n+    //! Number of elements to allocate in bulk. Doubles each time, until m_max_num_allocs is reached.\n+    size_t m_num_chunks_alloc{NUM_CHUNKS_ALLOC_MIN};\n+};\n+\n+/// Allocator that's usable for node-based containers like std::unorderd_map or std::list. It requires a Pool\n+/// which will be used for allocations of n==1. The pool's memory is only actually freed when the pool's\n+/// destructor is called, otherwise previously allocated memory will be put back into the pool for further use.\n+///\n+/// Be aware that this allocator assumes that the containers will call allocate(1) to allocate nodes, otherwise\n+/// the pool won't be used. Also, it assumes that the *first* call to allocate(1) is done with the actual node\n+/// size. Only subsequent allocate(1) calls with the same sizeof(T) will make use of the allocator.\n+template <typename T>\n+class Allocator\n+{\n+    template <typename U>\n+    friend class Allocator;\n+\n+    template <typename X, typename Y>\n+    friend bool operator==(const Allocator<X>& a, const Allocator<Y>& b) noexcept;\n+\n+public:\n+    using value_type = T;\n+\n+    //! Note: when two containers a and b have different pools and a=b is called, we replace a's allocator with b's.\n+    using propagate_on_container_copy_assignment = std::true_type;\n+    using propagate_on_container_move_assignment = std::true_type;\n+    using propagate_on_container_swap = std::true_type;\n+    using pointer = T*;\n+    using const_pointer = const T*;\n+    using reference = T&;\n+    using const_reference = const T&;\n+    using size_type = size_t;\n+    using difference_type = std::ptrdiff_t;\n+\n+    template <typename U>\n+    struct rebind {\n+        using other = Allocator<U>;\n+    };\n+\n+    explicit Allocator(Pool* pool) noexcept\n+        : m_pool(pool)\n+    {\n+    }\n+\n+    /// Conversion constructor, all Allocators use the same pool.\n+    template <typename U>\n+    Allocator(const Allocator<U>& other) noexcept\n+        : m_pool(other.m_pool)\n+    {\n+    }\n+\n+    /// Allocates n entries. When n==1, the pool is used. The pool might return nullptr if sizeof(T)\n+    /// does not match the pool's chunk size. In that case, we fall back to new().\n+    /// This method should be kept short so it's easily inlineable.\n+    T* allocate(size_t n)\n+    {\n+        if (n == 1) {\n+            auto r = m_pool->Allocate<T>();\n+            if (r != nullptr) {\n+                return r;\n+            }\n+        }\n+        return reinterpret_cast<T*>(::operator new(n * sizeof(T)));\n+    }\n+\n+    /// If n==1, we might have gotten the object from the pool. This is not the case when sizeof(T) does\n+    /// not match the pool's chunk size. In that case, we fall back to delete().\n+    void deallocate(T* p, std::size_t n)\n+    {\n+        if (n == 1 && m_pool->Deallocate(p)) {\n+            return;\n+        }\n+        ::operator delete(p);\n+    }\n+\n+    /// Calls p->~U(). Only required for g++4.8",
      "path": "src/support/allocators/bulk_pool.h",
      "position": null,
      "original_position": 312,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "in_reply_to_id": 341272476,
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It seems only g++4.8 requires that this method is present, otherwise I get a compile error. It's deprecated in C++17 and removed in C++20. I'll add a comment for that.",
      "created_at": "2019-10-31T18:10:19Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341292940",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341292940"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 312,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341293993",
      "pull_request_review_id": 310086183,
      "id": 341293993,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI5Mzk5Mw==",
      "diff_hunk": "@@ -0,0 +1,344 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+#define BITCOIN_SUPPORT_ALLOCATORS_BULK_POOL_H\n+\n+#include <cstddef>\n+#include <new>\n+#include <type_traits>\n+#include <utility>\n+\n+namespace bulk_pool {\n+\n+/// This pool allocates one object (memory block) at a time. The first call to allocate determine\n+/// the size of chunks in the pool. Subsequent calls with other types of different size will\n+/// return nullptr. It is designed for use in node-based container like std::unordered_map or\n+/// std::list, where most allocations are for 1 element. It allocates increasingly large blocks\n+/// of memory, and only deallocates at destruction.\n+///\n+/// The size of the allocated blocks are doubled until NUM_CHUNKS_ALLOC_MAX is reached. This way we\n+/// don't have too large an overhead for small pool usage, and still get efficiency for lots of\n+/// elements since number of mallocs() are very reduced. Also, less bookkeeping is necessary, so\n+/// it's more space efficient than allocating one chunk at a time.\n+///\n+/// Deallocate() does not actually free memory, but puts the data into a linked list which can then\n+/// be used for allocate() calls when 1 element is requested. The linked list is in place, reusing\n+/// the memory of the chunks.\n+///\n+/// Memory layout\n+///\n+///  m_blocks\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk3] // block 0\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk7] // block 1\n+///        :\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 12\n+///        v\n+///    [ BlockNode, chunk0, chunk1, ... chunk16383] // block 13\n+///        v\n+///      nullptr\n+///\n+/// m_free_chunks represents a singly linked list of all T's that have been deallocated.\n+class Pool\n+{\n+public:\n+    // Inplace linked list of all allocated blocks. Make sure it is aligned in such a way that whatever comes\n+    // after a BlockNode is correctly aligned.\n+    struct alignas(alignof(::max_align_t)) BlockNode {\n+        // make sure to align\n+        BlockNode* next;\n+    };\n+\n+    // Inplace linked list of the allocation chunks\n+    struct ChunkNode {\n+        ChunkNode* next;\n+    };\n+\n+    /// Explicitly specify the Pool's chunk size. It will only allocate chunks of this size, returning\n+    /// nullptr if a type of different size is specified. If set to 0, the first Allocate() call will\n+    /// determine the chunk size of the pool.\n+    explicit Pool(size_t chunk_size) noexcept\n+        : m_chunk_size(chunk_size)\n+    {\n+    }\n+\n+    /// Doesn't specify the chunk size, so it's determined by the first call to Allocate.\n+    Pool() = default;\n+\n+    // Don't allow moving/copying a pool, it's dangerous\n+    Pool(Pool&&) = delete;\n+    Pool& operator=(Pool&&) = delete;\n+    Pool(const Pool&) = delete;\n+    Pool& operator=(const Pool&) = delete;\n+\n+    /// Deallocates all allocated memory, even when Deallocate() was not yet called.\n+    ~Pool() noexcept\n+    {\n+        Destroy();\n+    }\n+\n+    /// Don't allow allocation for types that are smaller than a Node. This does not make sense\n+    /// because we need to fit a pointer into the memory.",
      "path": "src/support/allocators/bulk_pool.h",
      "position": 84,
      "original_position": 84,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "329754d4c33656b0d526aa456077f4667c6ecb11",
      "in_reply_to_id": 341266452,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Oh, I see. I didn't realize it would fall back to default operator new. Could mention that explicitly, but this is also fine.",
      "created_at": "2019-10-31T18:12:35Z",
      "updated_at": "2019-11-01T07:20:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341293993",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341293993"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": 83,
      "original_start_line": 83,
      "start_side": "RIGHT",
      "line": 84,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341607795",
      "pull_request_review_id": 310502054,
      "id": 341607795,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTYwNzc5NQ==",
      "diff_hunk": "@@ -215,10 +216,11 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * declared as \"const\".\n      */\n     mutable uint256 hashBlock;\n-    mutable CCoinsMap cacheCoins;\n+    mutable bulk_pool::Pool cacheCoinsPool{};",
      "path": "src/coins.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Given that the pool only grows and uses increasing memory over time, and that its lifetime is effectively the lifetime of the entire node, would it make sense to add some kind of garbage collection method for `CCoinsViewCache` that would free unneeded memory (maybe after finishing syncing, or after flushing, or on an interval, or from an RPC a user could call)?",
      "created_at": "2019-11-01T14:54:43Z",
      "updated_at": "2019-11-01T14:54:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341607795",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341607795"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 219,
      "original_line": 219,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341716163",
      "pull_request_review_id": 310647224,
      "id": 341716163,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTcxNjE2Mw==",
      "diff_hunk": "@@ -215,10 +216,11 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * declared as \"const\".\n      */\n     mutable uint256 hashBlock;\n-    mutable CCoinsMap cacheCoins;\n+    mutable bulk_pool::Pool cacheCoinsPool{};",
      "path": "src/coins.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "in_reply_to_id": 341607795,
      "user": {
        "login": "JeremyRubin",
        "id": 886523,
        "node_id": "MDQ6VXNlcjg4NjUyMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JeremyRubin",
        "html_url": "https://github.com/JeremyRubin",
        "followers_url": "https://api.github.com/users/JeremyRubin/followers",
        "following_url": "https://api.github.com/users/JeremyRubin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/JeremyRubin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/JeremyRubin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
        "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
        "repos_url": "https://api.github.com/users/JeremyRubin/repos",
        "events_url": "https://api.github.com/users/JeremyRubin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I have the following code for something i'm working on. It should be amortized cheap to call after every erase; you could also make it have different parameters during sync or after (e.g, always compact after sync, only compact if it's above 50MB free during sync).\r\n```c++\r\n static void resize_if_savings(CTxMemPoolEntry::relatives& relatives) {\r\n       assert(relatives.max_load_factor() == 1)\r\n       // If we're at 0, clear out the map\r\n       if (relatives.size() == 0) {\r\n           CTxMemPool::relatives tmp;\r\n           std::swap(tmp, relatives);\r\n           return;\r\n       }\r\n       // don't bother saving for small enough sets\r\n       // 19 buckets isn't very large, and fits in with the usual\r\n       // prime rehash policies\r\n       if (relatives.bucket_count() <= 19) return;\r\n       // don't bother rehashing if we're more than half full\r\n       const size_t full_size = relatives.bucket_count();\r\n       if (relatives.size() > full_size/2) return;\r\n   \r\n       CTxMemPool::relatives tmp{std::make_move_iterator(relatives.begin()), std::make_move_iterator(relatives.end()), relatives.size()};\r\n       std::swap(tmp, relatives);\r\n   }\r\n```",
      "created_at": "2019-11-01T19:16:23Z",
      "updated_at": "2019-11-01T19:16:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341716163",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341716163"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 219,
      "original_line": 219,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341808938",
      "pull_request_review_id": 310767991,
      "id": 341808938,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTgwODkzOA==",
      "diff_hunk": "@@ -215,10 +216,11 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * declared as \"const\".\n      */\n     mutable uint256 hashBlock;\n-    mutable CCoinsMap cacheCoins;\n+    mutable bulk_pool::Pool cacheCoinsPool{};",
      "path": "src/coins.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "in_reply_to_id": 341607795,
      "user": {
        "login": "martinus",
        "id": 14386,
        "node_id": "MDQ6VXNlcjE0Mzg2",
        "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/martinus",
        "html_url": "https://github.com/martinus",
        "followers_url": "https://api.github.com/users/martinus/followers",
        "following_url": "https://api.github.com/users/martinus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/martinus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/martinus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
        "organizations_url": "https://api.github.com/users/martinus/orgs",
        "repos_url": "https://api.github.com/users/martinus/repos",
        "events_url": "https://api.github.com/users/martinus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/martinus/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "@JeremyRubin that looks interesting. I think the `if (relatives.size() > full_size/2) return;` is a bit too aggressive though. For a hashmap uses doubling as resize strategy: if it has e.g. 256 elements and you add one it will double its size, and when you remove one element again it would already trigger the rehashing to decrease its size.",
      "created_at": "2019-11-02T12:06:34Z",
      "updated_at": "2019-11-02T12:06:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341808938",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341808938"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 219,
      "original_line": 219,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341826698",
      "pull_request_review_id": 310789614,
      "id": 341826698,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTgyNjY5OA==",
      "diff_hunk": "@@ -215,10 +216,11 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * declared as \"const\".\n      */\n     mutable uint256 hashBlock;\n-    mutable CCoinsMap cacheCoins;\n+    mutable bulk_pool::Pool cacheCoinsPool{};",
      "path": "src/coins.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "original_commit_id": "54ada87348dbaa963490547b342ce57b4249987e",
      "in_reply_to_id": 341607795,
      "user": {
        "login": "JeremyRubin",
        "id": 886523,
        "node_id": "MDQ6VXNlcjg4NjUyMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JeremyRubin",
        "html_url": "https://github.com/JeremyRubin",
        "followers_url": "https://api.github.com/users/JeremyRubin/followers",
        "following_url": "https://api.github.com/users/JeremyRubin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/JeremyRubin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/JeremyRubin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
        "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
        "repos_url": "https://api.github.com/users/JeremyRubin/repos",
        "events_url": "https://api.github.com/users/JeremyRubin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "On my system the rehash policy is the  prime less than double policy, which ensures that we have a growth factor < 2 for all resizes. So in the case of 256, we would first \"double\" to 503. Then we would be at 257/503 \"fullness\", where half would be 251. So we can remove up to 6 elements before triggering a re-hash. So the pathological cases are a bit more precise, see below:\r\n\r\n\r\nIf you're at exactly 251, then you add one, you double to 503, and then you can remove two before triggering a rehash (strict inequality). Let's say you choose to remove a third. Then you'll rehash to either 467 or 257 (implementations depending -- I believe it's usually 257 because we go to the smallest prime larger than N). That means you will need to remove down to 233 (~20 more elements) before triggering a rehash OR more likely ~125 elements. Let's say instead, if you add back another N, you won't trigger a rehash until you hit 467, so you can add back another ~215 elements before having to go again OR more likely, 7 elements.\r\n\r\nSo there is a case to be made that it's less than ideal, but it's not quite as bad given the primes.\r\n\r\nThere's also a case to be made (at least for the use cases I'm looking at) where you're usually in a streak of erases, followed by a streak of adds. So while it is possible to trigger the bad behavior, it's atypical.\r\n\r\nTherefore I don't actually think it's that bad to use half as the shrink test, given that it quickly gets us shrunk to a more than half full table.\r\n\r\nBut if we do a resize at, say, at n <= (buckets - (buckets/100)*54), and resize to (n + (n/100)*36), then we can always be able to add at least 36% after a resize and remove 1/(1 + 0.36*1.08) - 0.36 ~~ 36% more before resizing again.  (The ~1.08 more than 36% I think, is half the average overshoot prime to prime. This is not a great estimate but can be improved).",
      "created_at": "2019-11-02T21:34:04Z",
      "updated_at": "2019-11-02T21:34:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/16801#discussion_r341826698",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341826698"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/16801"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 219,
      "original_line": 219,
      "side": "RIGHT"
    }
  ]
}