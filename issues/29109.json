{
  "type": "issue",
  "issue": {
    "id": 2046743377,
    "node_id": "I_kwDOABII5855_tNR",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29109",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29109/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29109/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29109/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/29109",
    "number": 29109,
    "state": "open",
    "state_reason": null,
    "title": "Old wallet.dat: Error reading wallet database: keymeta found with unexpected path / All keys read correctly, but transaction data or address metadata may be missing or incorrect",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nWhen starting bitcoind with an old wallet (created July 2019, probably `v0.17.x` or `v0.18.x`) the log records 2 errors and one warning that are not self-explanatory.\r\n\r\nMight be related to #19051\n\n### Expected behaviour\n\nNo warning/errors are shown or the errors/warnings are more detailed as to what's going on.\n\n### Steps to reproduce\n\nRun v26.0 with a very old `wallet.dat` file. I wasn't able to reproduce this with a wallet.dat file created in `v0.12.x`, `v0.16.3` or `v0.18.x`. I'm not sure how to reproduce this without uploading the specific `wallet.dat` file (I'm not able to, sorry).\n\n### Relevant log output\n\n## Log from v26.0.0\r\n\r\n```\r\n2023-12-18T13:24:00Z Bitcoin Core version v26.0.0 (release build)\r\n2023-12-18T13:24:00Z Using the 'x86_shani(1way,2way)' SHA256 implementation\r\n2023-12-18T13:24:00Z Using RdSeed as an additional entropy source\r\n2023-12-18T13:24:00Z Using RdRand as an additional entropy source\r\n[..]\r\n2023-12-18T13:24:00Z Using at most 125 automatic connections (1024 file descriptors available)\r\n2023-12-18T13:24:00Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2023-12-18T13:24:00Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2023-12-18T13:24:00Z Script verification uses 7 additional threads\r\n2023-12-18T13:24:00Z scheduler thread start\r\n[..]\r\n2023-12-18T13:24:00Z Using wallet directory /home/foobar/.bitcoin\r\n2023-12-18T13:24:00Z init message: Verifying wallet(s)…\r\n2023-12-18T13:24:00Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n2023-12-18T13:24:00Z Using wallet /home/foobar/.bitcoin/wallet.dat\r\n2023-12-18T13:24:00Z BerkeleyEnvironment::Open: LogDir=/home/foobar/.bitcoin/database ErrorFile=/home/foobar/.bitcoin/db.log\r\n[..]\r\n2023-12-18T13:24:00Z init message: Loading block index…\r\n2023-12-18T13:24:00Z Assuming ancestors of block 00000000000000000001a0a448d6cf2546b06801389cc030b2b18c6491266815 have valid signatures.\r\n2023-12-18T13:24:00Z Setting nMinimumChainWork=000000000000000000000000000000000000000052b2559353df4117b7348b64\r\n2023-12-18T13:24:00Z Opening LevelDB in /home/foobar/.bitcoin/blocks/index\r\n2023-12-18T13:24:00Z Opened LevelDB successfully\r\n2023-12-18T13:24:00Z Using obfuscation key for /home/foobar/.bitcoin/blocks/index: 0000000000000000\r\n2023-12-18T13:24:03Z LoadBlockIndexDB: last block file = 3945\r\n2023-12-18T13:24:03Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=51, size=84327429, heights=817322...817411, time=2023-11-18...2023-11-19)\r\n2023-12-18T13:24:03Z Checking all blk files are present...\r\n2023-12-18T13:24:04Z Initializing chainstate Chainstate [ibd] @ height -1 (null)\r\n2023-12-18T13:24:04Z Opening LevelDB in /home/foobar/.bitcoin/chainstate\r\n2023-12-18T13:24:04Z Opened LevelDB successfully\r\n2023-12-18T13:24:04Z Using obfuscation key for /home/foobar/.bitcoin/chainstate: 9735fc6504867afd\r\n2023-12-18T13:24:04Z Loaded best chain: hashBestChain=0000000000000000000290f359a90a5d57160fd27954703351c6f1bf838941e0 height=816997 date=2023-11-16T10:24:28Z progress=0.983619\r\n2023-12-18T13:24:04Z Opening LevelDB in /home/foobar/.bitcoin/chainstate\r\n2023-12-18T13:24:04Z Opened LevelDB successfully\r\n2023-12-18T13:24:04Z Using obfuscation key for /home/foobar/.bitcoin/chainstate: 9735fc6504867afd\r\n2023-12-18T13:24:04Z [Chainstate [ibd] @ height 816997 (0000000000000000000290f359a90a5d57160fd27954703351c6f1bf838941e0)] resized coinsdb cache to 8.0 MiB\r\n2023-12-18T13:24:04Z [Chainstate [ibd] @ height 816997 (0000000000000000000290f359a90a5d57160fd27954703351c6f1bf838941e0)] resized coinstip cache to 440.0 MiB\r\n2023-12-18T13:24:04Z init message: Verifying blocks…\r\n2023-12-18T13:24:04Z Verifying last 6 blocks at level 3\r\n2023-12-18T13:24:04Z Verification progress: 0%\r\n2023-12-18T13:24:05Z Verification progress: 16%\r\n2023-12-18T13:24:05Z Verification progress: 33%\r\n2023-12-18T13:24:05Z Verification progress: 50%\r\n2023-12-18T13:24:05Z Verification progress: 66%\r\n2023-12-18T13:24:05Z Verification progress: 83%\r\n2023-12-18T13:24:06Z Verification progress: 99%\r\n2023-12-18T13:24:06Z Verification: No coin database inconsistencies in last 6 blocks (26158 transactions)\r\n2023-12-18T13:24:06Z  block index            5148ms\r\n2023-12-18T13:24:06Z init message: Loading wallet…\r\n2023-12-18T13:24:06Z BerkeleyEnvironment::Open: LogDir=/home/foobar/.bitcoin/database ErrorFile=/home/foobar/.bitcoin/db.log\r\n2023-12-18T13:24:06Z [default wallet] Wallet file version = 10500, last client version = 220000\r\n\r\n2023-12-18T13:24:06Z [default wallet] Error reading wallet database: keymeta found with unexpected path\r\n2023-12-18T13:24:06Z [default wallet] Error reading wallet database: keymeta found with unexpected path\r\n\r\n2023-12-18T13:24:06Z [default wallet] Legacy Wallet Keys: 657 plaintext, 0 encrypted, 657 w/ metadata, 657 total.\r\n2023-12-18T13:24:06Z [default wallet] Descriptors: 0, Descriptor Keys: 0 plaintext, 0 encrypted, 0 total.\r\n2023-12-18T13:24:06Z [default wallet] Wallet completed loading in               8ms\r\n2023-12-18T13:24:06Z [default wallet] setKeyPool.size() = 600\r\n2023-12-18T13:24:06Z [default wallet] mapWallet.size() = 51\r\n2023-12-18T13:24:06Z [default wallet] m_address_book.size() = 100\r\n\r\n2023-12-18T13:24:06Z Warning: Error reading /home/foobar/.bitcoin/wallet.dat! All keys read correctly, but transaction data or address metadata may be missing or incorrect.\r\n\r\n2023-12-18T13:24:06Z Setting NODE_NETWORK on non-prune mode\r\n2023-12-18T13:24:06Z block tree size = 821776\r\n2023-12-18T13:24:06Z nBestHeight = 816997\r\n2023-12-18T13:24:06Z initload thread start\r\n2023-12-18T13:24:06Z torcontrol thread start\r\n2023-12-18T13:24:06Z Imported mempool transactions from disk: 0 succeeded, 0 failed, 0 expired, 0 already there, 0 waiting for initial broadcast\r\n2023-12-18T13:24:06Z initload thread exit\r\n2023-12-18T13:24:06Z Bound to 127.0.0.1:8334\r\n2023-12-18T13:24:06Z Bound to [::]:8333\r\n2023-12-18T13:24:06Z Bound to 0.0.0.0:8333\r\n2023-12-18T13:24:06Z Loaded 1 addresses from \"anchors.dat\"\r\n2023-12-18T13:24:06Z 1 block-relay-only anchors will be tried for connections.\r\n2023-12-18T13:24:06Z init message: Starting network threads…\r\n[..]\r\n```\r\n\r\n## Log from v25.1.0\r\n\r\nThe error/warning is slightly different.\r\n\r\nInstead of\r\n\r\n> Warning: Error reading /home/foobar/.bitcoin/wallet.dat! All keys read correctly, but transaction data or address metadata may be missing or incorrect.\r\n\r\nit logs\r\n\r\n> Warning: Error reading /home/foobar/.bitcoin/wallet.dat! All keys read correctly, but transaction data or address book entries might be missing or incorrect.\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\nv26.0\n\n### Operating system and version\n\nUbuntu 22.04 LTS\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "c0deright",
      "id": 20477825,
      "node_id": "MDQ6VXNlcjIwNDc3ODI1",
      "avatar_url": "https://avatars.githubusercontent.com/u/20477825?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/c0deright",
      "html_url": "https://github.com/c0deright",
      "followers_url": "https://api.github.com/users/c0deright/followers",
      "following_url": "https://api.github.com/users/c0deright/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/c0deright/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/c0deright/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/c0deright/subscriptions",
      "organizations_url": "https://api.github.com/users/c0deright/orgs",
      "repos_url": "https://api.github.com/users/c0deright/repos",
      "events_url": "https://api.github.com/users/c0deright/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/c0deright/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 1,
    "created_at": "2023-12-18T14:06:32Z",
    "updated_at": "2023-12-18T19:42:50Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1861029919,
      "node_id": "IC_kwDOABII585u7RAf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1861029919",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-18T16:48:51Z",
      "updated_at": "2023-12-18T19:42:50Z",
      "author_association": "MEMBER",
      "body": "The specific thing causing this error would be the lines:\r\n\r\n```\r\n2023-12-18T13:24:06Z [default wallet] Error reading wallet database: keymeta found with unexpected path\r\n2023-12-18T13:24:06Z [default wallet] Error reading wallet database: keymeta found with unexpected path\r\n```\r\n\r\nThis means that the stored metadata entries for a 2 keys has derivation paths of an unexpected length (`!= 3`). This error should be benign, although I think it's also erroneous since I'm pretty sure it is possible to import keys with derivation path information that would not match the standard pattern the loading code is checking for. \r\n\r\nEdit: Actually, such imports would not reach this code. Rather the only way that it is possible to get these errors is if that wallet got corrupted.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29109#issuecomment-1861029919",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29109"
    }
  ]
}