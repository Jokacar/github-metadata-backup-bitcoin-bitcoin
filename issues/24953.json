{
  "type": "issue",
  "issue": {
    "id": 1213267267,
    "node_id": "I_kwDOABII585IUP1D",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/24953",
    "number": 24953,
    "state": "closed",
    "state_reason": "completed",
    "title": "fs::create_directories causes crashes in multiple places when lacking write permission",
    "body": "**Expected behavior**\r\n\r\nI expected for the program to keep executing, or to shutdown gracefully, after having displayed and/or logged messages/warnings telling me that write permissions are lacking on the involved filesystem resources. This can affect attempting to write to directories outside of the normal bitcoin data directory and/or blocks directory, as seen in my second example below. The nastier crashes are like the ones in the GUI settings that could happen concurrent to data modification. Those could lead to data corruption when files are not flushed, and/or data gets out of synch.\r\n\r\n**Actual behavior**\r\n\r\nThe program logged a runaway exception and immediately aborted.\r\n\r\n**To reproduce**\r\n\r\nThis can be reproduced in multiple ways since there are many references to `fs::create_directories`. Also, crashes can result from restrictive `umask` settings too since some calls attempt to create directories multiple levels deep.\r\n\r\nHere are two easy ways:\r\n\r\n1. bitcoind \"-blocksdir not writable\"\r\n    1. start with the command line: `mkdir /tmp/blocks && chmod 0500 /tmp/blocks && ./src/bitcoind -blocksdir=/tmp/blocks`\r\n    2. the program will immediately crash with this logged in the console:\r\n```\r\n************************\r\nEXCEPTION: NSt10filesystem7__cxx1116filesystem_errorE       \r\nfilesystem error: cannot create directories: Permission denied [/tmp/blocks/blocks]       \r\nbitcoin in AppInit()\r\n```\r\n2. bitcoin-qt \"Start Bitcoin Core on system login\r\n    1. start with the command line: `mkdir -p /tmp/btc && mkdir -p /tmp/crash && chmod 0500 /tmp/crash && XDG_CONFIG_HOME=/tmp/crash ./src/qt/bitcoin-qt -debug -datadir=/tmp/btc -connect=0`\r\n    4. in the GUI go to the `Settings` menu and select `Options...`\r\n    5. check `Start Bitcoin Core on system login`\r\n![settings](https://user-images.githubusercontent.com/6440430/164890624-f335ed11-96c1-460a-b6eb-7204c079b3d9.png)\r\n    6. click OK. you will be presented with the exception as:\r\n![exception](https://user-images.githubusercontent.com/6440430/164890658-393a5303-6924-494c-a955-a3f2cc2d870c.png)\r\n    7. the console will show:\r\n```\r\n************************\r\nEXCEPTION: NSt10filesystem7__cxx1116filesystem_errorE       \r\nfilesystem error: cannot create directories: Permission denied [/tmp/crash/autostart]       \r\nbitcoin in Runaway exception       \r\n\r\nbitcoin-qt: ./checkqueue.h:204: CCheckQueue<T>::~CCheckQueue() [with T = CScriptCheck]: Assertion `m_worker_threads.empty()' failed.\r\nAborted (core dumped)\r\n```\r\n\r\n**System information**\r\n\r\nThis affects current master branch as of at least be7a5f2fc400e7a3ef72dedbdcf49dd6c96d4f9e. Tested on Ubuntu 21.10.\r\n",
    "user": {
      "login": "mruddy",
      "id": 6440430,
      "node_id": "MDQ6VXNlcjY0NDA0MzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mruddy",
      "html_url": "https://github.com/mruddy",
      "followers_url": "https://api.github.com/users/mruddy/followers",
      "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
      "organizations_url": "https://api.github.com/users/mruddy/orgs",
      "repos_url": "https://api.github.com/users/mruddy/repos",
      "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/mruddy/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 241832923,
        "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
        "name": "Utils/log/libs",
        "description": "",
        "color": "5319e7",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": true,
    "comments": 2,
    "closed_at": "2022-06-09T12:26:14Z",
    "created_at": "2022-04-23T10:36:53Z",
    "updated_at": "2023-06-09T10:05:37Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 6483912457,
      "node_id": "LE_lADOABII585IUP1DzwAAAAGCeKcJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6483912457",
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T10:36:53Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "commented",
      "id": 1107468841,
      "node_id": "IC_kwDOABII585CAqIp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107468841",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T13:05:47Z",
      "updated_at": "2022-04-23T13:08:55Z",
      "author_association": "MEMBER",
      "body": "I wouldn't consider these as bugs. The error, and even the cause of the error \"permission denied\" is logged or printed, right? Sure, messages could always be nicer, but there's an infinite amount of things that can be wrong with the file system, or underlying assumptions that could be broken, it's not possible to special-case all of them.\r\n\r\nEdit: though I have to admit this unrelated assertion error is a bit strange:\r\n```\r\nbitcoin-qt: ./checkqueue.h:204: CCheckQueue<T>::~CCheckQueue() [with T = CScriptCheck]: Assertion `m_worker_threads.empty()' failed.\r\nAborted (core dumped)\r\n```",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/24953#issuecomment-1107468841",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953"
    },
    {
      "event": "unlabeled",
      "id": 6484043852,
      "node_id": "UNLE_lADOABII585IUP1DzwAAAAGCeqhM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6484043852",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T13:06:20Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 6484043854,
      "node_id": "LE_lADOABII585IUP1DzwAAAAGCeqhO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6484043854",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T13:06:20Z",
      "label": {
        "name": "Utils/log/libs",
        "color": "5319e7"
      }
    },
    {
      "event": "labeled",
      "id": 6484043855,
      "node_id": "LE_lADOABII585IUP1DzwAAAAGCeqhP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6484043855",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T13:06:20Z",
      "label": {
        "name": "Data corruption",
        "color": "f7c6c7"
      }
    },
    {
      "event": "unlabeled",
      "id": 6484044375,
      "node_id": "UNLE_lADOABII585IUP1DzwAAAAGCeqpX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6484044375",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T13:06:45Z",
      "label": {
        "name": "Data corruption",
        "color": "f7c6c7"
      }
    },
    {
      "event": "commented",
      "id": 1107478420,
      "node_id": "IC_kwDOABII585CAseU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107478420",
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-23T14:12:19Z",
      "updated_at": "2022-04-23T14:12:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "I think the 2nd example (the one in the GUI) is a good example that this is a bug because: 1) the crash can cause data loss, 2) it goes beyond the scope of thinking that everything in the data directory has to be writable by the node because it deals with a directory outside of the bitcoin node's data directory. For that one, if you don't set the env var `XDG_CONFIG_HOME`, like I did to make the test easily reproducible and lightweight, then the default will try to create `$HOME/.config/autostart`, if it does not exist. If this ends up not being considered a bug, then we should definitely document that having write permissions available on `$HOME/.config` is a prereq for bitcoin-qt to not crash suddenly.",
      "user": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/24953#issuecomment-1107478420",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/24953"
    },
    {
      "event": "referenced",
      "id": 6506355081,
      "node_id": "REFE_lADOABII585IUP1DzwAAAAGDzxmJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6506355081",
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "0d9e61a8d9828db8baf258362579578abf1f8053",
      "commit_url": "https://api.github.com/repos/mruddy/bitcoin/commits/0d9e61a8d9828db8baf258362579578abf1f8053",
      "created_at": "2022-04-27T11:53:48Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-27T12:05:47Z",
      "updated_at": "2022-04-27T12:05:47Z",
      "source": {
        "issue": {
          "id": 1217258146,
          "node_id": "PR_kwDOABII58423q78",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25000",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25000/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25000/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25000/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/25000",
          "number": 25000,
          "state": "closed",
          "state_reason": null,
          "title": "gui: avoid unclean exit due to permissions issues when setting start on system startup",
          "body": "Closes #24953\r\n\r\nThis remedies two cases where the GUI can cause the process to exit in an unclean manner. These two cases are cases where the directory path causing the exception is likely/usually not under the node's data and/or blocks directory and thus could be more likely to lack write permissions.\r\n\r\nInstead of abruptly exiting the process, this path instead makes log entries such as:\r\n\r\n```\r\n2022-04-27T11:43:03Z failed to create autostart directory: filesystem error: cannot create directories: Permission denied [/tmp/crash/autostart]\r\n```\r\n\r\n```\r\n2022-04-27T11:44:05Z failed to remove autostart file: filesystem error: cannot remove: Permission denied [/tmp/crash/autostart/bitcoin.desktop]\r\n```\r\n\r\nthe command line used to test and create the above log entries (with this patch applied) was:\r\n```\r\nmkdir -p /tmp/btc && mkdir -p /tmp/crash && chmod 0500 /tmp/crash && XDG_CONFIG_HOME=/tmp/crash ./src/qt/bitcoin-qt -debug -datadir=/tmp/btc -connect=0\r\n```\r\n\r\nThe short/easy process to generate the exception is noted in the original issue.\r\n\r\nThis PR does not address the other cases where `fs::create_directories` may create an unclean exit due to the reasoning that the other cases are generated by paths under the blocks and/or data directories and those directories need to be writable by the bitcoin process, or lots of things fail. This is a targeted PR to avoid a couple of unique recoverable situations.",
          "user": {
            "login": "mruddy",
            "id": 6440430,
            "node_id": "MDQ6VXNlcjY0NDA0MzA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mruddy",
            "html_url": "https://github.com/mruddy",
            "followers_url": "https://api.github.com/users/mruddy/followers",
            "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
            "organizations_url": "https://api.github.com/users/mruddy/orgs",
            "repos_url": "https://api.github.com/users/mruddy/repos",
            "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/mruddy/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "comments": 2,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/25000",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/25000",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/25000.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/25000.patch"
          },
          "closed_at": "2022-04-27T12:10:33Z",
          "created_at": "2022-04-27T12:05:47Z",
          "updated_at": "2023-04-27T09:57:24Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-04-27T12:35:44Z",
      "updated_at": "2022-04-27T12:35:44Z",
      "source": {
        "issue": {
          "id": 1217292314,
          "node_id": "PR_kwDOEEET9c423yTS",
          "url": "https://api.github.com/repos/bitcoin-core/gui/issues/595",
          "repository_url": "https://api.github.com/repos/bitcoin-core/gui",
          "labels_url": "https://api.github.com/repos/bitcoin-core/gui/issues/595/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin-core/gui/issues/595/comments",
          "events_url": "https://api.github.com/repos/bitcoin-core/gui/issues/595/events",
          "html_url": "https://github.com/bitcoin-core/gui/pull/595",
          "number": 595,
          "state": "closed",
          "state_reason": null,
          "title": "Avoid unclean exit due to permissions issues when setting start on system startup",
          "body": "moving https://github.com/bitcoin/bitcoin/pull/25000 to this repo\r\n\r\nCloses https://github.com/bitcoin/bitcoin/issues/24953\r\n\r\nThis remedies two cases where the GUI can cause the process to exit in an unclean manner. These two cases are cases where the directory path causing the exception is likely/usually not under the node's data and/or blocks directory and thus could be more likely to lack write permissions.\r\n\r\nInstead of abruptly exiting the process, this patch instead makes log entries such as:\r\n\r\n```\r\n2022-04-27T11:43:03Z failed to create autostart directory: filesystem error: cannot create directories: Permission denied [/tmp/crash/autostart]\r\n```\r\n\r\n```\r\n2022-04-27T11:44:05Z failed to remove autostart file: filesystem error: cannot remove: Permission denied [/tmp/crash/autostart/bitcoin.desktop]\r\n```\r\n\r\nthe command line used to test and create the above log entries (with this patch applied) was:\r\n```\r\nmkdir -p /tmp/btc && mkdir -p /tmp/crash && chmod 0500 /tmp/crash && XDG_CONFIG_HOME=/tmp/crash ./src/qt/bitcoin-qt -debug -datadir=/tmp/btc -connect=0\r\n```\r\n\r\nThe short/easy process to generate the exception is noted in the original issue.\r\n\r\nThis PR does not address the other cases where `fs::create_directories` may create an unclean exit due to the reasoning that the other cases are generated by paths under the blocks and/or data directories and those directories need to be writable by the bitcoin process, or lots of things fail. This is a targeted PR to avoid a couple of unique recoverable situations.",
          "user": {
            "login": "mruddy",
            "id": 6440430,
            "node_id": "MDQ6VXNlcjY0NDA0MzA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mruddy",
            "html_url": "https://github.com/mruddy",
            "followers_url": "https://api.github.com/users/mruddy/followers",
            "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
            "organizations_url": "https://api.github.com/users/mruddy/orgs",
            "repos_url": "https://api.github.com/users/mruddy/repos",
            "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/mruddy/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 2140649117,
              "node_id": "MDU6TGFiZWwyMTQwNjQ5MTE3",
              "url": "https://api.github.com/repos/bitcoin-core/gui/labels/Bug",
              "name": "Bug",
              "description": "Something isn't working",
              "color": "d73a4a",
              "default": false
            },
            {
              "id": 2793865191,
              "node_id": "MDU6TGFiZWwyNzkzODY1MTkx",
              "url": "https://api.github.com/repos/bitcoin-core/gui/labels/Linux",
              "name": "Linux",
              "description": "",
              "color": "b60205",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "comments": 7,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin-core/gui/pulls/595",
            "html_url": "https://github.com/bitcoin-core/gui/pull/595",
            "diff_url": "https://github.com/bitcoin-core/gui/pull/595.diff",
            "patch_url": "https://github.com/bitcoin-core/gui/pull/595.patch"
          },
          "closed_at": "2022-06-09T12:25:27Z",
          "created_at": "2022-04-27T12:35:44Z",
          "updated_at": "2023-06-09T10:05:32Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "referenced",
      "id": 6655417518,
      "node_id": "REFE_lADOABII585IUP1DzwAAAAGMsZyu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6655417518",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "de8357419d49c6f304e33ea58d17cdeb13fd09a9",
      "commit_url": "https://api.github.com/repos/luke-jr/bitcoin/commits/de8357419d49c6f304e33ea58d17cdeb13fd09a9",
      "created_at": "2022-05-21T21:51:49Z"
    },
    {
      "event": "referenced",
      "id": 6656725132,
      "node_id": "REFE_lADOABII585IUP1DzwAAAAGMxZCM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6656725132",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "4d5beb29126b7933d48453d330e42bf04483dfe6",
      "commit_url": "https://api.github.com/repos/bitcoinknots/bitcoin/commits/4d5beb29126b7933d48453d330e42bf04483dfe6",
      "created_at": "2022-05-22T22:30:25Z"
    },
    {
      "event": "closed",
      "id": 6777509908,
      "node_id": "CE_lADOABII585IUP1DzwAAAAGT-JgU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6777509908",
      "actor": {
        "login": "mruddy",
        "id": 6440430,
        "node_id": "MDQ6VXNlcjY0NDA0MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6440430?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mruddy",
        "html_url": "https://github.com/mruddy",
        "followers_url": "https://api.github.com/users/mruddy/followers",
        "following_url": "https://api.github.com/users/mruddy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mruddy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mruddy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mruddy/subscriptions",
        "organizations_url": "https://api.github.com/users/mruddy/orgs",
        "repos_url": "https://api.github.com/users/mruddy/repos",
        "events_url": "https://api.github.com/users/mruddy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mruddy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-09T12:26:14Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-06-22T17:21:54Z",
      "updated_at": "2022-06-22T17:21:54Z",
      "source": {
        "issue": {
          "id": 1280592042,
          "node_id": "I_kwDOABII585MVEiq",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25448",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25448/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25448/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25448/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/25448",
          "number": 25448,
          "state": "open",
          "state_reason": null,
          "title": "~CCheckQueue assertion failure during unclean exits",
          "body": "For testing, I am using this:\r\n```diff\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -2102,6 +2102,7 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\r\n void CWallet::CommitTransaction(CTransactionRef tx, mapValue_t mapValue, std::vector<std::pair<std::string, std::string>> orderForm)\r\n {\r\n     LOCK(cs_wallet);\r\n+    throw std::runtime_error(std::string(__func__) + \": Wallet db error, transaction commit failed\");\r\n     WalletLogPrintf(\"CommitTransaction:\\n%s\", tx->ToString()); /* Continued */\r\n \r\n     // Add tx to wallet, because if it has change it's also ours,\r\n```\r\n\r\nTo trigger it, you have to attempt to send a transaction.\r\n\r\nThis correctly displays an error dialog, then exits with:\r\n```\r\n************************\r\nEXCEPTION: St13runtime_error       \r\nCommitTransaction: Wallet db error, transaction commit failed       \r\nbitcoin in QPushButton->SendCoinsDialog       \r\n\r\nbitcoin-qt: ./checkqueue.h:204: CCheckQueue<CScriptCheck>::~CCheckQueue() [T = CScriptCheck]: Assertion `m_worker_threads.empty()' failed.\r\nAborted\r\n```\r\n\r\nThis issue is related to the failed assertion during the unclean exit.",
          "user": {
            "login": "luke-jr",
            "id": 1095675,
            "node_id": "MDQ6VXNlcjEwOTU2NzU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/luke-jr",
            "html_url": "https://github.com/luke-jr",
            "followers_url": "https://api.github.com/users/luke-jr/followers",
            "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
            "organizations_url": "https://api.github.com/users/luke-jr/orgs",
            "repos_url": "https://api.github.com/users/luke-jr/repos",
            "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/luke-jr/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 64585,
              "node_id": "MDU6TGFiZWw2NDU4NQ==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
              "name": "Bug",
              "color": "FBBAAB",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 4,
          "created_at": "2022-06-22T17:21:15Z",
          "updated_at": "2022-12-28T13:19:52Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "locked",
      "id": 9482743889,
      "node_id": "LOE_lADOABII585IUP1DzwAAAAI1NzBR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9482743889",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-09T10:05:37Z"
    }
  ]
}