{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516",
    "id": 1984244412,
    "node_id": "PR_kwDOABII5852RSq8",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30516",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30516.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30516.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/51f197bd84916c494e9250926776b9efc3225100",
    "number": 30516,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "Assumeutxo: Sanitize block height in metadata",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixes #30514 which has more context.\r\n\r\nThe block height in the assumeutxo metadata was implicitly cast to `int` which could cause it to be interpreted as signed.\r\n\r\nThe first commit shows how to reproduce the error shown in #30514 and how it could be fixed with a minimal change. The second commit adds an explicit sanitizer that will probably be the preferred approach. I can squash the commits but first I would like to hear conceptual feedback since #30514 suggested to remove the block height instead.",
    "labels": [],
    "created_at": "2024-07-23T22:21:32Z",
    "updated_at": "2024-08-07T09:31:29Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "602974a75b98bd3ee53407ec6ee9725f6199b429",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "fjahr:2024-07-au-blockheight-san",
      "ref": "2024-07-au-blockheight-san",
      "sha": "51f197bd84916c494e9250926776b9efc3225100",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 196253948,
        "node_id": "MDEwOlJlcG9zaXRvcnkxOTYyNTM5NDg=",
        "name": "bitcoin",
        "full_name": "fjahr/bitcoin",
        "owner": {
          "login": "fjahr",
          "id": 1322187,
          "node_id": "MDQ6VXNlcjEzMjIxODc=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/fjahr",
          "html_url": "https://github.com/fjahr",
          "followers_url": "https://api.github.com/users/fjahr/followers",
          "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
          "organizations_url": "https://api.github.com/users/fjahr/orgs",
          "repos_url": "https://api.github.com/users/fjahr/repos",
          "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/fjahr/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/fjahr/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/fjahr/bitcoin",
        "archive_url": "https://api.github.com/repos/fjahr/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/fjahr/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/fjahr/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/fjahr/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/fjahr/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/fjahr/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/fjahr/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/fjahr/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/fjahr/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/fjahr/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/fjahr/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/fjahr/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/fjahr/bitcoin/events",
        "forks_url": "https://api.github.com/repos/fjahr/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/fjahr/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/fjahr/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/fjahr/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/fjahr/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/fjahr/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/fjahr/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/fjahr/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/fjahr/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/fjahr/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/fjahr/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/fjahr/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/fjahr/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/fjahr/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/fjahr/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/fjahr/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:fjahr/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/fjahr/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/fjahr/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/fjahr/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/fjahr/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/fjahr/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/fjahr/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/fjahr/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/fjahr/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/fjahr/bitcoin/hooks",
        "svn_url": "https://github.com/fjahr/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 252127,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-08-06T22:50:24Z",
        "created_at": "2019-07-10T18:11:06Z",
        "updated_at": "2024-07-23T22:14:45Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "7cc00bfc86b4dece2e3baef5b12e910d79c822a1",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35964,
        "stargazers_count": 77761,
        "watchers_count": 77761,
        "size": 265076,
        "default_branch": "master",
        "open_issues_count": 660,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-08-07T09:20:53Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-08-07T07:54:47Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 11,
    "deletions": 1,
    "changed_files": 3,
    "commits": 2,
    "review_comments": 3,
    "comments": 5
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk4ZTExOWRhMzVjNGY3ZTc0ZjBjNDIzOTc0ZDQ5N2UzNTBjOGU5ZmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/98e119da35c4f7e74f0c423974d497e350c8e9fa",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/98e119da35c4f7e74f0c423974d497e350c8e9fa",
      "tree": {
        "sha": "71aa4ca3c55abf32a67cc38dfe3a3df98a46e5a4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/71aa4ca3c55abf32a67cc38dfe3a3df98a46e5a4"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 71aa4ca3c55abf32a67cc38dfe3a3df98a46e5a4\nparent 7cc00bfc86b4dece2e3baef5b12e910d79c822a1\nauthor Fabian Jahr <fjahr@protonmail.com> 1721771955 +0200\ncommitter Fabian Jahr <fjahr@protonmail.com> 1721771955 +0200\n\nAssumeutxo: Fix implicit conversion of block height and add test\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmagJ7MVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNbEEP/14hva1rtj3aHtFx7cDptp4PLkcY\nBUMmIl/7WpmosIfft0VO1PE5jQBDuuHObBoJmCuHYuV7KVxrJ7PRQwPG6evMpwUS\nKI2N/sxXn0Yvd0Ss68YnpZJ2zz0U7vulI6hsm6oYZBrTXn4ss+XPwGH1aYF9Ufqz\nXefRIGsxVFkckHNoBt4AIDxglRySUC+fCdkTgJvWnbxBAornnvZl4SePFZsR8/eA\n68D2cpqcch+nrz1jyeZABIjBnSvfETnVmeummZCT+8I8zNIU1YxRC01dIJIbb6ZD\n/2sOzqVaEOPTVwU6MleHw1Kb2fykigpR+D6yjPV2krxOFpNZwO6M1FOfxE0FgOsI\n+xAVLZT3nZbnZ8FT7EQP+gw1FSn2iYSDGIpoqoF4RvzpoE2RfCK6bIT9xxudFGs0\nXYa8miFb3FdbEk5rHIs428oIFJjSMQX27OrvEl30TuQY2LxL+uUIXt8GRYm4i016\n7y6WJ33VzTnGutnmyQehtwvNiem7mO/goTqNWWEm/AFl3FxZTGlBg3g89dMMXLJM\n0JBMp9OD+CUAO4cTkOjIl67v8G6WV80MnK65o5P0f5WySeesTZrNy+YBMHw0smjL\nVuCIWWQrQBfdeZDSS8FbBl5Z5gpi+nIAZk1HW4jhC65ko54m6vm3AGWwF694miNl\nZpXolRvanHNKLoId\n=+MB6\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7cc00bfc86b4dece2e3baef5b12e910d79c822a1",
          "sha": "7cc00bfc86b4dece2e3baef5b12e910d79c822a1",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7cc00bfc86b4dece2e3baef5b12e910d79c822a1"
        }
      ],
      "message": "Assumeutxo: Fix implicit conversion of block height and add test",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-07-23T21:59:15Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-07-23T21:59:15Z"
      },
      "sha": "98e119da35c4f7e74f0c423974d497e350c8e9fa"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUxZjE5N2JkODQ5MTZjNDk0ZTkyNTA5MjY3NzZiOWVmYzMyMjUxMDA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/51f197bd84916c494e9250926776b9efc3225100",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/51f197bd84916c494e9250926776b9efc3225100",
      "tree": {
        "sha": "863649af79da342fe49ead6b4b268157fef2f21d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/863649af79da342fe49ead6b4b268157fef2f21d"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 863649af79da342fe49ead6b4b268157fef2f21d\nparent 98e119da35c4f7e74f0c423974d497e350c8e9fa\nauthor Fabian Jahr <fjahr@protonmail.com> 1721772802 +0200\ncommitter Fabian Jahr <fjahr@protonmail.com> 1721772802 +0200\n\nAssumeutxo: Sanitize block height in assumeutxo metadata\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmagKwMVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNJLYQAKLrbwSy1yowh18VtWFSgDjHh/u2\n1KSVGXUDP7VnOpqreOG51RyzhyLsdwM3NTB3a+IZpvccpI0NxHzB+M31FzT677Ff\n7ZP+ZXkvNHxrPQ6BY13HiL89FcdnPdJI+e3G620aDKFtR7HkK7tfX08nH7pcVIei\nXnI+wloYk41tYDlAibTEqz/fN7rKvG4ckqLd7b0Ryl4TWQmIvmbpFRDk6BP5TW8T\nRPwqLJsF/mpl1ZAG6RqznuAAFn39Qawolwei2+loshPm5hVAqqPejXfH9IJhne4Q\noSDeQEdGdNny7AL78ow2OJrK40QDHX3XIoGaBohubiTREWogToAIsAQqOoe7Berd\nHMRgkaIzuL0PFUNVMZKRxF/5tVZToHb10q8Q2iSPgZtMHOlawA9O2JzBefldcEXw\nogWX92RFo41X2V9quWrMHVRn07Hb61rCu31dtxFgF7EJOFsd7SZnatNc5vI+ROa8\nqdJAJaaeGbS5N1w9R0AnY3Sp7UDK+evD9zyOohT4MzpimYLXef9rY6dwzE/51Yj/\nL6WsR5ro0f/CDbQW3kKiIKjRJ6blLbBWtg11SvcpTnENX4lKxjoE9L9RTY/peSH5\nMZ5kn00iD0/KCkIcGog+1wXDqGdqrmpLLS5s4PebM+bc5M44zFoG67TrktoJMHXS\nXnSu3jKJWMQQQGY0\n=CwIA\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/98e119da35c4f7e74f0c423974d497e350c8e9fa",
          "sha": "98e119da35c4f7e74f0c423974d497e350c8e9fa",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/98e119da35c4f7e74f0c423974d497e350c8e9fa"
        }
      ],
      "message": "Assumeutxo: Sanitize block height in assumeutxo metadata",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-07-23T22:13:22Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-07-23T22:13:22Z"
      },
      "sha": "51f197bd84916c494e9250926776b9efc3225100"
    },
    {
      "event": "commented",
      "id": 2246409155,
      "node_id": "IC_kwDOABII586F5XvD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2246409155",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-23T22:21:34Z",
      "updated_at": "2024-08-07T09:31:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30516).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30598](https://github.com/bitcoin/bitcoin/pull/30598) (assumeutxo: Drop block height from metadata by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#issuecomment-2246409155",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516"
    },
    {
      "event": "reviewed",
      "id": 2195659920,
      "node_id": "PRR_kwDOABII586C3xyQ",
      "url": null,
      "actor": null,
      "commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#pullrequestreview-2195659920",
      "submitted_at": "2024-07-24T05:19:22Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516"
    },
    {
      "event": "commented",
      "id": 2271764814,
      "node_id": "IC_kwDOABII586HaGFO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2271764814",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T17:14:48Z",
      "updated_at": "2024-08-06T17:14:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "From the issue:\r\n> The additional information can be helpful to us in certain failure cases, especially if we discuss issues like in #30288 seriously.\r\n\r\nHow? I could see how situations described in #30288 would require to add the block hash in a hypothetical scenario where we only saved the height - but we are in the reverse scenario where we already have the block hash, so I can't really think of a scenario where haveing the block height would help. I also didn't find any discussion about the reason for the block height in #29612 on a quick glance (but didn't expand every comment).",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#issuecomment-2271764814",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516"
    },
    {
      "event": "commented",
      "id": 2272254485,
      "node_id": "IC_kwDOABII586Hb9oV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2272254485",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T22:27:19Z",
      "updated_at": "2024-08-06T22:27:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "> How?\r\n\r\nThe height in the metadata clearly tells us which height the hash is expected at. Not having the same hash at that height clearly tells us that the node is on a different chain than was expected by the metadata. That is better than just saying \"we don't know this hash for whatever reason\".\r\n\r\n> I also didn't find any discussion about the reason for the block height in https://github.com/bitcoin/bitcoin/pull/29612 on a quick glance (but didn't expand every comment).\r\n\r\nIt was suggested [here](https://github.com/bitcoin/bitcoin/pull/29612#issuecomment-2039223974) and when I added it along with the other suggested values, all reviewers ACK-ed it.\r\n\r\n> An alternative would be to write a full file-content hash in the metadata as the second field (after the file magic), covering the whole file after the second field. This way, the file-content hash would be retrieved from the trusted chainparams, then calculated and compared. Afterwards, the code can assume that all fields in the checked file are trusted to some extent, which would allow using the block height value.\r\n\r\nDo you mean the serialized tx hash here? That's different from the file content hash. We do have the serialized hash in the trusted assumeutxo data but not the file hash. I don't think we want to have it in there because we want to force users of the data to calculate it themselves. And if there is a mismatch it's just the same as with the block height where it seems to be an issue for you that it may mismatch. Or are you arguing that the file hash should be added to the chainparams as well? It's unclear to me, honestly.\r\n\r\n> You'll have to check that the block height corresponds to the block hash, otherwise I fail to see how it can be used without adding bugs or risks or confusion. However, if you do the check, you may as well discard the deserialized value and just use the value from the check.\r\n\r\nThe block height is intended as additional information that can help users debug what the issue is, like the error message in the suggested change above where it is removed. It doesn't need to be checked for that. If the file is corrupt or the network is found in an unexpected state, it can be helpful as additional information as described above.\r\n\r\n> In an otherwise fully valid utxo snapshot dump, with a single bit flip in the block height field in the metadata, the error message for the user will not be: \"Corrupt metadata, block height corrupt\", but instead \"A forked headers-chain with more work than the chain with the snapshot base block header exists. Please proceed to sync without AssumeUtxo.\"\r\n\r\nI don't think it's fair criticism to say \"this is confusing when I introduce a magic bitflip in this exact place\". There are literally infinite places all over the code base where that is true and we won't get anywhere if this is the bar we need to meet. If I can just flip any bit in your block storage or utxo set, we are completely screwed and most importantly you probably wouldn't even see an error until it's too late while in the case discussed here, there is a failure right away (if we check) or there is no issue at all because the value is not used for anything critical as outlined before.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#issuecomment-2272254485",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516"
    },
    {
      "event": "commented",
      "id": 2272260642,
      "node_id": "IC_kwDOABII586Hb_Ii",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2272260642",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T22:32:10Z",
      "updated_at": "2024-08-06T22:32:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "The arguments here don't convince me yet that the height really has to be dropped necessarily but I also seem to be less passionate about this issue than @maflcko et al. So I opened the suggested approach of removing the block height in #30598 and I pinged other reviewers of the original metadata PR to weigh in shortly.\r\n\r\nUltimately what matters most to me is that we finally get this feature into the hands of users and I am fine to go along with either approach if it avoids further blocking of that.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#issuecomment-2272260642",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516"
    },
    {
      "event": "mentioned",
      "id": 13784577775,
      "node_id": "MEE_lADOABII586QnSrQzwAAAAM1n_bv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13784577775",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T22:32:11Z"
    },
    {
      "event": "subscribed",
      "id": 13784577786,
      "node_id": "SE_lADOABII586QnSrQzwAAAAM1n_b6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13784577786",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T22:32:11Z"
    },
    {
      "event": "commented",
      "id": 2272318013,
      "node_id": "IC_kwDOABII586HcNI9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2272318013",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-06T23:16:36Z",
      "updated_at": "2024-08-06T23:16:36Z",
      "author_association": "CONTRIBUTOR",
      "body": ">The height in the metadata clearly tells us which height the hash is expected at. Not having the same hash at that height clearly tells us that the node is on a different chain than was expected by the metadata. That is better than just saying \"we don't know this hash for whatever reason\".\r\n\r\nAh, ok, my point is that the height is implied by the block hash, together with the block index db of the node. If the block tree db doesn't contain a header with that block hash, then we abort anyway. If it contains the index but we don't have a registered snapshot for this height in the chainparams, we can look the attempted height up from the block index, e.g. for a user-facing error message.\r\nBut it should be impossible to construct an alternative block tree db where a block with the given hash is at a different height (unless you can break sha256...) so providing the height doesn't add any information in my opinion. ",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#issuecomment-2272318013",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30516"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1689146902",
      "pull_request_review_id": 2195659920,
      "id": 1689146902,
      "node_id": "PRRC_kwDOABII585krlYW",
      "diff_hunk": "@@ -99,6 +99,9 @@ class SnapshotMetadata\n         }\n \n         s >> m_base_blockheight;\n+        if (m_base_blockheight > static_cast<uint32_t>(std::numeric_limits<int>::max())) {\n+            throw std::ios_base::failure(\"Block height is out of range.\");\n+        }",
      "path": "src/node/utxo_snapshot.h",
      "position": 6,
      "original_position": 6,
      "commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "original_commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "in_reply_to_id": null,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The fix isn't enough. The file may be completely untrusted and corrupt, so just because the block height is a signed 32-bit, but positive integer, doesn't mean that the height is correct.\r\n\r\nYou'll have to check that the block height corresponds to the block hash, otherwise I fail to see how it can be used without adding bugs or risks or confusion. However, if you do the check, you may as well discard the deserialized value and just use the value from the check.\r\n\r\nSo again, my recommendation would be to remove it, because either:\r\n\r\n1) The value is untrusted, thus can not be used\r\n2) The value is checked, in which case it is redundant with the value from the check\r\n\r\n\r\nAn alternative would be to write a full file-content hash in the metadata as the second field (after the file magic), covering the whole file after the second field. This way, the file-content hash would be retrieved from the trusted chainparams, then calculated and compared. Afterwards the code can assume that all fields in the checked file are trusted to some extent, which would allow using the block height value.\r\n\r\nHowever, that is a more involved fix, so my recommendation for now would be to drop the value.\r\n\r\nSuggested diff:\r\n\r\n```diff\r\ndiff --git a/src/node/utxo_snapshot.h b/src/node/utxo_snapshot.h\r\nindex a7c4135787..bd5b68ba30 100644\r\n--- a/src/node/utxo_snapshot.h\r\n+++ b/src/node/utxo_snapshot.h\r\n@@ -28,16 +28,17 @@ class Chainstate;\r\n namespace node {\r\n //! Metadata describing a serialized version of a UTXO set from which an\r\n //! assumeutxo Chainstate can be constructed.\r\n+//! All metadata fields come from an untrusted file, so must be validated\r\n+//! before being used. Thus, new fields should be added only if needed.\r\n class SnapshotMetadata\r\n {\r\n-    const uint16_t m_version{1};\r\n-    const std::set<uint16_t> m_supported_versions{1};\r\n+    static const uint16_t VERSION{2};\r\n+    const std::set<uint16_t> m_supported_versions{VERSION};\r\n     const MessageStartChars m_network_magic;\r\n public:\r\n     //! The hash of the block that reflects the tip of the chain for the\r\n     //! UTXO set contained in this snapshot.\r\n     uint256 m_base_blockhash;\r\n-    uint32_t m_base_blockheight;\r\n \r\n \r\n     //! The number of coins in the UTXO set contained in this snapshot. Used\r\n@@ -54,15 +55,13 @@ public:\r\n         uint64_t coins_count) :\r\n             m_network_magic(network_magic),\r\n             m_base_blockhash(base_blockhash),\r\n-            m_base_blockheight(base_blockheight),\r\n             m_coins_count(coins_count) { }\r\n \r\n     template <typename Stream>\r\n     inline void Serialize(Stream& s) const {\r\n         s << SNAPSHOT_MAGIC_BYTES;\r\n-        s << m_version;\r\n+        s << VERSION;\r\n         s << m_network_magic;\r\n-        s << m_base_blockheight;\r\n         s << m_base_blockhash;\r\n         s << m_coins_count;\r\n     }\r\n@@ -98,7 +97,6 @@ public:\r\n             }\r\n         }\r\n \r\n-        s >> m_base_blockheight;\r\n         s >> m_base_blockhash;\r\n         s >> m_coins_count;\r\n     }\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 9899a13a1e..ee72fb2c20 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -2862,10 +2862,12 @@ static RPCHelpMan loadtxoutset()\r\n         throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to load UTXO snapshot: %s. (%s)\", util::ErrorString(activation_result).original, path.utf8string()));\r\n     }\r\n \r\n+    CBlockIndex& snap{*CHECK_NONFATAL(*activation_result)};\r\n+\r\n     UniValue result(UniValue::VOBJ);\r\n     result.pushKV(\"coins_loaded\", metadata.m_coins_count);\r\n-    result.pushKV(\"tip_hash\", metadata.m_base_blockhash.ToString());\r\n-    result.pushKV(\"base_height\", metadata.m_base_blockheight);\r\n+    result.pushKV(\"tip_hash\", snap.GetBlockHash().ToString());\r\n+    result.pushKV(\"base_height\", snap.nHeight);\r\n     result.pushKV(\"path\", fs::PathToString(path));\r\n     return result;\r\n },\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 2b8f64e81a..0b101d1551 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -5633,31 +5633,31 @@ Chainstate& ChainstateManager::InitializeChainstate(CTxMemPool* mempool)\r\n     return destroyed && !fs::exists(db_path);\r\n }\r\n \r\n-util::Result<void> ChainstateManager::ActivateSnapshot(\r\n+util::Result<CBlockIndex*> ChainstateManager::ActivateSnapshot(\r\n         AutoFile& coins_file,\r\n         const SnapshotMetadata& metadata,\r\n         bool in_memory)\r\n {\r\n     uint256 base_blockhash = metadata.m_base_blockhash;\r\n-    int base_blockheight = metadata.m_base_blockheight;\r\n \r\n     if (this->SnapshotBlockhash()) {\r\n         return util::Error{Untranslated(\"Can't activate a snapshot-based chainstate more than once\")};\r\n     }\r\n \r\n+    CBlockIndex* snapshot_start_block{};\r\n+\r\n     {\r\n         LOCK(::cs_main);\r\n \r\n         if (!GetParams().AssumeutxoForBlockhash(base_blockhash).has_value()) {\r\n             auto available_heights = GetParams().GetAvailableSnapshotHeights();\r\n             std::string heights_formatted = util::Join(available_heights, \", \", [&](const auto& i) { return util::ToString(i); });\r\n-            return util::Error{strprintf(Untranslated(\"assumeutxo block hash in snapshot metadata not recognized (hash: %s, height: %s). The following snapshot heights are available: %s\"),\r\n+            return util::Error{strprintf(Untranslated(\"assumeutxo block hash in snapshot metadata not recognized (hash: %s). The following snapshot heights are available: %s\"),\r\n                 base_blockhash.ToString(),\r\n-                base_blockheight,\r\n                 heights_formatted)};\r\n         }\r\n \r\n-        CBlockIndex* snapshot_start_block = m_blockman.LookupBlockIndex(base_blockhash);\r\n+        snapshot_start_block = m_blockman.LookupBlockIndex(base_blockhash);\r\n         if (!snapshot_start_block) {\r\n             return util::Error{strprintf(Untranslated(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call loadtxoutset again\"),\r\n                           base_blockhash.ToString())};\r\n@@ -5668,7 +5668,7 @@ util::Result<void> ChainstateManager::ActivateSnapshot(\r\n             return util::Error{strprintf(Untranslated(\"The base block header (%s) is part of an invalid chain\"), base_blockhash.ToString())};\r\n         }\r\n \r\n-        if (!m_best_header || m_best_header->GetAncestor(base_blockheight) != snapshot_start_block) {\r\n+        if (!m_best_header || m_best_header->GetAncestor(snapshot_start_block->nHeight) != snapshot_start_block) {\r\n             return util::Error{_(\"A forked headers-chain with more work than the chain with the snapshot base block header exists. Please proceed to sync without AssumeUtxo.\")};\r\n         }\r\n \r\n@@ -5782,7 +5782,7 @@ util::Result<void> ChainstateManager::ActivateSnapshot(\r\n         m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\r\n \r\n     this->MaybeRebalanceCaches();\r\n-    return {};\r\n+    return snapshot_start_block;\r\n }\r\n \r\n static void FlushSnapshotToDisk(CCoinsViewCache& coins_cache, bool snapshot_loaded)\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 08e672c620..0638bbe983 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -1098,7 +1098,7 @@ public:\r\n     //!   faking nTx* block index data along the way.\r\n     //! - Move the new chainstate to `m_snapshot_chainstate` and make it our\r\n     //!   ChainstateActive().\r\n-    [[nodiscard]] util::Result<void> ActivateSnapshot(\r\n+    [[nodiscard]] util::Result<CBlockIndex*> ActivateSnapshot(\r\n         AutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\r\n \r\n     //! Once the background validation chainstate has reached the height which\r\n",
      "created_at": "2024-07-24T05:19:22Z",
      "updated_at": "2024-07-24T05:19:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#discussion_r1689146902",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1689146902"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516"
        }
      },
      "start_line": 102,
      "original_start_line": 102,
      "start_side": "RIGHT",
      "line": 104,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1700350964",
      "pull_request_review_id": 2213091934,
      "id": 1700350964,
      "node_id": "PRRC_kwDOABII585lWUv0",
      "diff_hunk": "@@ -99,6 +99,9 @@ class SnapshotMetadata\n         }\n \n         s >> m_base_blockheight;\n+        if (m_base_blockheight > static_cast<uint32_t>(std::numeric_limits<int>::max())) {\n+            throw std::ios_base::failure(\"Block height is out of range.\");\n+        }",
      "path": "src/node/utxo_snapshot.h",
      "position": 6,
      "original_position": 6,
      "commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "original_commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "in_reply_to_id": 1689146902,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I forgot to mention this earlier, but to reply to your comment on IRC that this is only used in \"uncritical\" places:\r\n\r\nIt is currently used in `validation.cpp`, added as part of https://github.com/bitcoin/bitcoin/pull/30320.\r\n\r\nThis means:\r\n\r\n* The check accidentally serves as a validity check for the untrusted or possibly corrupt metadata value. (I don't think this was intentional by the author of the pull request; If it was, it would be good to document it)\r\n* This may be used in new places in the future without proper checks, leading to more issues down the line.\r\n* In an otherwise fully valid utxo snapshot dump, with a single bit flip in the block height field in the metadata, the error message for the user will not be: \"Corrupt metadata, block height corrupt\", but instead \"A forked headers-chain with more work than the chain with the snapshot base block header exists. Please proceed to sync without AssumeUtxo.\"\r\n\r\nThis seems confusing at best.\r\n\r\nSteps to reproduce should be something like:\r\n\r\n```diff\r\ndiff --git a/test/functional/feature_assumeutxo.py b/test/functional/feature_assumeutxo.py\r\nindex da7cabf87c..0c4eb126ed 100755\r\n--- a/test/functional/feature_assumeutxo.py\r\n+++ b/test/functional/feature_assumeutxo.py\r\n@@ -68,8 +68,9 @@ class AssumeutxoTest(BitcoinTestFramework):\r\n         parsing_error_code = -22\r\n         bad_magic = 0xf00f00f000\r\n         with open(bad_snapshot_path, 'wb') as f:\r\n-            f.write(bad_magic.to_bytes(5, \"big\") + valid_snapshot_contents[5:])\r\n+            f.write(valid_snapshot_contents[:11]+(1).to_bytes(4, \"little\")+valid_snapshot_contents[15:])\r\n         assert_raises_rpc_error(parsing_error_code, \"Unable to parse metadata: Invalid UTXO set snapshot magic bytes. Please check if this is indeed a snapshot file or if you are using an outdated snapshot format.\", node.loadtxoutset, bad_snapshot_path)\r\n+        assert False\r\n \r\n         self.log.info(\"  - snapshot file with unsupported version\")\r\n         for version in [0, 2]:\r\n",
      "created_at": "2024-08-01T14:57:39Z",
      "updated_at": "2024-08-01T14:57:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#discussion_r1700350964",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1700350964"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516"
        }
      },
      "start_line": 102,
      "original_start_line": 102,
      "start_side": "RIGHT",
      "line": 104,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1705871583",
      "pull_request_review_id": 2221851949,
      "id": 1705871583,
      "node_id": "PRRC_kwDOABII585lrYjf",
      "diff_hunk": "@@ -99,6 +99,9 @@ class SnapshotMetadata\n         }\n \n         s >> m_base_blockheight;\n+        if (m_base_blockheight > static_cast<uint32_t>(std::numeric_limits<int>::max())) {\n+            throw std::ios_base::failure(\"Block height is out of range.\");\n+        }",
      "path": "src/node/utxo_snapshot.h",
      "position": 6,
      "original_position": 6,
      "commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "original_commit_id": "51f197bd84916c494e9250926776b9efc3225100",
      "in_reply_to_id": 1689146902,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> * I don't think this was intentional by the author of the pull request;\r\n\r\nNo, it wasn't intentional, I didn't consider the possibility of incorrect metadata - might simply use `snapshot_start_block->nHeight` instead of `base_blockheight` though I think?\r\n",
      "created_at": "2024-08-06T17:12:19Z",
      "updated_at": "2024-08-06T17:12:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30516#discussion_r1705871583",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1705871583"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30516"
        }
      },
      "start_line": 102,
      "original_start_line": 102,
      "start_side": "RIGHT",
      "line": 104,
      "original_line": 104,
      "side": "RIGHT"
    }
  ]
}