{
  "type": "issue",
  "issue": {
    "id": 2296347151,
    "node_id": "I_kwDOABII586I33oP",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/30102",
    "number": 30102,
    "state": "open",
    "state_reason": null,
    "title": "contrib/signet/miner: grind will fail for high difficulty chain",
    "body": "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nMining will fail with a `Could not satisfy difficulty target`.\r\n\r\n```bash\r\n❯ ~/2-development/bitcoin/bitcoin-core/contrib/signet/miner --cli \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-cli -datadir=/Users/jose.edil/2-development/bitcoin/signet-mining-experiments/signet-fix-hashing\" generate --address tb1qylfujt900rjxzfxjj7sktpu7dpm2n9j60ch7jt --grind-cmd \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-util grind\" --nbits 1d008d28 --ongoing\r\n2024-05-14 16:29:05 INFO Mined block at height 10079; next in -324h56m20s (mine)\r\n2024-05-14 16:31:22 INFO Mined block at height 10080; next in -324h56m7s (mine)\r\n2024-05-14 16:32:34 INFO Mined block at height 10081; next in -324h54m49s (mine)\r\nCould not satisfy difficulty target\r\nTraceback (most recent call last):\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 545, in <module>\r\n    main()\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 539, in main\r\n    return args.fn(args)\r\n           ^^^^^^^^^^^^^\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 418, in do_generate\r\n    block = finish_block(block, signet_solution, args.grind_cmd)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 107, in finish_block\r\n    newheadhex = subprocess.run(cmd, stdout=subprocess.PIPE, input=b\"\", check=True).stdout.strip()\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/local/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/subprocess.py\", line 571, in run\r\n    raise CalledProcessError(retcode, process.args,\r\nsubprocess.CalledProcessError: Command '['/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-util', 'grind', '0000002063d19ae45a71b26fc04ddeef152919d2ecc22ed936ea7129d3bf291f03000000703be9fb35f03fc17b9b3210ac8364c1b76888d793397b7686128107d21c0b4a39e33166ac77031d00000000']' returned non-zero exit status 1.\r\n```\r\n\r\nThis is a follow-up of the discussion in #30091: I started a signet with difficulty `--nbits 1d008d28` and mined the first block with a date 30 days in the past. That would let the miner run as fast as it can until difficulty is so high it will converge to the 10 minute average time between blocks.\r\n\r\nAfter each 2016 blocks, the difficulty is adjusted as per the network consensus and it gets increasingly harder to find new blocks. After 5 adjustments, the grinder eventually exhausts the nonce search space and fails, making the python script to fail as well.\r\n\r\nI inspected the [bitcoin-util grinder source](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/bitcoin-util.cpp#L85-L147), but could not find any problem there. Indeed, it does what one would expect: look for PoW and fail if the `nonce` search space is exhausted. That's where the stdout message comes.\r\n\r\n### Expected behaviour\r\n\r\nI tracked down the problem [to this section of the code](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/contrib/signet/miner#L412-L419). \r\n\r\nThe `finish_block` function should be able to catch the exception that can arise from the grinder subprocess and in case of failure try another block header. In case of signet, I believe it is a matter of resigning it [as in](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/contrib/signet/miner#L412) and looking for PoW again until it finds something.\r\n\r\nI started a fix to submit a PR, but wanted to see if someone else could reproduce this behavior in the meantime. It's not clear to me how to make a (unit) test to systematically expose the problem, though.\r\n\r\n### Steps to reproduce\r\n\r\nFollow the outline discussed in #30091 and let the miner run (for a few hours) until the difficulty gets high enough so that one needs a bigger search space to find valid PoW for new blocks.\r\n\r\n### Relevant log output\r\n\r\nCurrent chain info\r\n\r\n```bash\r\n❯ ~/2-development/bitcoin/bitcoin-core/src/bitcoin-cli -datadir=\"/Users/jose.edil/2-development/bitcoin/signet-mining-experiments/signet-fix-hashing\" -signet getblockchaininfo\r\n{\r\n  \"chain\": \"signet\",\r\n  \"blocks\": 10081,\r\n  \"headers\": 10081,\r\n  \"bestblockhash\": \"000000031f29bfd32971ea36d92ec2ecd2192915efde4dc06fb2715ae49ad163\",\r\n  \"difficulty\": 0.2883904525532027,\r\n  \"time\": 1714545315,\r\n  \"mediantime\": 1714544565,\r\n  \"verificationprogress\": 1,\r\n  \"initialblockdownload\": true,\r\n  \"chainwork\": \"000000000000000000000000000000000000000000000000000000c3e464c5fc\",\r\n  \"size_on_disk\": 4153462,\r\n  \"pruned\": false,\r\n  \"warnings\": \"\"\r\n}\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nv27.0\r\n\r\n### Operating system and version\r\n\r\nMacOS Sonoma 14.4\r\n\r\n### Machine specifications\r\n\r\nMacbook Pro M3 Pro\r\n18GB Memory",
    "user": {
      "login": "edilmedeiros",
      "id": 78322931,
      "node_id": "MDQ6VXNlcjc4MzIyOTMx",
      "avatar_url": "https://avatars.githubusercontent.com/u/78322931?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/edilmedeiros",
      "html_url": "https://github.com/edilmedeiros",
      "followers_url": "https://api.github.com/users/edilmedeiros/followers",
      "following_url": "https://api.github.com/users/edilmedeiros/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/edilmedeiros/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/edilmedeiros/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/edilmedeiros/subscriptions",
      "organizations_url": "https://api.github.com/users/edilmedeiros/orgs",
      "repos_url": "https://api.github.com/users/edilmedeiros/repos",
      "events_url": "https://api.github.com/users/edilmedeiros/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/edilmedeiros/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 231994551,
        "node_id": "MDU6TGFiZWwyMzE5OTQ1NTE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Scripts%20and%20tools",
        "name": "Scripts and tools",
        "color": "ffffee",
        "default": false
      },
      {
        "id": 477890092,
        "node_id": "MDU6TGFiZWw0Nzc4OTAwOTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Questions%20and%20Help",
        "name": "Questions and Help",
        "color": "006688",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2024-05-14T20:17:28Z",
    "updated_at": "2024-05-16T18:33:20Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 12819619658,
      "node_id": "LE_lADOABII586I33oPzwAAAAL8G99K",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12819619658",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T15:12:22Z",
      "label": {
        "name": "Scripts and tools",
        "color": "ffffee"
      }
    },
    {
      "event": "labeled",
      "id": 12819619664,
      "node_id": "LE_lADOABII586I33oPzwAAAAL8G99Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12819619664",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T15:12:22Z",
      "label": {
        "name": "Questions and Help",
        "color": "006688"
      }
    },
    {
      "event": "comment_deleted",
      "id": 12821377251,
      "node_id": "CDE_lADOABII586I33oPzwAAAAL8NrDj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12821377251",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T17:39:55Z"
    },
    {
      "event": "commented",
      "id": 2113592794,
      "node_id": "IC_kwDOABII5859-t3a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113592794",
      "actor": {
        "login": "1ma",
        "id": 1456708,
        "node_id": "MDQ6VXNlcjE0NTY3MDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1456708?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1ma",
        "html_url": "https://github.com/1ma",
        "followers_url": "https://api.github.com/users/1ma/followers",
        "following_url": "https://api.github.com/users/1ma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1ma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1ma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1ma/subscriptions",
        "organizations_url": "https://api.github.com/users/1ma/orgs",
        "repos_url": "https://api.github.com/users/1ma/repos",
        "events_url": "https://api.github.com/users/1ma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1ma/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T22:33:42Z",
      "updated_at": "2024-05-15T22:36:08Z",
      "author_association": "NONE",
      "body": "Can reproduce. Been running a signet network whose miner stalled a few dozens of blocks after the block 10080 difficulty adjustment.\r\n\r\nThe miner (v26.1 script) is ran as a systemd service like this, and the nbits parameter was determined by running the calibrating utility set to 600s. Despite this, before block 10080 the miner used to mine a block every 2.5 min instead of 10. I don't quite understand how it works, honestly.\r\n\r\n```shell\r\nminer --cli=\"bitcoin-cli\" generate --address $rewards_addy --grind-cmd=\"bitcoin-util grind\" --nbits=1d02257e --ongoing\r\n```",
      "user": {
        "login": "1ma",
        "id": 1456708,
        "node_id": "MDQ6VXNlcjE0NTY3MDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1456708?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1ma",
        "html_url": "https://github.com/1ma",
        "followers_url": "https://api.github.com/users/1ma/followers",
        "following_url": "https://api.github.com/users/1ma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1ma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1ma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1ma/subscriptions",
        "organizations_url": "https://api.github.com/users/1ma/orgs",
        "repos_url": "https://api.github.com/users/1ma/repos",
        "events_url": "https://api.github.com/users/1ma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1ma/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30102#issuecomment-2113592794",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102"
    },
    {
      "event": "commented",
      "id": 2113923344,
      "node_id": "IC_kwDOABII5859_-kQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113923344",
      "actor": {
        "login": "edilmedeiros",
        "id": 78322931,
        "node_id": "MDQ6VXNlcjc4MzIyOTMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/78322931?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/edilmedeiros",
        "html_url": "https://github.com/edilmedeiros",
        "followers_url": "https://api.github.com/users/edilmedeiros/followers",
        "following_url": "https://api.github.com/users/edilmedeiros/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/edilmedeiros/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/edilmedeiros/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/edilmedeiros/subscriptions",
        "organizations_url": "https://api.github.com/users/edilmedeiros/orgs",
        "repos_url": "https://api.github.com/users/edilmedeiros/repos",
        "events_url": "https://api.github.com/users/edilmedeiros/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/edilmedeiros/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T02:59:15Z",
      "updated_at": "2024-05-16T02:59:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for reporting.\n\nAbout the 2m30s interval, see #30091.",
      "user": {
        "login": "edilmedeiros",
        "id": 78322931,
        "node_id": "MDQ6VXNlcjc4MzIyOTMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/78322931?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/edilmedeiros",
        "html_url": "https://github.com/edilmedeiros",
        "followers_url": "https://api.github.com/users/edilmedeiros/followers",
        "following_url": "https://api.github.com/users/edilmedeiros/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/edilmedeiros/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/edilmedeiros/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/edilmedeiros/subscriptions",
        "organizations_url": "https://api.github.com/users/edilmedeiros/orgs",
        "repos_url": "https://api.github.com/users/edilmedeiros/repos",
        "events_url": "https://api.github.com/users/edilmedeiros/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/edilmedeiros/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30102#issuecomment-2113923344",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102"
    },
    {
      "event": "commented",
      "id": 2115939051,
      "node_id": "IC_kwDOABII585-Hqrr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115939051",
      "actor": {
        "login": "1ma",
        "id": 1456708,
        "node_id": "MDQ6VXNlcjE0NTY3MDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1456708?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1ma",
        "html_url": "https://github.com/1ma",
        "followers_url": "https://api.github.com/users/1ma/followers",
        "following_url": "https://api.github.com/users/1ma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1ma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1ma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1ma/subscriptions",
        "organizations_url": "https://api.github.com/users/1ma/orgs",
        "repos_url": "https://api.github.com/users/1ma/repos",
        "events_url": "https://api.github.com/users/1ma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1ma/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T18:31:33Z",
      "updated_at": "2024-05-16T18:33:20Z",
      "author_association": "NONE",
      "body": "Thanks for the pointer. A bit off-topic, but since there are not so many people yet who are familiar with operating a signet let me ask you a follow up question:\r\n\r\nI'm don't really understand why the signet miner has so much logic and is so opinionated. My initial idea was to keep the difficulty as low as possible then fire a cronjob every 10 minutes to insta-mine a block at the current timestamp, so the consensus algorithm would be tricked into thinking that is the real difficulty.\r\n\r\nI was never able to use the miner like this though, it seems to have a life of its own. No matter which `nbits` value I selected it mined a block every 2m30s (until it reached block 10080 and broke soon after at 10106). And if it stopped for some time it insta-mined blocks with a backdated timestamp until it catched up to the present.\r\n\r\nIs it possible to have a signet mining setup like that, that is not constantly raising the difficulty and wasting CPU?",
      "user": {
        "login": "1ma",
        "id": 1456708,
        "node_id": "MDQ6VXNlcjE0NTY3MDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1456708?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/1ma",
        "html_url": "https://github.com/1ma",
        "followers_url": "https://api.github.com/users/1ma/followers",
        "following_url": "https://api.github.com/users/1ma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/1ma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/1ma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/1ma/subscriptions",
        "organizations_url": "https://api.github.com/users/1ma/orgs",
        "repos_url": "https://api.github.com/users/1ma/repos",
        "events_url": "https://api.github.com/users/1ma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/1ma/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30102#issuecomment-2115939051",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30102"
    }
  ]
}