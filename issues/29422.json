{
  "type": "issue",
  "issue": {
    "id": 2129102547,
    "node_id": "I_kwDOABII585-54bT",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29422",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29422/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29422/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29422/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/29422",
    "number": 29422,
    "state": "open",
    "state_reason": null,
    "title": "Assertion chainman().ActiveChain()[height] fails on startup on memory-constrained system",
    "body": "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nbitcoind crashes on startup with this error: (not logged in debug.log)\r\n```\r\nnode/interfaces.cpp:525 getBlockHash: Assertion `chainman().ActiveChain()[height]' failed.\r\nAborted (core dumped)\r\n```\r\nThis is after trying to bring the node up after it was killed by the system during IBD (likely due to OOM).\r\n\r\n### Expected behaviour\r\n\r\nbitcoind should not crash, or at least it should exit with a more helpful error log.\r\n\r\n### Steps to reproduce\r\n\r\nRun bitcoind with these configuration options:\r\n```\r\ndisablewallet=1\r\nprune=550\r\nlisten=0\r\ncoinstatsindex=1\r\n```\r\n\r\n### Relevant log output\r\n\r\nLast few lines before being killed (last line not recorded in debug.log):\r\n\r\n```\r\n2024-02-11T19:09:40Z UpdateTip: new best=00000000000005ab0d71214ffa5b38cd51e13525892a221bbf748fee8de806ad height=140916 version=0x00000001 log2_work=66.122154 tx=1282449 date='2011-08-14T11:18:30Z' progress=0.001328 cache=104.2MiB(896112txo)\r\n2024-02-11T19:09:40Z UpdateTip: new best=0000000000000390717df9a1baaf8e65f9b96c87ee994d20dd897a95e8adc3e9 height=140917 version=0x00000001 log2_work=66.122300 tx=1282533 date='2011-08-14T11:27:11Z' progress=0.001328 cache=104.2MiB(896392txo)\r\n2024-02-11T19:09:41Z UpdateTip: new best=000000000000038559aa65f99789894199f2f4f08bfba66454864b5e514ba58a height=140918 version=0x00000001 log2_work=66.122445 tx=1282552 date='2011-08-14T11:32:11Z' progress=0.001328 cache=104.2MiB(896387txo)\r\n2024-02-11T19:09:41Z UpdateTip: new best=000000000000000121734a048a6dcd9f5184929ef6b4d60fab74612de0e5e26c height=140919 version=0x00000001 log2_work=66.122591 tx=1282659 date='2011-08-14T12:12:06Z' progress=0.001328 cache=104.2MiB(896508txo)\r\n2024-02-11T19:09:41Z UpdateTip: new best=000000000000017fab19329089a1ab54e1f4ab110b1ef0c5d4f9990c2815d624 height=140920 version=0x00000001 log2_work=66.122737 tx=1282673 date='2011-08-14T12:16:33Z' progress=0.001328 cache=104.2MiB(896564txo)\r\n2024-02-11T19:09:41Z UpdateTip: new best=00000000000006a0e9cbe57335835c382bc09f11045b68dbb834495f4ae22faf height=140921 version=0x00000001 log2_work=66.122882 tx=1282777 date='2011-08-14T12:41:24Z' progress=0.001328 cache=104.2MiB(896561txo)\r\n2024-02-11T19:09:41Z UpdateTip: new best=000000000000052e30dd0b273b500fde21e4bee67d1f5cd05fef91a663dadfcd height=140922 version=0x00000001 log2_work=66.123028 tx=1282926 date='2011-08-14T12:47:38Z' progress=0.001329 cache=104.2MiB(896633txo)\r\nKilled\r\n```\r\n\r\nAfter trying to start the node again (last two lines not recorded in debug.log):\r\n\r\n```\r\n2024-02-11T19:46:07Z Bitcoin Core version v26.0.0 (release build)\r\n2024-02-11T19:46:07Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -upnp=0\r\n2024-02-11T19:46:07Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -natpmp=0\r\n2024-02-11T19:46:07Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -discover=0\r\n2024-02-11T19:46:07Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -listenonion=0\r\n2024-02-11T19:46:07Z InitParameterInteraction: parameter interaction: -listen=0 -> setting -i2pacceptincoming=0\r\n2024-02-11T19:46:07Z Using the 'x86_shani(1way,2way)' SHA256 implementation\r\n2024-02-11T19:46:07Z Using RdSeed as an additional entropy source\r\n2024-02-11T19:46:07Z Using RdRand as an additional entropy source\r\n2024-02-11T19:46:07Z Default data directory /home/***/.bitcoin\r\n2024-02-11T19:46:07Z Using data directory /home/***/.bitcoin\r\n2024-02-11T19:46:07Z Config file: /home/***/.bitcoin/bitcoin.conf\r\n2024-02-11T19:46:07Z Config file arg: coinstatsindex=\"1\"\r\n2024-02-11T19:46:07Z Config file arg: disablewallet=\"1\"\r\n2024-02-11T19:46:07Z Config file arg: listen=\"0\"\r\n2024-02-11T19:46:07Z Config file arg: prune=\"550\"\r\n2024-02-11T19:46:07Z Using at most 125 automatic connections (1024 file descriptors available)\r\n2024-02-11T19:46:07Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2024-02-11T19:46:07Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2024-02-11T19:46:07Z Script verification uses 0 additional threads\r\n2024-02-11T19:46:07Z Wallet disabled!\r\n2024-02-11T19:46:07Z scheduler thread start\r\n2024-02-11T19:46:07Z Binding RPC on address ::1 port 8332\r\n2024-02-11T19:46:07Z Binding RPC on address 127.0.0.1 port 8332\r\n2024-02-11T19:46:07Z [http] creating work queue of depth 16\r\n2024-02-11T19:46:07Z Using random cookie authentication.\r\n2024-02-11T19:46:07Z Generated RPC authentication cookie /home/***/.bitcoin/.cookie\r\n2024-02-11T19:46:07Z [http] starting 4 worker threads\r\n2024-02-11T19:46:07Z Using /16 prefix for IP bucketing\r\n2024-02-11T19:46:07Z init message: Loading P2P addresses…\r\n2024-02-11T19:46:07Z Loaded 8837 addresses from peers.dat  20ms\r\n2024-02-11T19:46:07Z init message: Loading banlist…\r\n2024-02-11T19:46:07Z SetNetworkActive: true\r\n2024-02-11T19:46:07Z /home/***/.bitcoin/fee_estimates.dat is not found. Continue anyway.\r\n2024-02-11T19:46:07Z Cache configuration:\r\n2024-02-11T19:46:07Z * Using 2.0 MiB for block index database\r\n2024-02-11T19:46:07Z * Using 8.0 MiB for chain state database\r\n2024-02-11T19:46:07Z * Using 440.0 MiB for in-memory UTXO set (plus up to 286.1 MiB of unused mempool space)\r\n2024-02-11T19:46:07Z init message: Loading block index…\r\n2024-02-11T19:46:07Z Assuming ancestors of block 00000000000000000001a0a448d6cf2546b06801389cc030b2b18c6491266815 have valid signatures.\r\n2024-02-11T19:46:07Z Setting nMinimumChainWork=000000000000000000000000000000000000000052b2559353df4117b7348b64\r\n2024-02-11T19:46:07Z Prune configured to target 550 MiB on disk for block and undo files.\r\n2024-02-11T19:46:07Z Opening LevelDB in /home/***/.bitcoin/blocks/index\r\n2024-02-11T19:46:13Z Opened LevelDB successfully\r\n2024-02-11T19:46:13Z Using obfuscation key for /home/***/.bitcoin/blocks/index: 0000000000000000\r\n2024-02-11T19:46:17Z LoadBlockIndexDB: last block file = 3\r\n2024-02-11T19:46:17Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=4007, size=94150965, heights=136926...140942, time=2011-07-18...2011-08-14)\r\n2024-02-11T19:46:17Z Checking all blk files are present...\r\n2024-02-11T19:46:17Z LoadBlockIndexDB(): Block files have previously been pruned\r\n2024-02-11T19:46:17Z Initializing chainstate Chainstate [ibd] @ height -1 (null)\r\n2024-02-11T19:46:17Z Opening LevelDB in /home/***/.bitcoin/chainstate\r\n2024-02-11T19:46:17Z Opened LevelDB successfully\r\n2024-02-11T19:46:17Z Using obfuscation key for /home/***/.bitcoin/chainstate: c31b181c8ff3ce9b\r\n2024-02-11T19:46:17Z Opening LevelDB in /home/***/.bitcoin/chainstate\r\n2024-02-11T19:46:17Z Opened LevelDB successfully\r\n2024-02-11T19:46:17Z Using obfuscation key for /home/***/.bitcoin/chainstate: c31b181c8ff3ce9b\r\n2024-02-11T19:46:17Z [Chainstate [ibd] @ height -1 (null)] resized coinsdb cache to 8.0 MiB\r\n2024-02-11T19:46:17Z [Chainstate [ibd] @ height -1 (null)] resized coinstip cache to 440.0 MiB\r\n2024-02-11T19:46:17Z init message: Verifying blocks…\r\n2024-02-11T19:46:17Z  block index            9824ms\r\n2024-02-11T19:46:17Z Opening LevelDB in /home/***/.bitcoin/indexes/coinstats/db\r\n2024-02-11T19:46:17Z Opened LevelDB successfully\r\n2024-02-11T19:46:17Z Using obfuscation key for /home/***/.bitcoin/indexes/coinstats/db: 0000000000000000\r\n2024-02-11T19:46:17Z init message: Pruning blockstore…\r\n2024-02-11T19:46:17Z initload thread start\r\nnode/interfaces.cpp:525 getBlockHash: Assertion `chainman().ActiveChain()[height]' failed.\r\nAborted (core dumped)\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nPre-built binaries\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nv26.0\r\n\r\n### Operating system and version\r\n\r\nUbuntu 20.04.6 LTS\r\n\r\n### Machine specifications\r\n\r\nThe system only has 1 GB of RAM.",
    "user": {
      "login": "vostrnad",
      "id": 43024885,
      "node_id": "MDQ6VXNlcjQzMDI0ODg1",
      "avatar_url": "https://avatars.githubusercontent.com/u/43024885?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vostrnad",
      "html_url": "https://github.com/vostrnad",
      "followers_url": "https://api.github.com/users/vostrnad/followers",
      "following_url": "https://api.github.com/users/vostrnad/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/vostrnad/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/vostrnad/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/vostrnad/subscriptions",
      "organizations_url": "https://api.github.com/users/vostrnad/orgs",
      "repos_url": "https://api.github.com/users/vostrnad/repos",
      "events_url": "https://api.github.com/users/vostrnad/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/vostrnad/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 0,
    "created_at": "2024-02-11T18:07:52Z",
    "updated_at": "2024-02-11T21:26:39Z"
  },
  "events": []
}