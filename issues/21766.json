{
  "type": "issue",
  "issue": {
    "id": 866397362,
    "node_id": "MDU6SXNzdWU4NjYzOTczNjI=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/21766",
    "number": 21766,
    "state": "open",
    "state_reason": null,
    "title": "followups: Various potential improvements arising out of chainman-deglobalizing review",
    "body": "There are a few potential improvements mentioned by various reviewers of the chainman-deglobalizing work that are deserving of a tracking ticket, but are perhaps either not crucial to the main thrust of the work or the flaws already existed before the work. Let's discuss and collate them here so that we don't lose track of them!\r\n\r\n1. `m_chain` methods should perhaps require holding `cs_main`\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613951719\r\n2. `Ensure*()` in src/rpc should be called at the top of functions to fail as early as possible\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613992845\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613942578\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613944794\r\n3. IncrementExtraNonce does not need `cs_main`, and the locking scope can be limited\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613967463\r\n4. `CoinsDB.Cursor()` passes ownership to caller and should return a `std::unique_ptr`\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r614696860\r\n5. Call to `GetNetworkHashPS` in `getnetworkhashps` contains many operators, which may increase risk of precedence bugs\r\n    - https://github.com/bitcoin/bitcoin/pull/21391#discussion_r613953875\r\n6. Avoid repeated calls to `ActiveChain()` where appropriate\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592357247\r\n7. Review whether or not `m_blockman` member of `ChainstateManager` needs `cs_main` to be accessed\r\n    - Various\r\n8. Review whether or not to support running bitcoin without a chainman\r\n    - https://github.com/bitcoin/bitcoin/pull/21767#discussion_r628905295\r\n9. Investigate how indexing interacts with `CChainState`\r\n    - https://github.com/bitcoin/bitcoin/pull/21767#discussion_r641791366\r\n\r\nPlease feel free to comment here for extra ones I've missed!",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 2,
    "created_at": "2021-04-23T20:06:20Z",
    "updated_at": "2021-06-17T05:51:59Z"
  },
  "events": [
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "dongcarl",
        "id": 3445290,
        "node_id": "MDQ6VXNlcjM0NDUyOTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dongcarl",
        "html_url": "https://github.com/dongcarl",
        "followers_url": "https://api.github.com/users/dongcarl/followers",
        "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
        "organizations_url": "https://api.github.com/users/dongcarl/orgs",
        "repos_url": "https://api.github.com/users/dongcarl/repos",
        "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dongcarl/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-04-23T20:13:10Z",
      "updated_at": "2021-04-23T20:13:10Z",
      "source": {
        "issue": {
          "id": 866401000,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NjIyMzAzNDc1",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21767",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21767/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21767/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21767/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/21767",
          "number": 21767,
          "state": "closed",
          "state_reason": null,
          "title": "[Bundle 6/n] Prune g_chainman usage in auxiliary modules",
          "body": "Overall PR: #20158 (tree-wide: De-globalize ChainstateManager)\r\n\r\nThe first 2 commits are fixups addressing review for the last bundle: #21391\r\n\r\nNEW note:\r\n1. I have opened #21766 which keeps track of potential improvements where the flaws already existed before the de-globalization work, please post on that issue about these improvements, thanks!\r\n\r\nNote to reviewers:\r\n1. This bundle may _apparently_ introduce usage of `g_chainman` or `::Chain(state|)Active()` globals, but these are resolved later on in the overall PR. [Commits of overall PR](https://github.com/bitcoin/bitcoin/pull/20158/commits)\r\n2. There may be seemingly obvious local references to `ChainstateManager` or other validation objects which are not being used in callers of the current function in question, this is done intentionally to **_keep each commit centered around one function/method_** to ease review and to make the overall change systematic. We don't assume anything about our callers. Rest assured that once we are considering that particular caller in later commits, we will use the obvious local references. [Commits of overall PR](https://github.com/bitcoin/bitcoin/pull/20158/commits)\r\n3. When changing a function/method that has many callers (e.g. `LookupBlockIndex` with 55 callers), it is sometimes easier (and less error-prone) to use a scripted-diff. When doing so, there will be 3 commits in sequence so that every commit compiles like so:\r\n\t1. Add `new_function`, make `old_function` a wrapper of `new_function`, divert all calls to `old_function` to `new_function` **in the local module only**\r\n\t2. Scripted-diff to divert all calls to `old_function` to `new_function` **in the rest of the codebase**\r\n\t3. Remove `old_function`",
          "user": {
            "login": "dongcarl",
            "id": 3445290,
            "node_id": "MDQ6VXNlcjM0NDUyOTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dongcarl",
            "html_url": "https://github.com/dongcarl",
            "followers_url": "https://api.github.com/users/dongcarl/followers",
            "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
            "organizations_url": "https://api.github.com/users/dongcarl/orgs",
            "repos_url": "https://api.github.com/users/dongcarl/repos",
            "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/dongcarl/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 10,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/21767",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/21767.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/21767.patch"
          },
          "closed_at": "2021-06-01T11:40:49Z",
          "created_at": "2021-04-23T20:13:09Z",
          "updated_at": "2022-08-18T18:24:33Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "dongcarl",
        "id": 3445290,
        "node_id": "MDQ6VXNlcjM0NDUyOTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dongcarl",
        "html_url": "https://github.com/dongcarl",
        "followers_url": "https://api.github.com/users/dongcarl/followers",
        "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
        "organizations_url": "https://api.github.com/users/dongcarl/orgs",
        "repos_url": "https://api.github.com/users/dongcarl/repos",
        "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dongcarl/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-05-05T20:51:55Z",
      "updated_at": "2021-05-05T20:51:55Z",
      "source": {
        "issue": {
          "id": 876824606,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NjMwODkzNDk1",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21866",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21866/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21866/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21866/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/21866",
          "number": 21866,
          "state": "closed",
          "state_reason": null,
          "title": "[Bundle 7/7] validation: Farewell, global Chainstate!",
          "body": "Based on:  #21767\r\n\r\nà la Mr. Sandman\r\n```\r\nMr. Chainman, bring me a tip (bung, bung, bung, bung)\r\nMake it the most work that I've ever seen (bung, bung, bung, bung)\r\nRewind old tip till we're at the fork point (bung, bung, bung, bung)\r\nThen tell it that it's time to call Con-nectTip\r\n\r\nChainman, I'm so alone (bung, bung, bung, bung)\r\nNo local objects to call my own (bung, bung, bung, bung)\r\nPlease make sure I have a ref\r\nMr. Chainman, bring me a tip!\r\n```\r\n\r\nThis is the last bundle in the #20158 series. Thanks everyone for their diligent review.\r\nI would like to call attention to https://github.com/bitcoin/bitcoin/issues/21766, where a few leftover improvements were collated.\r\n\r\n- Remove globals:\r\n  - `ChainstateManager g_chainman`\r\n  - `CChainState& ChainstateActive()`\r\n  - `CChain& ChainActive()`\r\n- Remove all review-only assertions.",
          "user": {
            "login": "dongcarl",
            "id": 3445290,
            "node_id": "MDQ6VXNlcjM0NDUyOTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dongcarl",
            "html_url": "https://github.com/dongcarl",
            "followers_url": "https://api.github.com/users/dongcarl/followers",
            "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
            "organizations_url": "https://api.github.com/users/dongcarl/orgs",
            "repos_url": "https://api.github.com/users/dongcarl/repos",
            "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/dongcarl/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            },
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "milestone": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/47",
            "html_url": "https://github.com/bitcoin/bitcoin/milestone/47",
            "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/47/labels",
            "id": 5347322,
            "node_id": "MDk6TWlsZXN0b25lNTM0NzMyMg==",
            "number": 47,
            "state": "closed",
            "title": "22.0",
            "description": "",
            "creator": {
              "login": "MarcoFalke",
              "id": 6399679,
              "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
              "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/MarcoFalke",
              "html_url": "https://github.com/MarcoFalke",
              "followers_url": "https://api.github.com/users/MarcoFalke/followers",
              "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
              "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
              "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
              "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
              "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
              "repos_url": "https://api.github.com/users/MarcoFalke/repos",
              "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
              "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
              "type": "User",
              "site_admin": false
            },
            "open_issues": 0,
            "closed_issues": 124,
            "created_at": "2020-04-25T00:14:49Z",
            "updated_at": "2021-09-14T07:16:53Z",
            "closed_at": "2021-09-09T12:47:52Z"
          },
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 16,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21866",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/21866",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/21866.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/21866.patch"
          },
          "closed_at": "2021-06-12T03:29:52Z",
          "created_at": "2021-05-05T20:51:55Z",
          "updated_at": "2022-08-16T17:24:14Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "referenced",
      "id": 4824839397,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ4MjQ4MzkzOTc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4824839397",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f63fc53c2aea2e33ce3195fe5e069447e2eddb1e",
      "commit_url": "https://api.github.com/repos/MarcoFalke/b-c/commits/f63fc53c2aea2e33ce3195fe5e069447e2eddb1e",
      "created_at": "2021-06-01T11:40:45Z"
    },
    {
      "event": "referenced",
      "id": 4880762061,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ4ODA3NjIwNjE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4880762061",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "a55904a80c35730c89d4d84214c2afbec8b1536d",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a55904a80c35730c89d4d84214c2afbec8b1536d",
      "created_at": "2021-06-12T03:29:47Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "dongcarl",
        "id": 3445290,
        "node_id": "MDQ6VXNlcjM0NDUyOTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dongcarl",
        "html_url": "https://github.com/dongcarl",
        "followers_url": "https://api.github.com/users/dongcarl/followers",
        "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
        "organizations_url": "https://api.github.com/users/dongcarl/orgs",
        "repos_url": "https://api.github.com/users/dongcarl/repos",
        "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dongcarl/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-16T16:19:42Z",
      "updated_at": "2021-06-16T16:19:42Z",
      "source": {
        "issue": {
          "id": 722569048,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NTA0Mjk2MzUx",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20158",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20158/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20158/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20158/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/20158",
          "number": 20158,
          "state": "closed",
          "state_reason": null,
          "title": "tree-wide: De-globalize ChainstateManager",
          "body": "## Prelude\r\n\r\n**Note to reviewers**: Currently looking Code Review on Sub-PRs (see below)\r\n\r\nOriginally: #20049\r\n\r\n### Sub-PRs\r\n\r\n_Last updated May 9th, 2020_\r\n\r\n- [x] #20323 | tests: Create or use existing properly initialized NodeContexts\r\n- [x] #20946 | fuzz: Consolidate fuzzing TestingSetup initialization\r\n- [x] #20972 | locks: Annotate CTxMemPool::check to require cs_main\r\n- [x] #20749 | [Bundle 1/n] Prune g_chainman usage related to ::LookupBlockIndex\r\n- [x] #20750 | [Bundle 2/n] Prune g_chainman usage in mempool-related validation functions\r\n- [x] #21055 | [Bundle 3/n] Prune remaining g_chainman usage in validation functions\r\n- [x] #21270 | [Bundle 4/n] Prune g_chainman usage in validation-adjacent modules\r\n- [x] #21391 | [Bundle 5/n] Prune g_chainman usage in RPC modules\r\n- [x] #21767 | [Bundle 6/n] Prune g_chainman usage in auxiliary modules\r\n- [x] #21866 | [Bundle 7/n] Farewell, global Chainstate!\r\n\r\n### Todo List\r\n\r\n_Last updated Feb 1st, 2020_\r\n\r\n- [x] Address ryanofsky's comments\r\n\t- [x] https://github.com/bitcoin/bitcoin/pull/20158#discussion_r520639845\r\n\r\n## Motivation\r\n\r\n###  Modularizing our consensus engine\r\n\r\nExcerpt from #20049\r\n> From my reading of past conversations and from a few offline chats, it seems that modularizing our consensus engine is a worthwhile first step towards a more complete isolation of said engine from non-consensus code.\r\n> \r\n> Modularizing our consensus engine means that:\r\n> \r\n> 1. We get clearer visibility into what currently lies in consensus codepaths **and** what depends on our consensus engine\r\n> 1. We can coalesce duplicate consensus initialization codepaths, mitigating against bugs that arise out of test/non-test initialization inconsistencies\r\n\r\n### De-globalizing `g_chainman`\r\n\r\nExcerpt from #20049\r\n> In order to modularize our consensus engine, we need to first de-globalize the global `ChainstateManager` -- namely `g_chainman` -- as it and its dependencies are what makes up the bulk of our consensus engine. A few direct references to `g_chainman` have already been removed in #19927, however, its indirect uses (mainly via `::Chain(state|)Active()`) are numerous in our codebase and often used to ~~cheat~~ avoid obtaining a `ChainstateManager` reference.\r\n\r\n## Description\r\n\r\nThis changeset moves the global `ChainstateManger` to `NodeContext` and removes `::Chain{state,}Active()` as a first step towards better modularization of our consensus engine. \r\n\r\nThe commits are ordered as such:\r\n1. Fixes to our existing codebase crucial to subsequent changes in this changeset\r\nhttps://github.com/bitcoin/bitcoin/compare/master...dongcarl:2020-10-chainman-fixes\r\n1. Remove all references to `g_chainman`, `::Chain{state,}Active()`\r\n\t1. In `src/validation.{cpp,h}`\r\n\t\t1. In a bundle of functions related to `::LookupBlockIndex` in the call graph\r\n\t\thttps://github.com/dongcarl/bitcoin/compare/2020-10-chainman-fixes...dongcarl:2020-09-libbitcoinruntime-v4\r\n\t\t1. In a bundle of functions that are mempool-related\r\n\t\thttps://github.com/dongcarl/bitcoin/compare/dongcarl:2020-09-libbitcoinruntime-v4...2020-09-reduce-validation-mempool-ccsactiveglobal-usage\r\n\t\t1. In a bundle of functions which do not belong in previous bundles\r\n\t\thttps://github.com/dongcarl/bitcoin/compare/2020-09-reduce-validation-mempool-ccsactiveglobal-usage...dongcarl:2020-09-reduce-validation-ccsactiveglobal-usage\r\n\t1. In \"validation-adjacent\" modules of the codebase\r\n\thttps://github.com/dongcarl/bitcoin/compare/dongcarl:2020-09-reduce-validation-ccsactiveglobal-usage...2020-09-libbitcoinruntime-v6\r\n\t\t1. In `src/txmempool.cpp`\r\n\t\t1. In `src/miner.cpp`\r\n\t\t1. In `src/node`\r\n\t\t1. In `src/net_processing.cpp`\r\n\t1. In RPC modules of the codebase\r\n\thttps://github.com/dongcarl/bitcoin/compare/2020-09-libbitcoinruntime-v6...dongcarl:2020-10-libbitcoinruntime-v7\r\n\t\t1. In `src/rpc`\r\n\t\t1. In `src/rest.cpp`\r\n\t1. In auxiliary modules of the codebase\r\n\thttps://github.com/dongcarl/bitcoin/compare/dongcarl:2020-10-libbitcoinruntime-v7...2020-10-libbitcoinruntime-v8\r\n\t\t1. In `src/bench`\r\n\t\t1. In `src/index`\r\n\t1. In initialization codepaths and tests\r\n\thttps://github.com/dongcarl/bitcoin/compare/2020-10-libbitcoinruntime-v8...dongcarl:2020-06-libbitcoinruntime\r\n\t\t1. In `src/init.cpp`\r\n\t\t1. In `src/test`\r\n\t\t1. In `src/wallet/test`\r\n\t\t1. In `src/qt/test`\r\n\r\nA few things to note:\r\n- The above ordering is constructed according to the overall call graph of our codebase such that we avoid touching the same function/module twice. \r\n- Due to the length of this overall change, each commit aims to be trivially-reviewable and only requires the reviewer to reason about the correctness of one function/module at a time.\r\n- There are a lot of review-only assertions which can be used to check for correctness. They are removed in 2236237070a45fe570cd0113f0025b0a46ac89be.\r\n",
          "user": {
            "login": "dongcarl",
            "id": 3445290,
            "node_id": "MDQ6VXNlcjM0NDUyOTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dongcarl",
            "html_url": "https://github.com/dongcarl",
            "followers_url": "https://api.github.com/users/dongcarl/followers",
            "following_url": "https://api.github.com/users/dongcarl/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/dongcarl/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/dongcarl/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
            "organizations_url": "https://api.github.com/users/dongcarl/orgs",
            "repos_url": "https://api.github.com/users/dongcarl/repos",
            "events_url": "https://api.github.com/users/dongcarl/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/dongcarl/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135946,
              "node_id": "MDU6TGFiZWwxMzU5NDY=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/GUI",
              "name": "GUI",
              "color": "02d7e1",
              "default": false
            },
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            },
            {
              "id": 97470796,
              "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
              "name": "UTXO Db and Indexes",
              "color": "fbca04",
              "default": false
            },
            {
              "id": 98279177,
              "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
              "name": "RPC/REST/ZMQ",
              "color": "0052cc",
              "default": false
            },
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            },
            {
              "id": 118378960,
              "node_id": "MDU6TGFiZWwxMTgzNzg5NjA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mining",
              "name": "Mining",
              "color": "c7def8",
              "default": false
            },
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            },
            {
              "id": 164208572,
              "node_id": "MDU6TGFiZWwxNjQyMDg1NzI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool",
              "name": "Mempool",
              "color": "fef2c0",
              "default": false
            },
            {
              "id": 192202000,
              "node_id": "MDU6TGFiZWwxOTIyMDIwMDA=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Consensus",
              "name": "Consensus",
              "color": "009800",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "comments": 17,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20158",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/20158",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/20158.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/20158.patch"
          },
          "closed_at": "2021-06-16T16:19:42Z",
          "created_at": "2020-10-15T18:28:35Z",
          "updated_at": "2022-11-27T09:59:55Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 862521331,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2MjUyMTMzMQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862521331",
      "actor": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-16T16:22:58Z",
      "updated_at": "2021-06-16T16:22:58Z",
      "author_association": "MEMBER",
      "body": "Concept ACK. Please tag me in any PR you open.",
      "user": {
        "login": "jnewbery",
        "id": 1063656,
        "node_id": "MDQ6VXNlcjEwNjM2NTY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jnewbery",
        "html_url": "https://github.com/jnewbery",
        "followers_url": "https://api.github.com/users/jnewbery/followers",
        "following_url": "https://api.github.com/users/jnewbery/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jnewbery/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jnewbery/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
        "organizations_url": "https://api.github.com/users/jnewbery/orgs",
        "repos_url": "https://api.github.com/users/jnewbery/repos",
        "events_url": "https://api.github.com/users/jnewbery/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jnewbery/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/21766#issuecomment-862521331",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-17T00:35:09Z",
      "updated_at": "2021-06-17T00:35:09Z",
      "source": {
        "issue": {
          "id": 923255524,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NjcyMDM5NTM0",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22263",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22263/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22263/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22263/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/22263",
          "number": 22263,
          "state": "closed",
          "state_reason": null,
          "title": "refactor: wrap CCoinsViewCursor in unique_ptr",
          "body": "I tripped over this one for a few hours at the beginning of the week, so I've sort of got a personal vendetta against `CCoinsView::Cursor()` returning a raw pointer.\r\n\r\nSpecifically in the case of CCoinsViewDB, if a raw cursor is allocated and not freed, a cryptic leveldb assertion failure occurs on CCoinsViewDB destruction (`Assertion 'dummy_versions_.next_ == &dummy_versions_' failed.`).\r\n\r\nThis is a pretty simple change.\r\n\r\nRelated to: https://github.com/bitcoin/bitcoin/issues/21766\r\nSee also: https://github.com/google/leveldb/issues/142#issuecomment-414418135",
          "user": {
            "login": "jamesob",
            "id": 73197,
            "node_id": "MDQ6VXNlcjczMTk3",
            "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jamesob",
            "html_url": "https://github.com/jamesob",
            "followers_url": "https://api.github.com/users/jamesob/followers",
            "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
            "organizations_url": "https://api.github.com/users/jamesob/orgs",
            "repos_url": "https://api.github.com/users/jamesob/repos",
            "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/jamesob/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 6,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22263",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/22263",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/22263.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/22263.patch"
          },
          "closed_at": "2021-06-23T16:34:47Z",
          "created_at": "2021-06-17T00:35:09Z",
          "updated_at": "2022-08-16T17:24:35Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 862947075,
      "node_id": "MDEyOklzc3VlQ29tbWVudDg2Mjk0NzA3NQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862947075",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-06-17T05:51:59Z",
      "updated_at": "2021-06-17T05:51:59Z",
      "author_association": "MEMBER",
      "body": "4 is addressed in #22263 (can be checked off in OP?)",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/21766#issuecomment-862947075",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21766"
    },
    {
      "event": "referenced",
      "id": 4930005549,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ5MzAwMDU1NDk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4930005549",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "7317e14a44c6efc545e6fb9bcedee7174e93a8fa",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7317e14a44c6efc545e6fb9bcedee7174e93a8fa",
      "created_at": "2021-06-23T16:34:40Z"
    },
    {
      "event": "referenced",
      "id": 4931919152,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ5MzE5MTkxNTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4931919152",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "2dabf43c8fa84c93deb00ad5b0020b7721438dbf",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/2dabf43c8fa84c93deb00ad5b0020b7721438dbf",
      "created_at": "2021-06-24T01:53:03Z"
    }
  ]
}