{
  "type": "issue",
  "issue": {
    "id": 2605720160,
    "node_id": "I_kwDOABII586bUCJg",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31133",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31133/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31133/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31133/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31133",
    "number": 31133,
    "state": "open",
    "state_reason": null,
    "title": "net: Tor service target port collides when running multiple nodes, making bitcoind error out",
    "body": "Various people have reported this on IRC after the 28.0 release, but have not created a GH issue, so i'm creating one.\r\n\r\nTo be able to distinguish incoming localhost connections from connections on the Tor hidden (onion) service, we automatically create a separate \"Tor service target\" P2P port. This port is always opened, even if `-listenonion=0`, because the user might manually configure a Tor hidden service and wants the same behavior.\r\n\r\n[DefaultOnionServiceTarget()](https://github.com/bitcoin/bitcoin/blob/master/src/torcontrol.cpp#L714) creates the CService for the Tor service target port. This number is fixed in the chainparams to [8334](https://github.com/bitcoin/bitcoin/blob/master/src/chainparamsbase.cpp#L44) for mainnet, on localhost.\r\n\r\nNormally, this is no problem. However a common scenario is to run multiple bitcoin nodes on one machine (usually for testing) with different P2P and RPC ports. In this case, they will all try to bind to port 8334 and the latter ones will fail. This problem has existed since the Tor service port was introduced, however it became visible in v0.28 with #22729. After that PR it becomes a crash issue.\r\n(it *was* a problem before because multiple `bitcoind` instances would try to bind on port `8334` while ignoring failures, but still have the wrong internal knowledge that they bound on port 8334, passing this to Tor. So all of Tor's connections would go to the first node)\r\n\r\n*The current suggested workaround* is to manually set `-bind=...`. This removes the automatic onion binds (although explicit `-bind=.....=onion` can be used to create new ones). i have tagged this issue with milestone 28.1 as it could be considered a regression and would be nice to have this automatically work again (especially in cases where the user doesn't care  about Tor, like in regtest harnesses).\r\n\r\nVarious ideas to resolve this have been discussed, among which:\r\n\r\n1. Revert #22729: i strongly dislike this, as it would only bury the problem again. Explicit failures are always better than having to debug silent loss of functionality.\r\n2. Instead of hardcoding port 8334, make it `P2P_port + 1`:  When overriding the `-port`, the Tor service target port changes at the same time. This resolves the problem automatically, except in the edge case where the different `bitcoind` instances' P2P ports are specified very closely together (and maybe it's just better to avoid that in the first place).\r\n3. Disable the Tor service port binding when `-listenonion=0`: This avoids the problem when the user doesn't care about Onion binds, however it means that an extra option has to be set, it's still not nice automatic behavior. Might as well set `-bind=` then.\r\n4. Disable the Tor service port binding when `-regtest`: In case of regtest, it's uncommon to care about Tor. However not always; this would interfere with out own tests when we want to test interaction with Tor. It also doesn't solve the issue in case of sigtest/mainnet.\r\n\r\ni personally prefer 2. It keeps the current behavior, except when port is overridden, and doesn't require any special workarounds.",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/70",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/70",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/70/labels",
      "id": 11766653,
      "node_id": "MI_kwDOABII584As4t9",
      "number": 70,
      "state": "open",
      "title": "28.1",
      "description": "",
      "creator": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 2,
      "closed_issues": 0,
      "created_at": "2024-10-21T08:35:32Z",
      "updated_at": "2024-10-22T14:59:27Z"
    },
    "locked": false,
    "comments": 0,
    "created_at": "2024-10-22T14:59:27Z",
    "updated_at": "2024-10-22T14:59:28Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 14787298168,
      "node_id": "LE_lADOABII586bUCJgzwAAAANxZEN4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787298168",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:59:27Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "milestoned",
      "id": 14787298187,
      "node_id": "MIE_lADOABII586bUCJgzwAAAANxZEOL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787298187",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:59:27Z",
      "milestone": {
        "title": "28.1"
      }
    }
  ]
}