{
  "type": "issue",
  "issue": {
    "id": 386216069,
    "node_id": "MDU6SXNzdWUzODYyMTYwNjk=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14850",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14850/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14850/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14850/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/14850",
    "number": 14850,
    "state": "closed",
    "state_reason": "completed",
    "title": "Race conditions in BerkeleyEnvironment",
    "body": "I believe we should add concurrency control to `BerkeleyEnvironment` members, especially when a wallet is created from `CWallet::CreateWalletFromFile` - the `BerkeleyDatabase` instance is added to `BerkeleyEnvironment::m_databases` without any lock held.\r\n\r\nFrom https://github.com/bitcoin/bitcoin/pull/14552#discussion_r234812302.",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": true,
    "active_lock_reason": "resolved",
    "comments": 1,
    "closed_at": "2020-04-26T16:16:39Z",
    "created_at": "2018-11-30T14:45:21Z",
    "updated_at": "2022-02-15T11:02:53Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 1998107212,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDE5OTgxMDcyMTI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1998107212",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-11-30T14:46:53Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 443551802,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MzU1MTgwMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/443551802",
      "actor": {
        "login": "practicalswift",
        "id": 7826565,
        "node_id": "MDQ6VXNlcjc4MjY1NjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7826565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/practicalswift",
        "html_url": "https://github.com/practicalswift",
        "followers_url": "https://api.github.com/users/practicalswift/followers",
        "following_url": "https://api.github.com/users/practicalswift/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/practicalswift/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/practicalswift/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
        "organizations_url": "https://api.github.com/users/practicalswift/orgs",
        "repos_url": "https://api.github.com/users/practicalswift/repos",
        "events_url": "https://api.github.com/users/practicalswift/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/practicalswift/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-12-02T23:17:22Z",
      "updated_at": "2018-12-02T23:18:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "FWIW TSan complains about races in `BerkeleyEnvironment` when running the unit tests.\r\n\r\nSee output from `./configure --with-sanitizers=thread && make check`",
      "user": {
        "login": "practicalswift",
        "id": 7826565,
        "node_id": "MDQ6VXNlcjc4MjY1NjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7826565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/practicalswift",
        "html_url": "https://github.com/practicalswift",
        "followers_url": "https://api.github.com/users/practicalswift/followers",
        "following_url": "https://api.github.com/users/practicalswift/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/practicalswift/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/practicalswift/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
        "organizations_url": "https://api.github.com/users/practicalswift/orgs",
        "repos_url": "https://api.github.com/users/practicalswift/repos",
        "events_url": "https://api.github.com/users/practicalswift/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/practicalswift/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/14850#issuecomment-443551802",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14850"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "bitcoinhodler",
        "id": 31543633,
        "node_id": "MDQ6VXNlcjMxNTQzNjMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/31543633?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoinhodler",
        "html_url": "https://github.com/bitcoinhodler",
        "followers_url": "https://api.github.com/users/bitcoinhodler/followers",
        "following_url": "https://api.github.com/users/bitcoinhodler/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoinhodler/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoinhodler/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoinhodler/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoinhodler/orgs",
        "repos_url": "https://api.github.com/users/bitcoinhodler/repos",
        "events_url": "https://api.github.com/users/bitcoinhodler/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoinhodler/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-12-23T06:03:06Z",
      "updated_at": "2018-12-23T06:03:06Z",
      "source": {
        "issue": {
          "id": 393726295,
          "node_id": "MDU6SXNzdWUzOTM3MjYyOTU=",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15030",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15030/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15030/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15030/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/15030",
          "number": 15030,
          "state": "closed",
          "state_reason": "completed",
          "title": "Crash: BerkeleyEnvironment::VerifyResult upon `loadwallet`",
          "body": "<!-- Describe the issue -->\r\n\r\n# Problem\r\n\r\nAfter creating a new wallet and running a series of operations concluding with `unloadwallet`, the next time that wallet is loaded with `loadwallet`, `bitcoin-qt` crashes after the following assertion fires:\r\n\r\n    bitcoin-qt: wallet/db.cpp:236: BerkeleyEnvironment::VerifyResult BerkeleyEnvironment::Verify(const string&, BerkeleyEnvironment::recoverFunc_type, std::__cxx11::string&): Assertion `mapFileUseCount.count(strFile) == 0' failed.\r\n\r\n# Recreating\r\n\r\nSee gist: [loadwallet-crash.sh](https://gist.github.com/bitcoinhodler/a46edc6e94557e2952f8001239c63761)\r\n\r\nThis fails reliably for me on v0.17.0.1 release binaries, and also on my local build of v0.17.1rc1, on 32-bit Whonix 13.\r\n\r\n# Possibly related\r\n\r\n#14572, #14850 ",
          "user": {
            "login": "bitcoinhodler",
            "id": 31543633,
            "node_id": "MDQ6VXNlcjMxNTQzNjMz",
            "avatar_url": "https://avatars.githubusercontent.com/u/31543633?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/bitcoinhodler",
            "html_url": "https://github.com/bitcoinhodler",
            "followers_url": "https://api.github.com/users/bitcoinhodler/followers",
            "following_url": "https://api.github.com/users/bitcoinhodler/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/bitcoinhodler/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/bitcoinhodler/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/bitcoinhodler/subscriptions",
            "organizations_url": "https://api.github.com/users/bitcoinhodler/orgs",
            "repos_url": "https://api.github.com/users/bitcoinhodler/repos",
            "events_url": "https://api.github.com/users/bitcoinhodler/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/bitcoinhodler/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 3,
          "closed_at": "2019-06-02T21:45:30Z",
          "created_at": "2018-12-23T06:03:06Z",
          "updated_at": "2021-12-16T14:58:56Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "closed",
      "id": 3273100341,
      "node_id": "MDExOkNsb3NlZEV2ZW50MzI3MzEwMDM0MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3273100341",
      "actor": {
        "login": "promag",
        "id": 3534524,
        "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/promag",
        "html_url": "https://github.com/promag",
        "followers_url": "https://api.github.com/users/promag/followers",
        "following_url": "https://api.github.com/users/promag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/promag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/promag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
        "organizations_url": "https://api.github.com/users/promag/orgs",
        "repos_url": "https://api.github.com/users/promag/repos",
        "events_url": "https://api.github.com/users/promag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/promag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-26T16:16:39Z"
    },
    {
      "event": "locked",
      "id": 6074005067,
      "node_id": "LOE_lADOABII584XBTCFzwAAAAFqCfZL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/6074005067",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-02-15T11:02:53Z",
      "lock_reason": "resolved"
    }
  ]
}