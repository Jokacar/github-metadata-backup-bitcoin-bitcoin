{
  "type": "issue",
  "issue": {
    "id": 453177712,
    "node_id": "MDU6SXNzdWU0NTMxNzc3MTI=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16159",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16159/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16159/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16159/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/16159",
    "number": 16159,
    "state": "open",
    "state_reason": null,
    "title": "listrecievedbyaddress with include_empty not filtering out \"send\" side of address book",
    "body": "I noticed if you call listreceivedbyaddress with true for incude_empty it was skipping the cross-reference against mapTally. The skip causes the entire address book (including \"send\" purpose) to be included in the results erroneously. There should be a \"if purpose not 'send' then include results\".\r\n\r\nCode would be inserted here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/wallet/rpcwallet.cpp#L1122\r\n\r\nsomething like:\r\n```\r\n        if(item_it->second.purpose == \"send\")\r\n            continue;\r\n```",
    "user": {
      "login": "sidhujag",
      "id": 6238042,
      "node_id": "MDQ6VXNlcjYyMzgwNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sidhujag",
      "html_url": "https://github.com/sidhujag",
      "followers_url": "https://api.github.com/users/sidhujag/followers",
      "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
      "organizations_url": "https://api.github.com/users/sidhujag/orgs",
      "repos_url": "https://api.github.com/users/sidhujag/repos",
      "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sidhujag/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 1,
    "created_at": "2019-06-06T18:31:28Z",
    "updated_at": "2022-09-01T15:02:41Z"
  },
  "events": [
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-06-06T23:04:36Z",
      "updated_at": "2019-06-06T23:04:36Z",
      "source": {
        "issue": {
          "id": 452849216,
          "node_id": "MDExOlB1bGxSZXF1ZXN0Mjg1NjU2NjEz",
          "url": "https://api.github.com/repos/syscoin/syscoin/issues/335",
          "repository_url": "https://api.github.com/repos/syscoin/syscoin",
          "labels_url": "https://api.github.com/repos/syscoin/syscoin/issues/335/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/syscoin/syscoin/issues/335/comments",
          "events_url": "https://api.github.com/repos/syscoin/syscoin/issues/335/events",
          "html_url": "https://github.com/syscoin/syscoin/pull/335",
          "number": 335,
          "state": "closed",
          "state_reason": null,
          "title": "Dev 4.x",
          "body": "Multiple bug fixes:\r\n\r\n1) rename syscoin-geth to sgeth.node and syscoin-relayer to srelayer.node. Motivation is to not have syscoin in name because some people might mass strip binaries with syscoin in it or starting with geth or syscoin. We don't want to strip these binaries especially relayer as it is a nodejs bin which is not strippable.\r\n2) We also want to avoid stripping code in Gitian that tries to strip all executables, we avoid *.node* in this case capturing .node and .node.exe files.\r\n3) Fix launching relayer/geth on windows paths with spaces. We weren't quoting the path as the first argument in the argument parameter to CreateProcessW\r\n4) FIx OSX codesigning issue because binaries were put in MacOS rather than resources which codesigning is compatible with since relayer is not code signable as executables.\r\n5) For OSX installer we use add-resources to push to resources for geth/relayer bins\r\n6) Breaking change with governance we missed on initial release, we've updated the governance budget calculation to accurately reflect our medium post earlier last month.\r\n7) Breaking change we had to update the superblock contract as we noticed that forks due to miner variance caused our agent to go off on the wrong chain and we did not have enough agents running to monitor the fork. Now that we are stable for hash power it should be fixed but we need to update the contract to a new one.\r\n8) Fixed lastseen time to accurately reflect the last ping time. This was changed to last paid time but we've noticed that last paid time is 0 for alot fo the time so we went back to last ping time.\r\n9) Fix listreceivedbyaddress which was actually a bitcoin bug https://github.com/bitcoin/bitcoin/issues/16159\r\n10) Fix snapshot asset balances not showing up due to conversion between bech32 and legacy, we convert internally and now Spark should show properly",
          "user": {
            "login": "sidhujag",
            "id": 6238042,
            "node_id": "MDQ6VXNlcjYyMzgwNDI=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sidhujag",
            "html_url": "https://github.com/sidhujag",
            "followers_url": "https://api.github.com/users/sidhujag/followers",
            "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
            "organizations_url": "https://api.github.com/users/sidhujag/orgs",
            "repos_url": "https://api.github.com/users/sidhujag/repos",
            "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/sidhujag/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 0,
          "pull_request": {
            "url": "https://api.github.com/repos/syscoin/syscoin/pulls/335",
            "html_url": "https://github.com/syscoin/syscoin/pull/335",
            "diff_url": "https://github.com/syscoin/syscoin/pull/335.diff",
            "patch_url": "https://github.com/syscoin/syscoin/pull/335.patch"
          },
          "closed_at": "2019-06-06T23:15:07Z",
          "created_at": "2019-06-06T06:13:07Z",
          "updated_at": "2019-06-06T23:21:51Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "labeled",
      "id": 3280136067,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMyODAxMzYwNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3280136067",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-28T12:44:22Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 3280136069,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMyODAxMzYwNjk=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3280136069",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-28T12:44:22Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "commented",
      "id": 1234405923,
      "node_id": "IC_kwDOABII585Jk4oj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234405923",
      "actor": {
        "login": "kouloumos",
        "id": 18506343,
        "node_id": "MDQ6VXNlcjE4NTA2MzQz",
        "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kouloumos",
        "html_url": "https://github.com/kouloumos",
        "followers_url": "https://api.github.com/users/kouloumos/followers",
        "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
        "organizations_url": "https://api.github.com/users/kouloumos/orgs",
        "repos_url": "https://api.github.com/users/kouloumos/repos",
        "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kouloumos/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-09-01T15:02:40Z",
      "updated_at": "2022-09-01T15:02:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "Addresses with  a \"send\" purpose should not be included in the results of the `listreceivedby*` RPCs. \r\n\r\nWhen does a \"send\" purpose is assigned? \r\n- [When using the `addmultisigaddress` RPC](https://github.com/bitcoin/bitcoin/blob/fa5c224d444802dabec5841009e029b9754c92f1/src/wallet/rpc/addresses.cpp#L292).\r\n- [When sending a transaction using the GUI](https://github.com/bitcoin/bitcoin/blob/fa5c224d444802dabec5841009e029b9754c92f1/src/qt/walletmodel.cpp#L282).\r\n- [When using the `setlabel` RPC for an address that is not mine](https://github.com/bitcoin/bitcoin/blob/fa5c224d444802dabec5841009e029b9754c92f1/src/wallet/rpc/addresses.cpp#L145-L149).\r\n\r\nHow to reproduce (legacy & descriptor wallets):\r\n- Create 2 wallets (w1, w2)\r\n  ```shell\r\n   # (using variables for productivity)\r\n   NODE1=\"src/bitcoin-cli -regtest -datadir=/tmp/node1-datadir\"\r\n   $NODE1 -named createwallet wallet_name=w1\r\n   $NODE1 -named createwallet wallet_name=w2\r\n  \r\n   w1=\"$(echo $NODE1) -rpcwallet=w1\"\r\n   w2=\"$(echo $NODE1) -rpcwallet=w2\"\r\n  \r\n   $NODE1 generatetoaddress 101 $($w1 getnewaddress) # fund wallet1\r\n  ```\r\n- Get an address for w2 (This address is added as receiving in the address book of w2)\r\n   ```shell\r\n   w2_addr=$($w2 getnewaddress)\r\n   ```\r\n- Send tx from w1 to `w2_addr` using the GUI or use the `setlabel` RPC with `$w1 setlabel $w2_addr`.\r\n- **Observe that `w2_addr` is returned from `$w1 -named listreceivedbyaddress include_empty=true`.**",
      "user": {
        "login": "kouloumos",
        "id": 18506343,
        "node_id": "MDQ6VXNlcjE4NTA2MzQz",
        "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kouloumos",
        "html_url": "https://github.com/kouloumos",
        "followers_url": "https://api.github.com/users/kouloumos/followers",
        "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
        "organizations_url": "https://api.github.com/users/kouloumos/orgs",
        "repos_url": "https://api.github.com/users/kouloumos/repos",
        "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kouloumos/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/16159#issuecomment-1234405923",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/16159"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "kouloumos",
        "id": 18506343,
        "node_id": "MDQ6VXNlcjE4NTA2MzQz",
        "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kouloumos",
        "html_url": "https://github.com/kouloumos",
        "followers_url": "https://api.github.com/users/kouloumos/followers",
        "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
        "organizations_url": "https://api.github.com/users/kouloumos/orgs",
        "repos_url": "https://api.github.com/users/kouloumos/repos",
        "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kouloumos/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-09-01T15:15:02Z",
      "updated_at": "2022-09-01T15:15:02Z",
      "source": {
        "issue": {
          "id": 1359015170,
          "node_id": "PR_kwDOABII584-OGE6",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25973",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25973/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25973/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25973/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/25973",
          "number": 25973,
          "state": "open",
          "state_reason": null,
          "title": "wallet: Filter-out \"send\" addresses from `listreceivedby*`",
          "body": "`listreceivedbyaddress` & `listreceivedbylabel` RPCs list balances by receiving address and label respectively. That works by creating a tally (`mapTally[address]`) from all the transaction outputs in the wallet and then cross-reference that with the address book in order to calculate which addresses received funds.\r\n\r\nIf an address is in the address book but not in the tally, it's considered empty (never received funds) and is not returned unless `include_empty=true`. That effectively means that when `include_empty=true` the entire address book is included in the result.\r\n\r\n**This creates 2 issues:**\r\n\r\n1. As reported in https://github.com/bitcoin/bitcoin/issues/16159, the address book also includes addresses with a \"send\" purpose which should not be part of the response.\r\n2. As reported in https://github.com/bitcoin/bitcoin/issues/10468, if `include_watchonly=false` [the watchonly addresses are not included in `mapTally`](https://github.com/bitcoin/bitcoin/blob/fa5c224d444802dabec5841009e029b9754c92f1/src/wallet/rpc/transactions.cpp#L120-L122 ) leading to them being considered empty during the subsequent cross-reference with the address book thus becoming part of the result when `include_empty=true`.\r\n\r\nThis PR fixes https://github.com/bitcoin/bitcoin/issues/16159 by filtering-out \"send\" addresses, see https://github.com/bitcoin/bitcoin/issues/16159#issuecomment-1234405923 for more details on the issue. I haven't thought of a nice solution to fix (2) yet.\r\n\r\n**Edit**: Split `wallet_listreceivedby.py` tests for code maintainability as tests for more than one RPC have been added since the creation of the file. Added test coverage for the introduced change.",
          "user": {
            "login": "kouloumos",
            "id": 18506343,
            "node_id": "MDQ6VXNlcjE4NTA2MzQz",
            "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/kouloumos",
            "html_url": "https://github.com/kouloumos",
            "followers_url": "https://api.github.com/users/kouloumos/followers",
            "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
            "organizations_url": "https://api.github.com/users/kouloumos/orgs",
            "repos_url": "https://api.github.com/users/kouloumos/repos",
            "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/kouloumos/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 6,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/25973",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/25973",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/25973.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/25973.patch"
          },
          "created_at": "2022-09-01T15:15:02Z",
          "updated_at": "2023-07-20T13:45:03Z"
        },
        "type": "issue"
      }
    }
  ]
}