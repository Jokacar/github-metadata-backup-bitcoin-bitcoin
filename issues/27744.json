{
  "type": "issue",
  "issue": {
    "id": 1724602364,
    "node_id": "I_kwDOABII585my1f8",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/27744",
    "number": 27744,
    "state": "open",
    "state_reason": null,
    "title": "Log which peer sent us a header (first)",
    "body": "Discussed in https://github.com/bitcoin/bitcoin/pull/27278#issuecomment-1478368582\r\n\r\n```\r\nSaw new header hash=... height=...\r\n```\r\n\r\nIt would be useful to add the node id to this message. The validation code doesn't know which peer the header came from, so we'd have to move the log entry to net_processing.\r\n\r\nOne way is to add a helper function `LogBlockHeader` and call it right after both `ProcessNewBlockHeaders(header, peer, compact_blk)` calls in net_processing, only if they return true. Since we process headers in batches, it's perhaps easiest to only log the last header.\r\n\r\nDoing so would also make the log less noisy when the header is received via a compact block, because this is the same site that produces the `Saw new cmpctblock header hash` message.",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 3,
    "created_at": "2023-05-24T19:21:45Z",
    "updated_at": "2023-06-05T10:42:17Z"
  },
  "events": [
    {
      "event": "unsubscribed",
      "id": 9332714288,
      "node_id": "UE_lADOABII585my1f8zwAAAAIsResw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9332714288",
      "actor": {
        "login": "joostjager",
        "id": 4638168,
        "node_id": "MDQ6VXNlcjQ2MzgxNjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4638168?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/joostjager",
        "html_url": "https://github.com/joostjager",
        "followers_url": "https://api.github.com/users/joostjager/followers",
        "following_url": "https://api.github.com/users/joostjager/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/joostjager/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/joostjager/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/joostjager/subscriptions",
        "organizations_url": "https://api.github.com/users/joostjager/orgs",
        "repos_url": "https://api.github.com/users/joostjager/repos",
        "events_url": "https://api.github.com/users/joostjager/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/joostjager/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T21:08:00Z"
    },
    {
      "event": "commented",
      "id": 1573894340,
      "node_id": "IC_kwDOABII585dz7jE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1573894340",
      "actor": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-02T15:11:30Z",
      "updated_at": "2023-06-02T15:11:30Z",
      "author_association": "NONE",
      "body": "Hey !! I am new into bitcoin developement and if no one is already working to do this change, I am willing to do this.",
      "user": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27744#issuecomment-1573894340",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744"
    },
    {
      "event": "commented",
      "id": 1576530976,
      "node_id": "IC_kwDOABII585d9_Qg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576530976",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T10:24:04Z",
      "updated_at": "2023-06-05T10:24:04Z",
      "author_association": "MEMBER",
      "body": "@Harshil-Jani no need to ask permission. That said, validation and net_processing are usually not the best place to start if you're new to this code. It's easy to make mistakes here, even with something as simple as adding a log entry (e.g. #27673).",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27744#issuecomment-1576530976",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744"
    },
    {
      "event": "mentioned",
      "id": 9431130069,
      "node_id": "MEE_lADOABII585my1f8zwAAAAIyI5_V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9431130069",
      "actor": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T10:24:04Z"
    },
    {
      "event": "subscribed",
      "id": 9431130085,
      "node_id": "SE_lADOABII585my1f8zwAAAAIyI5_l",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9431130085",
      "actor": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T10:24:04Z"
    },
    {
      "event": "commented",
      "id": 1576553817,
      "node_id": "IC_kwDOABII585d-E1Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576553817",
      "actor": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T10:42:16Z",
      "updated_at": "2023-06-05T10:42:16Z",
      "author_association": "NONE",
      "body": "I see. Thanks for this, I will try to look towards something else. ",
      "user": {
        "login": "Harshil-Jani",
        "id": 79367883,
        "node_id": "MDQ6VXNlcjc5MzY3ODgz",
        "avatar_url": "https://avatars.githubusercontent.com/u/79367883?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Harshil-Jani",
        "html_url": "https://github.com/Harshil-Jani",
        "followers_url": "https://api.github.com/users/Harshil-Jani/followers",
        "following_url": "https://api.github.com/users/Harshil-Jani/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Harshil-Jani/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Harshil-Jani/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Harshil-Jani/subscriptions",
        "organizations_url": "https://api.github.com/users/Harshil-Jani/orgs",
        "repos_url": "https://api.github.com/users/Harshil-Jani/repos",
        "events_url": "https://api.github.com/users/Harshil-Jani/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Harshil-Jani/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/27744#issuecomment-1576553817",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27744"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T11:53:29Z",
      "updated_at": "2023-06-05T11:53:29Z",
      "source": {
        "issue": {
          "id": 1741612382,
          "node_id": "PR_kwDOABII585SL5TZ",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27826",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27826/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27826/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27826/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/27826",
          "number": 27826,
          "state": "open",
          "state_reason": null,
          "title": "validation: log which peer sent us a header",
          "body": "Fixes #27744\r\n\r\nSince #27278 we log received headers. For compact blocks we also log which peer sent it (e5ce8576349d404c466b2f4cab1ca7bf920904b2), but not for regular headers. That required an additional refactor, which this PR provides.\r\n\r\nMove the logging from validation to net_processing.\r\n\r\nThis also reduces the number of log entries (under default configuration) per compact block header from 3 to 2: one for the header and one for the connected tip.\r\n\r\nThe PR introduces a new helper method `LogBlockHeader`.\r\n\r\nWhen receiving a _compact block_ we call `LogBlockHeader` from the exact same place as where we previously logged. So that log message doesn't change. What does change is that we no longer _also_ log from `AcceptBlockHeader`.\r\n\r\nWhen receiving a regular header(s) message, _we only log the last one_. This is a change in behaviour because it was simpler to implement, but it's probably better anyway. It does mean that if a peer sends of a bunch of headers of which _any_ is invalid, we won't log it (here).\r\n\r\nLastly I expanded the code comment explaining why we log this. It initially only covered selfish mining, but we also care about peers sending us headers but not following up (see e.g. #27626).\r\n\r\nExample log:\r\n\r\n```\r\n2023-06-05T13:12:21Z Saw new header hash=000000000000000000045910263ef84b575ae3af151865238f1e5c619e69c330 height=792964 peer=0\r\n2023-06-05T13:12:23Z UpdateTip: new best=000000000000000000045910263ef84b575ae3af151865238f1e5c619e69c330 height=792964 version=0x20000000 log2_work=94.223098 tx=848176824 date='2023-06-05T13:11:49Z' progress=1.000000 cache=6.4MiB(54615txo)\r\n2023-06-05T13:14:05Z Saw new cmpctblock header hash=00000000000000000003c6fd4ef2e1246a3f9e1fffab7247344f94cadb9de979 height=792965 peer=0\r\n2023-06-05T13:14:05Z UpdateTip: new best=00000000000000000003c6fd4ef2e1246a3f9e1fffab7247344f94cadb9de979 height=792965 version=0x20000000 log2_work=94.223112 tx=848179461 date='2023-06-05T13:13:58Z' progress=1.000000 cache=7.2MiB(61275txo)\r\n2023-06-05T13:14:41Z Saw new header hash=000000000000000000048e6d69c8399992782d08cb57f5d6cbc81a9f996c3f43 height=792966 peer=8\r\n2023-06-05T13:14:42Z UpdateTip: new best=000000000000000000048e6d69c8399992782d08cb57f5d6cbc81a9f996c3f43 height=792966 version=0x2db3c000 log2_work=94.223126 tx=848182944 date='2023-06-05T13:14:35Z' progress=1.000000 cache=8.0MiB(69837txo)\r\n```",
          "user": {
            "login": "Sjors",
            "id": 10217,
            "node_id": "MDQ6VXNlcjEwMjE3",
            "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Sjors",
            "html_url": "https://github.com/Sjors",
            "followers_url": "https://api.github.com/users/Sjors/followers",
            "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
            "organizations_url": "https://api.github.com/users/Sjors/orgs",
            "repos_url": "https://api.github.com/users/Sjors/repos",
            "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/Sjors/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 7,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27826",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/27826",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/27826.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/27826.patch"
          },
          "created_at": "2023-06-05T11:53:28Z",
          "updated_at": "2023-08-01T22:20:00Z"
        },
        "type": "issue"
      }
    }
  ]
}