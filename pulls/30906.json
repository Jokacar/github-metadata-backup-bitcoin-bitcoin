{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906",
    "id": 2072708954,
    "node_id": "PR_kwDOABII5857iwda",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30906",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30906.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30906.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/50cce20013c97e1257cb9f4c9319701a09b0a196",
    "number": 30906,
    "state": "closed",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "refactor: prohibit direct flags access in CCoinsCacheEntry and remove invalid tests",
    "user": {
      "login": "l0rinc",
      "id": 1841944,
      "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/l0rinc",
      "html_url": "https://github.com/l0rinc",
      "followers_url": "https://api.github.com/users/l0rinc/followers",
      "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
      "organizations_url": "https://api.github.com/users/l0rinc/orgs",
      "repos_url": "https://api.github.com/users/l0rinc/repos",
      "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/l0rinc/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "Similarly to https://github.com/bitcoin/bitcoin/pull/30849, this cleanup is intended to de-risk https://github.com/bitcoin/bitcoin/pull/30673#discussion_r1739909068 by simplifying the coin cache public interface.\r\n\r\n`CCoinsCacheEntry` provided general access to its internal flags state, even though, in reality, it could only be `clean`, `fresh`, `dirty`, or `fresh|dirty` (in the follow-up, we will remove `fresh` without `dirty`).\r\n\r\nOnce it was marked as `dirty`, we couldn’t set the state back to clean with `AddFlags(0)`—tests explicitly checked against that.\r\n\r\nThis PR refines the public interface to make this distinction clearer and to make invalid behavior impossible, rather than just checked by tests. We don't need extensive access to the internals of `CCoinsCacheEntry`, as many tests were simply validating invalid combinations in this way.\r\n\r\nThe last few commits contain significant test refactorings to make `coins_tests` easier to change in follow-ups.",
    "labels": [
      {
        "id": 97470796,
        "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
        "name": "UTXO Db and Indexes",
        "color": "fbca04",
        "default": false
      }
    ],
    "created_at": "2024-09-15T13:39:38Z",
    "updated_at": "2024-12-05T22:15:35Z",
    "closed_at": "2024-12-04T19:09:14Z",
    "mergeable_state": "unknown",
    "merged_at": "2024-12-04T19:09:14Z",
    "merged_by": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "merge_commit_sha": "17372d788e6ca6f5a8452acf88d6b7db4221cb7e",
    "assignee": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "assignees": [
      {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    ],
    "requested_reviewers": [
      {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    ],
    "requested_teams": [],
    "head": {
      "label": "l0rinc:l0rinc/hide-coin-flags",
      "ref": "l0rinc/hide-coin-flags",
      "sha": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 674169038,
        "node_id": "R_kgDOKC8Azg",
        "name": "bitcoin",
        "full_name": "l0rinc/bitcoin",
        "owner": {
          "login": "l0rinc",
          "id": 1841944,
          "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/l0rinc",
          "html_url": "https://github.com/l0rinc",
          "followers_url": "https://api.github.com/users/l0rinc/followers",
          "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
          "organizations_url": "https://api.github.com/users/l0rinc/orgs",
          "repos_url": "https://api.github.com/users/l0rinc/repos",
          "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/l0rinc/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/l0rinc/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/l0rinc/bitcoin",
        "archive_url": "https://api.github.com/repos/l0rinc/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/l0rinc/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/l0rinc/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/l0rinc/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/l0rinc/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/l0rinc/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/l0rinc/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/l0rinc/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/l0rinc/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/l0rinc/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/l0rinc/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/l0rinc/bitcoin/events",
        "forks_url": "https://api.github.com/repos/l0rinc/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/l0rinc/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/l0rinc/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/l0rinc/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/l0rinc/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/l0rinc/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/l0rinc/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/l0rinc/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/l0rinc/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/l0rinc/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/l0rinc/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/l0rinc/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/l0rinc/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/l0rinc/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/l0rinc/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:l0rinc/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/l0rinc/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/l0rinc/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/l0rinc/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/l0rinc/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/l0rinc/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/l0rinc/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/l0rinc/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/l0rinc/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/l0rinc/bitcoin/hooks",
        "svn_url": "https://github.com/l0rinc/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 250671,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-05T09:46:23Z",
        "created_at": "2023-08-03T09:49:12Z",
        "updated_at": "2024-07-18T12:40:18Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "192767410072ad27fc09fc5fb79ee625e717e663",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36485,
        "stargazers_count": 80064,
        "watchers_count": 80064,
        "size": 273256,
        "default_branch": "master",
        "open_issues_count": 658,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-05T20:47:48Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-12-05T22:02:46Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 300,
    "deletions": 366,
    "changed_files": 5,
    "commits": 9,
    "review_comments": 126,
    "comments": 13
  },
  "events": [
    {
      "event": "commented",
      "id": 2351599095,
      "node_id": "IC_kwDOABII586MKo33",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2351599095",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T13:39:41Z",
      "updated_at": "2024-12-05T02:11:59Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/30906.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [laanwj](https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2475532101), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2476055822), [andrewtoth](https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2517783841) |\n| Concept ACK | [davidgumberg](https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2356666728), [hodlinator](https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2312129363) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31308](https://github.com/bitcoin/bitcoin/pull/31308) (ci, iwyu: Treat warnings as errors for specific targets by hebasto)\n* [#31306](https://github.com/bitcoin/bitcoin/pull/31306) (ci: Update Clang in \"tidy\" job by hebasto)\n* [#31132](https://github.com/bitcoin/bitcoin/pull/31132) (validation: fetch block inputs on parallel threads 10% faster IBD by andrewtoth)\n* [#30643](https://github.com/bitcoin/bitcoin/pull/30643) (coins: Add move operations to Coin and CCoinsCacheEntry by l0rinc)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2351599095",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "labeled",
      "id": 14263175918,
      "node_id": "LE_lADOABII586Wnbp3zwAAAANSJsru",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14263175918",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T13:39:43Z",
      "label": {
        "name": "UTXO Db and Indexes",
        "color": "fbca04"
      }
    },
    {
      "event": "renamed",
      "id": 14263190873,
      "node_id": "RTE_lADOABII586Wnbp3zwAAAANSJwVZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14263190873",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T13:47:03Z",
      "rename": {
        "from": "coins: prohibit direct flags access in CCoinsCacheEntry and remove invalid tests",
        "to": "refactor: prohibit direct flags access in CCoinsCacheEntry and remove invalid tests"
      }
    },
    {
      "event": "reviewed",
      "id": 2305366216,
      "node_id": "PRR_kwDOABII586JaRjI",
      "url": null,
      "actor": null,
      "commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\n\nCan we remove any other tests that are trying to add flags that are not FRESH or DIRTY and so are now useless?",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2305366216",
      "submitted_at": "2024-09-15T13:58:32Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14264180856,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANSNiB4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264180856",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T18:36:00Z"
    },
    {
      "event": "commented",
      "id": 2351740285,
      "node_id": "IC_kwDOABII586MLLV9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2351740285",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T18:39:57Z",
      "updated_at": "2024-09-15T19:24:11Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Can we remove any other tests that are trying to add flags that are not FRESH or DIRTY and so are now useless?\r\n\r\nI've merged `NO_ENTRY` and `char(0)` values - this simplifies the cases somewhat.\r\nDo you think we can remove any of the lines? There aren't any duplicates, even after the above change...\r\n\r\nEdit: moved the booleans closer to the edges in later commits.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2351740285",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14264195337,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANSNlkJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264195337",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T18:41:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14264375681,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANSORmB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264375681",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T19:22:19Z"
    },
    {
      "event": "labeled",
      "id": 14264375781,
      "node_id": "LE_lADOABII586Wnbp3zwAAAANSORnl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264375781",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T19:22:23Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 14264615192,
      "node_id": "UNLE_lADOABII586Wnbp3zwAAAANSPMEY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264615192",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T20:35:19Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2305620312,
      "node_id": "PRR_kwDOABII586JbPlY",
      "url": null,
      "actor": null,
      "commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2305620312",
      "submitted_at": "2024-09-15T21:47:34Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "convert_to_draft",
      "id": 14264918477,
      "node_id": "CTDE_lADOABII586Wnbp3zwAAAANSQWHN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14264918477",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-15T23:19:48Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14293766049,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANT-Y-h",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14293766049",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-17T15:59:54Z"
    },
    {
      "event": "reviewed",
      "id": 2310253600,
      "node_id": "PRR_kwDOABII586Js6wg",
      "url": null,
      "actor": null,
      "commit_id": "ba52ebd41673abf63d4495215c84be7244469d30",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2310253600",
      "submitted_at": "2024-09-17T16:29:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2310578143,
      "node_id": "PRR_kwDOABII586JuJ_f",
      "url": null,
      "actor": null,
      "commit_id": "c4bf4d76fea926045cdfb19e8b1e74284724cd9f",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2310578143",
      "submitted_at": "2024-09-17T18:45:28Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "commented",
      "id": 2356666728,
      "node_id": "IC_kwDOABII586Md-Fo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2356666728",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-17T18:55:03Z",
      "updated_at": "2024-09-17T18:55:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK on dropping the bitfield interface for `CCoinsCacheEntry` flags",
      "user": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2356666728",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14302188867,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANUehVD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14302188867",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T06:41:57Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14302291034,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANUe6Ra",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14302291034",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T06:51:55Z"
    },
    {
      "event": "ready_for_review",
      "id": 14302393338,
      "node_id": "RFRE_lADOABII586Wnbp3zwAAAANUfTP6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14302393338",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T07:01:27Z"
    },
    {
      "event": "reviewed",
      "id": 2312647088,
      "node_id": "PRR_kwDOABII586J2DGw",
      "url": null,
      "actor": null,
      "commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2312647088",
      "submitted_at": "2024-09-18T13:12:00Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2312661395,
      "node_id": "PRR_kwDOABII586J2GmT",
      "url": null,
      "actor": null,
      "commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2312661395",
      "submitted_at": "2024-09-18T13:16:42Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14307890491,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANU0RU7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14307890491",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T13:36:50Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14307939786,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANU0dXK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14307939786",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T13:39:48Z"
    },
    {
      "event": "reviewed",
      "id": 2312129363,
      "node_id": "PRR_kwDOABII586J0EtT",
      "url": null,
      "actor": null,
      "commit_id": "5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK.\r\n\r\nReally like the move to put restrictions on how flags are used.",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2312129363",
      "submitted_at": "2024-09-18T22:03:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14319780674,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANVhoNC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14319780674",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-19T08:13:11Z"
    },
    {
      "event": "reviewed",
      "id": 2317044728,
      "node_id": "PRR_kwDOABII586KG0v4",
      "url": null,
      "actor": null,
      "commit_id": "b8bc5989c9395fb522f38c9260e0357a8c29b83d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "I think the commit title `test: Migrate GetCoinsMapEntry to return std::optional<CoinState>` is no longer accurate.\r\n\r\nI didn't find splitting the changes in `coins_tests` up into that many commits to be helpful for review. I ended up reviewing the combined diff for that file. Will review in more depth later.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2317044728",
      "submitted_at": "2024-09-20T02:13:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14349901740,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANXUh-s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14349901740",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-21T15:43:24Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14349915131,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANXUlP7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14349915131",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-21T15:50:45Z"
    },
    {
      "event": "reviewed",
      "id": 2320885732,
      "node_id": "PRR_kwDOABII586KVefk",
      "url": null,
      "actor": null,
      "commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2320885732",
      "submitted_at": "2024-09-22T16:44:44Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2320890297,
      "node_id": "PRR_kwDOABII586KVfm5",
      "url": null,
      "actor": null,
      "commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2320890297",
      "submitted_at": "2024-09-22T17:09:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14362275484,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANYDu6c",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14362275484",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-23T11:41:45Z"
    },
    {
      "event": "reviewed",
      "id": 2334816826,
      "node_id": "PRR_kwDOABII586LKno6",
      "url": null,
      "actor": null,
      "commit_id": "1dd79a32c9c6e0c6cf4ecef00b56972574babced",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2334816826",
      "submitted_at": "2024-09-27T23:51:09Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14438970812,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANcoTW8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14438970812",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-28T06:32:16Z"
    },
    {
      "event": "commented",
      "id": 2381032408,
      "node_id": "IC_kwDOABII586N66vY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2381032408",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-29T00:13:42Z",
      "updated_at": "2024-09-29T00:13:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "crACK cb9be6729c4e27bf2d6d703c0d454a22cbcdb6e1\r\n\r\nThis simplifies the CCoinsCacheEntry interface, which was leaking the flags bitfield as an implementation detail. Now we don't have to worry about fuzzing that, and it will make removing the FRESH-but-not-DIRTY or FRESH-and-spent cases easier in https://github.com/bitcoin/bitcoin/pull/30673.\r\n\r\nAlso, the tests are much saner now and easier to parse by also removing the flags interface there.\r\n\r\nThere are some minor issues with the commits though.\r\n\r\nCommit titles `test: Migrate GetCoinsMapEntry to return std::optional<CoinState>`\r\nand `test: Group values and states in tests into CoinState wrappers` should reference `CoinEntry` now.\r\n\r\n`test: Validate error messages on fail` should add some context in the commit message or description that it is for CCoinsViewCache AddCoin and WriteCoin unit tests.\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2381032408",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "review_requested",
      "id": 14443105575,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAANc4E0n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14443105575",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-29T00:13:47Z",
      "requested_reviewer": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "review_requested",
      "id": 14443105602,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAANc4E1C",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14443105602",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-29T00:13:48Z",
      "requested_reviewer": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14454563898,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANdjyQ6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14454563898",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T11:41:24Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14455893106,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAANdo2xy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14455893106",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T13:07:50Z"
    },
    {
      "event": "commented",
      "id": 2383146568,
      "node_id": "IC_kwDOABII586OC-5I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2383146568",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T13:08:50Z",
      "updated_at": "2024-10-09T08:18:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "No code changes since https://github.com/bitcoin/bitcoin/commit/cb9be6729c4e27bf2d6d703c0d454a22cbcdb6e1, only commit messages (as requested) and rebased on latest master (separately).\r\n\r\nEdit: `git range-diff cb9be67~7..cb9be67 48047ce~7..48047ce `",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2383146568",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "comment_deleted",
      "id": 14637434140,
      "node_id": "CDE_lADOABII586Wnbp3zwAAAANodYUc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14637434140",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-14T14:38:21Z"
    },
    {
      "event": "comment_deleted",
      "id": 14637435150,
      "node_id": "CDE_lADOABII586Wnbp3zwAAAANodYkO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14637435150",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-14T14:38:25Z"
    },
    {
      "event": "labeled",
      "id": 14856562502,
      "node_id": "LE_lADOABII586Wnbp3zwAAAAN1hSdG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14856562502",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T18:13:26Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14857268000,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAAN1j-sg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14857268000",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T19:00:09Z"
    },
    {
      "event": "unlabeled",
      "id": 14858425893,
      "node_id": "UNLE_lADOABII586Wnbp3zwAAAAN1oZYl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14858425893",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T20:28:28Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2401499690,
      "node_id": "PRR_kwDOABII586PI_oq",
      "url": null,
      "actor": null,
      "commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2401499690",
      "submitted_at": "2024-10-29T10:55:38Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2404680812,
      "node_id": "PRR_kwDOABII586PVIRs",
      "url": null,
      "actor": null,
      "commit_id": "3b5b2457f713014fd5073da34b76a5a8cd796e4a",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 3b5b2457f713014fd5073da34b76a5a8cd796e4a. Nice change that should make the API more safe and also makes tests more complete and easier to maintain.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2404680812",
      "submitted_at": "2024-10-30T22:42:16Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "review_requested",
      "id": 15019943603,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAN_Qiaz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15019943603",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-30T22:42:20Z",
      "requested_reviewer": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15035620504,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAAOAMVyY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15035620504",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-31T13:17:01Z"
    },
    {
      "event": "commented",
      "id": 2449822242,
      "node_id": "IC_kwDOABII586SBVIi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2449822242",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-31T13:17:18Z",
      "updated_at": "2024-10-31T13:17:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks a lot @ryanofsky for the review. Applied almost all of your insightful changes, adding two new commits (adding you as coauthor).\r\nYou can view the diff with [`Compare`](https://github.com/bitcoin/bitcoin/compare/3b5b2457f713014fd5073da34b76a5a8cd796e4a..aa2f3139529c054b011a0f75ff314e6d63f0d977) or via `git range-diff 8e1381a..3b5b2457 a6921049..aa2f3139`\r\n\r\nAdded the following commits based on feedback:\r\n* coins, refactor: Assume state after SetClean in AddFlags to prevent dangling pointers\r\n* coins, refactor: Make AddFlags, SetDirty, SetFresh static\r\n\r\nUpdated commit messages to warn about test order changes and method move reasons.\r\nSeparated method move from method changes and other minor moves between commits for clarity.\r\nAsserted both fresh and dirty in tests where flags were changed originally.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2449822242",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "mentioned",
      "id": 15035624849,
      "node_id": "MEE_lADOABII586Wnbp3zwAAAAOAMW2R",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15035624849",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-31T13:17:20Z"
    },
    {
      "event": "subscribed",
      "id": 15035624869,
      "node_id": "SE_lADOABII586Wnbp3zwAAAAOAMW2l",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15035624869",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-31T13:17:20Z"
    },
    {
      "event": "reviewed",
      "id": 2415709430,
      "node_id": "PRR_kwDOABII586P_Mz2",
      "url": null,
      "actor": null,
      "commit_id": "aa2f3139529c054b011a0f75ff314e6d63f0d977",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK aa2f3139529c054b011a0f75ff314e6d63f0d977. Thanks for the updates! Left a few more comments that are not important and you can feel free to ignore.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2415709430",
      "submitted_at": "2024-11-05T14:29:45Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2418862806,
      "node_id": "PRR_kwDOABII586QLOrW",
      "url": null,
      "actor": null,
      "commit_id": "aa2f3139529c054b011a0f75ff314e6d63f0d977",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "re-crACK aa2f3139529c054b011a0f75ff314e6d63f0d977\r\n\r\nIt might be worth updating the `AddFlags` comment now, but otherwise non-blocking nits.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2418862806",
      "submitted_at": "2024-11-06T16:44:14Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15240964691,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAAOMbqpT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15240964691",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "commit_url": "https://api.github.com/repos/l0rinc/bitcoin/commits/9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "created_at": "2024-11-10T12:23:42Z"
    },
    {
      "event": "commented",
      "id": 2466714671,
      "node_id": "IC_kwDOABII586TBxQv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2466714671",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-10T12:24:20Z",
      "updated_at": "2024-11-10T12:24:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks @ryanofsky & @andrewtoth, applied most nits, please re-review: `git range-diff a6921049..aa2f3139 a6921049..9edbe5a4` or https://github.com/bitcoin/bitcoin/compare/aa2f3139529c054b011a0f75ff314e6d63f0d977..9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2466714671",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "mentioned",
      "id": 15240966058,
      "node_id": "MEE_lADOABII586Wnbp3zwAAAAOMbq-q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15240966058",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-10T12:24:21Z"
    },
    {
      "event": "subscribed",
      "id": 15240966063,
      "node_id": "SE_lADOABII586Wnbp3zwAAAAOMbq-v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15240966063",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-10T12:24:21Z"
    },
    {
      "event": "mentioned",
      "id": 15240966067,
      "node_id": "MEE_lADOABII586Wnbp3zwAAAAOMbq-z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15240966067",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-10T12:24:21Z"
    },
    {
      "event": "subscribed",
      "id": 15240966073,
      "node_id": "SE_lADOABII586Wnbp3zwAAAAOMbq-5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15240966073",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-10T12:24:21Z"
    },
    {
      "event": "commented",
      "id": 2468489763,
      "node_id": "IC_kwDOABII586TIioj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2468489763",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-11T15:49:23Z",
      "updated_at": "2024-11-11T15:49:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "re-crACK 9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2468489763",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "review_requested",
      "id": 15252224373,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAONGnl1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15252224373",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-11T15:49:29Z",
      "requested_reviewer": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "reviewed",
      "id": 2427626316,
      "node_id": "PRR_kwDOABII586QsqNM",
      "url": null,
      "actor": null,
      "commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2427626316",
      "submitted_at": "2024-11-11T15:50:04Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2429297641,
      "node_id": "PRR_kwDOABII586QzCPp",
      "url": null,
      "actor": null,
      "commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24. Only small changes since last review like adding an Assume, changing commit messages, renaming self to pair. Thanks for the updates!\r\n\r\nI left two suggestions which are not important and don't affect the final code, just meant to make review a little easier for the next reviewer. Feel free to ignore them or save for a later update.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2429297641",
      "submitted_at": "2024-11-12T11:34:55Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "reviewed",
      "id": 2468800236,
      "node_id": "PRR_kwDOABII586TJubs",
      "url": null,
      "actor": null,
      "commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code reviewed 9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24\r\n\r\nGood that `AddFlags()` was made `static` so one doesn't have both `this` and `self` any longer! 😅\r\n\r\nSurprised that `CCoinsCacheEntry::m_next` and `m_prev` were not nulled out before this PR as is done in `SetClean()` in 9d61b956d91153d25d06047de03133bc2e23b2a6, but seems reasonable. Only caller of `SetClean()` outside of tests is `CoinsViewCacheCursor::NextAndMaybeErase()`. That's the only commit where I feel that more domain expertise would help calm me down. **If anyone has any assuring context to drop on me, please do.**\r\n\r\nIt would be good to make `AddFlags()` `private` in the commit after introducing `SetDirty()` & `SetFresh()` to further clarify that nothing exterior is using it any longer. Also think it may be good to introduce `SetDirty()` & `SetFresh()` as `static` from the start to reduce churn. Doing so makes `AddFlags` a bit harder to review though.\r\n\r\nBranch with my suggested changes:\r\nhttps://github.com/bitcoin/bitcoin/compare/master...hodlinator:bitcoin:pr/30906_suggestions (commit making `AddFlags()` & co `static` is merged into first commit).\r\n[Comparison at this PR.](https://github.com/bitcoin/bitcoin/compare/9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24..840924d5b6d88d6dc841517fade8a78745322e52)",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2468800236",
      "submitted_at": "2024-11-29T13:52:42Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "review_requested",
      "id": 15475952028,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAOacEmc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15475952028",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-29T13:52:48Z",
      "requested_reviewer": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "commented",
      "id": 2507914836,
      "node_id": "IC_kwDOABII586Ve75U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2507914836",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-29T14:21:25Z",
      "updated_at": "2024-11-29T14:21:25Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Surprised that CCoinsCacheEntry::m_next and m_prev were not nulled out before this PR\r\n\r\nThis was brought up but I didn't change it https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1687007975. It does seem cleaner nulling them though.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2507914836",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGNkMDQ5OGVhYmM5MTBlZmEzZWQ3YTZkMzJlNjg3MTA3MjQ4YmI1YmU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cd0498eabc910efa3ed7a6d32e687107248bb5be",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/cd0498eabc910efa3ed7a6d32e687107248bb5be",
      "tree": {
        "sha": "790d18fc681d1aa294cabcff978165fcae81fe5a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/790d18fc681d1aa294cabcff978165fcae81fe5a"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/74fb19317aec6d5156e12da6be63e59e0cc99770",
          "sha": "74fb19317aec6d5156e12da6be63e59e0cc99770",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/74fb19317aec6d5156e12da6be63e59e0cc99770"
        }
      ],
      "message": "coins, refactor: Split up AddFlags to remove invalid states\n\nCCoinsCacheEntry provided general access to its internal flags state, even though in reality it could only be clean, fresh, dirty or fresh|dirty.\n\nAfter it got dirtied we couldn't set the state back to clean by AddFlags(0) - tests were explicitly checking against that.\n\nThis commit cleans up the public interface to make this distinction cleaner and invalid behavior impossible instead of just checked by tests.\nThis includes the removal of redundant `inline` qualifiers (we're inside a struct).\nAlso renamed `self` to `pair` to simplify the upcoming commits.\n\nAlso modernized `EmplaceCoinInternalDANGER` since it was already modified.\n\nCo-authored-by: Andrew Toth <andrewstoth@gmail.com>",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T12:48:04Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-13T08:58:16Z"
      },
      "sha": "cd0498eabc910efa3ed7a6d32e687107248bb5be"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZjOGMyODIwMjJlNmNlNGViM2NlNTI2ODAwYTZhZGEzYjRhMjk5NmQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fc8c282022e6ce4eb3ce526800a6ada3b4a2996d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fc8c282022e6ce4eb3ce526800a6ada3b4a2996d",
      "tree": {
        "sha": "3151b7a2d39a6c2053ce6b98e8d1045faee14688",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3151b7a2d39a6c2053ce6b98e8d1045faee14688"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cd0498eabc910efa3ed7a6d32e687107248bb5be",
          "sha": "cd0498eabc910efa3ed7a6d32e687107248bb5be",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/cd0498eabc910efa3ed7a6d32e687107248bb5be"
        }
      ],
      "message": "coins, refactor: Make AddFlags, SetDirty, SetFresh static\n\nThis makes the `Assume(&self.second == this)` check redundant\n\nCo-authored-by: Ryan Ofsky <ryan@ofsky.org>",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T12:52:32Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-10-31T12:18:13Z"
      },
      "sha": "fc8c282022e6ce4eb3ce526800a6ada3b4a2996d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDZiNzMzNjk5Y2ZjNzkyNTNmZmFlMTUyNzEwNmJhYTQyOGRkNjJmMzk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b733699cfc79253ffae1527106baa428dd62f39",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6b733699cfc79253ffae1527106baa428dd62f39",
      "tree": {
        "sha": "465517c58f8b22d4c659896ad7deaa218143a1b0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/465517c58f8b22d4c659896ad7deaa218143a1b0"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fc8c282022e6ce4eb3ce526800a6ada3b4a2996d",
          "sha": "fc8c282022e6ce4eb3ce526800a6ada3b4a2996d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fc8c282022e6ce4eb3ce526800a6ada3b4a2996d"
        }
      ],
      "message": "coins, refactor: Assume state after SetClean in AddFlags to prevent dangling pointers\n\nCo-authored-by: Ryan Ofsky <ryan@ofsky.org>",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T12:52:34Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-10-31T12:33:36Z"
      },
      "sha": "6b733699cfc79253ffae1527106baa428dd62f39"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE1YWFhODFjMzgxOGI0MTM4NjAyYzEyN2Q2YTE2MDE4YWFlNzU2ODc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/15aaa81c3818b4138602c127d6a16018aae75687",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/15aaa81c3818b4138602c127d6a16018aae75687",
      "tree": {
        "sha": "47efd732eefeacca429e26255e0c5d85526e2ec4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/47efd732eefeacca429e26255e0c5d85526e2ec4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b733699cfc79253ffae1527106baa428dd62f39",
          "sha": "6b733699cfc79253ffae1527106baa428dd62f39",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/6b733699cfc79253ffae1527106baa428dd62f39"
        }
      ],
      "message": "coins, refactor: Remove direct GetFlags access\n\nWe don't need so much access to the internals of CCoinsCacheEntry, since many tests are just exercising invalid combinations this way.\nThis implies that `AddFlags` has private access now.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T12:52:34Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-13T09:13:28Z"
      },
      "sha": "15aaa81c3818b4138602c127d6a16018aae75687"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGNhNzRhYTc0OTBhNTAwNWQyMjdkYTc1ZGM4ZjJkMWFiNzNjNmU5ZDI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2",
      "tree": {
        "sha": "85f8dbff6df63c289559d83ce296977fc713d823",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/85f8dbff6df63c289559d83ce296977fc713d823"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/15aaa81c3818b4138602c127d6a16018aae75687",
          "sha": "15aaa81c3818b4138602c127d6a16018aae75687",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/15aaa81c3818b4138602c127d6a16018aae75687"
        }
      ],
      "message": "test, refactor: Migrate GetCoinsMapEntry to return MaybeCoin",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T13:24:10Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-16T11:49:56Z"
      },
      "sha": "ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQ1ZjhkNjA3YWIxZjhmZDlmYzE3YWJhNDEwNTg2N2I0NTAxMTdiZTI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d5f8d607ab1f8fd9fc17aba4105867b450117be2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d5f8d607ab1f8fd9fc17aba4105867b450117be2",
      "tree": {
        "sha": "1ff576b044cd690906d9d48b6caf647e05fdafd4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1ff576b044cd690906d9d48b6caf647e05fdafd4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2",
          "sha": "ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ca74aa7490a5005d227da75dc8f2d1ab73c6e9d2"
        }
      ],
      "message": "test: Group values and states in tests into CoinEntry wrappers\n\nNote: that this commit affects the test order, but doesn't change its behavior or coverage otherwise.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T13:49:36Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-15T18:21:32Z"
      },
      "sha": "d5f8d607ab1f8fd9fc17aba4105867b450117be2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGMwYjRiMmMxZWVmOTVjMGI2MjY1NzNhOWEyZTIxN2Y0YTU0MWE4ODA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c0b4b2c1eef95c0b626573a9a2e217f4a541a880",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c0b4b2c1eef95c0b626573a9a2e217f4a541a880",
      "tree": {
        "sha": "b142433139308acbfad43cc3a243d1ffce29f235",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b142433139308acbfad43cc3a243d1ffce29f235"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d5f8d607ab1f8fd9fc17aba4105867b450117be2",
          "sha": "d5f8d607ab1f8fd9fc17aba4105867b450117be2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d5f8d607ab1f8fd9fc17aba4105867b450117be2"
        }
      ],
      "message": "test: Validate error messages on fail\n\nThe `ccoins_add` and `ccoins_write` tests check the actual exception error messages now instead of just that they fail for the given parameters.\nThis enables us testing different exceptions in a more fine-grained way in later changes.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T13:49:43Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-18T06:18:44Z"
      },
      "sha": "c0b4b2c1eef95c0b626573a9a2e217f4a541a880"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBhMTU5ZjA5MTQ3NzU3NTZkY2FjMmQ5ZmE3ZmU0ZTRkNGU3MGJhMGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c",
      "tree": {
        "sha": "4d1fcc0847da8c8d47d83b369d5a1995d37a35c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4d1fcc0847da8c8d47d83b369d5a1995d37a35c2"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c0b4b2c1eef95c0b626573a9a2e217f4a541a880",
          "sha": "c0b4b2c1eef95c0b626573a9a2e217f4a541a880",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c0b4b2c1eef95c0b626573a9a2e217f4a541a880"
        }
      ],
      "message": "test, refactor: Remove remaining unbounded flags from coins_tests",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T13:49:45Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-17T15:52:41Z"
      },
      "sha": "0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUwY2NlMjAwMTNjOTdlMTI1N2NiOWY0YzkzMTk3MDFhMDliMGExOTY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/50cce20013c97e1257cb9f4c9319701a09b0a196",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/50cce20013c97e1257cb9f4c9319701a09b0a196",
      "tree": {
        "sha": "cb42b7fe124ea80f0963e5edae9ffb93d6b35d56",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cb42b7fe124ea80f0963e5edae9ffb93d6b35d56"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c",
          "sha": "0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0a159f0914775756dcac2d9fa7fe4e4d4e70ba0c"
        }
      ],
      "message": "test, refactor: Compact ccoins_access and ccoins_spend\n\nAlso added an extra check for `AccessCoin` in `CheckAccessCoin` to make sure its result is also validated.",
      "committer": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-12-02T13:49:45Z"
      },
      "author": {
        "name": "Lőrinc",
        "email": "pap.lorinc@gmail.com",
        "date": "2024-09-18T07:00:52Z"
      },
      "sha": "50cce20013c97e1257cb9f4c9319701a09b0a196"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15493684198,
      "node_id": "HRFPE_lADOABII586Wnbp3zwAAAAObftvm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15493684198",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "commit_url": "https://api.github.com/repos/l0rinc/bitcoin/commits/50cce20013c97e1257cb9f4c9319701a09b0a196",
      "created_at": "2024-12-02T14:11:48Z"
    },
    {
      "event": "commented",
      "id": 2511657756,
      "node_id": "IC_kwDOABII586VtNsc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2511657756",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T14:14:35Z",
      "updated_at": "2024-12-02T14:14:35Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks @hodlinator, updated the PR:\r\n* Removed redundant `inlines` from `struct CCoinsCacheEntry`\r\n* Moved constants above `CoinEntry`and used const and brace init in more places in `coins_tests.cpp`\r\n* Migrated changes inside the commits as soon as possible to minimize churn\r\n* Added `AccessCoin` return value check in `CheckAccessCoin`\r\n* Change `CheckAddCoin` param order to have cache values before the modified values in the row\r\n* Fixed remaining `SetDirty`/`SetFresh` static reference in Fuzz",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2511657756",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "mentioned",
      "id": 15493723117,
      "node_id": "MEE_lADOABII586Wnbp3zwAAAAObf3Pt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15493723117",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T14:14:36Z"
    },
    {
      "event": "subscribed",
      "id": 15493723148,
      "node_id": "SE_lADOABII586Wnbp3zwAAAAObf3QM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15493723148",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-02T14:14:36Z"
    },
    {
      "event": "reviewed",
      "id": 2475532101,
      "node_id": "PRR_kwDOABII586TjZ9F",
      "url": null,
      "actor": null,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Code review ACK 50cce20013c97e1257cb9f4c9319701a09b0a196\r\n\r\ni have checked that behavior stays the same with regard to adding DIRTY and FRESH flags, i did not check all the test changes in detail but overall LGTM.",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2475532101",
      "submitted_at": "2024-12-03T12:24:43Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "review_requested",
      "id": 15508930282,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAOcZ37q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15508930282",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-03T12:24:49Z",
      "requested_reviewer": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "review_requested",
      "id": 15508930437,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAOcZ3-F",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15508930437",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-03T12:24:50Z",
      "requested_reviewer": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "reviewed",
      "id": 2475766827,
      "node_id": "PRR_kwDOABII586TkTQr",
      "url": null,
      "actor": null,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2475766827",
      "submitted_at": "2024-12-03T14:18:12Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "review_requested",
      "id": 15510603967,
      "node_id": "RRE_lADOABII586Wnbp3zwAAAAOcgQi_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15510603967",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-03T14:18:22Z",
      "requested_reviewer": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "reviewed",
      "id": 2476055822,
      "node_id": "PRR_kwDOABII586TlZ0O",
      "url": null,
      "actor": null,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 50cce20013c97e1257cb9f4c9319701a09b0a196. Looks good! Thanks for the followups.\r\n\r\nSince last review, coins.h commits were reorganized to minimize diffs, but only overall change was to drop redundant `inline` keywords. In `coins_tests.cpp` a lot of smaller changes were made like adding `const` to amount parameters (which is not great but ok), using more brace initialization, changing CheckAddCoin parameter order, and fixing up some comments.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#pullrequestreview-2476055822",
      "submitted_at": "2024-12-03T15:33:19Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
    },
    {
      "event": "commented",
      "id": 2517783841,
      "node_id": "IC_kwDOABII586WElUh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2517783841",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T15:29:50Z",
      "updated_at": "2024-12-04T15:29:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "Code Review ACK 50cce20013c97e1257cb9f4c9319701a09b0a196\r\n\r\nOnly behavior change from last review seems to be the new check in `CheckAccessCoin`.\r\n\r\nI'm not sure why `inline`s needed to be dropped.\r\n\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2517783841",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "commented",
      "id": 2517907461,
      "node_id": "IC_kwDOABII586WFDgF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2517907461",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T16:15:03Z",
      "updated_at": "2024-12-04T16:15:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "Will merge this soon since it has 3 ACKs and mostly consists of test changes and a few straightforward cleanups in coins.h/coins.cpp.\r\n\r\nI think the only part of this that might deserve some extra scrutiny is commit 6b733699cfc79253ffae1527106baa428dd62f39 which sets no longer used pointers to null and adds Assume calls to check that they are null. Reviewers also seemed to disagree about [const](https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867774375) and [inline](https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2517783841) changes, but these are minor changes and clang-tidy is able to check for them so they could be revisited again in a broader context:\r\n\r\nhttps://clang.llvm.org/extra/clang-tidy/checks/readability/avoid-const-params-in-decls.html\r\nhttps://clang.llvm.org/extra/clang-tidy/checks/readability/redundant-inline-specifier.html",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2517907461",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    },
    {
      "event": "assigned",
      "id": 15529103803,
      "node_id": "AE_lADOABII586Wnbp3zwAAAAOdm1G7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15529103803",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T16:15:34Z",
      "assignee": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "merged",
      "id": 15531281642,
      "node_id": "ME_lADOABII586Wnbp3zwAAAAOdvIzq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15531281642",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "17372d788e6ca6f5a8452acf88d6b7db4221cb7e",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/17372d788e6ca6f5a8452acf88d6b7db4221cb7e",
      "created_at": "2024-12-04T19:09:14Z"
    },
    {
      "event": "closed",
      "id": 15531281682,
      "node_id": "CE_lADOABII586Wnbp3zwAAAAOdvI0S",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15531281682",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T19:09:14Z"
    },
    {
      "event": "head_ref_deleted",
      "id": 15531349168,
      "node_id": "HRDE_lADOABII586Wnbp3zwAAAAOdvZSw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15531349168",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T19:14:56Z"
    },
    {
      "event": "commented",
      "id": 2521571872,
      "node_id": "IC_kwDOABII586WTCIg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2521571872",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T22:10:34Z",
      "updated_at": "2024-12-05T22:15:35Z",
      "author_association": "CONTRIBUTOR",
      "body": "post-merge ACK https://github.com/bitcoin/bitcoin/commit/50cce20013c97e1257cb9f4c9319701a09b0a196\r\n\r\nThis refactor reduces the risk of  `CCoinsCacheEntry`'s interfaces, and making `CCoinsCacheEntry::AddFlags()` static is a big improvement for readability (and safety).\r\n\r\nI did not thoroughly review the refactors to unit tests, but they seem correct to me.\r\n\r\nMore broadly, I think the changes made here to `SetClean()` are good, but `SetClean()` being public (only used externally by `NextAndMaybeErase()`) seems dangerous to me. The invariant that the code currently respects is that a coin's state has been written to the parent/backing view before `NextAndMaybeErase()`->`SetClean()`, so removing DIRTY and FRESH flags are fine, but is it risky to have an interface that doesn't enforce that?",
      "user": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#issuecomment-2521571872",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30906"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760052629",
      "pull_request_review_id": 2305366216,
      "id": 1760052629,
      "node_id": "PRRC_kwDOABII585o6EWV",
      "diff_hunk": "@@ -616,7 +617,9 @@ void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const C\n         } else {\n             value = it->second.coin.out.nValue;\n         }\n-        flags = it->second.GetFlags();\n+        flags = 0;\n+        if (it->second.IsDirty()) flags |= DIRTY;\n+        if (it->second.IsFresh()) flags |= FRESH;\n         assert(flags != NO_ENTRY);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This assertion is obviated now.",
      "created_at": "2024-09-15T13:52:51Z",
      "updated_at": "2024-09-15T13:58:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760052629",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760052629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 623,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760052862",
      "pull_request_review_id": 2305366216,
      "id": 1760052862,
      "node_id": "PRRC_kwDOABII585o6EZ-",
      "diff_hunk": "@@ -708,7 +711,7 @@ static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount exp\n     GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n     BOOST_CHECK_EQUAL(result_value, expected_value);\n     BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+}",
      "path": "src/test/coins_tests.cpp",
      "position": 248,
      "original_position": 26,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why was this changed?",
      "created_at": "2024-09-15T13:54:17Z",
      "updated_at": "2024-09-15T13:58:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760052862",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760052862"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 711,
      "original_line": 711,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760053494",
      "pull_request_review_id": 2305366216,
      "id": 1760053494,
      "node_id": "PRRC_kwDOABII585o6Ej2",
      "diff_hunk": "@@ -146,70 +146,48 @@ BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n     // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    n1.second.SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n     // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    n2.second.SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n     // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    n1.second.SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n     // Check that we can clear flags then re-add them\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Check that calling `ClearFlags` with 0 flags has no effect\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n     // But adding DIRTY re-inserts it after n2",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 124,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`But` can be removed now.",
      "created_at": "2024-09-15T13:57:05Z",
      "updated_at": "2024-09-15T13:58:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760053494",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760053494"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760102028",
      "pull_request_review_id": 2305399341,
      "id": 1760102028,
      "node_id": "PRRC_kwDOABII585o6QaM",
      "diff_hunk": "@@ -708,7 +711,7 @@ static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount exp\n     GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n     BOOST_CHECK_EQUAL(result_value, expected_value);\n     BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+}",
      "path": "src/test/coins_tests.cpp",
      "position": 248,
      "original_position": 26,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": 1760052862,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Because class declarations don't need semicolons, but I'll revert if you find it distracting",
      "created_at": "2024-09-15T16:01:49Z",
      "updated_at": "2024-09-15T16:01:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760102028",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760102028"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 711,
      "original_line": 711,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760258646",
      "pull_request_review_id": 2305550025,
      "id": 1760258646,
      "node_id": "PRRC_kwDOABII585o62pW",
      "diff_hunk": "@@ -616,7 +617,9 @@ void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const C\n         } else {\n             value = it->second.coin.out.nValue;\n         }\n-        flags = it->second.GetFlags();\n+        flags = 0;\n+        if (it->second.IsDirty()) flags |= DIRTY;\n+        if (it->second.IsFresh()) flags |= FRESH;\n         assert(flags != NO_ENTRY);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": 1760052629,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Replaced it with a flag validation",
      "created_at": "2024-09-15T18:35:58Z",
      "updated_at": "2024-09-15T18:35:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760258646",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760258646"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 623,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760258689",
      "pull_request_review_id": 2305550076,
      "id": 1760258689,
      "node_id": "PRRC_kwDOABII585o62qB",
      "diff_hunk": "@@ -146,70 +146,48 @@ BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n     // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    n1.second.SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n     // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    n2.second.SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n     // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    n1.second.SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n     // Check that we can clear flags then re-add them\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Check that calling `ClearFlags` with 0 flags has no effect\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n     // But adding DIRTY re-inserts it after n2",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 124,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": 1760053494,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-09-15T18:36:02Z",
      "updated_at": "2024-09-15T18:36:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760258689",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760258689"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760349038",
      "pull_request_review_id": 2305620312,
      "id": 1760349038,
      "node_id": "PRRC_kwDOABII585o7Mtu",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Since we don't pass a bitmap as flags anymore, does it make sense to get rid of the `char` type for flags in `coins_tests` and replace with a more descriptive enum?\r\n```C++\r\nenum Flags\r\n{\r\n   Clean,\r\n   Dirty,\r\n   Fresh,\r\n   DirtyAndFresh\r\n};\r\n```\r\n\r\nCould also be a `std::optional<Flags>` so we can handle the `NO_ENTRY` case cleanly instead of with a `-1`.",
      "created_at": "2024-09-15T21:47:34Z",
      "updated_at": "2024-09-15T21:54:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760349038",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760349038"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760375960",
      "pull_request_review_id": 2305631302,
      "id": 1760375960,
      "node_id": "PRRC_kwDOABII585o7TSY",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "what's the difference between clean and NO_ENTRY? Does that difference still make sense after this change?\r\n\r\n> get rid of the char type for flags in coins_tests and replace with a more descriptive enum\r\n\r\nSince we don't have flags in the production code anymore I would prefer getting rid of them in the tests as well. Reintroducing an enum would kinda' defeat that purpose in my opinion.\r\n\r\nTo make sure the tests are still checking the same combinations, I have added a few scripted diffs to transition the tests away from the flags - now the tabular data displays dirty and fresh booleans instead (I guess we can group some of the examples into `CoinMapEntry` as well, if needed).\r\nThis should help us selectively decide which combinations are still valid.\r\nWhat do you think?",
      "created_at": "2024-09-15T22:53:50Z",
      "updated_at": "2024-09-15T22:53:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760375960",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760375960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760378255",
      "pull_request_review_id": 2305632140,
      "id": 1760378255,
      "node_id": "PRRC_kwDOABII585o7T2P",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`Clean` means not dirty and not fresh. `NO_ENTRY` is a special value that is not a possible flag but signals to the tests that that entry does not exist. With proper types, that would correspond to a `std::nullopt`.\r\nWe don't have to name the enum `Flags`, we can name it `EntryState`. That way we don't have to validate the `flags` variable to see if it's one of the values we will accept. That is better served by using an enum and std::optional.",
      "created_at": "2024-09-15T22:59:19Z",
      "updated_at": "2024-09-15T22:59:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760378255",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760378255"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760380040",
      "pull_request_review_id": 2305632784,
      "id": 1760380040,
      "node_id": "PRRC_kwDOABII585o7USI",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't think replacing with true and false is the right approach. Using enums, tests would be like\r\n```\r\nCheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\r\nbecomes\r\nCheckAccessCoin(VALUE1, SPENT , SPENT , DirtyAndFresh, DirtyAndFresh);\r\n\r\nCheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY    );\r\nbecomes\r\nCheckSpendCoins(ABSENT, SPENT , ABSENT, Fresh      , std::nullopt);\r\n```",
      "created_at": "2024-09-15T23:03:42Z",
      "updated_at": "2024-09-15T23:11:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760380040",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760380040"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760380094",
      "pull_request_review_id": 2305632812,
      "id": 1760380094,
      "node_id": "PRRC_kwDOABII585o7US-",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> is a special value that is not a possible flag but signals to the tests that that entry does not exist\r\n\r\n> That is better served by using an enum and std::optional.\r\n\r\nThanks, I'll investigate tomorrow.\r\nPlease leave some comments about the overall direction as well, do you think this new test layout is more readable or less?\r\nDrafting until then.",
      "created_at": "2024-09-15T23:03:51Z",
      "updated_at": "2024-09-15T23:20:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760380094",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1760380094"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763508568",
      "pull_request_review_id": 2310194905,
      "id": 1763508568,
      "node_id": "PRRC_kwDOABII585pHQFY",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Did a significant restructure, the tabular tests should be a lot easier to comprehend and modify now.\r\nAlso testing the exception messages directly, you'll need this in your new PR.\r\nI still need to get rid of remaining flags in the tests, will do that tomorrow - any early feedback until then is appreciated.",
      "created_at": "2024-09-17T16:04:00Z",
      "updated_at": "2024-09-17T16:11:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1763508568",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763508568"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763544909",
      "pull_request_review_id": 2310253600,
      "id": 1763544909,
      "node_id": "PRRC_kwDOABII585pHY9N",
      "diff_hunk": "@@ -562,6 +564,15 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinStruct {\n+    const CAmount value;\n+    const char flags;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "ba52ebd41673abf63d4495215c84be7244469d30",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I still think this should be an enum named `EntryState` or something, with all combinations of flags like https://github.com/bitcoin/bitcoin/pull/30906/commits/ba52ebd41673abf63d4495215c84be7244469d30#r1760349038. That's the proper way to do this instead of defining static vars for each value of a char we care about.",
      "created_at": "2024-09-17T16:29:27Z",
      "updated_at": "2024-09-17T16:29:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1763544909",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763544909"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 569,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763548746",
      "pull_request_review_id": 2310259965,
      "id": 1763548746,
      "node_id": "PRRC_kwDOABII585pHZ5K",
      "diff_hunk": "@@ -562,6 +564,15 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinStruct {\n+    const CAmount value;\n+    const char flags;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "ba52ebd41673abf63d4495215c84be7244469d30",
      "in_reply_to_id": 1763544909,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Absolutely, that's my plan for tomorrow - but needed to clean up the test before doing that",
      "created_at": "2024-09-17T16:32:43Z",
      "updated_at": "2024-09-17T16:32:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1763548746",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763548746"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 569,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763731654",
      "pull_request_review_id": 2310578143,
      "id": 1763731654,
      "node_id": "PRRC_kwDOABII585pIGjG",
      "diff_hunk": "@@ -663,47 +663,43 @@ static void CheckAccessCoin(CAmount base_value, CoinStruct coin_state, CoinStruc\n     test.cache.SelfTest(/*sanity_check=*/false);\n     BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected_coin_state);\n }\n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n-{\n-    CheckAccessCoin(base_value, CoinStruct(cache_value, cache_flags), CoinStruct(expected_value, expected_flags));\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n      *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *              Base     Cache   Cache          Result  Result\n+     *              Value    Value   Flags          Value   Flags\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    CheckAccessCoin(ABSENT, {ABSENT, NO_ENTRY   }, {ABSENT, NO_ENTRY   });\n+    CheckAccessCoin(ABSENT, {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(ABSENT, {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(ABSENT, {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(ABSENT, {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(ABSENT, {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(ABSENT, {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(ABSENT, {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(ABSENT, {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});\n+    CheckAccessCoin(SPENT , {ABSENT, NO_ENTRY   }, {ABSENT, NO_ENTRY   });\n+    CheckAccessCoin(SPENT , {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(SPENT , {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(SPENT , {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(SPENT , {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(SPENT , {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(SPENT , {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(SPENT , {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(SPENT , {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});\n+    CheckAccessCoin(VALUE1, {ABSENT, NO_ENTRY   }, {VALUE1, UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(VALUE1, {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(VALUE1, {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(VALUE1, {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(VALUE1, {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(VALUE1, {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 73,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "c4bf4d76fea926045cdfb19e8b1e74284724cd9f",
      "in_reply_to_id": null,
      "user": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: Could be made into a loop as below",
      "created_at": "2024-09-17T18:45:28Z",
      "updated_at": "2024-09-17T18:45:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1763731654",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1763731654"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 702,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764488736",
      "pull_request_review_id": 2311774268,
      "id": 1764488736,
      "node_id": "PRRC_kwDOABII585pK_Yg",
      "diff_hunk": "@@ -571,11 +571,19 @@ const static CAmount VALUE2 = 200;\n const static CAmount VALUE3 = 300;\n const static char DIRTY = CCoinsCacheEntry::DIRTY;\n const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;",
      "path": "src/test/coins_tests.cpp",
      "position": 21,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "390c670c37fbb1601d6de42d72dceb74e6bc84fa",
      "in_reply_to_id": 1760349038,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-09-18T06:43:38Z",
      "updated_at": "2024-09-18T06:43:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1764488736",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764488736"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764497635",
      "pull_request_review_id": 2311788691,
      "id": 1764497635,
      "node_id": "PRRC_kwDOABII585pLBjj",
      "diff_hunk": "@@ -562,6 +564,15 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinStruct {\n+    const CAmount value;\n+    const char flags;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "ba52ebd41673abf63d4495215c84be7244469d30",
      "in_reply_to_id": 1763544909,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-09-18T06:52:15Z",
      "updated_at": "2024-09-18T06:52:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1764497635",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764497635"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 569,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764507421",
      "pull_request_review_id": 2311804549,
      "id": 1764507421,
      "node_id": "PRRC_kwDOABII585pLD8d",
      "diff_hunk": "@@ -663,47 +663,43 @@ static void CheckAccessCoin(CAmount base_value, CoinStruct coin_state, CoinStruc\n     test.cache.SelfTest(/*sanity_check=*/false);\n     BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected_coin_state);\n }\n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n-{\n-    CheckAccessCoin(base_value, CoinStruct(cache_value, cache_flags), CoinStruct(expected_value, expected_flags));\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n      *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *              Base     Cache   Cache          Result  Result\n+     *              Value    Value   Flags          Value   Flags\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, UNCHANGED  , UNCHANGED  );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    CheckAccessCoin(ABSENT, {ABSENT, NO_ENTRY   }, {ABSENT, NO_ENTRY   });\n+    CheckAccessCoin(ABSENT, {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(ABSENT, {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(ABSENT, {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(ABSENT, {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(ABSENT, {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(ABSENT, {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(ABSENT, {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(ABSENT, {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});\n+    CheckAccessCoin(SPENT , {ABSENT, NO_ENTRY   }, {ABSENT, NO_ENTRY   });\n+    CheckAccessCoin(SPENT , {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(SPENT , {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(SPENT , {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(SPENT , {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(SPENT , {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(SPENT , {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(SPENT , {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(SPENT , {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});\n+    CheckAccessCoin(VALUE1, {ABSENT, NO_ENTRY   }, {VALUE1, UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {SPENT , UNCHANGED  }, {SPENT , UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {SPENT , FRESH      }, {SPENT , FRESH      });\n+    CheckAccessCoin(VALUE1, {SPENT , DIRTY      }, {SPENT , DIRTY      });\n+    CheckAccessCoin(VALUE1, {SPENT , DIRTY|FRESH}, {SPENT , DIRTY|FRESH});\n+    CheckAccessCoin(VALUE1, {VALUE2, UNCHANGED  }, {VALUE2, UNCHANGED  });\n+    CheckAccessCoin(VALUE1, {VALUE2, FRESH      }, {VALUE2, FRESH      });\n+    CheckAccessCoin(VALUE1, {VALUE2, DIRTY      }, {VALUE2, DIRTY      });\n+    CheckAccessCoin(VALUE1, {VALUE2, DIRTY|FRESH}, {VALUE2, DIRTY|FRESH});",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 73,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "c4bf4d76fea926045cdfb19e8b1e74284724cd9f",
      "in_reply_to_id": 1763731654,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done, thanks!",
      "created_at": "2024-09-18T07:01:07Z",
      "updated_at": "2024-09-18T07:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1764507421",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764507421"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 702,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764709955",
      "pull_request_review_id": 2312129363,
      "id": 1764709955,
      "node_id": "PRRC_kwDOABII585pL1ZD",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        assert(flags & DIRTY || flags & FRESH);",
      "path": "src/coins.h",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: terseness++\r\n```suggestion\r\n        assert(flags & (DIRTY | FRESH));\r\n```",
      "created_at": "2024-09-18T09:27:10Z",
      "updated_at": "2024-09-18T22:03:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1764709955",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1764709955"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765031560",
      "pull_request_review_id": 2312647088,
      "id": 1765031560,
      "node_id": "PRRC_kwDOABII585pND6I",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n    inline void SetClean() noexcept\r\n```",
      "created_at": "2024-09-18T13:11:59Z",
      "updated_at": "2024-09-18T13:12:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765031560",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765031560"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765039768",
      "pull_request_review_id": 2312661395,
      "id": 1765039768,
      "node_id": "PRRC_kwDOABII585pNF6Y",
      "diff_hunk": "@@ -589,314 +632,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinStruct& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinStruct{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            ToCaching(it->second.IsDirty(), it->second.IsFresh())};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 122,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Do we need a new function if we're only calling it the one time here? Just seems like unnecessary indirection.",
      "created_at": "2024-09-18T13:16:42Z",
      "updated_at": "2024-09-18T14:29:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765039768",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765039768"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 651,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765076854",
      "pull_request_review_id": 2312729724,
      "id": 1765076854,
      "node_id": "PRRC_kwDOABII585pNO92",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Excellent, fixed in https://github.com/bitcoin/bitcoin/compare/b2f9df78176011b616a1715387aa43fce747d589..5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "created_at": "2024-09-18T13:36:54Z",
      "updated_at": "2024-09-18T13:40:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765076854",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765076854"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765076974",
      "pull_request_review_id": 2312729883,
      "id": 1765076974,
      "node_id": "PRRC_kwDOABII585pNO_u",
      "diff_hunk": "@@ -589,314 +632,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinStruct& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinStruct{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            ToCaching(it->second.IsDirty(), it->second.IsFresh())};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 122,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765039768,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Converting flags to enums isn't the responsibility of this method, that's why I've extracted it.",
      "created_at": "2024-09-18T13:36:57Z",
      "updated_at": "2024-09-18T13:36:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765076974",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765076974"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 651,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765112447",
      "pull_request_review_id": 2312129363,
      "id": 1765112447,
      "node_id": "PRRC_kwDOABII585pNXp_",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "While \"clean\" is the opposite of \"dirty\", it doesn't involve how *fresh* something is. It's on another dimension.\r\n\r\nI actually prefer `ClearFlags()`, `ClearState()` or possibly `Reset-something()`.\r\n\r\nSame goes for `Caching::CLEAN`. Would prefer `VOID`/`EMPTY`/`INIT`/`NULL`.",
      "created_at": "2024-09-18T13:57:01Z",
      "updated_at": "2024-09-18T22:03:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765112447",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765112447"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765771596",
      "pull_request_review_id": 2312129363,
      "id": 1765771596,
      "node_id": "PRRC_kwDOABII585pP4lM",
      "diff_hunk": "@@ -562,20 +564,61 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+enum class Caching {\n+    CLEAN,\n+    DIRTY,\n+    FRESH,\n+    DIRTY_FRESH,\n+};\n+\n+struct CoinStruct {\n+    const CAmount value;\n+    const Caching caching;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 22,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Types should for the most part be nouns IMO. Seldom verbs in present participle like `Caching`. `CoinStruct` feels a bit WIP too.\r\n\r\nSuggestions:\r\n```suggestion\r\nstruct CoinState {\r\n    const CAmount value;\r\n    const CacheState cache;\r\n```\r\n```suggestion\r\nstruct CoinCache {\r\n    enum State {\r\n        CLEAN,\r\n        DIRTY,\r\n        FRESH,\r\n        DIRTY_FRESH,\r\n    };\r\n    const CAmount value;\r\n    const State state;\r\n```",
      "created_at": "2024-09-18T21:52:19Z",
      "updated_at": "2024-09-18T22:03:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765771596",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765771596"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 574,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765803669",
      "pull_request_review_id": 2313928208,
      "id": 1765803669,
      "node_id": "PRRC_kwDOABII585pQAaV",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "*fresh* is actually a substate of *dirty*. Being *fresh* implies *dirty*, so cleaning implies no longer fresh.\r\n\r\nSee https://github.com/bitcoin/bitcoin/pull/30673 which inspired this, which intends to remove possibility of FRESH-but-not-DIRTY entries.",
      "created_at": "2024-09-18T22:27:21Z",
      "updated_at": "2024-09-18T22:33:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1765803669",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1765803669"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766285389",
      "pull_request_review_id": 2314608427,
      "id": 1766285389,
      "node_id": "PRRC_kwDOABII585pR2BN",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`FRESH` is definitely a [very confusing concept](https://github.com/bitcoin/bitcoin/blob/master/src/coins.h#L143-L151)\r\n> the parent cache does not have this coin or that it is a spent coin in the parent cache\r\n\r\nMaybe after https://github.com/bitcoin/bitcoin/pull/30673 we can find a better name (and description) for it",
      "created_at": "2024-09-19T07:13:06Z",
      "updated_at": "2024-09-19T07:13:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1766285389",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766285389"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766373294",
      "pull_request_review_id": 2314752983,
      "id": 1766373294,
      "node_id": "PRRC_kwDOABII585pSLeu",
      "diff_hunk": "@@ -562,20 +564,61 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+enum class Caching {\n+    CLEAN,\n+    DIRTY,\n+    FRESH,\n+    DIRTY_FRESH,\n+};\n+\n+struct CoinStruct {\n+    const CAmount value;\n+    const Caching caching;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 22,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "in_reply_to_id": 1765771596,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Had a few versions before, played around with it a bit more, thanks for the pointers, what do you think of the [new structure and names](https://github.com/bitcoin/bitcoin/compare/5d6937c7ce7361befa752dec4b6738b72702dc3d..b8bc5989c9395fb522f38c9260e0357a8c29b83d).",
      "created_at": "2024-09-19T08:13:44Z",
      "updated_at": "2024-09-19T08:14:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1766373294",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766373294"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 574,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766374252",
      "pull_request_review_id": 2314754553,
      "id": 1766374252,
      "node_id": "PRRC_kwDOABII585pSLts",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        assert(flags & DIRTY || flags & FRESH);",
      "path": "src/coins.h",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1764709955,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Clever, thanks!",
      "created_at": "2024-09-19T08:14:26Z",
      "updated_at": "2024-09-19T08:14:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1766374252",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766374252"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767504341",
      "pull_request_review_id": 2316597052,
      "id": 1767504341,
      "node_id": "PRRC_kwDOABII585pWfnV",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Okay, so `FRESH` and `DIRTY_FRESH` will merge into one. :+1: ",
      "created_at": "2024-09-19T19:39:03Z",
      "updated_at": "2024-09-19T19:39:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767504341",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767504341"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767510588",
      "pull_request_review_id": 2316607414,
      "id": 1767510588,
      "node_id": "PRRC_kwDOABII585pWhI8",
      "diff_hunk": "@@ -562,20 +564,61 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+enum class Caching {\n+    CLEAN,\n+    DIRTY,\n+    FRESH,\n+    DIRTY_FRESH,\n+};\n+\n+struct CoinStruct {\n+    const CAmount value;\n+    const Caching caching;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 22,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "in_reply_to_id": 1765771596,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Like it! Moves related things closer together.",
      "created_at": "2024-09-19T19:45:19Z",
      "updated_at": "2024-09-19T19:45:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767510588",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767510588"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 574,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767514943",
      "pull_request_review_id": 2316614423,
      "id": 1767514943,
      "node_id": "PRRC_kwDOABII585pWiM_",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "rather `FRESH` will be removed in the mentioned follow-up, since it's not actually possible (unless in case of reorgs, which I don't fully understand yet, but not important for this PR)",
      "created_at": "2024-09-19T19:49:33Z",
      "updated_at": "2024-09-19T19:49:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767514943",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767514943"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767516058",
      "pull_request_review_id": 2316616232,
      "id": 1767516058,
      "node_id": "PRRC_kwDOABII585pWiea",
      "diff_hunk": "@@ -562,20 +564,61 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+enum class Caching {\n+    CLEAN,\n+    DIRTY,\n+    FRESH,\n+    DIRTY_FRESH,\n+};\n+\n+struct CoinStruct {\n+    const CAmount value;\n+    const Caching caching;",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 22,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "5d6937c7ce7361befa752dec4b6738b72702dc3d",
      "in_reply_to_id": 1765771596,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The usages are a lot more verbose, but I've extracted everything important now, so the tables are still readable",
      "created_at": "2024-09-19T19:50:40Z",
      "updated_at": "2024-09-19T19:50:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767516058",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767516058"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 574,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767813420",
      "pull_request_review_id": 2317044728,
      "id": 1767813420,
      "node_id": "PRRC_kwDOABII585pXrEs",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        assert(flags & (DIRTY | FRESH));",
      "path": "src/coins.h",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think this should be `Assume`. We should prefer it since it will be compiled out for release builds and this is a hot path.",
      "created_at": "2024-09-20T01:52:06Z",
      "updated_at": "2024-09-20T02:13:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767813420",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767813420"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767815543",
      "pull_request_review_id": 2317044728,
      "id": 1767815543,
      "node_id": "PRRC_kwDOABII585pXrl3",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.",
      "path": "src/coins.h",
      "position": 41,
      "original_position": 42,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Hmm not sure we should remove the extra context here about what exactly `self` and `sentinel` are and where they come from.",
      "created_at": "2024-09-20T01:56:13Z",
      "updated_at": "2024-09-20T02:13:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1767815543",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1767815543"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769603571",
      "pull_request_review_id": 2319844489,
      "id": 1769603571,
      "node_id": "PRRC_kwDOABII585pegHz",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.",
      "path": "src/coins.h",
      "position": 41,
      "original_position": 42,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": 1767815543,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This was moved to the `AddFlags` already - even though it seems to me the code already makes all of that clear:\r\n\r\n> Adding a flag also requires a self reference to the pair that contains this entry in the CCoinsCache map\r\n\r\n`AddFlags(uint8_t flags, CoinsCachePair& self`\r\n\r\n> and a reference to the sentinel of the flagged pair linked list\r\n\r\n, `CoinsCachePair& sentinel`",
      "created_at": "2024-09-21T15:50:42Z",
      "updated_at": "2024-09-21T15:50:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1769603571",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769603571"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769603574",
      "pull_request_review_id": 2319844497,
      "id": 1769603574,
      "node_id": "PRRC_kwDOABII585pegH2",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        assert(flags & (DIRTY | FRESH));",
      "path": "src/coins.h",
      "position": null,
      "original_position": 18,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": 1767813420,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This was meant to be a temporary transition, since we're removing the rest of the flags in your PR - but I'm fine with `Assume` as well - changed.",
      "created_at": "2024-09-21T15:50:44Z",
      "updated_at": "2024-09-21T15:50:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1769603574",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769603574"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770588271",
      "pull_request_review_id": 2320884532,
      "id": 1770588271,
      "node_id": "PRRC_kwDOABII585piQhv",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.",
      "path": "src/coins.h",
      "position": 41,
      "original_position": 42,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": 1767815543,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ah yes I see it was moved up with `AddFlags` to private. Maybe better to keep it on `SetDirty`.\r\n\r\n> Adding a flag also requires a self reference to the pair that contains this entry in the CCoinsCache map\r\n\r\nThere's no context in the method signature that it is an entry in the `CCoinsCache` map.\r\n\r\n> and a reference to the sentinel of the flagged pair linked list\r\n\r\nThere's no context in the method signature about a flagged linked list.",
      "created_at": "2024-09-22T16:22:30Z",
      "updated_at": "2024-09-22T16:22:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770588271",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770588271"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770589885",
      "pull_request_review_id": 2320885732,
      "id": 1770589885,
      "node_id": "PRRC_kwDOABII585piQ69",
      "diff_hunk": "@@ -562,20 +564,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    CoinEntry(CAmount v, State s) : value(v), state(s) {}",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\r\n```\r\nthen all `const static MaybeCoin` declarations below can be made `constexpr`.",
      "created_at": "2024-09-22T16:31:04Z",
      "updated_at": "2024-09-22T16:44:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770589885",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770589885"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 573,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770592376",
      "pull_request_review_id": 2320887726,
      "id": 1770592376,
      "node_id": "PRRC_kwDOABII585piRh4",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.",
      "path": "src/coins.h",
      "position": 41,
      "original_position": 42,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a595328a4a95efb082b1c2dde0f1779fa423a271",
      "in_reply_to_id": 1767815543,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> There's no context in the method signature that it is an entry in the CCoinsCache map\r\n\r\nisn't that what `CoinsCachePair` means?\r\n\r\n> method signature about a flagged linked list\r\n\r\nThe sentinel hints at it.\r\n\r\nBut, again, I kept the methods for AddFlags - and don't want to duplicate it for SetFresh and  SetDirty.",
      "created_at": "2024-09-22T16:46:07Z",
      "updated_at": "2024-09-22T16:46:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770592376",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770592376"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770595622",
      "pull_request_review_id": 2320890297,
      "id": 1770595622,
      "node_id": "PRRC_kwDOABII585piSUm",
      "diff_hunk": "@@ -589,314 +628,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 364,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can we just hardcode value3 for write? It's the same for every case here.",
      "created_at": "2024-09-22T17:05:39Z",
      "updated_at": "2024-09-22T17:09:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770595622",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770595622"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770597044",
      "pull_request_review_id": 2320891544,
      "id": 1770597044,
      "node_id": "PRRC_kwDOABII585piSq0",
      "diff_hunk": "@@ -589,314 +628,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 364,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": 1770595622,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Wouldn't that be inconsistent?\r\nIn every other case, the constant contained both values.",
      "created_at": "2024-09-22T17:15:37Z",
      "updated_at": "2024-09-22T17:15:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770597044",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770597044"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770598205",
      "pull_request_review_id": 2320892531,
      "id": 1770598205,
      "node_id": "PRRC_kwDOABII585piS89",
      "diff_hunk": "@@ -589,314 +628,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 364,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": 1770595622,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I mean, if you look at the `Write` column, each value is `VALUE3`.",
      "created_at": "2024-09-22T17:22:55Z",
      "updated_at": "2024-09-22T17:22:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1770598205",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1770598205"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1771218843",
      "pull_request_review_id": 2321885054,
      "id": 1771218843,
      "node_id": "PRRC_kwDOABII585pkqeb",
      "diff_hunk": "@@ -589,314 +628,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) iter->second.SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) iter->second.SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 364,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": 1770595622,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I thought of that, but since it has to be different from `base_value`, seems weird to assume that in a different method instead of the call-site.\r\n```C++\r\nBase        Write   Cache        Expected      Coinbase\r\nbase_value, VALUE3, SPENT_DIRTY, VALUE3_DIRTY, false // VALUE3 + SPENT_DIRTY -> VALUE3_DIRTY\r\n```\r\nmakes more sense than\r\n```C++\r\nBase        Cache        Expected      Coinbase\r\nbase_value, SPENT_DIRTY, VALUE3_DIRTY, false // SPENT_DIRTY -> VALUE3_DIRTY???\r\n```\r\n\r\nBut I don't mind renaming `VALUE3` to `VAL3` if you're worried about verbosity.",
      "created_at": "2024-09-23T11:16:53Z",
      "updated_at": "2024-09-23T12:04:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1771218843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1771218843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1771249650",
      "pull_request_review_id": 2321934830,
      "id": 1771249650,
      "node_id": "PRRC_kwDOABII585pkx_y",
      "diff_hunk": "@@ -562,20 +564,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    CoinEntry(CAmount v, State s) : value(v), state(s) {}",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1a89a97b1ab87c3be9629a49711c074127e4acd2",
      "in_reply_to_id": 1770589885,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done, thanks",
      "created_at": "2024-09-23T11:41:50Z",
      "updated_at": "2024-09-23T11:41:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1771249650",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1771249650"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 573,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1779311123",
      "pull_request_review_id": 2334816826,
      "id": 1779311123,
      "node_id": "PRRC_kwDOABII585qDiIT",
      "diff_hunk": "@@ -562,20 +564,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr CoinEntry::State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return CoinEntry::State::DIRTY_FRESH;\n+        if (is_dirty) return CoinEntry::State::DIRTY;\n+        if (is_fresh) return CoinEntry::State::FRESH;\n+        return CoinEntry::State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT = -1;\n+constexpr CAmount ABSENT = -2;\n+constexpr CAmount VALUE1 = 100;\n+constexpr CAmount VALUE2 = 200;\n+constexpr CAmount VALUE3 = 300;\n+\n+using MaybeCoin = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING            = std::nullopt;\n+constexpr MaybeCoin SPENT_DIRTY        = CoinEntry{SPENT, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin SPENT_DIRTY_FRESH  = CoinEntry{SPENT, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin SPENT_FRESH        = CoinEntry{SPENT, CoinEntry::State::FRESH};\n+constexpr MaybeCoin SPENT_CLEAN        = CoinEntry{SPENT, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE1_DIRTY       = CoinEntry{VALUE1, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE1_DIRTY_FRESH = CoinEntry{VALUE1, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin VALUE1_FRESH       = CoinEntry{VALUE1, CoinEntry::State::FRESH};\n+constexpr MaybeCoin VALUE1_CLEAN       = CoinEntry{VALUE1, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE2_DIRTY       = CoinEntry{VALUE2, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE2_DIRTY_FRESH = CoinEntry{VALUE2, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin VALUE2_FRESH       = CoinEntry{VALUE2, CoinEntry::State::FRESH};\n+constexpr MaybeCoin VALUE2_CLEAN       = CoinEntry{VALUE2, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE3_DIRTY       = CoinEntry{VALUE3, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE3_DIRTY_FRESH = CoinEntry{VALUE3, CoinEntry::State::DIRTY_FRESH};\n+\n+const static std::string EX_OVERWRITE_UNSPENT = \"Attempted to overwrite an unspent coin (when possible_overwrite is false)\";",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 75,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1dd79a32c9c6e0c6cf4ecef00b56972574babced",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Since #30921, we can now make these `constexpr string_view`.",
      "created_at": "2024-09-27T23:51:09Z",
      "updated_at": "2024-09-27T23:51:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1779311123",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1779311123"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 616,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1779377188",
      "pull_request_review_id": 2334887904,
      "id": 1779377188,
      "node_id": "PRRC_kwDOABII585qDyQk",
      "diff_hunk": "@@ -562,20 +564,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr CoinEntry::State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return CoinEntry::State::DIRTY_FRESH;\n+        if (is_dirty) return CoinEntry::State::DIRTY;\n+        if (is_fresh) return CoinEntry::State::FRESH;\n+        return CoinEntry::State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT = -1;\n+constexpr CAmount ABSENT = -2;\n+constexpr CAmount VALUE1 = 100;\n+constexpr CAmount VALUE2 = 200;\n+constexpr CAmount VALUE3 = 300;\n+\n+using MaybeCoin = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING            = std::nullopt;\n+constexpr MaybeCoin SPENT_DIRTY        = CoinEntry{SPENT, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin SPENT_DIRTY_FRESH  = CoinEntry{SPENT, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin SPENT_FRESH        = CoinEntry{SPENT, CoinEntry::State::FRESH};\n+constexpr MaybeCoin SPENT_CLEAN        = CoinEntry{SPENT, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE1_DIRTY       = CoinEntry{VALUE1, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE1_DIRTY_FRESH = CoinEntry{VALUE1, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin VALUE1_FRESH       = CoinEntry{VALUE1, CoinEntry::State::FRESH};\n+constexpr MaybeCoin VALUE1_CLEAN       = CoinEntry{VALUE1, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE2_DIRTY       = CoinEntry{VALUE2, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE2_DIRTY_FRESH = CoinEntry{VALUE2, CoinEntry::State::DIRTY_FRESH};\n+constexpr MaybeCoin VALUE2_FRESH       = CoinEntry{VALUE2, CoinEntry::State::FRESH};\n+constexpr MaybeCoin VALUE2_CLEAN       = CoinEntry{VALUE2, CoinEntry::State::CLEAN};\n+constexpr MaybeCoin VALUE3_DIRTY       = CoinEntry{VALUE3, CoinEntry::State::DIRTY};\n+constexpr MaybeCoin VALUE3_DIRTY_FRESH = CoinEntry{VALUE3, CoinEntry::State::DIRTY_FRESH};\n+\n+const static std::string EX_OVERWRITE_UNSPENT = \"Attempted to overwrite an unspent coin (when possible_overwrite is false)\";",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 75,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "1dd79a32c9c6e0c6cf4ecef00b56972574babced",
      "in_reply_to_id": 1779311123,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Made it a `constexpr auto` (I don't want non-owning fields) https://github.com/bitcoin/bitcoin/compare/1dd79a32c9c6e0c6cf4ecef00b56972574babced..cb9be6729c4e27bf2d6d703c0d454a22cbcdb6e1",
      "created_at": "2024-09-28T06:33:04Z",
      "updated_at": "2024-09-28T06:33:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1779377188",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1779377188"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 616,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820574292",
      "pull_request_review_id": 2401499690,
      "id": 1820574292,
      "node_id": "PRRC_kwDOABII585sg8JU",
      "diff_hunk": "@@ -107,13 +108,8 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    auto [it, inserted] = cacheCoins.emplace(\n-        std::piecewise_construct,",
      "path": "src/coins.cpp",
      "position": 24,
      "original_position": 24,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": null,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Was this verbose code that is replaced here a workaround for lack of `try_emplace`?",
      "created_at": "2024-10-29T10:55:37Z",
      "updated_at": "2024-10-29T10:55:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1820574292",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820574292"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 111,
      "original_line": 111,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821014127",
      "pull_request_review_id": 2402249228,
      "id": 1821014127,
      "node_id": "PRRC_kwDOABII585sinhv",
      "diff_hunk": "@@ -107,13 +108,8 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    auto [it, inserted] = cacheCoins.emplace(\n-        std::piecewise_construct,",
      "path": "src/coins.cpp",
      "position": 24,
      "original_position": 24,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1820574292,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It seems this [was introduced in 2017](https://github.com/bitcoin/bitcoin/commit/50830796889ecaa458871f1db878c255dd2554cb#diff-f0ed73d62dae6ca28ebd3045e5fc0d5d02eaaacadb4c2a292985a3fbd7e1c77cR100), when the project was still on [C++11](https://github.com/bitcoin/bitcoin/blob/342b9bc3907edf8eae64440397a32833ed44fae4/configure.ac#L58), but `try_emplace` was only introduced in [C++17](https://en.cppreference.com/w/cpp/container/map/try_emplace).\r\n\r\nWhen this was split out to [`EmplaceCoinInternalDANGER`](https://github.com/bitcoin/bitcoin/commit/f6e2da5fb7c6406c37612c838c998078ea8d2252#diff-095ce1081a930998a10b37358fae5499ac47f8cb6f25f5df5d88e920a54e0341R275), the old impl was copied (on Aug 25, 2020), but C++17 support was only enabled in [Nov 18, 2020](https://github.com/bitcoin/bitcoin/commit/faaee810e62d796d66bfb2bc4e53c8b4c8104d13#diff-3f2b8984fdf0aea4a02d35b54047634465410c1526da78c0b4f888248337d135).\r\n\r\nNote that this was already partially upgraded for [FetchCoin](https://github.com/bitcoin/bitcoin/pull/30326/files).",
      "created_at": "2024-10-29T15:19:50Z",
      "updated_at": "2024-10-29T15:19:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1821014127",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821014127"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 111,
      "original_line": 111,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822507538",
      "pull_request_review_id": 2404680812,
      "id": 1822507538,
      "node_id": "PRRC_kwDOABII585soUIS",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 16,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Split up AddFlags to remove invalid states\" (8e1381a991e325395fbc10df2fb091c508efa0f3)\r\n\r\nNot very important, but this commit would be easier to understand if AddFlags function were not moving at the same time as it being modified. Specifically it is harder to see the new `Assume(flags & (DIRTY | FRESH))` change and related changes because of this.\r\n\r\nWould suggest not moving AddFlags this commit, and instead moving it in the next commit \"coins: Remove direct GetFlags access\" getting rid of both flags methods at the same time.",
      "created_at": "2024-10-30T12:20:20Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1822507538",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822507538"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822513330",
      "pull_request_review_id": 2404680812,
      "id": 1822513330,
      "node_id": "PRRC_kwDOABII585soViy",
      "diff_hunk": "@@ -747,25 +754,22 @@ BOOST_AUTO_TEST_CASE(ccoins_spend)\n     CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoinBase(CAmount base_value, CAmount modify_value, const CoinEntry& cache_coin, const CoinEntry& expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n     try {\n+        SingleEntryCacheTest test(base_value, cache_coin);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 187,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Migrate GetCoinsMapEntry to return MaybeCoin\" (e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438)\r\n\r\nWould be better to leave this outside of the try loop so it is clearer this is not expected to throw std::logic_error, and if it it did, the test framework would catch it.\r\n\r\nSame for CheckWriteCoins test below.",
      "created_at": "2024-10-30T12:23:45Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1822513330",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822513330"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 760,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822525401",
      "pull_request_review_id": 2404680812,
      "id": 1822525401,
      "node_id": "PRRC_kwDOABII585soYfZ",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": 42,
      "original_position": 43,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Split up AddFlags to remove invalid states\" (8e1381a991e325395fbc10df2fb091c508efa0f3)\r\n\r\nFor this commit and other commits, it would be helpful if there was an indication about whether they were supposed to change behavior or test coverage. Would suggest including \"refactor\" in the subject for commits which are not supposed to change behavior like \"coins, refactor: Split up AddFlags to remove invalid states\" or could just say behavior isn't changing in the commit description. The PR title does include \"refactor:\" but this isn't visible at the commit level where it tends to be most useful (in git log and blame)",
      "created_at": "2024-10-30T12:30:59Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1822525401",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822525401"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 165,
      "original_line": 165,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823185560",
      "pull_request_review_id": 2404680812,
      "id": 1823185560,
      "node_id": "PRRC_kwDOABII585sq5qY",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 44,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Split up AddFlags to remove invalid states\" (8e1381a991e325395fbc10df2fb091c508efa0f3)\r\n\r\nMaybe wait for other opinions to see if this suggestion is worthwhile, but IMO this commit provides a good opportunity to remove the `Assume(&self.second == this);` footgun and make calling these functions more straightforward:\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/coins.cpp\r\n+++ b/src/coins.cpp\r\n@@ -49,7 +49,7 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\r\n             cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\r\n             if (ret->second.coin.IsSpent()) { // TODO GetCoin cannot return spent coins\r\n                 // The parent only has an empty entry for this outpoint; we can consider our version as fresh.\r\n-                ret->second.SetFresh(*ret, m_sentinel);\r\n+                SetFresh(*ret, m_sentinel);\r\n             }\r\n         } else {\r\n             cacheCoins.erase(ret);\r\n@@ -95,8 +95,8 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\r\n         fresh = !it->second.IsDirty();\r\n     }\r\n     it->second.coin = std::move(coin);\r\n-    it->second.SetDirty(*it, m_sentinel);\r\n-    if (fresh) it->second.SetFresh(*it, m_sentinel);\r\n+    SetDirty(*it, m_sentinel);\r\n+    if (fresh) SetFresh(*it, m_sentinel);\r\n     cachedCoinsUsage += it->second.coin.DynamicMemoryUsage();\r\n     TRACE5(utxocache, add,\r\n            outpoint.hash.data(),\r\n@@ -109,7 +109,7 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\r\n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\r\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\r\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\r\n-    if (inserted) it->second.SetDirty(*it, m_sentinel);\r\n+    if (inserted) SetDirty(*it, m_sentinel);\r\n }\r\n \r\n void AddCoins(CCoinsViewCache& cache, const CTransaction &tx, int nHeight, bool check_for_overwrite) {\r\n@@ -139,7 +139,7 @@ bool CCoinsViewCache::SpendCoin(const COutPoint &outpoint, Coin* moveout) {\r\n     if (it->second.IsFresh()) {\r\n         cacheCoins.erase(it);\r\n     } else {\r\n-        it->second.SetDirty(*it, m_sentinel);\r\n+        SetDirty(*it, m_sentinel);\r\n         it->second.coin.Clear();\r\n     }\r\n     return true;\r\n@@ -199,11 +199,11 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\r\n                     entry.coin = it->second.coin;\r\n                 }\r\n                 cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\r\n-                entry.SetDirty(*itUs, m_sentinel);\r\n+                SetDirty(*itUs, m_sentinel);\r\n                 // We can mark it FRESH in the parent if it was FRESH in the child\r\n                 // Otherwise it might have just been flushed from the parent's cache\r\n                 // and already exist in the grandparent\r\n-                if (it->second.IsFresh()) entry.SetFresh(*itUs, m_sentinel);\r\n+                if (it->second.IsFresh()) SetFresh(*itUs, m_sentinel);\r\n             }\r\n         } else {\r\n             // Found the entry in the parent cache\r\n@@ -231,7 +231,7 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\r\n                     itUs->second.coin = it->second.coin;\r\n                 }\r\n                 cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\r\n-                itUs->second.SetDirty(*itUs, m_sentinel);\r\n+                SetDirty(*itUs, m_sentinel);\r\n                 // NOTE: It isn't safe to mark the coin as FRESH in the parent\r\n                 // cache. If it already existed and was spent in the parent\r\n                 // cache then marking it FRESH would prevent that spentness\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -131,17 +131,16 @@ private:\r\n     //! Adding a flag also requires a self reference to the pair that contains\r\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\r\n     //! flagged pair linked list.\r\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n+    static inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n     {\r\n         Assume(flags & (DIRTY | FRESH));\r\n-        Assume(&self.second == this);\r\n-        if (!m_flags) {\r\n-            m_prev = sentinel.second.m_prev;\r\n-            m_next = &sentinel;\r\n+        if (!self.second.m_flags) {\r\n+            self.second.m_prev = sentinel.second.m_prev;\r\n+            self.second.m_next = &sentinel;\r\n             sentinel.second.m_prev = &self;\r\n-            m_prev->second.m_next = &self;\r\n+            self.second.m_prev->second.m_next = &self;\r\n         }\r\n-        m_flags |= flags;\r\n+        self.second.m_flags |= flags;\r\n     }\r\n \r\n public:\r\n@@ -175,11 +174,11 @@ public:\r\n         SetClean();\r\n     }\r\n \r\n-    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n+    friend void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n     {\r\n         AddFlags(DIRTY, self, sentinel);\r\n     }\r\n-    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n+    friend void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\r\n     {\r\n         AddFlags(FRESH, self, sentinel);\r\n     }\r\n```\r\n</p>\r\n</details>\r\n\r\n",
      "created_at": "2024-10-30T18:29:22Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823185560",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823185560"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 178,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823223280",
      "pull_request_review_id": 2404680812,
      "id": 1823223280,
      "node_id": "PRRC_kwDOABII585srC3w",
      "diff_hunk": "@@ -146,70 +146,48 @@ BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n     // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    n1.second.SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n     // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    n2.second.SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n     // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    n1.second.SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n     // Check that we can clear flags then re-add them\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Check that calling `ClearFlags` with 0 flags has no effect\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n     // But adding DIRTY re-inserts it after n2",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 124,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": 1760053494,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1760053494\r\n\r\nIn commit \"coins: Split up AddFlags to remove invalid states\" (8e1381a991e325395fbc10df2fb091c508efa0f3)\r\n\r\n> Done\r\n\r\nSeems like this is not actually done as of 8e1381a991e325395fbc10df2fb091c508efa0f3\r\n\r\n\r\n",
      "created_at": "2024-10-30T18:58:51Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823223280",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823223280"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823231744",
      "pull_request_review_id": 2404680812,
      "id": 1823231744,
      "node_id": "PRRC_kwDOABII585srE8A",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n-    inline void ClearFlags() noexcept\n+    inline void SetClean() noexcept\n     {\n         if (!m_flags) return;\n         m_next->second.m_prev = m_prev;",
      "path": "src/coins.h",
      "position": 60,
      "original_position": 64,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Split up AddFlags to remove invalid states\" (8e1381a991e325395fbc10df2fb091c508efa0f3)\r\n\r\nNot directly related to this PR, but would it make sense for SetClean to set m_prev and m_next to null here?\r\n\r\nIt seems that would be better than keeping dangling or invalid pointers. This would also make it possible to add asserts in AddFlags to confirm that the linked list state is valid when it is called.\r\n\r\nNot suggesting any change for this commit, just wondering if this idea makes sense for a possible followup commit or PR.",
      "created_at": "2024-10-30T19:05:39Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823231744",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823231744"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823241356",
      "pull_request_review_id": 2404680812,
      "id": 1823241356,
      "node_id": "PRRC_kwDOABII585srHSM",
      "diff_hunk": "@@ -21,7 +21,7 @@ std::list<CoinsCachePair> CreatePairs(CoinsCachePair& sentinel)\n         auto node{std::prev(nodes.end())};\n         node->second.SetDirty(*node, sentinel);\n \n-        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK(node->second.IsDirty());",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8df16f23a22b2e0b72dd6338ed37c09485f5ede3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Remove direct GetFlags access\" (8df16f23a22b2e0b72dd6338ed37c09485f5ede3)\r\n\r\nMay should check `!IsFresh()` here so new check is equivalent to previous check. Alternately, could just mention in commit message that this commit reduces test coverage a little bit by not checking some flags that are not relevant to the tests.\r\n\r\nSame comment applies to other tests below like `linked_list_random_deletion`",
      "created_at": "2024-10-30T19:13:51Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823241356",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823241356"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823243237",
      "pull_request_review_id": 2404680812,
      "id": 1823243237,
      "node_id": "PRRC_kwDOABII585srHvl",
      "diff_hunk": "@@ -63,7 +63,7 @@ BOOST_AUTO_TEST_CASE(linked_list_iteration)\n \n     // Delete the nodes from the list to make sure there are no dangling pointers\n     for (auto it{nodes.begin()}; it != nodes.end(); it = nodes.erase(it)) {\n-        BOOST_CHECK_EQUAL(it->second.GetFlags(), 0);\n+        BOOST_CHECK(!it->second.IsDirty() && !it->second.IsFresh());",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": 32,
      "original_position": 23,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8df16f23a22b2e0b72dd6338ed37c09485f5ede3",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins: Remove direct GetFlags access\" (8df16f23a22b2e0b72dd6338ed37c09485f5ede3)\r\n\r\nNot important, but usually test code and output is more readable with `CHECK(a); CHECK(b);` instead of `CHECK(a && b)`",
      "created_at": "2024-10-30T19:15:27Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823243237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823243237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 66,
      "original_line": 66,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823264089",
      "pull_request_review_id": 2404680812,
      "id": 1823264089,
      "node_id": "PRRC_kwDOABII585srM1Z",
      "diff_hunk": "@@ -558,16 +560,32 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {\n+    const CAmount value;\n+    const char flags;\n+\n+    CoinEntry(CAmount v, char s) : value(v), flags(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.flags; }\n+\n+    constexpr bool IsDirty() const { return flags & DIRTY; }\n+    constexpr bool IsFresh() const { return flags & FRESH; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Migrate GetCoinsMapEntry to return MaybeCoin\" (e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438)\r\n\r\nIt seems like these methods are not called in this commit, but they could be called in `InsertCoinsMapEntry` below. Maybe call them there or drop them here?",
      "created_at": "2024-10-30T19:31:44Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823264089",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823264089"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 576,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 577,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823433791",
      "pull_request_review_id": 2404680812,
      "id": 1823433791,
      "node_id": "PRRC_kwDOABII585sr2Q_",
      "diff_hunk": "@@ -661,47 +676,43 @@ static void CheckAccessCoin(CAmount base_value, const CoinEntry& cache_coin, con\n     test.cache.SelfTest(/*sanity_check=*/false);\n     BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n-{\n-    CheckAccessCoin(base_value, CoinEntry{cache_value, cache_flags}, CoinEntry{expected_value, expected_flags});\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *              Base    Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    CheckAccessCoin(ABSENT, MISSING,            MISSING           );",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 96,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Group values and states in tests into CoinEntry wrappers\" (553db5dec1334ed5e8e07e34306f16de9afc22bb)\r\n\r\nReview note: It's not really easy to verify by looking at code that new and old test cases are equivalent, but an approach that worked for me was to add extra prints showing the test cases, and then diff the output from `test_bitcoin -t coins_tests` before and after this commit, and confirm there are were no changes. My change used to test this was:\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/test/coins_tests.cpp\r\n+++ b/src/test/coins_tests.cpp\r\n@@ -286,6 +286,7 @@ void SimulationTest(CCoinsView* base, bool fake_best_block)\r\n // Run the above simulation for multiple base types.\r\n BOOST_FIXTURE_TEST_CASE(coins_cache_simulation_test, CacheTest)\r\n {\r\n+    if ((1)) return;\r\n     CCoinsViewTest base{m_rng};\r\n     SimulationTest(&base, false);\r\n \r\n@@ -318,6 +319,7 @@ UtxoData::iterator FindRandomFrom(const std::set<COutPoint> &utxoSet) {\r\n // has the expected effect (the other duplicate is overwritten at all cache levels)\r\n BOOST_FIXTURE_TEST_CASE(updatecoins_simulation_test, UpdateTest)\r\n {\r\n+    if ((1)) return;\r\n     SeedRandomForTest(SeedRand::ZEROS);\r\n \r\n     bool spent_a_duplicate_coinbase = false;\r\n@@ -572,7 +574,7 @@ struct CoinEntry {\r\n     CoinEntry(CAmount v, char s) : value(v), flags(s) {}\r\n \r\n     bool operator==(const CoinEntry& o) const = default;\r\n-    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.flags; }\r\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << \" \" << int{e.flags}; }\r\n \r\n     constexpr bool IsDirty() const { return flags & DIRTY; }\r\n     constexpr bool IsFresh() const { return flags & FRESH; }\r\n@@ -671,6 +673,7 @@ public:\r\n \r\n static void CheckAccessCoin(CAmount base_value, const CoinEntry& cache_coin, const CoinEntry& expected)\r\n {\r\n+    tfm::format(std::cout, \"CheckAccessCoin(%s, %s, %s)\\n\", base_value, cache_coin, expected);\r\n     SingleEntryCacheTest test(base_value, cache_coin);\r\n     test.cache.AccessCoin(OUTPOINT);\r\n     test.cache.SelfTest(/*sanity_check=*/false);\r\n@@ -717,6 +720,7 @@ BOOST_AUTO_TEST_CASE(ccoins_access)\r\n \r\n static void CheckSpendCoins(CAmount base_value, const CoinEntry& cache_coin, const CoinEntry& expected)\r\n {\r\n+    tfm::format(std::cout, \"CheckSpendCoins(%s, %s, %s)\\n\", base_value, cache_coin, expected);\r\n     SingleEntryCacheTest test(base_value, cache_coin);\r\n     test.cache.SpendCoin(OUTPOINT);\r\n     test.cache.SelfTest();\r\n@@ -763,6 +767,7 @@ BOOST_AUTO_TEST_CASE(ccoins_spend)\r\n \r\n static void CheckAddCoin(CAmount base_value, CAmount modify_value, const CoinEntry& cache_coin, const CoinEntry& expected, bool coinbase)\r\n {\r\n+    tfm::format(std::cout, \"CheckAddCoin(%s, %s, %s, %s, %s)\\n\", base_value, modify_value, cache_coin, expected, coinbase);\r\n     try {\r\n         SingleEntryCacheTest test(base_value, cache_coin);\r\n         CTxOut output;\r\n@@ -809,6 +814,7 @@ BOOST_AUTO_TEST_CASE(ccoins_add)\r\n \r\n void CheckWriteCoins(const CoinEntry& parent, const CoinEntry& child, const CoinEntry& expected)\r\n {\r\n+    tfm::format(std::cout, \"CheckWriteCoins(%s, %s, %s)\\n\", parent, child, expected);\r\n     try {\r\n         SingleEntryCacheTest test(ABSENT, parent);\r\n         WriteCoinsViewEntry(test.cache, child);\r\n```\r\n</p>\r\n</details>",
      "created_at": "2024-10-30T21:45:49Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823433791",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823433791"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 687,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823484089",
      "pull_request_review_id": 2404680812,
      "id": 1823484089,
      "node_id": "PRRC_kwDOABII585ssCi5",
      "diff_hunk": "@@ -764,54 +771,40 @@ static void CheckAddCoinBase(CAmount base_value, CAmount modify_value, const Coi\n         test.cache.SelfTest();\n         BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n     } catch (std::logic_error&) {\n-        BOOST_CHECK_EQUAL(CoinEntry(FAIL, NO_ENTRY), expected); // TODO empty\n+        BOOST_CHECK_EQUAL(FAIL_NO_ENTRY, expected);\n     }\n }\n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n-{\n-    CheckAddCoinBase(base_value, modify_value, CoinEntry{cache_value, cache_flags}, CoinEntry{expected_value, expected_flags}, coinbase);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected            Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {",
      "path": "src/test/coins_tests.cpp",
      "position": 374,
      "original_position": 265,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Group values and states in tests into CoinEntry wrappers\" (553db5dec1334ed5e8e07e34306f16de9afc22bb)\r\n\r\nNote: because this for loop is moving from `CheckAddCoin` function to the top-level test code, this commit changes order of the tests. But tests that are performed should still be the same. It would be good to note in commit message that this commit does affect test order of this test but doesn't change its coverage.",
      "created_at": "2024-10-30T22:04:04Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823484089",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823484089"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 757,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823499607",
      "pull_request_review_id": 2404680812,
      "id": 1823499607,
      "node_id": "PRRC_kwDOABII585ssGVX",
      "diff_hunk": "@@ -822,81 +815,83 @@ void CheckWriteCoins(const CoinEntry& parent, const CoinEntry& child, const Coin\n         test.cache.SelfTest(/*sanity_check=*/false);\n         BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n     } catch (std::logic_error&) {\n-        BOOST_CHECK_EQUAL(CoinEntry(FAIL, NO_ENTRY), expected); // TODO empty\n+        BOOST_CHECK_EQUAL(FAIL_NO_ENTRY, expected);\n     }\n }\n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n-{\n-    CheckWriteCoins(CoinEntry{parent_value, parent_flags}, CoinEntry{child_value, child_flags}, CoinEntry{expected_value, expected_flags});\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING           );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING           );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN       );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH       );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING           );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING           );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN      );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH      );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY      );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n \n     // The checks above omit cases where the child flags are not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const CoinEntry parent : {MISSING,",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 417,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Group values and states in tests into CoinEntry wrappers\" (553db5dec1334ed5e8e07e34306f16de9afc22bb)\r\n\r\nNote: Again in this part of the test, the order cases are run in seems to be changing, but the same set of cases is run. Would be helpful to mention this in commit message.",
      "created_at": "2024-10-30T22:08:40Z",
      "updated_at": "2024-10-30T22:42:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1823499607",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823499607"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 883,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439691",
      "pull_request_review_id": 2407933217,
      "id": 1824439691,
      "node_id": "PRRC_kwDOABII585svr2L",
      "diff_hunk": "@@ -822,81 +815,83 @@ void CheckWriteCoins(const CoinEntry& parent, const CoinEntry& child, const Coin\n         test.cache.SelfTest(/*sanity_check=*/false);\n         BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n     } catch (std::logic_error&) {\n-        BOOST_CHECK_EQUAL(CoinEntry(FAIL, NO_ENTRY), expected); // TODO empty\n+        BOOST_CHECK_EQUAL(FAIL_NO_ENTRY, expected);\n     }\n }\n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n-{\n-    CheckWriteCoins(CoinEntry{parent_value, parent_flags}, CoinEntry{child_value, child_flags}, CoinEntry{expected_value, expected_flags});\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING           );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING           );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN       );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH       );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING           );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING           );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY      );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN      );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH      );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY      );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING           );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  FAIL_NO_ENTRY     );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY      );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, FAIL_NO_ENTRY     );\n \n     // The checks above omit cases where the child flags are not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const CoinEntry parent : {MISSING,",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 417,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": 1823499607,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done in previous step",
      "created_at": "2024-10-31T13:17:22Z",
      "updated_at": "2024-10-31T13:17:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439691",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439691"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 883,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439724",
      "pull_request_review_id": 2407933322,
      "id": 1824439724,
      "node_id": "PRRC_kwDOABII585svr2s",
      "diff_hunk": "@@ -764,54 +771,40 @@ static void CheckAddCoinBase(CAmount base_value, CAmount modify_value, const Coi\n         test.cache.SelfTest();\n         BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n     } catch (std::logic_error&) {\n-        BOOST_CHECK_EQUAL(CoinEntry(FAIL, NO_ENTRY), expected); // TODO empty\n+        BOOST_CHECK_EQUAL(FAIL_NO_ENTRY, expected);\n     }\n }\n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n-{\n-    CheckAddCoinBase(base_value, modify_value, CoinEntry{cache_value, cache_flags}, CoinEntry{expected_value, expected_flags}, coinbase);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected            Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {",
      "path": "src/test/coins_tests.cpp",
      "position": 374,
      "original_position": 265,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": 1823484089,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done, thanks",
      "created_at": "2024-10-31T13:17:24Z",
      "updated_at": "2024-10-31T13:17:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439724",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439724"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 757,
      "original_line": 757,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439750",
      "pull_request_review_id": 2407933422,
      "id": 1824439750,
      "node_id": "PRRC_kwDOABII585svr3G",
      "diff_hunk": "@@ -661,47 +676,43 @@ static void CheckAccessCoin(CAmount base_value, const CoinEntry& cache_coin, con\n     test.cache.SelfTest(/*sanity_check=*/false);\n     BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n-{\n-    CheckAccessCoin(base_value, CoinEntry{cache_value, cache_flags}, CoinEntry{expected_value, expected_flags});\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *              Base    Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    CheckAccessCoin(ABSENT, MISSING,            MISSING           );",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 96,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": 1823433791,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Thank you for checking! Do you need any change here from me?",
      "created_at": "2024-10-31T13:17:26Z",
      "updated_at": "2024-10-31T13:17:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439750",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439750"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 687,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439835",
      "pull_request_review_id": 2407933611,
      "id": 1824439835,
      "node_id": "PRRC_kwDOABII585svr4b",
      "diff_hunk": "@@ -558,16 +560,32 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {\n+    const CAmount value;\n+    const char flags;\n+\n+    CoinEntry(CAmount v, char s) : value(v), flags(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.flags; }\n+\n+    constexpr bool IsDirty() const { return flags & DIRTY; }\n+    constexpr bool IsFresh() const { return flags & FRESH; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438",
      "in_reply_to_id": 1823264089,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-10-31T13:17:29Z",
      "updated_at": "2024-10-31T13:17:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439835",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439835"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 576,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 577,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439862",
      "pull_request_review_id": 2407933695,
      "id": 1824439862,
      "node_id": "PRRC_kwDOABII585svr42",
      "diff_hunk": "@@ -63,7 +63,7 @@ BOOST_AUTO_TEST_CASE(linked_list_iteration)\n \n     // Delete the nodes from the list to make sure there are no dangling pointers\n     for (auto it{nodes.begin()}; it != nodes.end(); it = nodes.erase(it)) {\n-        BOOST_CHECK_EQUAL(it->second.GetFlags(), 0);\n+        BOOST_CHECK(!it->second.IsDirty() && !it->second.IsFresh());",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": 32,
      "original_position": 23,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8df16f23a22b2e0b72dd6338ed37c09485f5ede3",
      "in_reply_to_id": 1823243237,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yeah, but I don't like the format of that. If this fails, it's easy to debug.",
      "created_at": "2024-10-31T13:17:30Z",
      "updated_at": "2024-10-31T13:17:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439862",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439862"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 66,
      "original_line": 66,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439886",
      "pull_request_review_id": 2407933787,
      "id": 1824439886,
      "node_id": "PRRC_kwDOABII585svr5O",
      "diff_hunk": "@@ -21,7 +21,7 @@ std::list<CoinsCachePair> CreatePairs(CoinsCachePair& sentinel)\n         auto node{std::prev(nodes.end())};\n         node->second.SetDirty(*node, sentinel);\n \n-        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK(node->second.IsDirty());",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8df16f23a22b2e0b72dd6338ed37c09485f5ede3",
      "in_reply_to_id": 1823241356,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Hmm, so always check both? Ok, I don't mind, done",
      "created_at": "2024-10-31T13:17:31Z",
      "updated_at": "2024-10-31T13:17:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439886",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439886"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439939",
      "pull_request_review_id": 2407933955,
      "id": 1824439939,
      "node_id": "PRRC_kwDOABII585svr6D",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n-    inline void ClearFlags() noexcept\n+    inline void SetClean() noexcept\n     {\n         if (!m_flags) return;\n         m_next->second.m_prev = m_prev;",
      "path": "src/coins.h",
      "position": 60,
      "original_position": 64,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1823231744,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Good idea, did it in a separate commit, let's see what the CI and others think.",
      "created_at": "2024-10-31T13:17:34Z",
      "updated_at": "2024-10-31T13:17:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439939",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439939"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439987",
      "pull_request_review_id": 2407934066,
      "id": 1824439987,
      "node_id": "PRRC_kwDOABII585svr6z",
      "diff_hunk": "@@ -146,70 +146,48 @@ BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n     // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    n1.second.SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n     // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    n2.second.SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n     // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    n1.second.SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n     // Check that we can clear flags then re-add them\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Check that calling `ClearFlags` with 0 flags has no effect\n     n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n     // But adding DIRTY re-inserts it after n2",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 124,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "03cf2bd3e1a7c915c58465f43b11381404b40beb",
      "in_reply_to_id": 1760053494,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Was already removed in `coins: Remove direct GetFlags access`, but I've moved it up to `coins, refactor: Split up AddFlags to remove invalid states`",
      "created_at": "2024-10-31T13:17:35Z",
      "updated_at": "2024-10-31T13:17:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824439987",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824439987"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440072",
      "pull_request_review_id": 2407934241,
      "id": 1824440072,
      "node_id": "PRRC_kwDOABII585svr8I",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 44,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1823185560,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Or maybe even go one step further and make `SetDirty`/`SetFresh` static as well - thanks for the hint, pushed in a separate commit with your coauthorship.",
      "created_at": "2024-10-31T13:17:38Z",
      "updated_at": "2024-10-31T13:17:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824440072",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440072"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 178,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440193",
      "pull_request_review_id": 2407934538,
      "id": 1824440193,
      "node_id": "PRRC_kwDOABII585svr-B",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": 42,
      "original_position": 43,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1822525401,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "added refactor to the coins commits, thanks",
      "created_at": "2024-10-31T13:17:42Z",
      "updated_at": "2024-10-31T13:18:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824440193",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440193"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 165,
      "original_line": 165,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440235",
      "pull_request_review_id": 2407934667,
      "id": 1824440235,
      "node_id": "PRRC_kwDOABII585svr-r",
      "diff_hunk": "@@ -747,25 +754,22 @@ BOOST_AUTO_TEST_CASE(ccoins_spend)\n     CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoinBase(CAmount base_value, CAmount modify_value, const CoinEntry& cache_coin, const CoinEntry& expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n     try {\n+        SingleEntryCacheTest test(base_value, cache_coin);",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 187,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "e8e70a4ae3cbd7a648629c2df4b5a7f6f0686438",
      "in_reply_to_id": 1822513330,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I was hesitant at first (mostly because this will be removed in `test: Validate error messages on fail`), but we want to always fail when these calls do, so you're right, thanks!",
      "created_at": "2024-10-31T13:17:44Z",
      "updated_at": "2024-10-31T13:18:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824440235",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440235"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 760,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440291",
      "pull_request_review_id": 2407934845,
      "id": 1824440291,
      "node_id": "PRRC_kwDOABII585svr_j",
      "diff_hunk": "@@ -128,6 +128,22 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 16,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1822507538,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Good idea, done!",
      "created_at": "2024-10-31T13:17:47Z",
      "updated_at": "2024-10-31T13:17:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1824440291",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824440291"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829401813",
      "pull_request_review_id": 2415709430,
      "id": 1829401813,
      "node_id": "PRRC_kwDOABII585tCnTV",
      "diff_hunk": "@@ -156,24 +156,33 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n     inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n+        Assume(flags & (DIRTY | FRESH));\n         Assume(&self.second == this);\n-        if (!m_flags && flags) {\n+        if (!m_flags) {\n             m_prev = sentinel.second.m_prev;\n             m_next = &sentinel;\n             sentinel.second.m_prev = &self;\n             m_prev->second.m_next = &self;\n         }\n         m_flags |= flags;\n     }\n-    inline void ClearFlags() noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 38,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a6921049fcc3de4067dc3f88fef57884450d25a1",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins, refactor: Split up AddFlags to remove invalid states\" (a6921049fcc3de4067dc3f88fef57884450d25a1)\r\n\r\nNot important, but instead of SetFresh and SetClean() are being introduced as non-static methods in this commit and then changing them to static in the next commit, wouldn't it make more sense to just introduce them as static methods in this commit? That should reduce churn and make the next commit simpler, because only AddFlags will be changing.",
      "created_at": "2024-11-05T13:58:27Z",
      "updated_at": "2024-11-05T14:29:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829401813",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829401813"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 181,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829417295",
      "pull_request_review_id": 2415709430,
      "id": 1829417295,
      "node_id": "PRRC_kwDOABII585tCrFP",
      "diff_hunk": "@@ -166,6 +166,7 @@ struct CCoinsCacheEntry\n     {\n         Assume(flags & (DIRTY | FRESH));\n         if (!self.second.m_flags) {\n+            Assume(self.second.m_prev == nullptr && self.second.m_next == nullptr);",
      "path": "src/coins.h",
      "position": null,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "2d691b50d3729445a60898981b78c4239f2f0dd7",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins, refactor: Assume state after SetClean in AddFlags to prevent dangling pointers\" (2d691b50d3729445a60898981b78c4239f2f0dd7)\r\n\r\nI think this could also check the converse, that pointers are valid if flags were set. It could simply check that pointers are non-null if flags are set, or go further and check prev->next == self, and next->prev == self",
      "created_at": "2024-11-05T14:07:47Z",
      "updated_at": "2024-11-05T14:30:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829417295",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829417295"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829431415",
      "pull_request_review_id": 2415709430,
      "id": 1829431415,
      "node_id": "PRRC_kwDOABII585tCuh3",
      "diff_hunk": "@@ -558,16 +560,29 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {",
      "path": "src/test/coins_tests.cpp",
      "position": 34,
      "original_position": 17,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a902af6fb195fae97a89876b88d5034162ab8366",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Migrate GetCoinsMapEntry to return MaybeCoin\" (a902af6fb195fae97a89876b88d5034162ab8366)\r\n\r\nMay want to add \"refactor\" to commit subject or otherwise mention that this commit is not adding or removing any test coverage. Otherwise it's hard to know looking at the commit what it's intended to do.\r\n\r\nSame comment also applies to commit \"test: Remove remaining unbounded flags from coins_tests\" (e4db49949c55470950a206172ee53f6baacf3767) and commit \"test: Compact ccoins_access and ccoins_spend\" (aa2f3139529c054b011a0f75ff314e6d63f0d977)",
      "created_at": "2024-11-05T14:16:32Z",
      "updated_at": "2024-11-05T14:29:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829431415",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829431415"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829434993",
      "pull_request_review_id": 2415709430,
      "id": 1829434993,
      "node_id": "PRRC_kwDOABII585tCvZx",
      "diff_hunk": "@@ -558,16 +560,29 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {\n+    const CAmount value;\n+    const char flags;\n+\n+    CoinEntry(CAmount v, char s) : value(v), flags(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.flags; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a902af6fb195fae97a89876b88d5034162ab8366",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"test: Migrate GetCoinsMapEntry to return MaybeCoin\" (a902af6fb195fae97a89876b88d5034162ab8366)\r\n\r\nShould this include a space between the value and flags? Otherwise if test fails it looks like amount and flags will run together and might not be possible to distinguish.",
      "created_at": "2024-11-05T14:18:44Z",
      "updated_at": "2024-11-05T14:30:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829434993",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829434993"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 574,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829440915",
      "pull_request_review_id": 2415709430,
      "id": 1829440915,
      "node_id": "PRRC_kwDOABII585tCw2T",
      "diff_hunk": "@@ -661,47 +676,43 @@ static void CheckAccessCoin(CAmount base_value, const CoinEntry& cache_coin, con\n     test.cache.SelfTest(/*sanity_check=*/false);\n     BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n-{\n-    CheckAccessCoin(base_value, CoinEntry{cache_value, cache_flags}, CoinEntry{expected_value, expected_flags});\n-}\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *              Base    Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    CheckAccessCoin(ABSENT, MISSING,            MISSING           );",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 96,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "553db5dec1334ed5e8e07e34306f16de9afc22bb",
      "in_reply_to_id": 1823433791,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Thanks, no this is just a note to help myself and other reviewers.",
      "created_at": "2024-11-05T14:21:59Z",
      "updated_at": "2024-11-05T14:29:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829440915",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1829440915"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 687,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831358176",
      "pull_request_review_id": 2418846935,
      "id": 1831358176,
      "node_id": "PRRC_kwDOABII585tKE7g",
      "diff_hunk": "@@ -156,24 +172,18 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 44,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "8e1381a991e325395fbc10df2fb091c508efa0f3",
      "in_reply_to_id": 1823185560,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This is a great idea!",
      "created_at": "2024-11-06T16:25:37Z",
      "updated_at": "2024-11-06T16:25:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1831358176",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831358176"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 178,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831367497",
      "pull_request_review_id": 2418862806,
      "id": 1831367497,
      "node_id": "PRRC_kwDOABII585tKHNJ",
      "diff_hunk": "@@ -162,26 +162,19 @@ struct CCoinsCacheEntry\n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the",
      "path": "src/coins.h",
      "position": null,
      "original_position": 2,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "d5e3bbf440aa948df8159999fd4eb5275c354b93",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: this comment is no longer accurate after d5e3bbf440aa948df8159999fd4eb5275c354b93\r\n\r\nWe should just remove the part about a self reference, and only mention the sentinel.",
      "created_at": "2024-11-06T16:31:12Z",
      "updated_at": "2024-11-06T16:44:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1831367497",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831367497"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 163,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831368185",
      "pull_request_review_id": 2418862806,
      "id": 1831368185,
      "node_id": "PRRC_kwDOABII585tKHX5",
      "diff_hunk": "@@ -162,26 +162,19 @@ struct CCoinsCacheEntry\n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    static inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "d5e3bbf440aa948df8159999fd4eb5275c354b93",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think `self` is no longer a good name for this parameter if we make this static. It should just be `pair`.\r\n\r\nSame for `SetDirty` and `SetFresh`.",
      "created_at": "2024-11-06T16:31:42Z",
      "updated_at": "2024-11-06T16:44:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1831368185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831368185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831374417",
      "pull_request_review_id": 2418862806,
      "id": 1831374417,
      "node_id": "PRRC_kwDOABII585tKI5R",
      "diff_hunk": "@@ -139,56 +139,55 @@ BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n }\n \n-BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n+BOOST_AUTO_TEST_CASE(linked_list_set_state)\n {\n     CoinsCachePair sentinel;\n     sentinel.second.SelfRef(sentinel);\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding DIRTY flag inserts it into linked list and sets flags\n+    // Check that setting DIRTY inserts it into linked list and sets state\n     CCoinsCacheEntry::SetDirty(n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK(n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n-    // Check that adding FRESH flag on new node inserts it after n1\n+    // Check that setting FRESH on new node inserts it after n1\n     CCoinsCacheEntry::SetFresh(n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK(n2.second.IsFresh() && !n2.second.IsDirty());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that we can add extra flags, but they don't change our position\n+    // Check that we can set extra state, but they don't change our position\n     CCoinsCacheEntry::SetFresh(n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n-    // Check that we can clear flags then re-add them\n+    // Check that we can clear state then re-set them",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 117,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "f92268456a5bb666758a6f0eced0018ba08fb2f0",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: `// Check that we can clear state then re-set it`",
      "created_at": "2024-11-06T16:36:10Z",
      "updated_at": "2024-11-06T16:44:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1831374417",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1831374417"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 173,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835675175",
      "pull_request_review_id": 2425742789,
      "id": 1835675175,
      "node_id": "PRRC_kwDOABII585tai4n",
      "diff_hunk": "@@ -156,24 +156,33 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n     inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n+        Assume(flags & (DIRTY | FRESH));\n         Assume(&self.second == this);\n-        if (!m_flags && flags) {\n+        if (!m_flags) {\n             m_prev = sentinel.second.m_prev;\n             m_next = &sentinel;\n             sentinel.second.m_prev = &self;\n             m_prev->second.m_next = &self;\n         }\n         m_flags |= flags;\n     }\n-    inline void ClearFlags() noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 38,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a6921049fcc3de4067dc3f88fef57884450d25a1",
      "in_reply_to_id": 1829401813,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Wouldn't I need to make `AddFlags` static as well in that case?\r\nWhich would trigger `this` removal and rewrite of the whole `AddFlags` method which is done in the next commit. Or you mean squash the first two commits?",
      "created_at": "2024-11-10T11:59:36Z",
      "updated_at": "2024-11-10T11:59:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835675175",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835675175"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 181,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681246",
      "pull_request_review_id": 2425748501,
      "id": 1835681246,
      "node_id": "PRRC_kwDOABII585takXe",
      "diff_hunk": "@@ -139,56 +139,55 @@ BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n }\n \n-BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n+BOOST_AUTO_TEST_CASE(linked_list_set_state)\n {\n     CoinsCachePair sentinel;\n     sentinel.second.SelfRef(sentinel);\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding DIRTY flag inserts it into linked list and sets flags\n+    // Check that setting DIRTY inserts it into linked list and sets state\n     CCoinsCacheEntry::SetDirty(n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK(n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n-    // Check that adding FRESH flag on new node inserts it after n1\n+    // Check that setting FRESH on new node inserts it after n1\n     CCoinsCacheEntry::SetFresh(n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK(n2.second.IsFresh() && !n2.second.IsDirty());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that we can add extra flags, but they don't change our position\n+    // Check that we can set extra state, but they don't change our position\n     CCoinsCacheEntry::SetFresh(n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n-    // Check that we can clear flags then re-add them\n+    // Check that we can clear state then re-set them",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": null,
      "original_position": 117,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "f92268456a5bb666758a6f0eced0018ba08fb2f0",
      "in_reply_to_id": 1831374417,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-10T12:23:47Z",
      "updated_at": "2024-11-10T12:23:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681246",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681246"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 173,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681261",
      "pull_request_review_id": 2425748513,
      "id": 1835681261,
      "node_id": "PRRC_kwDOABII585takXt",
      "diff_hunk": "@@ -162,26 +162,19 @@ struct CCoinsCacheEntry\n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    static inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "d5e3bbf440aa948df8159999fd4eb5275c354b93",
      "in_reply_to_id": 1831368185,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-10T12:23:52Z",
      "updated_at": "2024-11-10T12:23:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681261",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681261"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681273",
      "pull_request_review_id": 2425748524,
      "id": 1835681273,
      "node_id": "PRRC_kwDOABII585takX5",
      "diff_hunk": "@@ -162,26 +162,19 @@ struct CCoinsCacheEntry\n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the",
      "path": "src/coins.h",
      "position": null,
      "original_position": 2,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "d5e3bbf440aa948df8159999fd4eb5275c354b93",
      "in_reply_to_id": 1831367497,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-10T12:23:56Z",
      "updated_at": "2024-11-10T12:23:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681273",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681273"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 163,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681298",
      "pull_request_review_id": 2425748546,
      "id": 1835681298,
      "node_id": "PRRC_kwDOABII585takYS",
      "diff_hunk": "@@ -558,16 +560,29 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {\n+    const CAmount value;\n+    const char flags;\n+\n+    CoinEntry(CAmount v, char s) : value(v), flags(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << e.flags; }",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a902af6fb195fae97a89876b88d5034162ab8366",
      "in_reply_to_id": 1829434993,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-10T12:24:02Z",
      "updated_at": "2024-11-10T12:24:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681298",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681298"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 574,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681312",
      "pull_request_review_id": 2425748558,
      "id": 1835681312,
      "node_id": "PRRC_kwDOABII585takYg",
      "diff_hunk": "@@ -558,16 +560,29 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+const static char DIRTY = CCoinsCacheEntry::DIRTY;\n+const static char FRESH = CCoinsCacheEntry::FRESH;\n+const static char NO_ENTRY = -1;\n+\n+struct CoinEntry {",
      "path": "src/test/coins_tests.cpp",
      "position": 34,
      "original_position": 17,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a902af6fb195fae97a89876b88d5034162ab8366",
      "in_reply_to_id": 1829431415,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-10T12:24:06Z",
      "updated_at": "2024-11-10T12:24:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681312",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681312"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 570,
      "original_line": 570,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681334",
      "pull_request_review_id": 2425748582,
      "id": 1835681334,
      "node_id": "PRRC_kwDOABII585takY2",
      "diff_hunk": "@@ -166,6 +166,7 @@ struct CCoinsCacheEntry\n     {\n         Assume(flags & (DIRTY | FRESH));\n         if (!self.second.m_flags) {\n+            Assume(self.second.m_prev == nullptr && self.second.m_next == nullptr);",
      "path": "src/coins.h",
      "position": null,
      "original_position": 4,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "2d691b50d3729445a60898981b78c4239f2f0dd7",
      "in_reply_to_id": 1829417295,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> check that pointers are non-null if flags are set, or go further and check prev->next == self, and next->prev == self\r\n\r\nthe latter seems redundant, but the first is simple to check - done",
      "created_at": "2024-11-10T12:24:13Z",
      "updated_at": "2024-11-10T12:24:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1835681334",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1835681334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1836877971",
      "pull_request_review_id": 2427626316,
      "id": 1836877971,
      "node_id": "PRRC_kwDOABII585tfIiT",
      "diff_hunk": "@@ -197,11 +201,11 @@ struct CCoinsCacheEntry\n     }\n \n     //! Only use this for initializing the linked list sentinel\n-    inline void SelfRef(CoinsCachePair& self) noexcept\n+    inline void SelfRef(CoinsCachePair& pair) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 74,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "minor nit: I don't think this one needed to be renamed to `pair`. `self` still makes sense here.",
      "created_at": "2024-11-11T15:50:04Z",
      "updated_at": "2024-11-11T15:50:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1836877971",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1836877971"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 204,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1836880690",
      "pull_request_review_id": 2427630808,
      "id": 1836880690,
      "node_id": "PRRC_kwDOABII585tfJMy",
      "diff_hunk": "@@ -197,11 +201,11 @@ struct CCoinsCacheEntry\n     }\n \n     //! Only use this for initializing the linked list sentinel\n-    inline void SelfRef(CoinsCachePair& self) noexcept\n+    inline void SelfRef(CoinsCachePair& pair) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 74,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1836877971,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "yeah, but it's more consistent this way (and method name already mentions self)",
      "created_at": "2024-11-11T15:52:16Z",
      "updated_at": "2024-11-11T15:52:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1836880690",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1836880690"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 204,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1837922879",
      "pull_request_review_id": 2429297641,
      "id": 1837922879,
      "node_id": "PRRC_kwDOABII585tjHo_",
      "diff_hunk": "@@ -156,24 +156,33 @@ struct CCoinsCacheEntry\n     explicit CCoinsCacheEntry(Coin&& coin_) noexcept : coin(std::move(coin_)) {}\n     ~CCoinsCacheEntry()\n     {\n-        ClearFlags();\n+        SetClean();\n     }\n \n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n     inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n+        Assume(flags & (DIRTY | FRESH));\n         Assume(&self.second == this);\n-        if (!m_flags && flags) {\n+        if (!m_flags) {\n             m_prev = sentinel.second.m_prev;\n             m_next = &sentinel;\n             sentinel.second.m_prev = &self;\n             m_prev->second.m_next = &self;\n         }\n         m_flags |= flags;\n     }\n-    inline void ClearFlags() noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 38,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "a6921049fcc3de4067dc3f88fef57884450d25a1",
      "in_reply_to_id": 1829401813,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1829401813\r\n\r\n> Wouldn't I need to make `AddFlags` static as well in that case? \r\n\r\nNo that should not be necessary, and wouldn't suggest that. The suggestion is to make the new `SetFresh` and `SetClean` methods static and have them call `self.second.AddFlags` instead of `AddFlags` in this commit  so all the new calls to these methods don't need to change again in commit d5e3bbf440aa948df8159999fd4eb5275c354b93.",
      "created_at": "2024-11-12T11:14:15Z",
      "updated_at": "2024-11-12T11:34:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1837922879",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1837922879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 181,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1837939655",
      "pull_request_review_id": 2429297641,
      "id": 1837939655,
      "node_id": "PRRC_kwDOABII585tjLvH",
      "diff_hunk": "@@ -162,26 +162,19 @@ struct CCoinsCacheEntry\n     //! Adding a flag also requires a self reference to the pair that contains\n     //! this entry in the CCoinsCache map and a reference to the sentinel of the\n     //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    static inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "d5e3bbf440aa948df8159999fd4eb5275c354b93",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"coins, refactor: Make AddFlags, SetDirty, SetFresh static\" (d5e3bbf440aa948df8159999fd4eb5275c354b93)\r\n\r\nIt would make sense to rename `self` to `pair` this commit instead of in later commit afb0a3c88691cadc07fc985483f4cae1f486f6be so this code does not have to change twice and so later the change in the later commit can be move-only. Right now the later commit is tedious to review (or at least I don't know an easy way to review it) because the argument is renamed at the same time as the function is moved.",
      "created_at": "2024-11-12T11:27:27Z",
      "updated_at": "2024-11-12T11:34:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1837939655",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1837939655"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862673875",
      "pull_request_review_id": 2468800236,
      "id": 1862673875,
      "node_id": "PRRC_kwDOABII585vBiXT",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> _fresh_ is actually a substate of _dirty_. Being _fresh_ implies _dirty_, so cleaning implies no longer fresh.\r\n\r\nSorry for necroing this, but line 105 here seems to disagree?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24/src/coins.h#L101-L106",
      "created_at": "2024-11-28T20:45:39Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862673875",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862673875"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862704385",
      "pull_request_review_id": 2468800236,
      "id": 1862704385,
      "node_id": "PRRC_kwDOABII585vBp0B",
      "diff_hunk": "@@ -139,77 +139,55 @@ BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n }\n \n-BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n+BOOST_AUTO_TEST_CASE(linked_list_set_state)\n {\n     CoinsCachePair sentinel;\n     sentinel.second.SelfRef(sentinel);\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n-    // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    // Check that setting DIRTY inserts it into linked list and sets state\n+    CCoinsCacheEntry::SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n-    // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    // Check that setting FRESH on new node inserts it after n1\n+    CCoinsCacheEntry::SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh() && !n2.second.IsDirty());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    // Check that we can set extra state, but they don't change our position\n+    CCoinsCacheEntry::SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n-    // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n-    // Check that we can clear flags then re-add them\n-    n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Check that calling `ClearFlags` with 0 flags has no effect\n-    n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    // Check that we can clear state then re-set it\n+    n1.second.SetClean();\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    n1.second.SetClean();",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": 164,
      "original_position": 163,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: Could add comment\r\n```C++\r\n// Check that calling `SetClean` a second time has no effect\r\n```",
      "created_at": "2024-11-28T21:38:18Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862704385",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862704385"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 182,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862708127",
      "pull_request_review_id": 2468800236,
      "id": 1862708127,
      "node_id": "PRRC_kwDOABII585vBquf",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY,         true );\n+\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   true );\n+\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, VALUE3_DIRTY_FRESH,   true );\n+    }\n }\n \n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n+static void CheckWriteCoins(const MaybeCoin& parent, const MaybeCoin& child, const CoinOrError expected)\n {\n-    SingleEntryCacheTest test(ABSENT, parent_value, parent_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        WriteCoinsViewEntry(test.cache, child_value, child_flags);\n+    SingleEntryCacheTest test(ABSENT, parent);\n+    auto write_coins{[&]() { WriteCoinsViewEntry(test.cache, child); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        write_coins();\n         test.cache.SelfTest(/*sanity_check=*/false);\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(write_coins(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-\n-    // The checks above omit cases where the child flags are not DIRTY, since\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING            );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN        );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH        );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH  );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING            );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN       );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH       );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+\n+    // The checks above omit cases where the child state is not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const MaybeCoin& parent : {MISSING,\n+                                    SPENT_CLEAN, SPENT_DIRTY, SPENT_FRESH, SPENT_DIRTY_FRESH,\n+                                    VALUE1_CLEAN, VALUE1_DIRTY, VALUE1_FRESH, VALUE1_DIRTY_FRESH}) {\n+        for (const MaybeCoin& child : {MISSING,\n+                                       SPENT_CLEAN, SPENT_FRESH,\n+                                       VALUE2_CLEAN, VALUE2_FRESH}) {\n+            auto expected{CoinOrError{parent}}; // TODO add failure cases",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 542,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "New TODO?",
      "created_at": "2024-11-28T21:44:58Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862708127",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862708127"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 860,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862714606",
      "pull_request_review_id": 2468800236,
      "id": 1862714606,
      "node_id": "PRRC_kwDOABII585vBsTu",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {",
      "path": "src/test/coins_tests.cpp",
      "position": 124,
      "original_position": 121,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: Randomly gets curlies in c4eb31be3e56936479921b7556fcba1747867d02 but could have been there already in 7b3cfcf601524e442d71afbe448a526908e37e99.",
      "created_at": "2024-11-28T21:57:38Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862714606",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862714606"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 640,
      "original_line": 640,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862729959",
      "pull_request_review_id": 2468800236,
      "id": 1862729959,
      "node_id": "PRRC_kwDOABII585vBwDn",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 298,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why is the order between cache & modify parameters changed? Makes `ccoins_add`-diff harder to review.\r\n```suggestion\r\nstatic void CheckAddCoin(CAmount base_value, const MaybeCoin& cache_coin, CAmount modify_value, const CoinOrError expected, bool coinbase)\r\n```",
      "created_at": "2024-11-28T22:29:15Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862729959",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862729959"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 734,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862743627",
      "pull_request_review_id": 2468800236,
      "id": 1862743627,
      "node_id": "PRRC_kwDOABII585vBzZL",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << \", \" << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return State::DIRTY_FRESH;\n+        if (is_dirty) return State::DIRTY;\n+        if (is_fresh) return State::FRESH;\n+        return State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+using MaybeCoin   = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING           {std::nullopt};",
      "path": "src/test/coins_tests.cpp",
      "position": 60,
      "original_position": 59,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: Why not use `std::nullopt` directly instead of keeping the `MISSING`-alias when switching to `optional`?\r\nI tried, and had to use like `MaybeCoin{}` in 3 places where it was used in combination with other such values... so I'll give you that it's not entirely straight-forward.",
      "created_at": "2024-11-28T22:59:15Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862743627",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862743627"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 596,
      "original_line": 596,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862747678",
      "pull_request_review_id": 2468800236,
      "id": 1862747678,
      "node_id": "PRRC_kwDOABII585vB0Ye",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 310,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "(nit: Curlies)\r\n```suggestion\r\n    SingleEntryCacheTest test{base_value, cache_coin};\r\n    bool possible_overwrite{coinbase};\r\n    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin{CTxOut{modify_value, CScript{}}, 1, coinbase}, possible_overwrite); }};\r\n```",
      "created_at": "2024-11-28T23:08:43Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862747678",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862747678"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 736,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 738,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862752926",
      "pull_request_review_id": 2468800236,
      "id": 1862752926,
      "node_id": "PRRC_kwDOABII585vB1qe",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << \", \" << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return State::DIRTY_FRESH;\n+        if (is_dirty) return State::DIRTY;\n+        if (is_fresh) return State::FRESH;\n+        return State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+using MaybeCoin   = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING           {std::nullopt};\n+constexpr MaybeCoin SPENT_DIRTY       {CoinEntry{SPENT,  CoinEntry::State::DIRTY}};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 60,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: Less verbose (`MaybeCoin` type should be enough)?\r\n```suggestion\r\nconstexpr MaybeCoin SPENT_DIRTY       {{SPENT,  CoinEntry::State::DIRTY}};\r\n```\r\n\r\nAlso: Needless noise going from ` = `-initialization in early commits to brace-initialization in later ones, could be braces from the start.",
      "created_at": "2024-11-28T23:20:16Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862752926",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862752926"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 597,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862754511",
      "pull_request_review_id": 2468800236,
      "id": 1862754511,
      "node_id": "PRRC_kwDOABII585vB2DP",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`CoinEntry` could be `constexpr`-friendly from the very start instead of gaining that ability towards the end, meaning `SPENT_DIRTY` & co could be `constexpr` from the start, reducing noise.\r\n\r\nCould also place `struct CoinEntry` below the old `DIRTY`/`FRESH` constants in order to decrease size of diffs.",
      "created_at": "2024-11-28T23:24:10Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862754511",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862754511"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 569,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862760164",
      "pull_request_review_id": 2468800236,
      "id": 1862760164,
      "node_id": "PRRC_kwDOABII585vB3bk",
      "diff_hunk": "@@ -15,6 +15,8 @@\n #include <util/strencodings.h>\n \n #include <map>\n+#include <string>\n+#include <variant>",
      "path": "src/test/coins_tests.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "(nit: Introduced 2 commits before they're used, and `<string>` is only used transiently, where constants could be using `auto` (implicit `char[]`) from the start).",
      "created_at": "2024-11-28T23:37:03Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1862760164",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1862760164"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": 18,
      "original_start_line": 18,
      "start_side": "RIGHT",
      "line": 19,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863509899",
      "pull_request_review_id": 2468800236,
      "id": 1863509899,
      "node_id": "PRRC_kwDOABII585vEueL",
      "diff_hunk": "@@ -140,7 +141,8 @@ FUZZ_TARGET(coins_view, .init = initialize_coins_view)\n                         coins_cache_entry.coin = *opt_coin;\n                     }\n                     auto it{coins_map.emplace(random_out_point, std::move(coins_cache_entry)).first};\n-                    it->second.AddFlags(flags, *it, sentinel);\n+                    if (dirty) it->second.SetDirty(*it, sentinel);\n+                    if (fresh) it->second.SetFresh(*it, sentinel);",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Incomplete refactor:\r\n```suggestion\r\n                    if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel);\r\n                    if (fresh) CCoinsCacheEntry::SetFresh(*it, sentinel);\r\n```",
      "created_at": "2024-11-29T13:14:03Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1863509899",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863509899"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 144,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863530908",
      "pull_request_review_id": 2468800236,
      "id": 1863530908,
      "node_id": "PRRC_kwDOABII585vEzmc",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};",
      "path": "src/test/coins_tests.cpp",
      "position": 153,
      "original_position": 150,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: Going from `DIRTY` to `CoinEntry::State::DIRTY` is a bit noisy. I'd prefer making `CoinEntry::State` a non-`class` `enum`.\r\n```suggestion\r\n        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::DIRTY}};\r\n```",
      "created_at": "2024-11-29T13:30:50Z",
      "updated_at": "2024-11-29T13:52:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1863530908",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863530908"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 664,
      "original_line": 664,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863578230",
      "pull_request_review_id": 2469998750,
      "id": 1863578230,
      "node_id": "PRRC_kwDOABII585vE_J2",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY,         true );\n+\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   true );\n+\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, VALUE3_DIRTY_FRESH,   true );\n+    }\n }\n \n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n+static void CheckWriteCoins(const MaybeCoin& parent, const MaybeCoin& child, const CoinOrError expected)\n {\n-    SingleEntryCacheTest test(ABSENT, parent_value, parent_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        WriteCoinsViewEntry(test.cache, child_value, child_flags);\n+    SingleEntryCacheTest test(ABSENT, parent);\n+    auto write_coins{[&]() { WriteCoinsViewEntry(test.cache, child); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        write_coins();\n         test.cache.SelfTest(/*sanity_check=*/false);\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(write_coins(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-\n-    // The checks above omit cases where the child flags are not DIRTY, since\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING            );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN        );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH        );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH  );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING            );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN       );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH       );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+\n+    // The checks above omit cases where the child state is not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const MaybeCoin& parent : {MISSING,\n+                                    SPENT_CLEAN, SPENT_DIRTY, SPENT_FRESH, SPENT_DIRTY_FRESH,\n+                                    VALUE1_CLEAN, VALUE1_DIRTY, VALUE1_FRESH, VALUE1_DIRTY_FRESH}) {\n+        for (const MaybeCoin& child : {MISSING,\n+                                       SPENT_CLEAN, SPENT_FRESH,\n+                                       VALUE2_CLEAN, VALUE2_FRESH}) {\n+            auto expected{CoinOrError{parent}}; // TODO add failure cases",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 542,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862708127,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "yes, see the mentioned derisked PR: https://github.com/bitcoin/bitcoin/pull/30673/files#diff-1ef3b6a1936b50f3d5ec4a1786d9e2d63d1a3e1815b103e67f20601995f355b4R152-R154",
      "created_at": "2024-11-29T14:09:14Z",
      "updated_at": "2024-11-29T14:09:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1863578230",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1863578230"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 860,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865495151",
      "pull_request_review_id": 2472149304,
      "id": 1865495151,
      "node_id": "PRRC_kwDOABII585vMTJv",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY,         true );\n+\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   true );\n+\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, VALUE3_DIRTY_FRESH,   true );\n+    }\n }\n \n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n+static void CheckWriteCoins(const MaybeCoin& parent, const MaybeCoin& child, const CoinOrError expected)\n {\n-    SingleEntryCacheTest test(ABSENT, parent_value, parent_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        WriteCoinsViewEntry(test.cache, child_value, child_flags);\n+    SingleEntryCacheTest test(ABSENT, parent);\n+    auto write_coins{[&]() { WriteCoinsViewEntry(test.cache, child); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        write_coins();\n         test.cache.SelfTest(/*sanity_check=*/false);\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(write_coins(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-\n-    // The checks above omit cases where the child flags are not DIRTY, since\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING            );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN        );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH        );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH  );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING            );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN       );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH       );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+\n+    // The checks above omit cases where the child state is not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const MaybeCoin& parent : {MISSING,\n+                                    SPENT_CLEAN, SPENT_DIRTY, SPENT_FRESH, SPENT_DIRTY_FRESH,\n+                                    VALUE1_CLEAN, VALUE1_DIRTY, VALUE1_FRESH, VALUE1_DIRTY_FRESH}) {\n+        for (const MaybeCoin& child : {MISSING,\n+                                       SPENT_CLEAN, SPENT_FRESH,\n+                                       VALUE2_CLEAN, VALUE2_FRESH}) {\n+            auto expected{CoinOrError{parent}}; // TODO add failure cases",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 542,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862708127,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Don't get it, what does *src/test/fuzz/coinscache_sim.cpp* have to do with this? Something with clearing coins?\r\nBy \"failure\", do you mean the error half of `CoinOrError`?",
      "created_at": "2024-12-02T09:18:00Z",
      "updated_at": "2024-12-02T09:18:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865495151",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865495151"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 860,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865645185",
      "pull_request_review_id": 2472379286,
      "id": 1865645185,
      "node_id": "PRRC_kwDOABII585vM3yB",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        add_coin();\n         test.cache.SelfTest();\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(add_coin(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-}\n-\n-// Simple wrapper for CheckAddCoinBase function above that loops through\n-// different possible base_values, making sure each one gives the same results.\n-// This wrapper lets the coins_add test below be shorter and less repetitive,\n-// while still verifying that the CoinsViewCache::AddCoin implementation\n-// ignores base values.\n-template <typename... Args>\n-static void CheckAddCoin(Args&&... args)\n-{\n-    for (const CAmount base_value : {ABSENT, SPENT, VALUE1})\n-        CheckAddCoinBase(base_value, std::forward<Args>(args)...);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_add)\n {\n     /* Check AddCoin behavior, requesting a new coin from a cache view,\n      * writing a modification to the coin, and then checking the resulting\n      * entry in the cache after the modification. Verify behavior with the\n-     * AddCoin possible_overwrite argument set to false, and to true.\n-     *\n-     *           Cache   Write   Result  Cache        Result       possible_overwrite\n-     *           Value   Value   Value   Flags        Flags\n+     * AddCoin coinbase argument set to false, and to true.\n+     *               Base        Write   Cache               Expected              Coinbase\n      */\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY|FRESH, false);\n-    CheckAddCoin(ABSENT, VALUE3, VALUE3, NO_ENTRY   , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, false);\n-    CheckAddCoin(SPENT , VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , 0          , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, 0          , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , FRESH      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, FRESH      , DIRTY|FRESH, true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY      , NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY      , DIRTY      , true );\n-    CheckAddCoin(VALUE2, VALUE3, FAIL  , DIRTY|FRESH, NO_ENTRY   , false);\n-    CheckAddCoin(VALUE2, VALUE3, VALUE3, DIRTY|FRESH, DIRTY|FRESH, true );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, MISSING,            VALUE3_DIRTY,         true );\n+\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_CLEAN,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_FRESH,        VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY,        VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   false);\n+        CheckAddCoin(base_value, VALUE3, SPENT_DIRTY_FRESH,  VALUE3_DIRTY_FRESH,   true );\n+\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_CLEAN,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_FRESH,       VALUE3_DIRTY_FRESH,   true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY,       VALUE3_DIRTY,         true );\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, EX_OVERWRITE_UNSPENT, false);\n+        CheckAddCoin(base_value, VALUE3, VALUE2_DIRTY_FRESH, VALUE3_DIRTY_FRESH,   true );\n+    }\n }\n \n-void CheckWriteCoins(CAmount parent_value, CAmount child_value, CAmount expected_value, char parent_flags, char child_flags, char expected_flags)\n+static void CheckWriteCoins(const MaybeCoin& parent, const MaybeCoin& child, const CoinOrError expected)\n {\n-    SingleEntryCacheTest test(ABSENT, parent_value, parent_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        WriteCoinsViewEntry(test.cache, child_value, child_flags);\n+    SingleEntryCacheTest test(ABSENT, parent);\n+    auto write_coins{[&]() { WriteCoinsViewEntry(test.cache, child); }};\n+    if (auto* expected_coin{std::get_if<MaybeCoin>(&expected)}) {\n+        write_coins();\n         test.cache.SelfTest(/*sanity_check=*/false);\n-        GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    } catch (std::logic_error&) {\n-        result_value = FAIL;\n-        result_flags = NO_ENTRY;\n+        BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), *expected_coin);\n+    } else {\n+        BOOST_CHECK_EXCEPTION(write_coins(), std::logic_error, HasReason(std::get<std::string>(expected)));\n     }\n-\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_write)\n {\n     /* Check BatchWrite behavior, flushing one entry from a child cache to a\n      * parent cache, and checking the resulting entry in the parent cache\n      * after the write.\n-     *\n-     *              Parent  Child   Result  Parent       Child        Result\n-     *              Value   Value   Value   Flags        Flags        Flags\n+     *              Parent              Child               Expected\n      */\n-    CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(SPENT , ABSENT, SPENT , DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, FRESH      , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY|FRESH, DIRTY      );\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, 0          , NO_ENTRY   , 0          );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, FRESH      , NO_ENTRY   , FRESH      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY      , NO_ENTRY   , DIRTY      );\n-    CheckWriteCoins(VALUE1, ABSENT, VALUE1, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, SPENT , FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , 0          , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, FRESH      , DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , FRESH      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      , DIRTY      );\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY      , DIRTY|FRESH, NO_ENTRY   );\n-    CheckWriteCoins(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY      , DIRTY|FRESH);\n-    CheckWriteCoins(VALUE1, VALUE2, FAIL  , DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n-\n-    // The checks above omit cases where the child flags are not DIRTY, since\n+    CheckWriteCoins(MISSING,            MISSING,            MISSING            );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(MISSING,            SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(MISSING,            VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_CLEAN,        MISSING,            SPENT_CLEAN        );\n+    CheckWriteCoins(SPENT_FRESH,        MISSING,            SPENT_FRESH        );\n+    CheckWriteCoins(SPENT_DIRTY,        MISSING,            SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  MISSING,            SPENT_DIRTY_FRESH  );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_CLEAN,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_FRESH,        SPENT_DIRTY_FRESH,  MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY,        SPENT_DIRTY_FRESH,  SPENT_DIRTY        );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH,  MISSING            );\n+\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_CLEAN,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_FRESH,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY,        VALUE2_DIRTY_FRESH, VALUE2_DIRTY       );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(SPENT_DIRTY_FRESH,  VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH );\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       MISSING,            VALUE1_CLEAN       );\n+    CheckWriteCoins(VALUE1_FRESH,       MISSING,            VALUE1_FRESH       );\n+    CheckWriteCoins(VALUE1_DIRTY,       MISSING,            VALUE1_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, MISSING,            VALUE1_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_CLEAN,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_FRESH,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY,        SPENT_DIRTY        );\n+    CheckWriteCoins(VALUE1_DIRTY,       SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY,        MISSING            );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, SPENT_DIRTY_FRESH,  EX_FRESH_MISAPPLIED);\n+\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_CLEAN,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_FRESH,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY,       VALUE2_DIRTY       );\n+    CheckWriteCoins(VALUE1_DIRTY,       VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY,       VALUE2_DIRTY_FRESH );\n+    CheckWriteCoins(VALUE1_DIRTY_FRESH, VALUE2_DIRTY_FRESH, EX_FRESH_MISAPPLIED);\n+\n+    // The checks above omit cases where the child state is not DIRTY, since\n     // they would be too repetitive (the parent cache is never updated in these\n     // cases). The loop below covers these cases and makes sure the parent cache\n     // is always left unchanged.\n-    for (const CAmount parent_value : {ABSENT, SPENT, VALUE1})\n-        for (const CAmount child_value : {ABSENT, SPENT, VALUE2})\n-            for (const char parent_flags : parent_value == ABSENT ? ABSENT_FLAGS : FLAGS)\n-                for (const char child_flags : child_value == ABSENT ? ABSENT_FLAGS : CLEAN_FLAGS)\n-                    CheckWriteCoins(parent_value, child_value, parent_value, parent_flags, child_flags, parent_flags);\n+    for (const MaybeCoin& parent : {MISSING,\n+                                    SPENT_CLEAN, SPENT_DIRTY, SPENT_FRESH, SPENT_DIRTY_FRESH,\n+                                    VALUE1_CLEAN, VALUE1_DIRTY, VALUE1_FRESH, VALUE1_DIRTY_FRESH}) {\n+        for (const MaybeCoin& child : {MISSING,\n+                                       SPENT_CLEAN, SPENT_FRESH,\n+                                       VALUE2_CLEAN, VALUE2_FRESH}) {\n+            auto expected{CoinOrError{parent}}; // TODO add failure cases",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 542,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862708127,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It's not the purpose of this PR to add additional coverage, but after these refactors it's now possible to exercise the negative cases as well (which are missing here but tested in the other test methods, hence the TODO), similarly to how the above PR does for fuzzing.",
      "created_at": "2024-12-02T10:57:14Z",
      "updated_at": "2024-12-02T10:57:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865645185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865645185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 860,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865920849",
      "pull_request_review_id": 2472810643,
      "id": 1865920849,
      "node_id": "PRRC_kwDOABII585vN7FR",
      "diff_hunk": "@@ -159,19 +175,13 @@ struct CCoinsCacheEntry\n         ClearFlags();\n     }\n \n-    //! Adding a flag also requires a self reference to the pair that contains\n-    //! this entry in the CCoinsCache map and a reference to the sentinel of the\n-    //! flagged pair linked list.\n-    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    inline void SetDirty(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n     {\n-        Assume(&self.second == this);\n-        if (!m_flags && flags) {\n-            m_prev = sentinel.second.m_prev;\n-            m_next = &sentinel;\n-            sentinel.second.m_prev = &self;\n-            m_prev->second.m_next = &self;\n-        }\n-        m_flags |= flags;\n+        AddFlags(DIRTY, self, sentinel);\n+    }\n+    inline void SetFresh(CoinsCachePair& self, CoinsCachePair& sentinel) noexcept\n+    {\n+        AddFlags(FRESH, self, sentinel);\n     }\n     inline void ClearFlags() noexcept",
      "path": "src/coins.h",
      "position": null,
      "original_position": 56,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "b2f9df78176011b616a1715387aa43fce747d589",
      "in_reply_to_id": 1765031560,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "These definitions aren't fully consistent currently, the follow-up PR will partially clean this up I think (cc: @andrewtoth )",
      "created_at": "2024-12-02T14:11:55Z",
      "updated_at": "2024-12-02T14:11:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865920849",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865920849"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865920939",
      "pull_request_review_id": 2472810793,
      "id": 1865920939,
      "node_id": "PRRC_kwDOABII585vN7Gr",
      "diff_hunk": "@@ -139,77 +139,55 @@ BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n }\n \n-BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n+BOOST_AUTO_TEST_CASE(linked_list_set_state)\n {\n     CoinsCachePair sentinel;\n     sentinel.second.SelfRef(sentinel);\n     CoinsCachePair n1;\n     CoinsCachePair n2;\n \n-    // Check that adding 0 flag has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &sentinel);\n-\n-    // Check that adding DIRTY flag inserts it into linked list and sets flags\n-    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    // Check that setting DIRTY inserts it into linked list and sets state\n+    CCoinsCacheEntry::SetDirty(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n-    // Check that adding FRESH flag on new node inserts it after n1\n-    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    // Check that setting FRESH on new node inserts it after n1\n+    CCoinsCacheEntry::SetFresh(n2, sentinel);\n+    BOOST_CHECK(n2.second.IsFresh() && !n2.second.IsDirty());\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n \n-    // Check that adding 0 flag has no effect, and doesn't change position\n-    n1.second.AddFlags(0, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    // Check that we can set extra state, but they don't change our position\n+    CCoinsCacheEntry::SetFresh(n1, sentinel);\n+    BOOST_CHECK(n1.second.IsDirty() && n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n \n-    // Check that we can add extra flags, but they don't change our position\n-    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, sentinel);\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n-    BOOST_CHECK_EQUAL(n1.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(n1.second.Prev(), &sentinel);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &n1);\n-\n-    // Check that we can clear flags then re-add them\n-    n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n-    BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n-    BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n-    BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n-    BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n-\n-    // Check that calling `ClearFlags` with 0 flags has no effect\n-    n1.second.ClearFlags();\n-    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    // Check that we can clear state then re-set it\n+    n1.second.SetClean();\n+    BOOST_CHECK(!n1.second.IsDirty() && !n1.second.IsFresh());\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n2);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n2);\n     BOOST_CHECK_EQUAL(n2.second.Next(), &sentinel);\n     BOOST_CHECK_EQUAL(n2.second.Prev(), &sentinel);\n \n-    // Adding 0 still has no effect\n-    n1.second.AddFlags(0, n1, sentinel);\n+    n1.second.SetClean();",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": 164,
      "original_position": 163,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862704385,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:11:58Z",
      "updated_at": "2024-12-02T14:11:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865920939",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865920939"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 182,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921120",
      "pull_request_review_id": 2472811061,
      "id": 1865921120,
      "node_id": "PRRC_kwDOABII585vN7Jg",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {",
      "path": "src/test/coins_tests.cpp",
      "position": 124,
      "original_position": 121,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862714606,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:12:05Z",
      "updated_at": "2024-12-02T14:12:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865921120",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921120"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 640,
      "original_line": 640,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921273",
      "pull_request_review_id": 2472811307,
      "id": 1865921273,
      "node_id": "PRRC_kwDOABII585vN7L5",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 298,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862729959,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I must have had a reason for changing it, but it does make sense to have the cache value before the modify value in the row -> done",
      "created_at": "2024-12-02T14:12:11Z",
      "updated_at": "2024-12-02T14:12:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865921273",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921273"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 734,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921490",
      "pull_request_review_id": 2472811620,
      "id": 1865921490,
      "node_id": "PRRC_kwDOABII585vN7PS",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << \", \" << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return State::DIRTY_FRESH;\n+        if (is_dirty) return State::DIRTY;\n+        if (is_fresh) return State::FRESH;\n+        return State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+using MaybeCoin   = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING           {std::nullopt};",
      "path": "src/test/coins_tests.cpp",
      "position": 60,
      "original_position": 59,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862743627,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Optional is an implementation detail",
      "created_at": "2024-12-02T14:12:18Z",
      "updated_at": "2024-12-02T14:12:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865921490",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921490"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 596,
      "original_line": 596,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921632",
      "pull_request_review_id": 2472811843,
      "id": 1865921632,
      "node_id": "PRRC_kwDOABII585vN7Rg",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};\n+        WriteCoinsViewEntry(base, base_cache_coin);\n+        if (cache_coin) cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), *cache_coin);\n     }\n \n     CCoinsView root;\n     CCoinsViewCacheTest base{&root};\n     CCoinsViewCacheTest cache{&base};\n };\n \n-static void CheckAccessCoin(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckAccessCoin(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.AccessCoin(OUTPOINT);\n     test.cache.SelfTest(/*sanity_check=*/false);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n }\n \n BOOST_AUTO_TEST_CASE(ccoins_access)\n {\n     /* Check AccessCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, and checking the resulting entry in the cache after\n      * the access.\n-     *\n-     *               Base    Cache   Result  Cache        Result\n-     *               Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckAccessCoin(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(SPENT , VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, ABSENT, VALUE1, NO_ENTRY   , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , 0          , 0          );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, SPENT , SPENT , DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, 0          , 0          );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, FRESH      , FRESH      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY      , DIRTY      );\n-    CheckAccessCoin(VALUE1, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckAccessCoin(base_value, MISSING,            base_value == VALUE1 ? VALUE1_CLEAN : MISSING);\n+\n+        CheckAccessCoin(base_value, SPENT_CLEAN,        SPENT_CLEAN       );\n+        CheckAccessCoin(base_value, SPENT_FRESH,        SPENT_FRESH       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY,        SPENT_DIRTY       );\n+        CheckAccessCoin(base_value, SPENT_DIRTY_FRESH,  SPENT_DIRTY_FRESH );\n+\n+        CheckAccessCoin(base_value, VALUE2_CLEAN,       VALUE2_CLEAN      );\n+        CheckAccessCoin(base_value, VALUE2_FRESH,       VALUE2_FRESH      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY,       VALUE2_DIRTY      );\n+        CheckAccessCoin(base_value, VALUE2_DIRTY_FRESH, VALUE2_DIRTY_FRESH);\n+    }\n }\n \n-static void CheckSpendCoins(CAmount base_value, CAmount cache_value, CAmount expected_value, char cache_flags, char expected_flags)\n+static void CheckSpendCoins(CAmount base_value, const MaybeCoin& cache_coin, MaybeCoin expected)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n     test.cache.SpendCoin(OUTPOINT);\n     test.cache.SelfTest();\n-\n-    CAmount result_value;\n-    char result_flags;\n-    GetCoinsMapEntry(test.cache.map(), result_value, result_flags);\n-    BOOST_CHECK_EQUAL(result_value, expected_value);\n-    BOOST_CHECK_EQUAL(result_flags, expected_flags);\n-};\n+    BOOST_CHECK_EQUAL(GetCoinsMapEntry(test.cache.map()), expected);\n+}\n \n BOOST_AUTO_TEST_CASE(ccoins_spend)\n {\n     /* Check SpendCoin behavior, requesting a coin from a cache view layered on\n      * top of a base view, spending, and then checking\n      * the resulting entry in the cache after the modification.\n-     *\n-     *              Base    Cache   Result  Cache        Result\n-     *              Value   Value   Value   Flags        Flags\n+     *                  Base        Cache               Expected\n      */\n-    CheckSpendCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(ABSENT, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(ABSENT, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(SPENT , VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(SPENT , VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, ABSENT, SPENT , NO_ENTRY   , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, SPENT , SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, SPENT , ABSENT, DIRTY|FRESH, NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , 0          , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, FRESH      , NO_ENTRY   );\n-    CheckSpendCoins(VALUE1, VALUE2, SPENT , DIRTY      , DIRTY      );\n-    CheckSpendCoins(VALUE1, VALUE2, ABSENT, DIRTY|FRESH, NO_ENTRY   );\n+    for (auto base_value : {ABSENT, SPENT, VALUE1}) {\n+        CheckSpendCoins(base_value, MISSING,            base_value == VALUE1 ? SPENT_DIRTY : MISSING);\n+\n+        CheckSpendCoins(base_value, SPENT_CLEAN,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_FRESH,        MISSING    );\n+        CheckSpendCoins(base_value, SPENT_DIRTY,        SPENT_DIRTY);\n+        CheckSpendCoins(base_value, SPENT_DIRTY_FRESH,  MISSING    );\n+\n+        CheckSpendCoins(base_value, VALUE2_CLEAN,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_FRESH,       MISSING    );\n+        CheckSpendCoins(base_value, VALUE2_DIRTY,       SPENT_DIRTY);\n+        CheckSpendCoins(base_value, VALUE2_DIRTY_FRESH, MISSING    );\n+    }\n }\n \n-static void CheckAddCoinBase(CAmount base_value, CAmount cache_value, CAmount modify_value, CAmount expected_value, char cache_flags, char expected_flags, bool coinbase)\n+static void CheckAddCoin(CAmount base_value, CAmount modify_value, const MaybeCoin& cache_coin, const CoinOrError expected, bool coinbase)\n {\n-    SingleEntryCacheTest test(base_value, cache_value, cache_flags);\n-\n-    CAmount result_value;\n-    char result_flags;\n-    try {\n-        CTxOut output;\n-        output.nValue = modify_value;\n-        test.cache.AddCoin(OUTPOINT, Coin(std::move(output), 1, coinbase), coinbase);\n+    SingleEntryCacheTest test(base_value, cache_coin);\n+    bool possible_overwrite{coinbase};\n+    auto add_coin{[&]() { test.cache.AddCoin(OUTPOINT, Coin(CTxOut(modify_value, CScript()), 1, coinbase), possible_overwrite); }};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 310,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862747678,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:12:24Z",
      "updated_at": "2024-12-02T14:12:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865921632",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921632"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 736,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 738,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921841",
      "pull_request_review_id": 2472812154,
      "id": 1865921841,
      "node_id": "PRRC_kwDOABII585vN7Ux",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}\n+\n+    bool operator==(const CoinEntry& o) const = default;\n+    friend std::ostream& operator<<(std::ostream& os, const CoinEntry& e) { return os << e.value << \", \" << e.state; }\n+\n+    constexpr bool IsDirtyFresh() const { return state == State::DIRTY_FRESH; }\n+    constexpr bool IsDirty() const { return state == State::DIRTY || IsDirtyFresh(); }\n+    constexpr bool IsFresh() const { return state == State::FRESH || IsDirtyFresh(); }\n+\n+    static constexpr State ToState(bool is_dirty, bool is_fresh) {\n+        if (is_dirty && is_fresh) return State::DIRTY_FRESH;\n+        if (is_dirty) return State::DIRTY;\n+        if (is_fresh) return State::FRESH;\n+        return State::CLEAN;\n+    }\n+};\n+\n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+using MaybeCoin   = std::optional<CoinEntry>;\n+using CoinOrError = std::variant<MaybeCoin, std::string>;\n+\n+constexpr MaybeCoin MISSING           {std::nullopt};\n+constexpr MaybeCoin SPENT_DIRTY       {CoinEntry{SPENT,  CoinEntry::State::DIRTY}};",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 60,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862752926,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:12:31Z",
      "updated_at": "2024-12-02T14:12:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865921841",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865921841"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 597,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922183",
      "pull_request_review_id": 2472812600,
      "id": 1865922183,
      "node_id": "PRRC_kwDOABII585vN7aH",
      "diff_hunk": "@@ -558,20 +560,57 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n     }\n }\n \n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(CAmount v, State s) : value(v), state(s) {}",
      "path": "src/test/coins_tests.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862754511,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:12:42Z",
      "updated_at": "2024-12-02T14:12:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865922183",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922183"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 569,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922298",
      "pull_request_review_id": 2472812770,
      "id": 1865922298,
      "node_id": "PRRC_kwDOABII585vN7b6",
      "diff_hunk": "@@ -15,6 +15,8 @@\n #include <util/strencodings.h>\n \n #include <map>\n+#include <string>\n+#include <variant>",
      "path": "src/test/coins_tests.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862760164,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-12-02T14:12:46Z",
      "updated_at": "2024-12-02T14:12:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865922298",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922298"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": 18,
      "original_start_line": 18,
      "start_side": "RIGHT",
      "line": 19,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922400",
      "pull_request_review_id": 2472812948,
      "id": 1865922400,
      "node_id": "PRRC_kwDOABII585vN7dg",
      "diff_hunk": "@@ -140,7 +141,8 @@ FUZZ_TARGET(coins_view, .init = initialize_coins_view)\n                         coins_cache_entry.coin = *opt_coin;\n                     }\n                     auto it{coins_map.emplace(random_out_point, std::move(coins_cache_entry)).first};\n-                    it->second.AddFlags(flags, *it, sentinel);\n+                    if (dirty) it->second.SetDirty(*it, sentinel);\n+                    if (fresh) it->second.SetFresh(*it, sentinel);",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1863509899,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done, thanks",
      "created_at": "2024-12-02T14:12:50Z",
      "updated_at": "2024-12-02T14:12:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865922400",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922400"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": 144,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922643",
      "pull_request_review_id": 2472813244,
      "id": 1865922643,
      "node_id": "PRRC_kwDOABII585vN7hT",
      "diff_hunk": "@@ -585,314 +624,245 @@ static void SetCoinsValue(CAmount value, Coin& coin)\n     }\n }\n \n-static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, CAmount value, char flags)\n+static size_t InsertCoinsMapEntry(CCoinsMap& map, CoinsCachePair& sentinel, const CoinEntry& cache_coin)\n {\n-    if (value == ABSENT) {\n-        assert(flags == NO_ENTRY);\n-        return 0;\n-    }\n-    assert(flags != NO_ENTRY);\n     CCoinsCacheEntry entry;\n-    SetCoinsValue(value, entry.coin);\n-    auto inserted = map.emplace(OUTPOINT, std::move(entry));\n-    assert(inserted.second);\n-    inserted.first->second.AddFlags(flags, *inserted.first, sentinel);\n-    return inserted.first->second.coin.DynamicMemoryUsage();\n+    SetCoinsValue(cache_coin.value, entry.coin);\n+    auto [iter, inserted] = map.emplace(OUTPOINT, std::move(entry));\n+    assert(inserted);\n+    if (cache_coin.IsDirty()) CCoinsCacheEntry::SetDirty(*iter, sentinel);\n+    if (cache_coin.IsFresh()) CCoinsCacheEntry::SetFresh(*iter, sentinel);\n+    return iter->second.coin.DynamicMemoryUsage();\n }\n \n-void GetCoinsMapEntry(const CCoinsMap& map, CAmount& value, char& flags, const COutPoint& outp = OUTPOINT)\n+static MaybeCoin GetCoinsMapEntry(const CCoinsMap& map, const COutPoint& outp = OUTPOINT)\n {\n-    auto it = map.find(outp);\n-    if (it == map.end()) {\n-        value = ABSENT;\n-        flags = NO_ENTRY;\n-    } else {\n-        if (it->second.coin.IsSpent()) {\n-            value = SPENT;\n-        } else {\n-            value = it->second.coin.out.nValue;\n-        }\n-        flags = it->second.GetFlags();\n-        assert(flags != NO_ENTRY);\n+    if (auto it{map.find(outp)}; it != map.end()) {\n+        return CoinEntry{\n+            it->second.coin.IsSpent() ? SPENT : it->second.coin.out.nValue,\n+            CoinEntry::ToState(it->second.IsDirty(), it->second.IsFresh())};\n     }\n+    return MISSING;\n }\n \n-void WriteCoinsViewEntry(CCoinsView& view, CAmount value, char flags)\n+static void WriteCoinsViewEntry(CCoinsView& view, const MaybeCoin& cache_coin)\n {\n     CoinsCachePair sentinel{};\n     sentinel.second.SelfRef(sentinel);\n     CCoinsMapMemoryResource resource;\n     CCoinsMap map{0, CCoinsMap::hasher{}, CCoinsMap::key_equal{}, &resource};\n-    auto usage{InsertCoinsMapEntry(map, sentinel, value, flags)};\n+    auto usage{cache_coin ? InsertCoinsMapEntry(map, sentinel, *cache_coin) : 0};\n     auto cursor{CoinsViewCacheCursor(usage, sentinel, map, /*will_erase=*/true)};\n     BOOST_CHECK(view.BatchWrite(cursor, {}));\n }\n \n class SingleEntryCacheTest\n {\n public:\n-    SingleEntryCacheTest(CAmount base_value, CAmount cache_value, char cache_flags)\n+    SingleEntryCacheTest(CAmount base_value, const MaybeCoin& cache_coin)\n     {\n-        WriteCoinsViewEntry(base, base_value, base_value == ABSENT ? NO_ENTRY : DIRTY);\n-        cache.usage() += InsertCoinsMapEntry(cache.map(), cache.sentinel(), cache_value, cache_flags);\n+        auto base_cache_coin{base_value == ABSENT ? MISSING : CoinEntry{base_value, CoinEntry::State::DIRTY}};",
      "path": "src/test/coins_tests.cpp",
      "position": 153,
      "original_position": 150,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1863530908,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "enum class is safer than enum https://agrawalsuneet.github.io/blogs/enum-vs-enum-class-in-c++ and I didn't like the result of `using enum State`",
      "created_at": "2024-12-02T14:12:58Z",
      "updated_at": "2024-12-02T14:12:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1865922643",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865922643"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 664,
      "original_line": 664,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867774375",
      "pull_request_review_id": 2475766827,
      "id": 1867774375,
      "node_id": "PRRC_kwDOABII585vU_mn",
      "diff_hunk": "@@ -559,21 +561,58 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n }\n \n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n-\n-static void SetCoinsValue(CAmount value, Coin& coin)\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(const CAmount v, const State s) : value{v}, state{s} {}",
      "path": "src/test/coins_tests.cpp",
      "position": 40,
      "original_position": 40,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "in_reply_to_id": null,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Using `const` for value type parameters (`CAmount` is a typedef of `int64_t`), when a function doesn't contain any logic is noisy to me and not used in the codebase at large.\r\n```suggestion\r\n    constexpr CoinEntry(CAmount v, State s) : value{v}, state{s} {}\r\n```\r\n\r\nIt is useful in cases like this where the function is actually doing something:\r\nhttps://github.com/bitcoin/bitcoin/blob/ebe4cac38bf6c510b00b8e080acab079c54016d6/src/uint256.cpp#L20-L44\r\n\r\n(Edit: I realize that `string_view` isn't strictly a value-type. If one greps for `\"(const uint64_t \"` one gets 5 hits, while `\"(uint64_t \"` gives 212).\r\n\r\nSame goes for `ToState`, `SetCoinsValue`, `SingleEntryCacheTest`, `CheckAccessCoin` etc.\r\n\r\nOtherwise you might as well add `const` to `AddFlags(uint8_t flags, ...` etc?",
      "created_at": "2024-12-03T14:00:54Z",
      "updated_at": "2024-12-03T14:25:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867774375",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867774375"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 576,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867807271",
      "pull_request_review_id": 2475766827,
      "id": 1867807271,
      "node_id": "PRRC_kwDOABII585vVHon",
      "diff_hunk": "@@ -15,6 +15,8 @@\n #include <util/strencodings.h>\n \n #include <map>\n+#include <string>\n+#include <variant>",
      "path": "src/test/coins_tests.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862760164,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`<string>` is still needlessly added in c0b4b2c1eef95c0b626573a9a2e217f4a541a880.",
      "created_at": "2024-12-03T14:18:12Z",
      "updated_at": "2024-12-03T14:18:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867807271",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867807271"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": 18,
      "original_start_line": 18,
      "start_side": "RIGHT",
      "line": 19,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867894322",
      "pull_request_review_id": 2475964606,
      "id": 1867894322,
      "node_id": "PRRC_kwDOABII585vVc4y",
      "diff_hunk": "@@ -15,6 +15,8 @@\n #include <util/strencodings.h>\n \n #include <map>\n+#include <string>\n+#include <variant>",
      "path": "src/test/coins_tests.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24",
      "in_reply_to_id": 1862760164,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```bash\r\ngrep \"std::string\" bitcoin/src/test/coins_tests.cpp | wc -l\r\n3\r\n```",
      "created_at": "2024-12-03T15:01:45Z",
      "updated_at": "2024-12-03T15:01:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867894322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867894322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": 18,
      "original_start_line": 18,
      "start_side": "RIGHT",
      "line": 19,
      "original_line": 19,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867899670",
      "pull_request_review_id": 2475973232,
      "id": 1867899670,
      "node_id": "PRRC_kwDOABII585vVeMW",
      "diff_hunk": "@@ -559,21 +561,58 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n }\n \n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n-\n-static void SetCoinsValue(CAmount value, Coin& coin)\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(const CAmount v, const State s) : value{v}, state{s} {}",
      "path": "src/test/coins_tests.cpp",
      "position": 40,
      "original_position": 40,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "in_reply_to_id": 1867774375,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I prefer `const` here, my IDE was also asking for them, I don't mind adding them here.\r\nBeing `noisy` when `a function doesn't contain any logic` doesn't sound like a blocker to me :)",
      "created_at": "2024-12-03T15:04:43Z",
      "updated_at": "2024-12-03T15:04:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867899670",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867899670"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 576,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867966922",
      "pull_request_review_id": 2476082818,
      "id": 1867966922,
      "node_id": "PRRC_kwDOABII585vVunK",
      "diff_hunk": "@@ -559,21 +561,58 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n }\n \n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n-\n-static void SetCoinsValue(CAmount value, Coin& coin)\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(const CAmount v, const State s) : value{v}, state{s} {}",
      "path": "src/test/coins_tests.cpp",
      "position": 40,
      "original_position": 40,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "in_reply_to_id": 1867774375,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This issue is a non-nit for me as a general pattern as it will affect diffs & reviews going forward.\r\n\r\nWe've got a ratio of 5/212 or roughly 1:40 for this codebase. I'm surprised that the IDE is encouraging that.\r\n\r\nWhat is you rationale for not applying it to `AddFlags`? Did the specific version of your IDE not tell you to do so? Does your IDE have a documented rationale?\r\n\r\nIf there is a clear rationale, ideally with a statistical sample of % bugs discovered from changing to `const` value type parameters, I'm open to that. But the 1:40 ratio weighs heavily.",
      "created_at": "2024-12-03T15:43:12Z",
      "updated_at": "2024-12-03T15:43:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867966922",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867966922"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 576,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867992733",
      "pull_request_review_id": 2476124842,
      "id": 1867992733,
      "node_id": "PRRC_kwDOABII585vV06d",
      "diff_hunk": "@@ -559,21 +561,58 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n }\n \n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n-\n-static void SetCoinsValue(CAmount value, Coin& coin)\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(const CAmount v, const State s) : value{v}, state{s} {}",
      "path": "src/test/coins_tests.cpp",
      "position": 40,
      "original_position": 40,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "in_reply_to_id": 1867774375,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We can unify these in a separate PR, I don't mind, I added these since the linters were complaining - and I was fine with either option since it doesn't affect the body of the function signal-to-noise-ratio-wise.",
      "created_at": "2024-12-03T15:58:33Z",
      "updated_at": "2024-12-03T15:58:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1867992733",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1867992733"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 576,
      "original_line": 576,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868020679",
      "pull_request_review_id": 2476171098,
      "id": 1868020679,
      "node_id": "PRRC_kwDOABII585vV7vH",
      "diff_hunk": "@@ -559,21 +561,58 @@ BOOST_AUTO_TEST_CASE(ccoins_serialization)\n }\n \n const static COutPoint OUTPOINT;\n-const static CAmount SPENT = -1;\n-const static CAmount ABSENT = -2;\n-const static CAmount FAIL = -3;\n-const static CAmount VALUE1 = 100;\n-const static CAmount VALUE2 = 200;\n-const static CAmount VALUE3 = 300;\n-const static char DIRTY = CCoinsCacheEntry::DIRTY;\n-const static char FRESH = CCoinsCacheEntry::FRESH;\n-const static char NO_ENTRY = -1;\n-\n-const static auto FLAGS = {char(0), FRESH, DIRTY, char(DIRTY | FRESH)};\n-const static auto CLEAN_FLAGS = {char(0), FRESH};\n-const static auto ABSENT_FLAGS = {NO_ENTRY};\n-\n-static void SetCoinsValue(CAmount value, Coin& coin)\n+constexpr CAmount SPENT {-1};\n+constexpr CAmount ABSENT{-2};\n+constexpr CAmount VALUE1{100};\n+constexpr CAmount VALUE2{200};\n+constexpr CAmount VALUE3{300};\n+\n+struct CoinEntry {\n+    enum class State { CLEAN, DIRTY, FRESH, DIRTY_FRESH };\n+\n+    const CAmount value;\n+    const State state;\n+\n+    constexpr CoinEntry(const CAmount v, const State s) : value{v}, state{s} {}",
      "path": "src/test/coins_tests.cpp",
      "position": 40,
      "original_position": 40,
      "commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "original_commit_id": "50cce20013c97e1257cb9f4c9319701a09b0a196",
      "in_reply_to_id": 1867774375,
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "9edbe5a48fe9a2c0d364882fcb7d44ae6aac6d24 before the latest push didn't have these `const` params. I think it was a mistake to add them in the latest push and would prefer them rolled back.\r\n\r\nAnother alternative is to discuss my samples of ratios of `const` value type params or why you didn't apply it to `AddFlags`.\r\n\r\nSorry to be annoying about this but for some reason it really annoys me. :)\r\nWill take a timeout and see if I can let go of this, if you still insist.",
      "created_at": "2024-12-03T16:16:29Z",
      "updated_at": "2024-12-03T16:16:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30906#discussion_r1868020679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868020679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30906"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 576,
      "original_line": 576,
      "side": "RIGHT"
    }
  ]
}