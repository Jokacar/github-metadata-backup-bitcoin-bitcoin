{
  "type": "issue",
  "issue": {
    "id": 2682818447,
    "node_id": "I_kwDOABII586f6I-P",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31344",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31344/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31344/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31344/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31344",
    "number": 31344,
    "state": "open",
    "state_reason": null,
    "title": "ci: how to run native arm job on Apple silicon?",
    "body": "I'm trying to run the `arm64` worker job (ARM, unit tests, no functional tests) on my M4 mac, because that should be lot faster than emulating it in Qemu on my x86_64 machine.\r\n\r\nUnfortunately so far it fails:\r\n\r\n```\r\n[10:34:36.739] Test project /ci_container_base/ci/scratch/build-arm-linux-gnueabihf\r\n[10:34:36.742]         Start   2: util_rpcauth_test\r\n[10:34:36.744]         Start   4: univalue_object_test\r\n[10:34:36.747]         Start   6: secp256k1_tests\r\n[10:34:36.751]         Start   8: test_bitcoin-qt\r\n[10:34:36.754]         Start  10: addrman_tests\r\n[10:34:36.756]   2/141 Test   #4: univalue_object_test .................***Failed    0.01 sec\r\n[10:34:36.756] /ci_container_base/ci/scratch/build-arm-linux-gnueabihf/src/univalue/object: 1: Syntax error: word unexpected (expecting \")\")\r\n[10:34:36.756] \r\n[10:34:36.769]   9/141 Test   #2: util_rpcauth_test ....................   Passed    0.03 sec\r\n[10:34:36.888]  10/141 Test   #1: util_test_runner .....................***Failed    0.15 sec\r\n[10:34:36.888] 2024-11-22 10:34:36,767 - ERROR - OSError, Failed to execute /ci_container_base/ci/scratch/build-arm-linux-gnueabihf/src/bitcoin-util \r\n```\r\n\r\nhttps://cirrus-ci.com/task/4863394807808000\r\n\r\nThis is running https://github.com/Sjors/bitcoin/pull/67 which is based on master @ 2638fdb4f934be96b7c798dbac38ea5ab8a6374a.\r\n\r\nMy current setup:\r\n* MacBook Pro with M4 Pro chip\r\n* UTM to run a VM: https://mac.getutm.app\r\n* Ubuntu Server 24.0.1 for ARM: https://ubuntu.com/download/server/arm\r\n* UTM machine settings:\r\n  * ARM64 (aarch64)\r\n  * System: QEMU 7.2 ARM virt-8.2\r\n  * 14 GB RAM\r\n  * 10 CPU cores\r\n  * haven't touched other default settings\r\n\r\nFor `.cirrus.yaml` I use:\r\n\r\n```yaml\r\nname: MBP24-I\r\ntoken: ...\r\n\r\nlabels:\r\n  type: arm64\r\n```\r\n\r\nI start the worker with:\r\n\r\n```sh\r\nRESTART_CI_DOCKER_BEFORE_RUN=1 cirrus worker run -f ~/.cirrus.yaml\r\n```\r\n\r\nI also tried running the cirrus worker outside a VM, with `cirrus` installed via Homebrew. For setup that I used Podman Desktop with the Docker extension.\r\n\r\nIt fails with the same error. Here's the log for that:\r\n\r\nhttps://cirrus-ci.com/task/4838331626815488\r\n\r\nFor comparison here's the same job (still) running on x86_64 with qemu:\r\n\r\nhttps://cirrus-ci.com/task/4837454681735168",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      },
      {
        "id": 477890092,
        "node_id": "MDU6TGFiZWw0Nzc4OTAwOTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Questions%20and%20Help",
        "name": "Questions and Help",
        "color": "006688",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 1,
    "created_at": "2024-11-22T11:00:48Z",
    "updated_at": "2024-11-22T11:24:42Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2493529510,
      "node_id": "IC_kwDOABII586UoD2m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2493529510",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-22T11:24:17Z",
      "updated_at": "2024-11-22T11:24:17Z",
      "author_association": "MEMBER",
      "body": "My recommendation would be to try without the cirrus overhead for debugging. Just copy-pasting the one-line bash command may be easier and faster for troubleshooting. See https://github.com/bitcoin/bitcoin/tree/master/ci#running-a-stage-locally\r\n\r\n\r\nAs for the error itself: It is not possible to run 32-bit arm binaries on a CPU that only supports 64-bit mode.\r\n\r\nI don't know how to fix this, but if nothing helps, you'll have to select qemu-arm in UTM. (Is there a reason why you haven't done this in the first place?)\r\n\r\nRelevant CI output:\r\n\r\n```\r\n[11:51:42.955] + lscpu\r\n[11:51:42.957] Architecture:                         aarch64\r\n[11:51:42.957] CPU op-mode(s):                       64-bit\r\n```\r\n\r\nIt should be 32-bit, or at least include it:\r\n\r\n```\r\n[20:50:34.606] + lscpu\r\n[20:50:34.612] Architecture:                         aarch64\r\n[20:50:34.612] CPU op-mode(s):                       32-bit, 64-bit\r\n",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31344#issuecomment-2493529510",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31344"
    },
    {
      "event": "labeled",
      "id": 15396213496,
      "node_id": "LE_lADOABII586f6I-PzwAAAAOVr5L4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15396213496",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-22T11:24:42Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "labeled",
      "id": 15396213504,
      "node_id": "LE_lADOABII586f6I-PzwAAAAOVr5MA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15396213504",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-22T11:24:42Z",
      "label": {
        "name": "Questions and Help",
        "color": "006688"
      }
    }
  ]
}