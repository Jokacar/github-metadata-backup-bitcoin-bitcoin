{
  "type": "issue",
  "issue": {
    "id": 622126784,
    "node_id": "MDU6SXNzdWU2MjIxMjY3ODQ=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/19034",
    "number": 19034,
    "state": "open",
    "state_reason": null,
    "title": "Small memory leak when BerkeleyEnvironment::Open fails",
    "body": "Originally reported https://github.com/bitcoin/bitcoin/pull/18907#issuecomment-631153346\r\n\r\nThis happens when trying to load a wallet with corrupt logs. It can be reproduced running the wallet_db.py test from #18907@[`c6a2c26`](https://github.com/bitcoin/bitcoin/commits/c6a2c265f5d0b424fc8226c2f3426e82856779d0). From https://travis-ci.org/github/bitcoin/bitcoin/jobs/689013660#L4659: \r\n\r\n```\r\n==2504==ERROR: LeakSanitizer: detected memory leaks\r\nDirect leak of 65840 byte(s) in 2 object(s) allocated from:\r\n    #0 0x55b144d4adb3 in __interceptor_malloc (/home/travis/build/bitcoin/bitcoin/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/bitcoind+0x1c75db3)\r\n    #1 0x7f0207036cc4 in __os_malloc (/usr/lib/x86_64-linux-gnu/libdb_cxx-5.3.so+0x162cc4)\r\n    #2 0x19f3b1afb25218ff  (<unknown module>)\r\nSUMMARY: AddressSanitizer: 65840 byte(s) leaked in 2 allocation(s). \r\n```\r\n\r\nThe leak is known to happen at commits 274b9909f64aa617eb322850b799bc38c04f5f0c (initial commit) and e78c6820232865f21777bfeefadac0a1aea1fde2 (attempted fix) from #18907\r\n\r\nThis is probaby not a very severe issue, but it'd be good to track down the leak, fix it, and add the wallet_db test to have some test coverage for log recovery. All of this can be done independently of #18907, before or after it is merged.",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 1,
    "created_at": "2020-05-20T22:38:22Z",
    "updated_at": "2021-07-04T12:53:23Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 3358572067,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzNTg1NzIwNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3358572067",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-20T22:38:22Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-20T22:39:36Z",
      "updated_at": "2020-05-20T22:39:36Z",
      "source": {
        "issue": {
          "id": 614261149,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NDE0ODUyNjM1",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18907",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18907/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18907/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18907/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/18907",
          "number": 18907,
          "state": "closed",
          "state_reason": null,
          "title": "walletdb: Don't remove database transaction logs and instead error",
          "body": "Instead of removing the database transaction logs and retrying the\r\nwallet loading, just return an error message to the user. Additionally,\r\nspeciically for DB_RUNRECOVERY, notify the user that this could be due\r\nto different BDB versions.\r\n\r\nKind of implements the suggestion from https://github.com/bitcoin/bitcoin/pull/18870#discussion_r421647964",
          "user": {
            "login": "achow101",
            "id": 3782274,
            "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/achow101",
            "html_url": "https://github.com/achow101",
            "followers_url": "https://api.github.com/users/achow101/followers",
            "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
            "organizations_url": "https://api.github.com/users/achow101/orgs",
            "repos_url": "https://api.github.com/users/achow101/repos",
            "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/achow101/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 14,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18907",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/18907",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/18907.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/18907.patch"
          },
          "closed_at": "2020-07-22T07:02:14Z",
          "created_at": "2020-05-07T18:35:08Z",
          "updated_at": "2022-02-15T11:03:58Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "labeled",
      "id": 3358609395,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDMzNTg2MDkzOTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/3358609395",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-20T22:55:04Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-05-22T00:04:22Z",
      "updated_at": "2020-05-22T00:04:22Z",
      "source": {
        "issue": {
          "id": 614845244,
          "node_id": "MDU6SXNzdWU2MTQ4NDUyNDQ=",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18916",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18916/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18916/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18916/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/18916",
          "number": 18916,
          "state": "closed",
          "state_reason": "completed",
          "title": "Sqlite wallet storage",
          "body": "This has been brought up a few times since at least 2018, e.g. [here](http://www.erisian.com.au/meetbot/bitcoin-core-dev/2018/bitcoin-core-dev.2018-09-27-19.00.log.html#l-180), [here](http://www.erisian.com.au/meetbot/bitcoin-core-dev/2018/bitcoin-core-dev.2018-12-14-19.01.log.html#l-96), but I never bothered to open an issue.\r\n\r\nSome cherry-picked arguments in favor:\r\n\r\n> 19:47:38 <cfields> sqlite is also nice in that they provide a monolithic source file and encourage direct integration.\r\n\r\n> 19:54:05 <wumpus> integrating sqlite into a project is trivial, indeed can be done as a single .cpp file if that's desirable\r\n\r\n> 19:54:33 <promag> any reason to not consider postgres for instance?\r\n> 19:54:38 <wumpus> AHHHH\r\n> 19:54:41 <sipa> promag: god why\r\n\r\n> 19:55:45 <jonasschnelli> Also BDB is a compile pitfall\r\n\r\nWe could make this opt-in in a first release. Then after a few releases make it the default. That way users can still downgrade their node without losing access to the wallet.\r\n\r\nIt should be possible to `./configure` without BDB, but we'll probably have to ship with BDB 4.8 (at least the ability to read) until the heat death of the universe.",
          "user": {
            "login": "Sjors",
            "id": 10217,
            "node_id": "MDQ6VXNlcjEwMjE3",
            "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Sjors",
            "html_url": "https://github.com/Sjors",
            "followers_url": "https://api.github.com/users/Sjors/followers",
            "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
            "organizations_url": "https://api.github.com/users/Sjors/orgs",
            "repos_url": "https://api.github.com/users/Sjors/repos",
            "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/Sjors/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 64583,
              "node_id": "MDU6TGFiZWw2NDU4Mw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Feature",
              "name": "Feature",
              "color": "7cf575",
              "default": false
            },
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "milestone": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/45",
            "html_url": "https://github.com/bitcoin/bitcoin/milestone/45",
            "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/45/labels",
            "id": 4914019,
            "node_id": "MDk6TWlsZXN0b25lNDkxNDAxOQ==",
            "number": 45,
            "state": "closed",
            "title": "0.21.0",
            "description": "",
            "creator": {
              "login": "laanwj",
              "id": 126646,
              "node_id": "MDQ6VXNlcjEyNjY0Ng==",
              "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/laanwj",
              "html_url": "https://github.com/laanwj",
              "followers_url": "https://api.github.com/users/laanwj/followers",
              "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
              "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
              "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
              "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
              "organizations_url": "https://api.github.com/users/laanwj/orgs",
              "repos_url": "https://api.github.com/users/laanwj/repos",
              "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
              "received_events_url": "https://api.github.com/users/laanwj/received_events",
              "type": "User",
              "site_admin": false
            },
            "open_issues": 0,
            "closed_issues": 132,
            "created_at": "2019-12-09T08:39:58Z",
            "updated_at": "2021-01-15T19:50:53Z",
            "closed_at": "2021-01-15T19:50:53Z"
          },
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 29,
          "closed_at": "2020-10-15T07:19:06Z",
          "created_at": "2020-05-08T16:25:36Z",
          "updated_at": "2022-02-15T10:48:12Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-21T04:41:06Z",
      "updated_at": "2021-01-21T04:41:06Z",
      "source": {
        "issue": {
          "id": 790688091,
          "node_id": "MDExOlB1bGxSZXF1ZXN0NTU4ODU5NjUw",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20974",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20974/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20974/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20974/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/20974",
          "number": 20974,
          "state": "open",
          "state_reason": null,
          "title": "test: add test for corrupt wallet bdb logs",
          "body": "This PR adds a wallet test testing handling of corrupt BDB logs. It restores commit c6a2c265f5d0b424fc8226c2f3426e82856779d0 from #18907 which was dropped because it triggered a memory leak, which is reported as #19034",
          "user": {
            "login": "ryanofsky",
            "id": 7133040,
            "node_id": "MDQ6VXNlcjcxMzMwNDA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/ryanofsky",
            "html_url": "https://github.com/ryanofsky",
            "followers_url": "https://api.github.com/users/ryanofsky/followers",
            "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
            "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
            "repos_url": "https://api.github.com/users/ryanofsky/repos",
            "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 62963516,
              "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
              "name": "Tests",
              "color": "d4c5f9",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 4,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20974",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/20974",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/20974.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/20974.patch"
          },
          "created_at": "2021-01-21T04:41:06Z",
          "updated_at": "2023-07-22T15:46:32Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 764660846,
      "node_id": "MDEyOklzc3VlQ29tbWVudDc2NDY2MDg0Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/764660846",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-01-21T13:58:47Z",
      "updated_at": "2021-01-21T13:58:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "Opened #20974 to test this. Leak does still happen https://cirrus-ci.com/task/5428735379767296?command=ci#L4680\r\n\r\n```\r\n==36296==ERROR: LeakSanitizer: detected memory leaks\r\nDirect leak of 65840 byte(s) in 2 object(s) allocated from:\r\n    #0 0x55fe2c45d3bd in malloc (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/bitcoind+0x17733bd)\r\n    #1 0x7f03e35788c4 in __os_malloc (/lib/x86_64-linux-gnu/libdb_cxx-5.3.so+0x1698c4)\r\nSUMMARY: AddressSanitizer: 65840 byte(s) leaked in 2 allocation(s). \r\n```",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/19034#issuecomment-764660846",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19034"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-03-20T12:01:19Z",
      "updated_at": "2023-03-20T12:01:19Z",
      "source": {
        "issue": {
          "id": 1631965664,
          "node_id": "I_kwDOABII585hRdHg",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27283",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27283/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27283/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27283/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/27283",
          "number": 27283,
          "state": "open",
          "state_reason": null,
          "title": "Memory leak loading legacy wallet (BDB 4.8.30)",
          "body": "On Ubuntu 22.10 (GNU/Linux 6.0.6-060006-generic x86_64) with gcc (12.2.0) and then running under valgrind (3.18.1).\r\n\r\nLoading a legacy wallet and then shutting down the node is the easiest way to reproduce.\r\n\r\nCan be seen on master f4e42a78c75719ad6a99962360ec67d92a563a9d, but see https://github.com/bitcoin/bitcoin/issues/27283#issuecomment-1476501591 for when the leak was introduced. It does not happen with BDB 5.13.\r\n\r\n```\r\n./configure BDB_LIBS=… --enable-debug --disable-asm …\r\nmake\r\n… \r\nvalgrind —leak-check=full src/bitcoind -regtest -nowallet -wallet=test_legacy\r\n… \r\n023-03-20T19:32:09Z [test_legacy] Releasing wallet\r\n2023-03-20T19:32:09Z Shutdown: done\r\n==1744646== \r\n==1744646== HEAP SUMMARY:\r\n==1744646==     in use at exit: 2,377 bytes in 12 blocks\r\n==1744646==   total heap usage: 296,219 allocs, 296,207 frees, 103,153,206 bytes allocated\r\n==1744646== \r\n==1744646== 160 bytes in 1 blocks are definitely lost in loss record 6 of 12\r\n==1744646==    at 0x4844899: malloc (in /usr/libexec/valgrind/vgpreload_memcheck-amd64-linux.so)\r\n==1744646==    by 0xE702AD: __os_malloc (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xE455CC: __env_alloc (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xEE3CC1: __lock_open (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xE497EB: __env_attach_regions (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xE49A8E: __env_open (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xE49C01: __env_open_pp (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0xE16E7D: DbEnv::open(char const*, unsigned int, int) (in /home/sjors/dev/bitcoin2/src/bitcoind)\r\n==1744646==    by 0x9EDDE8: wallet::BerkeleyEnvironment::Open(bilingual_str&) (bdb.cpp:164)\r\n==1744646==    by 0x9EEF34: wallet::BerkeleyDatabase::Verify(bilingual_str&) (bdb.cpp:271)\r\n==1744646==    by 0x9F41C8: wallet::MakeBerkeleyDatabase(fs::path const&, wallet::DatabaseOptions const&, wallet::DatabaseStatus&, bilingual_str&) (bdb.cpp:849)\r\n==1744646==    by 0x9A074A: wallet::MakeDatabase(fs::path const&, wallet::DatabaseOptions const&, wallet::DatabaseStatus&, bilingual_str&) (walletdb.cpp:1228)\r\n==1744646== \r\n==1744646== LEAK SUMMARY:\r\n==1744646==    definitely lost: 160 bytes in 1 blocks\r\n==1744646==    indirectly lost: 0 bytes in 0 blocks\r\n==1744646==      possibly lost: 0 bytes in 0 blocks\r\n==1744646==    still reachable: 2,217 bytes in 11 blocks\r\n==1744646==         suppressed: 0 bytes in 0 blocks\r\n==1744646== Reachable blocks (those to which a pointer was found) are not shown.\r\n==1744646== To see them, rerun with: --leak-check=full --show-leak-kinds=all\r\n==1744646== \r\n==1744646== For lists of detected and suppressed errors, rerun with: -s\r\n==1744646== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)\r\n```\r\n\r\n\r\nOriginally I found it inside a test by using the address sanitizer. I kept the original text below so the comments make sense:\r\n\r\n---\r\n\r\n```\r\nsrc/test/test_bitcoin --run_test=wallet_tests\r\n```\r\n\r\nPassed when configured without BDB, fails when configured with BDB:\r\n\r\n```sh\r\n./configure 'BDB_LIBS=-L/…' BDB_CFLAGS=-I/…/include CC=clang CXX=clang++ --enable-suppress-external-warnings --disable-asm --with-sanitizers=address --disable-fuzz-binary --without-gui\r\nmake -C src/test\r\nsrc/test/test_bitcoin --run_test=wallet_tests\r\n\r\n…\r\n\r\n*** No errors detected\r\n\r\n=================================================================\r\n==637422==ERROR: LeakSanitizer: detected memory leaks\r\n\r\nDirect leak of 320 byte(s) in 2 object(s) allocated from:\r\n    #0 0x555592a03dbe in malloc (/home/sjors/dev/bitcoin/src/test/test_bitcoin+0x470dbe) (BuildId: 8a0fe1527885800d0ca318fefe6c7e66c608d5eb)\r\n    #1 0x555595965e64 in __os_malloc (/home/sjors/dev/bitcoin/src/test/test_bitcoin+0x33d2e64) (BuildId: 8a0fe1527885800d0ca318fefe6c7e66c608d5eb)\r\n\r\nSUMMARY: AddressSanitizer: 320 byte(s) leaked in 2 allocation(s).\r\nmake[3]: *** [Makefile:21823: wallet/test/wallet_tests.cpp.test] Error 1\r\n```\r\n\r\nThere's other BDB related `-with-sanitizers=address` issues: #22592, #19034.\r\n\r\nThere's currently no suppression file for the address sanitizer and I don't know how to make one. It could make sense to suppress the ones we've found, keep a Github issue open for each of one to fix & remove the suppression.\r\n\r\nWithout BDB I can run the full unit and functional test suite just fine, so that's good news in the long run. But in the shorter run it's good to be able to thoroughly test all the legacy -> descriptor migration code that's being written.",
          "user": {
            "login": "Sjors",
            "id": 10217,
            "node_id": "MDQ6VXNlcjEwMjE3",
            "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Sjors",
            "html_url": "https://github.com/Sjors",
            "followers_url": "https://api.github.com/users/Sjors/followers",
            "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
            "organizations_url": "https://api.github.com/users/Sjors/orgs",
            "repos_url": "https://api.github.com/users/Sjors/repos",
            "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/Sjors/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            },
            {
              "id": 159815356,
              "node_id": "MDU6TGFiZWwxNTk4MTUzNTY=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Upstream",
              "name": "Upstream",
              "color": "bfd4f2",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 19,
          "created_at": "2023-03-20T12:01:19Z",
          "updated_at": "2023-03-21T14:51:27Z"
        },
        "type": "issue"
      }
    }
  ]
}