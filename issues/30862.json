{
  "type": "issue",
  "issue": {
    "id": 2516922209,
    "node_id": "I_kwDOABII586WBS9h",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/30862",
    "number": 30862,
    "state": "open",
    "state_reason": null,
    "title": "Race condition between ZMQ UpdateTip and getblocktemplate",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nWhen ZMQ announces a new chain tip via \"sequence\" \"C\" message, if `getblocktemplate` is called immediately, it can return a block template that does not reflect the new chain tip.\r\n\r\nThis is important for Braidpool, which needs to switch to a new chain tip as quickly as possible when a new block comes in.\n\n### Expected behaviour\n\n`getblocktemplate` should return a result consistent with the information announced via ZMQ and correctly reflect the current chain tip.\n\n### Steps to reproduce\n\nThis was seen on the `cpunet` testnet fork (which does not touch any of the consensus or ZMQ code). The bug report there is: https://github.com/braidpool/bitcoin/issues/1#issuecomment-2341397203\r\n\r\nThis occurs infrequently and it may be necessary to run the miner script for a day or more to see it.\r\n\r\nThe script that receives the ZMQ messages and calls `getblocktemplate` is here: https://github.com/braidpool/bitcoin/blob/cpunet/contrib/cpunet/miner\n\n### Relevant log output\n\nPlease see https://github.com/braidpool/bitcoin/issues/1#issuecomment-2341397203 for log output.\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nBitcoin Core version v27.99.0-e8b157f687eb-dirty\n\n### Operating system and version\n\nArch Linux 6.10.5-zen1-1-zen #1 ZEN SMP PREEMPT_DYNAMIC\n\n### Machine specifications\n\n8 core Ryzen, SSD.",
    "user": {
      "login": "mcelrath",
      "id": 1746780,
      "node_id": "MDQ6VXNlcjE3NDY3ODA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1746780?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mcelrath",
      "html_url": "https://github.com/mcelrath",
      "followers_url": "https://api.github.com/users/mcelrath/followers",
      "following_url": "https://api.github.com/users/mcelrath/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/mcelrath/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/mcelrath/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/mcelrath/subscriptions",
      "organizations_url": "https://api.github.com/users/mcelrath/orgs",
      "repos_url": "https://api.github.com/users/mcelrath/repos",
      "events_url": "https://api.github.com/users/mcelrath/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/mcelrath/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 5,
    "created_at": "2024-09-10T16:28:38Z",
    "updated_at": "2024-09-18T16:25:29Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 14214060468,
      "node_id": "LE_lADOABII586WBS9hzwAAAANPOVm0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14214060468",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-11T10:57:31Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    },
    {
      "event": "commented",
      "id": 2347161468,
      "node_id": "IC_kwDOABII586L5td8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2347161468",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-12T20:17:52Z",
      "updated_at": "2024-09-12T20:17:52Z",
      "author_association": "CONTRIBUTOR",
      "body": "can you rule out that someone else on the network just mined a block, and the inconclusive `getblocktemplate` result belongs to a previous call that was sent off before that new block was connected?",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2347161468",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862"
    },
    {
      "event": "commented",
      "id": 2347235405,
      "node_id": "IC_kwDOABII586L5_hN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2347235405",
      "actor": {
        "login": "mcelrath",
        "id": 1746780,
        "node_id": "MDQ6VXNlcjE3NDY3ODA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1746780?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mcelrath",
        "html_url": "https://github.com/mcelrath",
        "followers_url": "https://api.github.com/users/mcelrath/followers",
        "following_url": "https://api.github.com/users/mcelrath/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mcelrath/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mcelrath/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mcelrath/subscriptions",
        "organizations_url": "https://api.github.com/users/mcelrath/orgs",
        "repos_url": "https://api.github.com/users/mcelrath/repos",
        "events_url": "https://api.github.com/users/mcelrath/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mcelrath/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-12T21:02:16Z",
      "updated_at": "2024-09-12T21:02:16Z",
      "author_association": "NONE",
      "body": "I believe that's answered positively by the timestamps and structure of the\r\ncalling code.\r\n\r\nA better test would be to reproduce this with regtest which I'll create a\r\nscript to demonstrate soon.\r\n\r\nBut at the same time it seems there should be a mutex around the chain tip.\r\nIf there isn't this is basically guaranteed to happen. I haven't looked yet.\r\n\r\nOn Thu, Sep 12, 2024, 4:18 PM Martin Zumsande ***@***.***>\r\nwrote:\r\n\r\n> can you rule out that someone else on the network just mined a block, and\r\n> the inconclusive getblocktemplate result belongs to a previous call that\r\n> was sent off before that new block was connected?\r\n>\r\n> —\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2347161468>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AANKOXC46L4DZOZRMYSCJSLZWHZIRAVCNFSM6AAAAABN7EPF2CVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGNBXGE3DCNBWHA>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n",
      "user": {
        "login": "mcelrath",
        "id": 1746780,
        "node_id": "MDQ6VXNlcjE3NDY3ODA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1746780?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mcelrath",
        "html_url": "https://github.com/mcelrath",
        "followers_url": "https://api.github.com/users/mcelrath/followers",
        "following_url": "https://api.github.com/users/mcelrath/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mcelrath/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mcelrath/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mcelrath/subscriptions",
        "organizations_url": "https://api.github.com/users/mcelrath/orgs",
        "repos_url": "https://api.github.com/users/mcelrath/repos",
        "events_url": "https://api.github.com/users/mcelrath/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mcelrath/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2347235405",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862"
    },
    {
      "event": "commented",
      "id": 2347297919,
      "node_id": "IC_kwDOABII586L6Ox_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2347297919",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-12T21:41:36Z",
      "updated_at": "2024-09-12T21:41:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I believe that's answered positively by the timestamps and structure of the calling code.\r\n\r\nnot really. I don't see a `\"Calling bitcoin-cli: getblocktemplate\"` entry in the [log](https://github.com/braidpool/bitcoin/issues/1#issuecomment-2341397203) excerpt, but I do see a `DEBUG     result =` log entry. \r\n\r\nBoth logs are part of `async def bitcoin_cli(self, *args, input=b\"\"):` in your script. That's why I thought the rpc call may have happened before the block was connected by bitcoind.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2347297919",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862"
    },
    {
      "event": "commented",
      "id": 2358889569,
      "node_id": "IC_kwDOABII586Mmcxh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2358889569",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T16:14:19Z",
      "updated_at": "2024-09-18T16:14:19Z",
      "author_association": "MEMBER",
      "body": "> A better test would be to reproduce this with regtest which I'll create a script to demonstrate soon.\r\n\r\nDid you get a chance to write the reproducer?\r\n\r\n> But at the same time it seems there should be a mutex around the chain tip. If there isn't this is basically guaranteed to happen. I haven't looked yet.\r\n\r\nYes, the mutex is called `cs_main` or `ChainstateManager::GetMutex()` . The mutex is held while enqueueing the event. And `getblocktemplate` takes the mutex at the start.\r\n\r\nSo there may be (for example) two `BlockConnected` events, but the tip that `getblocktemplate` later sees obviously can only be one of the two (not both at the same time), or even none of the two.\r\n\r\n\r\n\r\n",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2358889569",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862"
    },
    {
      "event": "commented",
      "id": 2358912616,
      "node_id": "IC_kwDOABII586MmiZo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2358912616",
      "actor": {
        "login": "mcelrath",
        "id": 1746780,
        "node_id": "MDQ6VXNlcjE3NDY3ODA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1746780?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mcelrath",
        "html_url": "https://github.com/mcelrath",
        "followers_url": "https://api.github.com/users/mcelrath/followers",
        "following_url": "https://api.github.com/users/mcelrath/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mcelrath/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mcelrath/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mcelrath/subscriptions",
        "organizations_url": "https://api.github.com/users/mcelrath/orgs",
        "repos_url": "https://api.github.com/users/mcelrath/repos",
        "events_url": "https://api.github.com/users/mcelrath/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mcelrath/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-18T16:25:27Z",
      "updated_at": "2024-09-18T16:25:27Z",
      "author_association": "NONE",
      "body": "Not yet. I've been running my morning script all week and haven't seen it\r\nhappen again.\r\n\r\nOn Wed, Sep 18, 2024, 12:14 PM maflcko ***@***.***> wrote:\r\n\r\n> A better test would be to reproduce this with regtest which I'll create a\r\n> script to demonstrate soon.\r\n>\r\n> Did you get a chance to write the reproducer?\r\n>\r\n> But at the same time it seems there should be a mutex around the chain\r\n> tip. If there isn't this is basically guaranteed to happen. I haven't\r\n> looked yet.\r\n>\r\n> Yes, the mutex is called cs_main or ChainstateManager::GetMutex() . The\r\n> mutex is held while enqueueing the event. And getblocktemplate takes the\r\n> mutex at the start.\r\n>\r\n> So there may be (for example) two BlockConnected events, but the tip that\r\n> getblocktemplate later sees obviously can only be one of the two (not\r\n> both at the same time), or even none of the two.\r\n>\r\n> —\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2358889569>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/AANKOXHI3RSJCGFNMVOSFYLZXGRHHAVCNFSM6AAAAABN7EPF2CVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGNJYHA4DSNJWHE>\r\n> .\r\n> You are receiving this because you authored the thread.Message ID:\r\n> ***@***.***>\r\n>\r\n",
      "user": {
        "login": "mcelrath",
        "id": 1746780,
        "node_id": "MDQ6VXNlcjE3NDY3ODA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1746780?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mcelrath",
        "html_url": "https://github.com/mcelrath",
        "followers_url": "https://api.github.com/users/mcelrath/followers",
        "following_url": "https://api.github.com/users/mcelrath/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mcelrath/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mcelrath/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mcelrath/subscriptions",
        "organizations_url": "https://api.github.com/users/mcelrath/orgs",
        "repos_url": "https://api.github.com/users/mcelrath/repos",
        "events_url": "https://api.github.com/users/mcelrath/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mcelrath/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30862#issuecomment-2358912616",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30862"
    }
  ]
}